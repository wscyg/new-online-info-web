{
  "version": "2.0",
  "id": "chapter6-advanced-techniques",
  "title": "ã€Šæ‰‹æ’• GPTã€‹Â· Chapter 6",
  "subtitle": "RoPE Â· GQA Â· MoE Â· åˆæˆæ•°æ®",
  "templateId": "chapter2",
  "accent": "cyan",
  "pages": [
    {
      "id": "p-hero",
      "page": 0,
      "kind": "hero",
      "accent": "cyan",
      "dataTitle": "Chapter 6",
      "dataSub": "ç°ä»£ LLM çš„å››å¤§æ ¸å¿ƒæŠ€æœ¯",
      "header": {
        "badgeHtml": "<span class=\"hero-badge\"><span class=\"hero-badge-dot\"></span>æ‰‹æ’• GPT Â· è¿›é˜¶ç¯‡</span>",
        "title": "ç¬¬ 6 ç« ï¼šç°ä»£ LLM æ ¸å¿ƒæŠ€æœ¯",
        "subtitle": "RoPE æ—‹è½¬ä½ç½®ç¼–ç  Â· GQA åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› Â· MoE æ··åˆä¸“å®¶ Â· åˆæˆæ•°æ®",
        "extraHtml": "<p style=\"color:#94a3b8;font-size:14px;\">ä» GPT-3 åˆ° GPT-4ã€Llamaã€Mixtral çš„æŠ€æœ¯æ¼”è¿›</p>",
        "delay": 200,
        "speed": 28
      },
      "blocks": [
        {
          "type": "bridgeRow",
          "prevLabel": "ä¸Šä¸€ç« ",
          "prev": "Transformer ä¼˜åŒ–",
          "currentLabel": "æœ¬ç« ",
          "current": "å››å¤§æ ¸å¿ƒæŠ€æœ¯",
          "nextLabel": "ä¸‹ä¸€ç« ",
          "next": "è®­ç»ƒæŠ€å·§"
        },
        {
          "type": "microLead",
          "text": "æœ¬ç« è·¯çº¿ï¼šâ‘  RoPE æ—‹è½¬ä½ç½®ç¼–ç  â‘¡ GQA åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ› â‘¢ MoE æ··åˆä¸“å®¶ â‘£ åˆæˆæ•°æ®ç®¡é“"
        },
        {
          "type": "keyline",
          "dot": "!",
          "html": "<b>æ ¸å¿ƒé—®é¢˜ï¼š</b>å¦‚ä½•è®© LLM å¤„ç†æ›´é•¿åºåˆ—ã€æ›´å¿«æ¨ç†ã€æ›´å¼ºæ³›åŒ–ï¼Ÿ"
        }
      ]
    },
    {
      "id": "p-rope-intro",
      "page": 1,
      "kind": "section",
      "accent": "purple",
      "dataTitle": "RoPE",
      "dataSub": "æ—‹è½¬ä½ç½®ç¼–ç ",
      "header": {
        "label": "Part 1",
        "title": "RoPEï¼šæ—‹è½¬ä½ç½®ç¼–ç ",
        "descHtml": "ä¸ºä»€ä¹ˆä¼ ç»Ÿä½ç½®ç¼–ç æœ‰ç¼ºé™·ï¼ŸRoPE å¦‚ä½•ç”¨æ—‹è½¬çŸ©é˜µä¼˜é›…è§£å†³ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "callout",
          "title": "ä½ç½®ç¼–ç çš„ä¸‰ä»£æ¼”è¿›",
          "tag": "Evolution",
          "bodyHtml": "<ul class=\"content-list\"><li><b>ç¬¬ä¸€ä»£ - æ­£å¼¦ç¼–ç ï¼š</b>å›ºå®šæ¨¡å¼ï¼Œæ— æ³•å¤–æ¨åˆ°æ›´é•¿åºåˆ—</li><li><b>ç¬¬äºŒä»£ - å¯å­¦ä¹ ç¼–ç ï¼š</b>çµæ´»ä½†ä»å—é™äºè®­ç»ƒé•¿åº¦</li><li><b>ç¬¬ä¸‰ä»£ - RoPEï¼š</b>æ—‹è½¬ç¼–ç ï¼Œå¤©ç„¶æ”¯æŒé•¿åº¦å¤–æ¨</li></ul>"
        },
        {
          "type": "cardsGrid",
          "columns": 3,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ“",
              "title": "ç›¸å¯¹ä½ç½®",
              "subtitle": "Relative Position",
              "text": "åªå…³å¿ƒ token ä¹‹é—´çš„ç›¸å¯¹è·ç¦»ï¼Œè€Œéç»å¯¹ä½ç½®"
            },
            {
              "accent": "purple",
              "icon": "ğŸ”„",
              "title": "æ—‹è½¬ä¸å˜æ€§",
              "subtitle": "Rotation Invariance",
              "text": "ä½ç½®ä¿¡æ¯é€šè¿‡æ—‹è½¬è§’åº¦ç¼–ç ï¼Œå†…ç§¯ä¿æŒç›¸å¯¹å…³ç³»"
            },
            {
              "accent": "pink",
              "icon": "ğŸ“ˆ",
              "title": "é•¿åº¦å¤–æ¨",
              "subtitle": "Length Extrapolation",
              "text": "è®­ç»ƒ 4K å¯æ¨ç† 16K+ï¼Œçªç ´ä¸Šä¸‹æ–‡é™åˆ¶"
            }
          ]
        },
        {
          "type": "thinkBox",
          "qid": "think-rope-1",
          "title": "æ€è€ƒï¼šä¸ºä»€ä¹ˆç»å¯¹ä½ç½®ç¼–ç éš¾ä»¥å¤–æ¨ï¼Ÿ",
          "text": "æç¤ºï¼šæƒ³æƒ³å¦‚æœä½ ç”¨ [0, 1, 2, ..., 4095] è®­ç»ƒï¼Œé‡åˆ°ä½ç½® 8000 æ—¶æ¨¡å‹è§è¿‡å—ï¼Ÿ"
        }
      ]
    },
    {
      "id": "p-rope-math",
      "page": 2,
      "kind": "section",
      "accent": "purple",
      "dataTitle": "RoPE",
      "dataSub": "æ•°å­¦åŸç†",
      "header": {
        "label": "Part 1.2",
        "title": "RoPE çš„æ•°å­¦åŸç†",
        "descHtml": "ç”¨å¤æ•°å’Œæ—‹è½¬çŸ©é˜µç†è§£ RoPE çš„æ ¸å¿ƒæ€æƒ³"
      },
      "blocks": [
        {
          "type": "formulaBox",
          "label": "RoPE æ ¸å¿ƒå…¬å¼",
          "math": "f(q, m) = q Â· e^{imÎ¸}",
          "desc": "å°†ä½ç½® m ç¼–ç ä¸ºå¤æ•°æ—‹è½¬è§’åº¦ mÎ¸ï¼Œåº”ç”¨åˆ°æŸ¥è¯¢å‘é‡ q"
        },
        {
          "type": "living",
          "title": "RoPE åˆ†æ­¥æ¨å¯¼ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "å¯è§†åŒ–",
          "hint": "ç‚¹å‡»å·¦ä¾§ä»£ç è¡ŒæŸ¥çœ‹è¯¦è§£",
          "steps": [
            {
              "id": "rope-step1",
              "label": "Step 1: å¤æ•°è¡¨ç¤º",
              "code": "# æŠŠ 2D å‘é‡çœ‹ä½œå¤æ•°\nq = q_0 + iÂ·q_1",
              "viz": {
                "title": "å‘é‡ â†’ å¤æ•°",
                "sub": "æ¯ä¸¤ä¸ªç»´åº¦é…å¯¹æˆä¸€ä¸ªå¤æ•°",
                "bullets": ["q = [q_0, q_1] â†’ q_0 + iÂ·q_1", "d_model=4096 â†’ 2048 ä¸ªå¤æ•°"]
              }
            },
            {
              "id": "rope-step2",
              "label": "Step 2: æ—‹è½¬ç¼–ç ",
              "code": "# ä½ç½® m å¯¹åº”æ—‹è½¬è§’åº¦ mÂ·Î¸\nq_rotated = q Â· e^(iÂ·mÂ·Î¸)",
              "viz": {
                "title": "ä½ç½® â†’ æ—‹è½¬è§’åº¦",
                "sub": "ä½ç½®ä¿¡æ¯å˜æˆæ—‹è½¬æ“ä½œ",
                "bullets": ["ä½ç½® 0: æ—‹è½¬ 0Â°", "ä½ç½® 1: æ—‹è½¬ Î¸Â°", "ä½ç½® m: æ—‹è½¬ mÃ—Î¸Â°"]
              }
            },
            {
              "id": "rope-step3",
              "label": "Step 3: ç›¸å¯¹ä½ç½®",
              "code": "# QÂ·K çš„å†…ç§¯åªä¾èµ–ç›¸å¯¹ä½ç½®\nq_m Â· k_n = q Â· k Â· e^(iÂ·(m-n)Â·Î¸)",
              "viz": {
                "title": "å†…ç§¯ â†’ ç›¸å¯¹è·ç¦»",
                "sub": "ç»å¯¹ä½ç½®æ¶ˆå¤±ï¼Œåªå‰©ç›¸å¯¹è·ç¦» m-n",
                "bullets": ["e^(imÎ¸) Â· e^(-inÎ¸) = e^(i(m-n)Î¸)", "æ³¨æ„åŠ›åˆ†æ•°åªä¾èµ–ç›¸å¯¹ä½ç½®", "è¿™å°±æ˜¯ RoPE çš„é­”æ³•ï¼"]
              }
            }
          ]
        },
        {
          "type": "codeBlock",
          "file": "rope.py",
          "code": "def apply_rope(x, freqs):\n    \"\"\"Apply Rotary Position Embedding\"\"\"\n    # x: [batch, seq_len, d_model]\n    # freqs: [seq_len, d_model//2]\n    \n    # å°†å‘é‡é…å¯¹æˆå¤æ•°\n    x_complex = x.view(*x.shape[:-1], -1, 2)\n    x_complex = torch.view_as_complex(x_complex)\n    \n    # æ—‹è½¬\n    freqs_complex = torch.polar(torch.ones_like(freqs), freqs)\n    x_rotated = x_complex * freqs_complex\n    \n    # è½¬å›å®æ•°\n    return torch.view_as_real(x_rotated).flatten(-2)"
        }
      ]
    },
    {
      "id": "p-rope-ext",
      "page": 3,
      "kind": "section",
      "accent": "purple",
      "dataTitle": "RoPE",
      "dataSub": "é•¿åº¦æ‰©å±•",
      "header": {
        "label": "Part 1.3",
        "title": "RoPE çš„é•¿åº¦æ‰©å±•æŠ€å·§",
        "descHtml": "å¦‚ä½•è®© 4K è®­ç»ƒçš„æ¨¡å‹æ¨ç† 100K+ åºåˆ—ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "cardsGrid",
          "columns": 2,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ“",
              "title": "Position Interpolation",
              "subtitle": "ä½ç½®æ’å€¼",
              "text": "å°†ä½ç½®å‹ç¼©åˆ°è®­ç»ƒèŒƒå›´å†…ï¼špos' = pos Ã— (L_train / L_target)",
              "bullets": ["ç®€å•æœ‰æ•ˆ", "éœ€è¦å°‘é‡å¾®è°ƒ", "Meta Llama 2 é‡‡ç”¨"]
            },
            {
              "accent": "purple",
              "icon": "ğŸ§¬",
              "title": "NTK-aware Scaling",
              "subtitle": "ç¥ç»åˆ‡çº¿æ ¸æ„ŸçŸ¥ç¼©æ”¾",
              "text": "è°ƒæ•´åŸºé¢‘è€Œéä½ç½®ï¼šÎ¸' = Î¸ Ã— (L_target / L_train)^(2/d)",
              "bullets": ["æ— éœ€å¾®è°ƒ", "ä¿æŒé«˜é¢‘ä¿¡æ¯", "ç†è®ºæ›´ä¼˜é›…"]
            }
          ]
        },
        {
          "type": "callout",
          "title": "YaRNï¼šæœ€ä½³å®è·µ",
          "tag": "State-of-the-Art",
          "bodyHtml": "<p><b>YaRN (Yet another RoPE extensioN)</b> ç»“åˆäº†å¤šç§æŠ€æœ¯ï¼š</p><ul class=\"content-list\"><li>NTK-aware æ’å€¼ä¿æŒé«˜é¢‘</li><li>ä½é¢‘å¤–æ¨ + é«˜é¢‘æ’å€¼çš„æ··åˆç­–ç•¥</li><li>æ³¨æ„åŠ›æ¸©åº¦ç¼©æ”¾è¡¥å¿</li></ul><p>æ•ˆæœï¼šLlama 2 7B ä» 4K æ‰©å±•åˆ° 128Kï¼Œå‡ ä¹æ— æŸï¼</p>"
        },
        {
          "type": "stickyNote",
          "color": "yellow",
          "title": "ğŸ’¡ å®æˆ˜ç»éªŒ",
          "text": "é•¿åº¦æ‰©å±•ååˆ«å¿˜äº†è°ƒæ•´æ³¨æ„åŠ› softmax çš„æ¸©åº¦ï¼åºåˆ—å˜é•¿åæ³¨æ„åŠ›åˆ†æ•°çš„æ–¹å·®ä¼šå¢å¤§ã€‚"
        }
      ]
    },
    {
      "id": "p-gqa-intro",
      "page": 4,
      "kind": "section",
      "accent": "cyan",
      "dataTitle": "GQA",
      "dataSub": "åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›",
      "header": {
        "label": "Part 2",
        "title": "GQAï¼šåˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›",
        "descHtml": "å¦‚ä½•åœ¨ä¿æŒè´¨é‡çš„åŒæ—¶åŠ é€Ÿæ¨ç†ï¼ŸKV Cache çš„å†…å­˜ç“¶é¢ˆå¦‚ä½•è§£å†³ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "keyline",
          "dot": "!",
          "html": "<b>æ ¸å¿ƒé—®é¢˜ï¼š</b>KV Cache çš„å†…å­˜å¼€é”€ä¸åºåˆ—é•¿åº¦å’Œæ‰¹æ¬¡å¤§å°æˆæ­£æ¯”ï¼Œæ˜¯é•¿åºåˆ—æ¨ç†çš„ç“¶é¢ˆ"
        },
        {
          "type": "living",
          "title": "æ³¨æ„åŠ›æœºåˆ¶çš„æ¼”è¿›ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "æ¶æ„å¯¹æ¯”",
          "hint": "ç‚¹å‡»æŸ¥çœ‹ä¸åŒæ³¨æ„åŠ›æœºåˆ¶",
          "steps": [
            {
              "id": "mha",
              "label": "MHA: å¤šå¤´æ³¨æ„åŠ›",
              "code": "# Multi-Head Attention\n# æ¯ä¸ªå¤´ç‹¬ç«‹çš„ Q, K, V\nQ: [batch, heads, seq, d_head]\nK: [batch, heads, seq, d_head]\nV: [batch, heads, seq, d_head]",
              "viz": {
                "title": "MHA: æ ‡å‡†å¤šå¤´æ³¨æ„åŠ›",
                "sub": "æ¯ä¸ªå¤´å®Œæ•´çš„ Q, K, V",
                "bullets": ["å‚æ•°é‡å¤§ï¼Œè¡¨è¾¾èƒ½åŠ›å¼º", "KV Cache: heads Ã— seq Ã— d_head Ã— 2", "32 å¤´ Ã— 4K Ã— 128 Ã— 2 = 32MB/å±‚"]
              }
            },
            {
              "id": "mqa",
              "label": "MQA: å¤šæŸ¥è¯¢æ³¨æ„åŠ›",
              "code": "# Multi-Query Attention\n# æ‰€æœ‰å¤´å…±äº« K, V\nQ: [batch, heads, seq, d_head]\nK: [batch, 1, seq, d_head]  # å…±äº«!\nV: [batch, 1, seq, d_head]  # å…±äº«!",
              "viz": {
                "title": "MQA: æç«¯å…±äº«",
                "sub": "æ‰€æœ‰æŸ¥è¯¢å¤´å…±ç”¨ä¸€ä»½ K, V",
                "bullets": ["KV Cache å‡å°‘åˆ° 1/32", "ä½†è´¨é‡ä¸‹é™æ˜æ˜¾", "PaLMã€Falcon é‡‡ç”¨"]
              }
            },
            {
              "id": "gqa",
              "label": "GQA: åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›",
              "code": "# Grouped-Query Attention\n# æ¯ç»„å…±äº« K, V\nQ: [batch, 32, seq, d_head]\nK: [batch, 8, seq, d_head]   # 8 ç»„\nV: [batch, 8, seq, d_head]   # 8 ç»„",
              "viz": {
                "title": "GQA: å¹³è¡¡çš„é€‰æ‹©",
                "sub": "åˆ†ç»„å…±äº«ï¼Œè´¨é‡ä¸æ•ˆç‡å…¼å¾—",
                "bullets": ["32 ä¸ª Q å¤´ï¼Œ8 ä¸ª KV ç»„", "æ¯ 4 ä¸ª Q å…±äº« 1 ä¸ª KV", "KV Cache å‡å°‘ 4xï¼Œè´¨é‡å‡ ä¹æ— æŸ"]
              }
            }
          ]
        },
        {
          "type": "formulaBox",
          "label": "KV Cache å†…å­˜å…¬å¼",
          "math": "Memory = 2 Ã— layers Ã— kv_heads Ã— seq_len Ã— d_head Ã— bytes",
          "desc": "GQA é€šè¿‡å‡å°‘ kv_heads æ•°é‡æ¥é™ä½å†…å­˜å ç”¨"
        }
      ]
    },
    {
      "id": "p-gqa-impl",
      "page": 5,
      "kind": "section",
      "accent": "cyan",
      "dataTitle": "GQA",
      "dataSub": "å®ç°ç»†èŠ‚",
      "header": {
        "label": "Part 2.2",
        "title": "GQA å®ç°ï¼šä» MHA åˆ° GQA",
        "descHtml": "å¦‚ä½•å°†ç°æœ‰æ¨¡å‹è½¬æ¢ä¸º GQAï¼Ÿè®­ç»ƒå’Œæ¨ç†æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "codeBlock",
          "file": "gqa.py",
          "code": "class GroupedQueryAttention(nn.Module):\n    def __init__(self, d_model, n_heads, n_kv_heads):\n        super().__init__()\n        self.n_heads = n_heads        # 32 ä¸ªæŸ¥è¯¢å¤´\n        self.n_kv_heads = n_kv_heads  # 8 ä¸ª KV ç»„\n        self.n_rep = n_heads // n_kv_heads  # 4x å¤åˆ¶\n        \n        self.d_head = d_model // n_heads\n        \n        # Q æŠ•å½±ï¼šå®Œæ•´çš„ 32 å¤´\n        self.wq = nn.Linear(d_model, n_heads * self.d_head)\n        # K, V æŠ•å½±ï¼šåªæœ‰ 8 å¤´\n        self.wk = nn.Linear(d_model, n_kv_heads * self.d_head)\n        self.wv = nn.Linear(d_model, n_kv_heads * self.d_head)\n        \n    def forward(self, x):\n        B, L, _ = x.shape\n        \n        q = self.wq(x).view(B, L, self.n_heads, self.d_head)\n        k = self.wk(x).view(B, L, self.n_kv_heads, self.d_head)\n        v = self.wv(x).view(B, L, self.n_kv_heads, self.d_head)\n        \n        # å…³é”®ï¼šå¤åˆ¶ K, V ä»¥åŒ¹é… Q çš„å¤´æ•°\n        k = k.repeat_interleave(self.n_rep, dim=2)\n        v = v.repeat_interleave(self.n_rep, dim=2)\n        \n        # æ ‡å‡†æ³¨æ„åŠ›è®¡ç®—\n        attn = (q @ k.transpose(-2, -1)) / math.sqrt(self.d_head)\n        attn = F.softmax(attn, dim=-1)\n        return attn @ v"
        },
        {
          "type": "callout",
          "title": "MHA â†’ GQA è½¬æ¢æŠ€å·§",
          "tag": "Uptraining",
          "bodyHtml": "<p>å·²æœ‰ MHA æ¨¡å‹å¦‚ä½•è½¬æˆ GQAï¼Ÿ</p><ul class=\"content-list\"><li><b>æ–¹æ³• 1 - å‡å€¼æ± åŒ–ï¼š</b>å°†æ¯ç»„ KV å¤´çš„æƒé‡å–å¹³å‡</li><li><b>æ–¹æ³• 2 - é€‰å–ä»£è¡¨ï¼š</b>æ¯ç»„ä¿ç•™ä¸€ä¸ªå¤´ï¼Œä¸¢å¼ƒå…¶ä»–</li><li><b>æ–¹æ³• 3 - æ¸è¿›è®­ç»ƒï¼š</b>é€æ­¥å¢åŠ å…±äº«ç¨‹åº¦ï¼ŒæŒç»­å¾®è°ƒ</li></ul><p>Llama 2 70B é‡‡ç”¨æ–¹æ³• 3ï¼Œæ•ˆæœæœ€å¥½ã€‚</p>"
        },
        {
          "type": "stickyNote",
          "color": "blue",
          "title": "ğŸ“Š å®æµ‹æ•°æ®",
          "text": "Llama 2 70B (GQA-8) vs å®Œæ•´ MHAï¼šæ¨ç†é€Ÿåº¦æå‡ 1.8xï¼Œå›°æƒ‘åº¦ä»…å¢åŠ  0.02ï¼"
        }
      ]
    },
    {
      "id": "p-moe-intro",
      "page": 6,
      "kind": "section",
      "accent": "pink",
      "dataTitle": "MoE",
      "dataSub": "æ··åˆä¸“å®¶æ¨¡å‹",
      "header": {
        "label": "Part 3",
        "title": "MoEï¼šæ··åˆä¸“å®¶æ¨¡å‹",
        "descHtml": "å¦‚ä½•ç”¨ç¨€ç–æ¿€æ´»å®ç°ä¸‡äº¿å‚æ•°æ¨¡å‹ï¼Ÿä¸ºä»€ä¹ˆåªæ¿€æ´» 2 ä¸ªä¸“å®¶å°±å¤Ÿäº†ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "keyline",
          "dot": "!",
          "html": "<b>æ ¸å¿ƒæ€æƒ³ï¼š</b>ä¸æ˜¯æ‰€æœ‰å‚æ•°éƒ½éœ€è¦å‚ä¸æ¯ä¸ª token çš„è®¡ç®—â€”â€”æ¡ä»¶è®¡ç®— + ç¨€ç–æ¿€æ´»"
        },
        {
          "type": "cardsGrid",
          "columns": 3,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ§ ",
              "title": "ä¸“å®¶ç½‘ç»œ",
              "subtitle": "Expert Networks",
              "text": "å¤šä¸ªç‹¬ç«‹çš„ FFNï¼Œæ¯ä¸ªä¸“ç²¾ä¸åŒçŸ¥è¯†é¢†åŸŸ"
            },
            {
              "accent": "purple",
              "icon": "ğŸ¯",
              "title": "è·¯ç”±å™¨",
              "subtitle": "Router/Gate",
              "text": "å†³å®šæ¯ä¸ª token åº”è¯¥ç”±å“ªäº›ä¸“å®¶å¤„ç†"
            },
            {
              "accent": "pink",
              "icon": "âš¡",
              "title": "ç¨€ç–æ¿€æ´»",
              "subtitle": "Sparse Activation",
              "text": "æ¯æ¬¡åªæ¿€æ´» Top-K ä¸“å®¶ï¼ˆé€šå¸¸ K=2ï¼‰"
            }
          ]
        },
        {
          "type": "formulaBox",
          "label": "MoE å±‚è®¡ç®—å…¬å¼",
          "math": "y = \\sum_{i=1}^{K} G(x)_i \\cdot E_i(x)",
          "desc": "G(x) æ˜¯è·¯ç”±å™¨çš„ Top-K é—¨æ§æƒé‡ï¼ŒE_i æ˜¯ç¬¬ i ä¸ªä¸“å®¶çš„è¾“å‡º"
        },
        {
          "type": "callout",
          "title": "ç¨€ç– vs ç¨ å¯†",
          "tag": "Comparison",
          "bodyHtml": "<table style=\"width:100%;border-collapse:collapse;\"><tr style=\"border-bottom:1px solid rgba(255,255,255,0.1);\"><th style=\"text-align:left;padding:8px;\"></th><th style=\"padding:8px;\">Dense 7B</th><th style=\"padding:8px;\">MoE 8x7B</th></tr><tr style=\"border-bottom:1px solid rgba(255,255,255,0.1);\"><td style=\"padding:8px;\">æ€»å‚æ•°</td><td style=\"text-align:center;padding:8px;\">7B</td><td style=\"text-align:center;padding:8px;\">47B</td></tr><tr style=\"border-bottom:1px solid rgba(255,255,255,0.1);\"><td style=\"padding:8px;\">æ¿€æ´»å‚æ•°</td><td style=\"text-align:center;padding:8px;\">7B</td><td style=\"text-align:center;padding:8px;\">13B</td></tr><tr><td style=\"padding:8px;\">æ¨ç†é€Ÿåº¦</td><td style=\"text-align:center;padding:8px;\">1x</td><td style=\"text-align:center;padding:8px;\">~1.5x æ…¢</td></tr></table><p style=\"margin-top:12px;\">Mixtral 8x7B ç”¨ 13B çš„æ¨ç†æˆæœ¬è·å¾—æ¥è¿‘ 47B çš„èƒ½åŠ›ï¼</p>"
        }
      ]
    },
    {
      "id": "p-moe-router",
      "page": 7,
      "kind": "section",
      "accent": "pink",
      "dataTitle": "MoE",
      "dataSub": "è·¯ç”±æœºåˆ¶",
      "header": {
        "label": "Part 3.2",
        "title": "MoE è·¯ç”±å™¨è®¾è®¡",
        "descHtml": "å¦‚ä½•è®©ä¸“å®¶è´Ÿè½½å‡è¡¡ï¼Ÿå¦‚ä½•é¿å…ä¸“å®¶åç¼©ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "living",
          "title": "è·¯ç”±å™¨å·¥ä½œæµç¨‹ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "å¯è§†åŒ–",
          "hint": "ç‚¹å‡»æŸ¥çœ‹è·¯ç”±è¿‡ç¨‹",
          "steps": [
            {
              "id": "route-1",
              "label": "Step 1: è®¡ç®—ä¸“å®¶åˆ†æ•°",
              "code": "# è¾“å…¥ xï¼Œè®¡ç®—æ¯ä¸ªä¸“å®¶çš„åŒ¹é…åˆ†æ•°\nscores = x @ router_weights  # [batch, seq, n_experts]",
              "viz": {
                "title": "è·¯ç”±å™¨æ‰“åˆ†",
                "sub": "æ¯ä¸ª token å¯¹æ¯ä¸ªä¸“å®¶æ‰“åˆ†",
                "bullets": ["scores[i] è¡¨ç¤ºç¬¬ i ä¸ªä¸“å®¶çš„åŒ¹é…åº¦", "å¯ä»¥æ˜¯ç®€å•çº¿æ€§å±‚", "ä¹Ÿå¯ä»¥æ˜¯æ›´å¤æ‚çš„ç½‘ç»œ"]
              }
            },
            {
              "id": "route-2",
              "label": "Step 2: Top-K é€‰æ‹©",
              "code": "# é€‰æ‹©åˆ†æ•°æœ€é«˜çš„ K ä¸ªä¸“å®¶\ntop_k_scores, top_k_indices = scores.topk(k=2)",
              "viz": {
                "title": "ç¨€ç–é€‰æ‹©",
                "sub": "åªæ¿€æ´»æœ€ç›¸å…³çš„ K ä¸ªä¸“å®¶",
                "bullets": ["K=1: æœ€ç¨€ç–ï¼Œå¯èƒ½ä¸ç¨³å®š", "K=2: Mixtral é»˜è®¤ï¼Œå¹³è¡¡å¥½", "K=4+: æ›´ç¨ å¯†ï¼Œèƒ½åŠ›æ›´å¼º"]
              }
            },
            {
              "id": "route-3",
              "label": "Step 3: Softmax å½’ä¸€åŒ–",
              "code": "# å¯¹ Top-K åˆ†æ•°å½’ä¸€åŒ–\nweights = F.softmax(top_k_scores, dim=-1)",
              "viz": {
                "title": "æƒé‡å½’ä¸€åŒ–",
                "sub": "ç¡®ä¿ä¸“å®¶è´¡çŒ®åŠ æƒæ±‚å’Œ",
                "bullets": ["weights æ€»å’Œä¸º 1", "è¡¨ç¤ºå„ä¸“å®¶çš„è´¡çŒ®æ¯”ä¾‹", "å¯åŠ å™ªå£°å¢åŠ æ¢ç´¢æ€§"]
              }
            },
            {
              "id": "route-4",
              "label": "Step 4: ä¸“å®¶è®¡ç®— + èšåˆ",
              "code": "# åªè®¡ç®—è¢«é€‰ä¸­çš„ä¸“å®¶\noutput = sum(weights[i] * experts[idx[i]](x)\n             for i in range(k))",
              "viz": {
                "title": "ç¨€ç–è®¡ç®—",
                "sub": "åªæœ‰è¢«é€‰ä¸­çš„ä¸“å®¶å‚ä¸è®¡ç®—",
                "bullets": ["8 ä¸ªä¸“å®¶åªæ¿€æ´» 2 ä¸ª", "è®¡ç®—é‡çº¦ä¸º Dense çš„ 2/8", "ä½†è·å¾— 8 ä¸ªä¸“å®¶çš„çŸ¥è¯†"]
              }
            }
          ]
        },
        {
          "type": "callout",
          "title": "è´Ÿè½½å‡è¡¡æŸå¤±",
          "tag": "Auxiliary Loss",
          "bodyHtml": "<p>é—®é¢˜ï¼šè·¯ç”±å™¨å¯èƒ½æ€»æ˜¯é€‰æ‹©åŒä¸€ä¸ªä¸“å®¶ï¼ˆä¸“å®¶åç¼©ï¼‰</p><p>è§£å†³æ–¹æ¡ˆï¼šæ·»åŠ è¾…åŠ©æŸå¤±é¼“åŠ±å‡è¡¡åˆ†é…</p><pre style=\"background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;margin-top:8px;\"><code>L_balance = Î± Ã— (n_experts Ã— sum(f_i Ã— P_i))\nf_i = åˆ†é…ç»™ä¸“å®¶ i çš„ token æ¯”ä¾‹\nP_i = è·¯ç”±å™¨ç»™ä¸“å®¶ i çš„å¹³å‡æ¦‚ç‡</code></pre>"
        }
      ]
    },
    {
      "id": "p-moe-impl",
      "page": 8,
      "kind": "section",
      "accent": "pink",
      "dataTitle": "MoE",
      "dataSub": "ä»£ç å®ç°",
      "header": {
        "label": "Part 3.3",
        "title": "MoE å®Œæ•´å®ç°",
        "descHtml": "ä»é›¶å®ç°ä¸€ä¸ªå¯ç”¨çš„ MoE å±‚"
      },
      "blocks": [
        {
          "type": "codeBlock",
          "file": "moe.py",
          "code": "class MoELayer(nn.Module):\n    def __init__(self, d_model, d_ff, n_experts=8, top_k=2):\n        super().__init__()\n        self.n_experts = n_experts\n        self.top_k = top_k\n        \n        # è·¯ç”±å™¨ï¼šä¸€ä¸ªç®€å•çš„çº¿æ€§å±‚\n        self.router = nn.Linear(d_model, n_experts, bias=False)\n        \n        # ä¸“å®¶ï¼šn_experts ä¸ªç‹¬ç«‹çš„ FFN\n        self.experts = nn.ModuleList([\n            nn.Sequential(\n                nn.Linear(d_model, d_ff),\n                nn.GELU(),\n                nn.Linear(d_ff, d_model)\n            )\n            for _ in range(n_experts)\n        ])\n    \n    def forward(self, x):\n        B, L, D = x.shape\n        x_flat = x.view(-1, D)  # [B*L, D]\n        \n        # 1. è·¯ç”±å™¨æ‰“åˆ†\n        router_logits = self.router(x_flat)  # [B*L, n_experts]\n        \n        # 2. Top-K é€‰æ‹©\n        weights, indices = torch.topk(\n            F.softmax(router_logits, dim=-1),\n            k=self.top_k\n        )\n        weights = weights / weights.sum(dim=-1, keepdim=True)\n        \n        # 3. ç¨€ç–è®¡ç®—\n        output = torch.zeros_like(x_flat)\n        for i, expert in enumerate(self.experts):\n            # æ‰¾å‡ºè·¯ç”±åˆ°è¿™ä¸ªä¸“å®¶çš„ token\n            mask = (indices == i).any(dim=-1)\n            if mask.any():\n                expert_out = expert(x_flat[mask])\n                # åŠ æƒæ±‚å’Œ\n                for k in range(self.top_k):\n                    k_mask = indices[:, k] == i\n                    combined = mask & k_mask\n                    output[combined] += weights[combined, k:k+1] * expert_out[k_mask[mask]]\n        \n        return output.view(B, L, D)"
        },
        {
          "type": "stickyNote",
          "color": "pink",
          "title": "âš ï¸ å·¥ç¨‹æŒ‘æˆ˜",
          "text": "å®é™…éƒ¨ç½² MoE éœ€è¦è§£å†³ï¼š1) ä¸“å®¶å¹¶è¡Œçš„é€šä¿¡å¼€é”€ 2) è´Ÿè½½ä¸å‡è¡¡å¯¼è‡´çš„ GPU åˆ©ç”¨ç‡é—®é¢˜ 3) æ˜¾å­˜ç®¡ç†"
        }
      ]
    },
    {
      "id": "p-moe-train",
      "page": 9,
      "kind": "section",
      "accent": "pink",
      "dataTitle": "MoE",
      "dataSub": "è®­ç»ƒæŠ€å·§",
      "header": {
        "label": "Part 3.4",
        "title": "MoE è®­ç»ƒçš„æŒ‘æˆ˜ä¸æŠ€å·§",
        "descHtml": "å¦‚ä½•ç¨³å®šè®­ç»ƒï¼Ÿå¦‚ä½•é¿å…ä¸“å®¶åç¼©ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "cardsGrid",
          "columns": 2,
          "cards": [
            {
              "accent": "red",
              "icon": "ğŸ’¥",
              "title": "ä¸“å®¶åç¼©",
              "subtitle": "Expert Collapse",
              "text": "é—®é¢˜ï¼šè·¯ç”±å™¨åªé€‰æ‹©å°‘æ•°ä¸“å®¶ï¼Œå…¶ä»–ä¸“å®¶åºŸå¼ƒ",
              "bullets": ["æ·»åŠ è´Ÿè½½å‡è¡¡æŸå¤±", "åˆå§‹åŒ–æ—¶å¢åŠ å™ªå£°", "ä½¿ç”¨å®¹é‡å› å­é™åˆ¶"]
            },
            {
              "accent": "orange",
              "icon": "âš–ï¸",
              "title": "è´Ÿè½½ä¸å‡è¡¡",
              "subtitle": "Load Imbalance",
              "text": "é—®é¢˜ï¼šä¸åŒä¸“å®¶å¤„ç†çš„ token æ•°é‡å·®å¼‚å¤§",
              "bullets": ["è®¾ç½®å®¹é‡å› å­ 1.25", "ä¸¢å¼ƒæº¢å‡ºçš„ token", "åŠ¨æ€è°ƒæ•´è·¯ç”±é˜ˆå€¼"]
            },
            {
              "accent": "cyan",
              "icon": "ğŸ“¡",
              "title": "é€šä¿¡å¼€é”€",
              "subtitle": "Communication Cost",
              "text": "é—®é¢˜ï¼šä¸“å®¶åˆ†å¸ƒåœ¨ä¸åŒ GPUï¼Œéœ€è¦ All-to-All",
              "bullets": ["ä¸“å®¶å¹¶è¡Œ + æ•°æ®å¹¶è¡Œ", "ä¼˜åŒ–é€šä¿¡æ‹“æ‰‘", "å¼‚æ­¥æµæ°´çº¿"]
            },
            {
              "accent": "purple",
              "icon": "ğŸ’¾",
              "title": "æ˜¾å­˜å ç”¨",
              "subtitle": "Memory Footprint",
              "text": "é—®é¢˜ï¼šæ€»å‚æ•°é‡å¤§ï¼Œæ˜¾å­˜éœ€æ±‚é«˜",
              "bullets": ["ä¸“å®¶åˆ†ç‰‡åˆ°å¤šå¡", "ä½¿ç”¨é‡åŒ–æŠ€æœ¯", "åŠ¨æ€åŠ è½½ä¸“å®¶"]
            }
          ]
        },
        {
          "type": "callout",
          "title": "Mixtral çš„æˆåŠŸé…æ–¹",
          "tag": "Best Practice",
          "bodyHtml": "<ul class=\"content-list\"><li>8 ä¸ªä¸“å®¶ï¼ŒTop-2 è·¯ç”±</li><li>æ¯å±‚ç‹¬ç«‹çš„ MoEï¼ˆä¸å…±äº«ä¸“å®¶ï¼‰</li><li>é«˜è´¨é‡æ•°æ®é¢„è®­ç»ƒ + æŒ‡ä»¤å¾®è°ƒ</li><li>32K ä¸Šä¸‹æ–‡çª—å£ï¼ˆRoPE æ‰©å±•ï¼‰</li></ul><p>ç»“æœï¼šç”¨ 13B æ¿€æ´»å‚æ•°è¾¾åˆ° Llama 2 70B æ°´å¹³ï¼</p>"
        }
      ]
    },
    {
      "id": "p-synthetic-intro",
      "page": 10,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "æ•°æ®ç”Ÿæˆç®¡é“",
      "header": {
        "label": "Part 4",
        "title": "åˆæˆæ•°æ®ï¼šLLM çš„ç§˜å¯†æ­¦å™¨",
        "descHtml": "ä¸ºä»€ä¹ˆ GPT-4 èƒ½åŠ›çªé£çŒ›è¿›ï¼Ÿåˆæˆæ•°æ®å¦‚ä½•çªç ´æ•°æ®ç“¶é¢ˆï¼Ÿ"
      },
      "blocks": [
        {
          "type": "keyline",
          "dot": "!",
          "html": "<b>æ ¸å¿ƒæ´å¯Ÿï¼š</b>é«˜è´¨é‡æ•°æ® > æµ·é‡ä½è´¨æ•°æ®ã€‚ç”¨å¼ºæ¨¡å‹ç”Ÿæˆæ•°æ®æ¥è®­ç»ƒå¼±æ¨¡å‹ã€‚"
        },
        {
          "type": "cardsGrid",
          "columns": 3,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ“š",
              "title": "Self-Instruct",
              "subtitle": "è‡ªæˆ‘æŒ‡ä»¤",
              "text": "ç”¨ LLM è‡ªå·±ç”Ÿæˆè®­ç»ƒæŒ‡ä»¤å’Œå›ç­”"
            },
            {
              "accent": "purple",
              "icon": "ğŸ”„",
              "title": "Evol-Instruct",
              "subtitle": "è¿›åŒ–æŒ‡ä»¤",
              "text": "è¿­ä»£å¢åŠ æŒ‡ä»¤å¤æ‚åº¦ï¼Œä»ç®€å•åˆ°å›°éš¾"
            },
            {
              "accent": "pink",
              "icon": "ğŸ§ª",
              "title": "Distillation",
              "subtitle": "çŸ¥è¯†è’¸é¦",
              "text": "å¤§æ¨¡å‹æ•™å°æ¨¡å‹ï¼Œä¼ é€’æ¨ç†èƒ½åŠ›"
            }
          ]
        },
        {
          "type": "callout",
          "title": "ä¸ºä»€ä¹ˆåˆæˆæ•°æ®æœ‰æ•ˆï¼Ÿ",
          "tag": "Insight",
          "bodyHtml": "<ul class=\"content-list\"><li><b>è´¨é‡å¯æ§ï¼š</b>å¯ä»¥è®¾è®¡ç‰¹å®šéš¾åº¦ã€é¢†åŸŸçš„æ•°æ®</li><li><b>è§„æ¨¡æ— é™ï¼š</b>ä¸å—äººå·¥æ ‡æ³¨é€Ÿåº¦é™åˆ¶</li><li><b>å¤šæ ·æ€§ï¼š</b>é€šè¿‡ temperature é‡‡æ ·å¢åŠ å˜åŒ–</li><li><b>æ— ç‰ˆæƒé—®é¢˜ï¼š</b>é¿å… copyrighted æ•°æ®çš„æ³•å¾‹é£é™©</li></ul>"
        },
        {
          "type": "thinkBox",
          "qid": "think-synthetic-1",
          "title": "æ€è€ƒï¼šåˆæˆæ•°æ®çš„å±€é™æ€§ï¼Ÿ",
          "text": "ç”¨ GPT-4 ç”Ÿæˆæ•°æ®è®­ç»ƒå°æ¨¡å‹ï¼Œèƒ½å¦è®©å°æ¨¡å‹è¶…è¶Š GPT-4ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿ"
        }
      ]
    },
    {
      "id": "p-synthetic-pipeline",
      "page": 11,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "ç”Ÿæˆç®¡é“",
      "header": {
        "label": "Part 4.2",
        "title": "åˆæˆæ•°æ®ç”Ÿæˆç®¡é“",
        "descHtml": "ä»ç§å­æ•°æ®åˆ°é«˜è´¨é‡è®­ç»ƒé›†çš„å®Œæ•´æµç¨‹"
      },
      "blocks": [
        {
          "type": "living",
          "title": "æ•°æ®ç”Ÿæˆæµç¨‹ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "æµç¨‹å›¾",
          "hint": "ç‚¹å‡»æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤",
          "steps": [
            {
              "id": "syn-1",
              "label": "Step 1: ç§å­æ•°æ®å‡†å¤‡",
              "code": "# å‡†å¤‡å°‘é‡é«˜è´¨é‡ç§å­\nseeds = [\n  {\"topic\": \"æ•°å­¦\", \"examples\": [...]},\n  {\"topic\": \"ä»£ç \", \"examples\": [...]},\n]",
              "viz": {
                "title": "ç§å­æ•°æ®",
                "sub": "äººå·¥ç­›é€‰çš„ä¼˜è´¨æ ·æœ¬",
                "bullets": ["æ¶µç›–ç›®æ ‡é¢†åŸŸ", "æ ¼å¼è§„èŒƒç»Ÿä¸€", "éš¾åº¦æ¢¯åº¦åˆ†å¸ƒ"]
              }
            },
            {
              "id": "syn-2",
              "label": "Step 2: æŒ‡ä»¤ç”Ÿæˆ",
              "code": "prompt = f\"\"\"åŸºäºä»¥ä¸‹ç¤ºä¾‹ï¼Œç”Ÿæˆç±»ä¼¼ä½†ä¸åŒçš„ä»»åŠ¡æŒ‡ä»¤ï¼š\n{seeds}\nè¦æ±‚ï¼šæ›´å¤æ‚ã€æ›´å¤šæ ·ã€è¦†ç›–è¾¹ç•Œæƒ…å†µ\"\"\"",
              "viz": {
                "title": "Self-Instruct",
                "sub": "ç”¨ LLM ç”Ÿæˆæ–°æŒ‡ä»¤",
                "bullets": ["å¤šæ ·åŒ– prompt æ¨¡æ¿", "æ§åˆ¶éš¾åº¦åˆ†å¸ƒ", "è¿‡æ»¤é‡å¤å’Œä½è´¨"]
              }
            },
            {
              "id": "syn-3",
              "label": "Step 3: å›ç­”ç”Ÿæˆ",
              "code": "for instruction in instructions:\n    response = gpt4(instruction, temperature=0.7)\n    # å¯é€‰ï¼šå¤šæ¬¡é‡‡æ ·å–æœ€ä½³",
              "viz": {
                "title": "å›ç­”ç”Ÿæˆ",
                "sub": "ç”¨å¼ºæ¨¡å‹ç”Ÿæˆå›ç­”",
                "bullets": ["å¤šæ¬¡é‡‡æ ·å¢åŠ å¤šæ ·æ€§", "ä½¿ç”¨ CoT æå‡è´¨é‡", "æ§åˆ¶å›ç­”é•¿åº¦"]
              }
            },
            {
              "id": "syn-4",
              "label": "Step 4: è´¨é‡è¿‡æ»¤",
              "code": "# å¤šç»´åº¦è´¨é‡è¿‡æ»¤\nfiltered = filter(\n    lambda x: quality_check(x),\n    raw_data\n)",
              "viz": {
                "title": "è´¨é‡æŠŠå…³",
                "sub": "ä¸¥æ ¼è¿‡æ»¤ä½è´¨æ•°æ®",
                "bullets": ["æ ¼å¼æ­£ç¡®æ€§", "å†…å®¹ä¸€è‡´æ€§", "éš¾åº¦é€‚ä¸­", "å»é™¤æœ‰å®³å†…å®¹"]
              }
            },
            {
              "id": "syn-5",
              "label": "Step 5: æ•°æ®å¢å¼º",
              "code": "# å¯¹é«˜è´¨é‡æ•°æ®è¿›è¡Œå¢å¼º\naugmented = [\n    paraphrase(x),\n    add_noise(x),\n    translate(x),\n]",
              "viz": {
                "title": "æ•°æ®å¢å¼º",
                "sub": "æ‰©å±•æ•°æ®å¤šæ ·æ€§",
                "bullets": ["æ”¹å†™ã€ç¿»è¯‘ã€å›è¯‘", "æ·»åŠ å™ªå£°æé«˜é²æ£’æ€§", "ç”Ÿæˆå¯¹æŠ—æ ·æœ¬"]
              }
            }
          ]
        }
      ]
    },
    {
      "id": "p-synthetic-code",
      "page": 12,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "ä»£ç å®ç°",
      "header": {
        "label": "Part 4.3",
        "title": "åˆæˆæ•°æ®ä»£ç å®æˆ˜",
        "descHtml": "ä½¿ç”¨ OpenAI API å®ç°æ•°æ®ç”Ÿæˆç®¡é“"
      },
      "blocks": [
        {
          "type": "codeBlock",
          "file": "synthetic_data.py",
          "code": "import openai\nimport json\nfrom typing import List, Dict\n\ndef generate_instructions(seeds: List[str], n: int = 100) -> List[str]:\n    \"\"\"åŸºäºç§å­ç”Ÿæˆæ–°æŒ‡ä»¤\"\"\"\n    prompt = f\"\"\"\nä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ•°æ®æ ‡æ³¨å‘˜ã€‚åŸºäºä»¥ä¸‹ç¤ºä¾‹æŒ‡ä»¤ï¼Œç”Ÿæˆ {n} ä¸ªç±»ä¼¼ä½†ä¸åŒçš„æ–°æŒ‡ä»¤ã€‚\n\nç¤ºä¾‹æŒ‡ä»¤ï¼š\n{json.dumps(seeds, ensure_ascii=False, indent=2)}\n\nè¦æ±‚ï¼š\n1. æŒ‡ä»¤åº”è¯¥å¤šæ ·åŒ–ï¼Œè¦†ç›–ä¸åŒçš„åœºæ™¯å’Œéš¾åº¦\n2. é¿å…ä¸ç¤ºä¾‹è¿‡äºç›¸ä¼¼\n3. æ¯ä¸ªæŒ‡ä»¤ç‹¬ç«‹æˆè¡Œï¼ŒJSON æ•°ç»„æ ¼å¼è¾“å‡º\n\"\"\"\n    response = openai.ChatCompletion.create(\n        model=\"gpt-4\",\n        messages=[{\"role\": \"user\", \"content\": prompt}],\n        temperature=0.9,\n        max_tokens=4096\n    )\n    return json.loads(response.choices[0].message.content)\n\ndef generate_response(instruction: str) -> Dict:\n    \"\"\"ä¸ºæŒ‡ä»¤ç”Ÿæˆé«˜è´¨é‡å›ç­”\"\"\"\n    system = \"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šã€å‡†ç¡®ã€æœ‰å¸®åŠ©çš„ AI åŠ©æ‰‹ã€‚è¯·è¯¦ç»†å›ç­”ç”¨æˆ·é—®é¢˜ã€‚\"\n    response = openai.ChatCompletion.create(\n        model=\"gpt-4\",\n        messages=[\n            {\"role\": \"system\", \"content\": system},\n            {\"role\": \"user\", \"content\": instruction}\n        ],\n        temperature=0.7,\n        max_tokens=2048\n    )\n    return {\n        \"instruction\": instruction,\n        \"response\": response.choices[0].message.content\n    }\n\ndef quality_filter(data: Dict) -> bool:\n    \"\"\"è´¨é‡è¿‡æ»¤\"\"\"\n    # é•¿åº¦æ£€æŸ¥\n    if len(data[\"response\"]) < 50:\n        return False\n    # æ ¼å¼æ£€æŸ¥\n    if \"æˆ‘ä¸èƒ½\" in data[\"response\"] or \"æˆ‘æ— æ³•\" in data[\"response\"]:\n        return False\n    # å¯ä»¥æ·»åŠ æ›´å¤šè§„åˆ™...\n    return True"
        },
        {
          "type": "stickyNote",
          "color": "green",
          "title": "ğŸ’° æˆæœ¬æç¤º",
          "text": "ç”Ÿæˆ 10 ä¸‡æ¡é«˜è´¨é‡æ•°æ®çº¦éœ€ $500-2000ï¼ˆGPT-4ï¼‰ã€‚å¯ä»¥å…ˆç”¨ GPT-3.5 ç”Ÿæˆï¼Œå†ç”¨ GPT-4 ç­›é€‰å’Œæ”¹è¿›ã€‚"
        }
      ]
    },
    {
      "id": "p-synthetic-evol",
      "page": 13,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "Evol-Instruct",
      "header": {
        "label": "Part 4.4",
        "title": "Evol-Instructï¼šè¿›åŒ–å¼æ•°æ®ç”Ÿæˆ",
        "descHtml": "WizardLM çš„æ ¸å¿ƒæŠ€æœ¯ï¼šè®©æŒ‡ä»¤è‡ªåŠ¨è¿›åŒ–"
      },
      "blocks": [
        {
          "type": "callout",
          "title": "è¿›åŒ–ç­–ç•¥",
          "tag": "Evolution",
          "bodyHtml": "<p>Evol-Instruct é€šè¿‡ä¸¤ç§æ–¹å¼è®©æŒ‡ä»¤\"è¿›åŒ–\"ï¼š</p><ul class=\"content-list\"><li><b>æ·±åº¦è¿›åŒ–ï¼š</b>æ·»åŠ çº¦æŸã€å¢åŠ æ­¥éª¤ã€æé«˜å¤æ‚åº¦</li><li><b>å¹¿åº¦è¿›åŒ–ï¼š</b>ä¸»é¢˜å˜æ¢ã€é¢†åŸŸè¿ç§»ã€è§†è§’åˆ‡æ¢</li></ul>"
        },
        {
          "type": "codeBlock",
          "file": "evol_instruct.py",
          "code": "EVOL_PROMPTS = {\n    \"deepen\": \"\"\"è¯·å°†ä»¥ä¸‹æŒ‡ä»¤æ”¹å†™å¾—æ›´åŠ å¤æ‚å’Œæœ‰æŒ‘æˆ˜æ€§ï¼š\nåŸå§‹æŒ‡ä»¤ï¼š{instruction}\n\nè¦æ±‚ï¼š\n1. æ·»åŠ æ›´å¤šçº¦æŸæ¡ä»¶\n2. è¦æ±‚æ›´è¯¦ç»†çš„æ­¥éª¤åˆ†è§£\n3. å¢åŠ è¾¹ç•Œæƒ…å†µçš„å¤„ç†\n4. ä¿æŒä»»åŠ¡æœ¬è´¨ä¸å˜\n\nè¿›åŒ–åçš„æŒ‡ä»¤ï¼š\"\"\",\n    \n    \"broaden\": \"\"\"è¯·å°†ä»¥ä¸‹æŒ‡ä»¤æ”¹å†™åˆ°ä¸€ä¸ªæ–°çš„é¢†åŸŸæˆ–åœºæ™¯ï¼š\nåŸå§‹æŒ‡ä»¤ï¼š{instruction}\n\nè¦æ±‚ï¼š\n1. ä¿æŒä»»åŠ¡ç±»å‹ç›¸ä¼¼\n2. è¿ç§»åˆ°ä¸åŒçš„ä¸“ä¸šé¢†åŸŸ\n3. ä½¿ç”¨è¯¥é¢†åŸŸçš„ä¸“ä¸šæœ¯è¯­\n4. éš¾åº¦ä¿æŒç›¸è¿‘\n\nè¿ç§»åçš„æŒ‡ä»¤ï¼š\"\"\",\n    \n    \"concretize\": \"\"\"è¯·å°†ä»¥ä¸‹æŒ‡ä»¤å…·ä½“åŒ–ï¼š\nåŸå§‹æŒ‡ä»¤ï¼š{instruction}\n\nè¦æ±‚ï¼š\n1. æ·»åŠ å…·ä½“çš„æ•°å­—ã€åç§°ã€åœºæ™¯\n2. ç»™å‡ºæ˜ç¡®çš„è¾“å…¥è¾“å‡ºæ ¼å¼\n3. æä¾›ç¤ºä¾‹æ•°æ®\n\nå…·ä½“åŒ–åçš„æŒ‡ä»¤ï¼š\"\"\"\n}\n\ndef evolve_instruction(instruction: str, strategy: str) -> str:\n    prompt = EVOL_PROMPTS[strategy].format(instruction=instruction)\n    response = openai.ChatCompletion.create(\n        model=\"gpt-4\",\n        messages=[{\"role\": \"user\", \"content\": prompt}],\n        temperature=0.8\n    )\n    return response.choices[0].message.content"
        },
        {
          "type": "cardsGrid",
          "columns": 2,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ“ˆ",
              "title": "è¿›åŒ–å‰",
              "text": "\"å†™ä¸€ä¸ªæ’åºç®—æ³•\""
            },
            {
              "accent": "purple",
              "icon": "ğŸš€",
              "title": "è¿›åŒ–å",
              "text": "\"å®ç°ä¸€ä¸ªæ”¯æŒç™¾ä¸‡çº§æ•°æ®çš„å¤–éƒ¨æ’åºç®—æ³•ï¼Œè¦æ±‚ï¼š1) å†…å­˜é™åˆ¶ 1GB 2) æ”¯æŒæ–­ç‚¹ç»­ä¼  3) æä¾›æ—¶é—´å¤æ‚åº¦åˆ†æ 4) å¤„ç†é‡å¤æ•°æ®\""
            }
          ]
        }
      ]
    },
    {
      "id": "p-synthetic-distill",
      "page": 14,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "çŸ¥è¯†è’¸é¦",
      "header": {
        "label": "Part 4.5",
        "title": "çŸ¥è¯†è’¸é¦ï¼šè®©å°æ¨¡å‹å­¦å¤§æ¨¡å‹",
        "descHtml": "å¦‚ä½•å°† GPT-4 çš„æ¨ç†èƒ½åŠ›ä¼ é€’ç»™ 7B æ¨¡å‹ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "living",
          "title": "è’¸é¦æ–¹æ³•å¯¹æ¯”ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "æ–¹æ³•è¯¦è§£",
          "hint": "ç‚¹å‡»æŸ¥çœ‹ä¸åŒè’¸é¦æ–¹æ³•",
          "steps": [
            {
              "id": "dist-1",
              "label": "Response Distillation",
              "code": "# æœ€ç®€å•ï¼šç›´æ¥ç”¨å¤§æ¨¡å‹å›ç­”è®­ç»ƒ\nstudent.train(input=question, target=gpt4_response)",
              "viz": {
                "title": "å›ç­”è’¸é¦",
                "sub": "æ¨¡ä»¿å¤§æ¨¡å‹çš„è¾“å‡º",
                "bullets": ["ç®€å•ç›´æ¥", "ä¸¢å¤±æ¨ç†è¿‡ç¨‹", "Alpacaã€Vicuna é‡‡ç”¨"]
              }
            },
            {
              "id": "dist-2",
              "label": "CoT Distillation",
              "code": "# è¿æ¨ç†è¿‡ç¨‹ä¸€èµ·è’¸é¦\nstudent.train(\n    input=question,\n    target=gpt4_reasoning + gpt4_answer\n)",
              "viz": {
                "title": "æ¨ç†é“¾è’¸é¦",
                "sub": "å­¦ä¹ æ€è€ƒè¿‡ç¨‹",
                "bullets": ["ä¿ç•™ CoT æ¨ç†æ­¥éª¤", "æå‡å¤æ‚é—®é¢˜èƒ½åŠ›", "WizardMath é‡‡ç”¨"]
              }
            },
            {
              "id": "dist-3",
              "label": "Feedback Distillation",
              "code": "# è’¸é¦æ‰¹è¯„å’Œæ”¹è¿›èƒ½åŠ›\nstudent.train(\n    input=(question, student_response),\n    target=gpt4_feedback\n)",
              "viz": {
                "title": "åé¦ˆè’¸é¦",
                "sub": "å­¦ä¹ è‡ªæˆ‘æ”¹è¿›",
                "bullets": ["Constitutional AI æ€æƒ³", "å­¦ä¼šè¯†åˆ«å’Œä¿®å¤é”™è¯¯", "Self-Refine æ–¹æ³•"]
              }
            },
            {
              "id": "dist-4",
              "label": "Preference Distillation",
              "code": "# è’¸é¦åå¥½åˆ¤æ–­èƒ½åŠ›\nstudent.train_preference(\n    query=question,\n    chosen=gpt4_good,\n    rejected=gpt4_bad\n)",
              "viz": {
                "title": "åå¥½è’¸é¦",
                "sub": "å­¦ä¹ è´¨é‡åˆ¤æ–­",
                "bullets": ["ç”Ÿæˆå¯¹æ¯”æ•°æ®", "DPO/PPO è®­ç»ƒ", "Zephyrã€Neural Chat"]
              }
            }
          ]
        },
        {
          "type": "callout",
          "title": "è’¸é¦çš„å±€é™æ€§",
          "tag": "Limitation",
          "bodyHtml": "<p><b>é‡è¦è®¤çŸ¥ï¼š</b>è’¸é¦æ— æ³•è®©å­¦ç”Ÿè¶…è¶Šè€å¸ˆçš„èƒ½åŠ›ä¸Šé™ã€‚</p><ul class=\"content-list\"><li>å­¦ç”Ÿå¯ä»¥åœ¨ç‰¹å®šä»»åŠ¡ä¸Šæ¥è¿‘è€å¸ˆæ°´å¹³</li><li>ä½†æ³›åŒ–èƒ½åŠ›ã€ç½•è§æƒ…å†µå¤„ç†é€šå¸¸ä¸å¦‚è€å¸ˆ</li><li>è€å¸ˆæ¨¡å‹çš„é”™è¯¯ä¹Ÿä¼šè¢«å­¦ä¹ </li></ul><p>è§£å†³æ–¹æ¡ˆï¼šå¤šè€å¸ˆè’¸é¦ + äººç±»åé¦ˆ + è‡ªæˆ‘æ”¹è¿›</p>"
        }
      ]
    },
    {
      "id": "p-synthetic-quality",
      "page": 15,
      "kind": "section",
      "accent": "green",
      "dataTitle": "åˆæˆæ•°æ®",
      "dataSub": "è´¨é‡æ§åˆ¶",
      "header": {
        "label": "Part 4.6",
        "title": "åˆæˆæ•°æ®è´¨é‡æ§åˆ¶",
        "descHtml": "åƒåœ¾è¿›ï¼Œåƒåœ¾å‡ºâ€”â€”å¦‚ä½•ç¡®ä¿æ•°æ®è´¨é‡ï¼Ÿ"
      },
      "blocks": [
        {
          "type": "cardsGrid",
          "columns": 2,
          "cards": [
            {
              "accent": "cyan",
              "icon": "ğŸ”",
              "title": "æ ¼å¼æ£€æŸ¥",
              "text": "ç¡®ä¿è¾“å‡ºæ ¼å¼æ­£ç¡®ï¼ŒJSON å¯è§£æï¼Œä»£ç å¯è¿è¡Œ"
            },
            {
              "accent": "purple",
              "icon": "âœ…",
              "title": "ä¸€è‡´æ€§éªŒè¯",
              "text": "é—®é¢˜å’Œå›ç­”æ˜¯å¦åŒ¹é…ï¼Œé€»è¾‘æ˜¯å¦è‡ªæ´½"
            },
            {
              "accent": "pink",
              "icon": "ğŸ§¹",
              "title": "å»é‡å»å™ª",
              "text": "ç§»é™¤é‡å¤ã€ç›¸ä¼¼ã€ä½ä¿¡æ¯é‡çš„æ ·æœ¬"
            },
            {
              "accent": "green",
              "icon": "ğŸ›¡ï¸",
              "title": "å®‰å…¨è¿‡æ»¤",
              "text": "æ£€æµ‹å¹¶ç§»é™¤æœ‰å®³ã€åè§ã€æ•æ„Ÿå†…å®¹"
            }
          ]
        },
        {
          "type": "codeBlock",
          "file": "quality_control.py",
          "code": "from transformers import AutoModelForSequenceClassification\nimport torch\n\nclass DataQualityChecker:\n    def __init__(self):\n        # åŠ è½½è´¨é‡è¯„åˆ†æ¨¡å‹\n        self.scorer = AutoModelForSequenceClassification.from_pretrained(\n            \"OpenAssistant/reward-model-deberta-v3-large\"\n        )\n        # åŠ è½½æ¯’æ€§æ£€æµ‹æ¨¡å‹\n        self.toxicity = AutoModelForSequenceClassification.from_pretrained(\n            \"facebook/roberta-hate-speech-dynabench-r4\"\n        )\n    \n    def check_quality(self, instruction: str, response: str) -> dict:\n        \"\"\"å¤šç»´åº¦è´¨é‡æ£€æŸ¥\"\"\"\n        text = f\"### Human: {instruction}\\n\\n### Assistant: {response}\"\n        \n        # 1. è´¨é‡è¯„åˆ†\n        quality_score = self.scorer(text).logits.item()\n        \n        # 2. æ¯’æ€§æ£€æµ‹\n        toxicity_score = self.toxicity(response).logits.softmax(-1)[0, 1].item()\n        \n        # 3. é•¿åº¦æ£€æŸ¥\n        length_ok = 50 < len(response) < 4000\n        \n        # 4. æ ¼å¼æ£€æŸ¥\n        format_ok = not response.startswith(\"I cannot\") \\\n                   and not \"as an AI\" in response.lower()\n        \n        return {\n            \"quality_score\": quality_score,\n            \"toxicity_score\": toxicity_score,\n            \"length_ok\": length_ok,\n            \"format_ok\": format_ok,\n            \"pass\": quality_score > 0.5 and toxicity_score < 0.3 \\\n                    and length_ok and format_ok\n        }"
        }
      ]
    },
    {
      "id": "p-practice-1",
      "page": 16,
      "kind": "section",
      "accent": "cyan",
      "dataTitle": "å®æˆ˜",
      "dataSub": "ç»¼åˆç»ƒä¹ ",
      "header": {
        "label": "Practice",
        "title": "å®æˆ˜ï¼šæ„å»ºå®Œæ•´ LLM è®­ç»ƒç®¡é“",
        "descHtml": "å°†å››å¤§æŠ€æœ¯æ•´åˆåˆ°ä¸€ä¸ªé¡¹ç›®ä¸­"
      },
      "blocks": [
        {
          "type": "callout",
          "title": "é¡¹ç›®ç›®æ ‡",
          "tag": "Mission",
          "bodyHtml": "<p>æ„å»ºä¸€ä¸ª 7B æ¨¡å‹çš„å®Œæ•´è®­ç»ƒæµç¨‹ï¼š</p><ul class=\"content-list\"><li>ä½¿ç”¨ <b>RoPE</b> æ”¯æŒ 16K ä¸Šä¸‹æ–‡</li><li>ä½¿ç”¨ <b>GQA</b> åŠ é€Ÿæ¨ç†</li><li>ä½¿ç”¨ <b>åˆæˆæ•°æ®</b> å¢å¼ºç‰¹å®šé¢†åŸŸèƒ½åŠ›</li><li>å¯é€‰ï¼šå°è¯• <b>MoE</b> æ¶æ„</li></ul>"
        },
        {
          "type": "living",
          "title": "å®æˆ˜æ­¥éª¤ï¼ˆç‚¹å‡»å·¦ä¾§æŸ¥çœ‹ï¼‰",
          "vizTitle": "è¯¦ç»†æŒ‡å—",
          "hint": "ç‚¹å‡»æŸ¥çœ‹æ¯ä¸ªæ­¥éª¤",
          "steps": [
            {
              "id": "prac-1",
              "label": "Step 1: åŸºç¡€æ¨¡å‹",
              "code": "# é€‰æ‹©åŸºåº§æ¨¡å‹\nmodel = AutoModelForCausalLM.from_pretrained(\n    \"meta-llama/Llama-2-7b-hf\"\n)",
              "viz": {
                "title": "é€‰æ‹©åŸºåº§",
                "sub": "æ¨è Llama 2 ç³»åˆ—",
                "bullets": ["å·²åŒ…å« RoPE", "å·²åŒ…å« GQA", "ç¤¾åŒºæ”¯æŒå¥½"]
              }
            },
            {
              "id": "prac-2",
              "label": "Step 2: æ‰©å±•ä¸Šä¸‹æ–‡",
              "code": "# åº”ç”¨ YaRN æ‰©å±•åˆ° 16K\nmodel.config.rope_scaling = {\n    \"type\": \"yarn\",\n    \"factor\": 4.0,  # 4K -> 16K\n}",
              "viz": {
                "title": "ä¸Šä¸‹æ–‡æ‰©å±•",
                "sub": "ä½¿ç”¨ YaRN æ–¹æ³•",
                "bullets": ["ä¿®æ”¹ rope_scaling é…ç½®", "éœ€è¦å°‘é‡å¾®è°ƒï¼ˆå¯é€‰ï¼‰", "éªŒè¯é•¿æ–‡æœ¬æ•ˆæœ"]
              }
            },
            {
              "id": "prac-3",
              "label": "Step 3: ç”Ÿæˆæ•°æ®",
              "code": "# ä½¿ç”¨ GPT-4 ç”Ÿæˆé¢†åŸŸæ•°æ®\ndata = generate_synthetic_data(\n    domain=\"æ³•å¾‹å’¨è¯¢\",\n    n_samples=10000\n)",
              "viz": {
                "title": "æ•°æ®ç”Ÿæˆ",
                "sub": "é’ˆå¯¹ç›®æ ‡é¢†åŸŸ",
                "bullets": ["Evol-Instruct å¢åŠ éš¾åº¦", "CoT ä¿ç•™æ¨ç†è¿‡ç¨‹", "ä¸¥æ ¼è´¨é‡è¿‡æ»¤"]
              }
            },
            {
              "id": "prac-4",
              "label": "Step 4: å¾®è°ƒ",
              "code": "# LoRA é«˜æ•ˆå¾®è°ƒ\ntrainer = SFTTrainer(\n    model=model,\n    train_dataset=data,\n    peft_config=LoraConfig(r=64),\n)",
              "viz": {
                "title": "é«˜æ•ˆå¾®è°ƒ",
                "sub": "ä½¿ç”¨ LoRA/QLoRA",
                "bullets": ["èŠ‚çœæ˜¾å­˜", "é¿å…ç¾éš¾é—å¿˜", "å¿«é€Ÿè¿­ä»£"]
              }
            },
            {
              "id": "prac-5",
              "label": "Step 5: è¯„ä¼°éƒ¨ç½²",
              "code": "# è¯„ä¼° + éƒ¨ç½²\nevaluate(model, benchmark=\"legal_qa\")\ndeploy(model, framework=\"vllm\")",
              "viz": {
                "title": "è¯„ä¼°éƒ¨ç½²",
                "sub": "ä½¿ç”¨ vLLM åŠ é€Ÿ",
                "bullets": ["åœ¨ç›®æ ‡ä»»åŠ¡ä¸Šè¯„ä¼°", "KV Cache + PagedAttention", "æ‰¹é‡æ¨ç†ä¼˜åŒ–"]
              }
            }
          ]
        }
      ]
    },
    {
      "id": "p-practice-2",
      "page": 17,
      "kind": "section",
      "accent": "purple",
      "dataTitle": "ä»£ç ",
      "dataSub": "å®Œæ•´è®­ç»ƒè„šæœ¬",
      "header": {
        "label": "Code",
        "title": "å®Œæ•´è®­ç»ƒè„šæœ¬",
        "descHtml": "å¯ç›´æ¥è¿è¡Œçš„è®­ç»ƒä»£ç "
      },
      "blocks": [
        {
          "type": "codeBlock",
          "file": "train.py",
          "code": "\"\"\"å®Œæ•´çš„ LLM å¾®è°ƒè„šæœ¬\"\"\"\nimport torch\nfrom transformers import (\n    AutoModelForCausalLM, AutoTokenizer,\n    TrainingArguments, Trainer\n)\nfrom peft import LoraConfig, get_peft_model\nfrom datasets import load_dataset\n\n# 1. åŠ è½½æ¨¡å‹å’Œåˆ†è¯å™¨\nmodel_id = \"meta-llama/Llama-2-7b-hf\"\ntokenizer = AutoTokenizer.from_pretrained(model_id)\nmodel = AutoModelForCausalLM.from_pretrained(\n    model_id,\n    torch_dtype=torch.bfloat16,\n    device_map=\"auto\"\n)\n\n# 2. é…ç½® LoRA\nlora_config = LoraConfig(\n    r=64,\n    lora_alpha=128,\n    target_modules=[\"q_proj\", \"k_proj\", \"v_proj\", \"o_proj\"],\n    lora_dropout=0.05,\n    bias=\"none\",\n    task_type=\"CAUSAL_LM\"\n)\nmodel = get_peft_model(model, lora_config)\n\n# 3. åŠ è½½æ•°æ®\ndataset = load_dataset(\"json\", data_files=\"synthetic_data.json\")\n\ndef format_prompt(example):\n    return f\"### Question: {example['instruction']}\\n\\n### Answer: {example['response']}\"\n\ndataset = dataset.map(lambda x: tokenizer(format_prompt(x), truncation=True, max_length=2048))\n\n# 4. è®­ç»ƒé…ç½®\ntraining_args = TrainingArguments(\n    output_dir=\"./output\",\n    num_train_epochs=3,\n    per_device_train_batch_size=4,\n    gradient_accumulation_steps=4,\n    learning_rate=2e-4,\n    warmup_ratio=0.1,\n    logging_steps=10,\n    save_strategy=\"epoch\",\n    bf16=True,\n)\n\n# 5. å¼€å§‹è®­ç»ƒ\ntrainer = Trainer(\n    model=model,\n    args=training_args,\n    train_dataset=dataset[\"train\"],\n)\ntrainer.train()\n\n# 6. ä¿å­˜æ¨¡å‹\nmodel.save_pretrained(\"./final_model\")"
        }
      ]
    },
    {
      "id": "p-summary",
      "page": 18,
      "kind": "section",
      "accent": "cyan",
      "dataTitle": "æ€»ç»“",
      "dataSub": "Chapter 6 å›é¡¾",
      "header": {
        "label": "Summary",
        "title": "ç¬¬ 6 ç« æ€»ç»“",
        "descHtml": "ç°ä»£ LLM çš„å››å¤§æ ¸å¿ƒæŠ€æœ¯"
      },
      "blocks": [
        {
          "type": "cardsGrid",
          "columns": 2,
          "cards": [
            {
              "accent": "purple",
              "icon": "ğŸ”„",
              "title": "RoPE",
              "subtitle": "æ—‹è½¬ä½ç½®ç¼–ç ",
              "bullets": ["ç”¨æ—‹è½¬ç¼–ç ç›¸å¯¹ä½ç½®", "æ”¯æŒé•¿åº¦å¤–æ¨", "YaRN æ‰©å±•åˆ° 100K+"]
            },
            {
              "accent": "cyan",
              "icon": "ğŸ¯",
              "title": "GQA",
              "subtitle": "åˆ†ç»„æŸ¥è¯¢æ³¨æ„åŠ›",
              "bullets": ["KV å¤´åˆ†ç»„å…±äº«", "æ¨ç†é€Ÿåº¦æå‡ 2x", "è´¨é‡å‡ ä¹æ— æŸ"]
            },
            {
              "accent": "pink",
              "icon": "ğŸ§ ",
              "title": "MoE",
              "subtitle": "æ··åˆä¸“å®¶æ¨¡å‹",
              "bullets": ["ç¨€ç–æ¿€æ´»é™æˆæœ¬", "ä¸“å®¶åˆ†å·¥åä½œ", "Mixtral 8x7B æˆåŠŸæ¡ˆä¾‹"]
            },
            {
              "accent": "green",
              "icon": "ğŸ“š",
              "title": "åˆæˆæ•°æ®",
              "subtitle": "æ•°æ®ç”Ÿæˆç®¡é“",
              "bullets": ["Self/Evol-Instruct", "çŸ¥è¯†è’¸é¦ä¼ æ‰¿èƒ½åŠ›", "è´¨é‡ > æ•°é‡"]
            }
          ]
        },
        {
          "type": "callout",
          "title": "å…³é”® Takeaways",
          "tag": "Key Points",
          "bodyHtml": "<ul class=\"content-list\"><li><b>RoPE</b> æ˜¯ç›®å‰æœ€å¥½çš„ä½ç½®ç¼–ç æ–¹æ¡ˆï¼Œå‡ ä¹æ‰€æœ‰æ–°æ¨¡å‹éƒ½åœ¨ç”¨</li><li><b>GQA</b> æ˜¯æ¨ç†ä¼˜åŒ–çš„æ ‡é…ï¼Œæ˜¾è‘—é™ä½ KV Cache å¼€é”€</li><li><b>MoE</b> æ˜¯çªç ´è§„æ¨¡ç“¶é¢ˆçš„æœ‰æ•ˆæ–¹æ¡ˆï¼Œä½†å·¥ç¨‹æŒ‘æˆ˜å¤§</li><li><b>åˆæˆæ•°æ®</b> æ­£åœ¨æˆä¸ºè®­ç»ƒæ•°æ®çš„ä¸»è¦æ¥æº</li></ul>"
        },
        {
          "type": "thinkBox",
          "qid": "think-final",
          "title": "è¯¾åæ€è€ƒ",
          "text": "å¦‚æœä½ è¦è®­ç»ƒä¸€ä¸ª 10B å‚æ•°çš„é¢†åŸŸä¸“ç”¨æ¨¡å‹ï¼Œä½ ä¼šå¦‚ä½•ç»„åˆè¿™å››ç§æŠ€æœ¯ï¼Ÿè¯·å†™å‡ºä½ çš„æŠ€æœ¯æ–¹æ¡ˆã€‚"
        }
      ]
    },
    {
      "id": "p-next",
      "page": 19,
      "kind": "section",
      "accent": "purple",
      "dataTitle": "é¢„å‘Š",
      "dataSub": "Chapter 7",
      "header": {
        "label": "Next",
        "title": "ä¸‹ä¸€ç« é¢„å‘Š",
        "descHtml": "ç¬¬ 7 ç« ï¼šè®­ç»ƒæŠ€å·§ä¸å·¥ç¨‹å®è·µ"
      },
      "blocks": [
        {
          "type": "cardsGrid",
          "columns": 3,
          "cards": [
            {
              "accent": "cyan",
              "icon": "âš¡",
              "title": "Flash Attention",
              "text": "IO æ„ŸçŸ¥çš„æ³¨æ„åŠ›ç®—æ³•ï¼Œå¤§å¹…åŠ é€Ÿè®­ç»ƒ"
            },
            {
              "accent": "purple",
              "icon": "ğŸ”§",
              "title": "FSDP & DeepSpeed",
              "text": "åˆ†å¸ƒå¼è®­ç»ƒæ¡†æ¶ä¸ä¼˜åŒ–ç­–ç•¥"
            },
            {
              "accent": "pink",
              "icon": "ğŸ“",
              "title": "é‡åŒ–ä¸æ¨ç†",
              "text": "INT8/INT4 é‡åŒ–ï¼Œæ¨ç†åŠ é€ŸæŠ€æœ¯"
            }
          ]
        },
        {
          "type": "callout",
          "title": "é¢„ä¹ å»ºè®®",
          "tag": "Homework",
          "bodyHtml": "<ul class=\"content-list\"><li>é˜…è¯» Flash Attention è®ºæ–‡ï¼ˆæˆ– Tri Dao çš„åšå®¢ï¼‰</li><li>äº†è§£ PyTorch FSDP åŸºæœ¬ç”¨æ³•</li><li>å°è¯•ç”¨ bitsandbytes é‡åŒ–ä¸€ä¸ªæ¨¡å‹</li></ul>"
        }
      ]
    }
  ]
}
