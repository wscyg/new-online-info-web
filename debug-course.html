<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹è¯¦æƒ…è°ƒè¯•é¡µé¢</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 2rem; }
        .btn { background: #3b82f6; color: white; border: none; padding: 0.75rem 1.5rem; margin: 0.5rem; border-radius: 4px; cursor: pointer; }
        .result { margin: 1rem 0; padding: 1rem; background: #f5f5f5; border-radius: 4px; white-space: pre-wrap; }
        .chapter { margin: 0.5rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; }
        .chapter.free { border-color: #22c55e; background: #f0fdf4; }
        .chapter.premium { border-color: #f59e0b; background: #fffbeb; }
    </style>
</head>
<body>
    <h1>ğŸ” è¯¾ç¨‹è¯¦æƒ…è°ƒè¯•é¡µé¢</h1>
    <p>è°ƒè¯•è¯¾ç¨‹ID=1çš„ç« èŠ‚è®¿é—®é—®é¢˜</p>
    
    <div>
        <button class="btn" onclick="checkAuth()">æ£€æŸ¥ç™»å½•çŠ¶æ€</button>
        <button class="btn" onclick="checkSubscription()">æ£€æŸ¥è®¢é˜…çŠ¶æ€</button>
        <button class="btn" onclick="loadChapters()">åŠ è½½ç« èŠ‚</button>
        <button class="btn" onclick="loginAsUser()">æ¨¡æ‹Ÿç™»å½•</button>
    </div>
    
    <div id="output" class="result">ç­‰å¾…æ“ä½œ...</div>
    <div id="chapters"></div>

    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let isSubscribed = false;
        let chapters = [];

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            document.getElementById('output').innerHTML += `[${timestamp}] ${message}\n`;
        }

        async function checkAuth() {
            log('=== æ£€æŸ¥ç™»å½•çŠ¶æ€ ===');
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('âŒ æœªæ‰¾åˆ°token');
                return false;
            }

            log('âœ… æ‰¾åˆ°token: ' + token.substring(0, 50) + '...');

            try {
                const response = await fetch(`${API_BASE}/auth/profile`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                log('ç”¨æˆ·ä¿¡æ¯å“åº”: ' + JSON.stringify(data, null, 2));

                if (data.success) {
                    currentUser = data.data;
                    log('âœ… ç”¨æˆ·å·²ç™»å½•: ' + currentUser.username);
                    return true;
                } else {
                    log('âŒ Tokenæ— æ•ˆ');
                    return false;
                }
            } catch (error) {
                log('âŒ æ£€æŸ¥ç™»å½•å¤±è´¥: ' + error.message);
                return false;
            }
        }

        async function checkSubscription() {
            log('=== æ£€æŸ¥è®¢é˜…çŠ¶æ€ ===');
            const token = localStorage.getItem('token');
            
            if (!token) {
                log('âŒ éœ€è¦å…ˆç™»å½•');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/subscriptions/check?subscribableType=course&subscribableId=1`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                log('è®¢é˜…çŠ¶æ€å“åº”: ' + JSON.stringify(data, null, 2));

                if (data.success) {
                    isSubscribed = data.data.subscribed;
                    log(`è®¢é˜…çŠ¶æ€: ${isSubscribed ? 'âœ… å·²è®¢é˜…' : 'âŒ æœªè®¢é˜…'}`);
                } else {
                    log('âŒ æ£€æŸ¥è®¢é˜…å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ è®¢é˜…æ£€æŸ¥å‡ºé”™: ' + error.message);
            }
        }

        async function loadChapters() {
            log('=== åŠ è½½ç« èŠ‚åˆ—è¡¨ ===');
            const token = localStorage.getItem('token');

            try {
                const response = await fetch(`${API_BASE}/content/courses/1/chapters`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                log('ç« èŠ‚æ•°æ®å“åº”: ' + JSON.stringify(data, null, 2));

                if (data.success && data.data) {
                    chapters = data.data;
                    log(`âœ… åŠ è½½äº† ${chapters.length} ä¸ªç« èŠ‚`);
                    displayChapters();
                } else {
                    log('âŒ åŠ è½½ç« èŠ‚å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ ç« èŠ‚åŠ è½½å‡ºé”™: ' + error.message);
            }
        }

        function displayChapters() {
            const chaptersDiv = document.getElementById('chapters');
            let html = '<h3>ğŸ“š ç« èŠ‚åˆ—è¡¨</h3>';

            chapters.forEach(chapter => {
                const isFree = chapter.isFree;
                const canAccess = isFree || isSubscribed;
                
                html += `
                    <div class="chapter ${isFree ? 'free' : 'premium'}" onclick="accessChapter(${chapter.id})">
                        <strong>${chapter.title}</strong>
                        <span style="float: right;">
                            ${isFree ? 'ğŸ†“ å…è´¹' : 'ğŸ’ ä»˜è´¹'} 
                            ${canAccess ? 'âœ… å¯è®¿é—®' : 'ğŸ”’ éœ€è®¢é˜…'}
                        </span>
                        <br>
                        <small>${chapter.description}</small>
                    </div>
                `;
            });

            chaptersDiv.innerHTML = html;
        }

        function accessChapter(chapterId) {
            log(`=== å°è¯•è®¿é—®ç« èŠ‚ ${chapterId} ===`);
            
            const chapter = chapters.find(c => c.id === chapterId);
            if (!chapter) {
                log('âŒ ç« èŠ‚ä¸å­˜åœ¨');
                return;
            }

            const canAccess = chapter.isFree || isSubscribed;
            
            if (canAccess) {
                log('âœ… å¯ä»¥è®¿é—®ç« èŠ‚');
                const studyUrl = `study.html?courseId=1&chapterId=${chapterId}`;
                log(`è·³è½¬åˆ°: ${studyUrl}`);
                window.open(studyUrl, '_blank');
            } else {
                log('âŒ éœ€è¦è®¢é˜…æ‰èƒ½è®¿é—®æ­¤ç« èŠ‚');
            }
        }

        async function loginAsUser() {
            log('=== æ¨¡æ‹Ÿç™»å½• ===');
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        loginAccount: 'cygws123',
                        password: '123.00.aa',
                        loginType: 'password',
                        deviceType: 'web'
                    })
                });

                const data = await response.json();
                log('ç™»å½•å“åº”: ' + JSON.stringify(data, null, 2));

                if (data.code === 200 && data.data && data.data.token) {
                    localStorage.setItem('token', data.data.token);
                    log('âœ… ç™»å½•æˆåŠŸï¼Œtokenå·²ä¿å­˜');
                    await checkAuth();
                    await checkSubscription();
                } else {
                    log('âŒ ç™»å½•å¤±è´¥: ' + data.message);
                }
            } catch (error) {
                log('âŒ ç™»å½•é”™è¯¯: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.onload = async function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹è¯Šæ–­...');
            await checkAuth();
            await checkSubscription();
            await loadChapters();
        };
    </script>
</body>
</html>