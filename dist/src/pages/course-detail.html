<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËØæÁ®ãËØ¶ÊÉÖ - AI Master Class</title>
    <meta name="description" content="ÊéåÊè°AIÔºåÂÆö‰πâÊú™Êù• - ‰∏éÁ°ÖË∞∑È°∂Â∞ñ‰∏ìÂÆ∂‰∏ÄËµ∑Â≠¶‰π†">

    <!-- Â§ñÈÉ®ËµÑÊ∫ê - ‰ºòÂåñÂä†ËΩΩ -->
    <!-- ÁßªÈô§GoogleÂ≠ó‰ΩìÔºå‰ΩøÁî®Á≥ªÁªüÂ≠ó‰ΩìÊ†àÊèêÈ´òÂä†ËΩΩÈÄüÂ∫¶ -->
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet"> -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS - Â∑•ÂÖ∑Á±ªCSSÊ°ÜÊû∂ (‰ºòÂÖàÂä†ËΩΩ) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Âª∂ËøüÂä†ËΩΩÁöÑËµÑÊ∫ê -->
    <script>
        // Âª∂ËøüÂä†ËΩΩÈáçÂûãÂ∫ì‰ª•‰ºòÂåñÂàùÂßãÂä†ËΩΩÊÄßËÉΩ
        function loadLazyResources() {
            const scripts = [
                'https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js',
                'https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js',
                'https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js',
                'https://unpkg.com/three@0.128.0/examples/js/loaders/OBJLoader.js',
                'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.16/typed.umd.js',
                'https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js'
            ];

            const links = [
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css'
            ];

            // Âª∂ËøüÂä†ËΩΩËÑöÊú¨
            let scriptIndex = 0;
            function loadNextScript() {
                if (scriptIndex < scripts.length) {
                    const script = document.createElement('script');
                    script.src = scripts[scriptIndex];
                    script.async = true;
                    script.onload = () => setTimeout(loadNextScript, 50);
                    script.onerror = () => setTimeout(loadNextScript, 50);
                    document.head.appendChild(script);
                    scriptIndex++;
                }
            }

            // Âª∂ËøüÂä†ËΩΩÊ†∑ÂºèË°®
            links.forEach(href => {
                const link = document.createElement('link');
                link.rel = 'stylesheet';
                link.href = href;
                document.head.appendChild(link);
            });

            // ÂºÄÂßãÂä†ËΩΩËÑöÊú¨
            setTimeout(loadNextScript, 300);
        }

        // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂÜçÂä†ËΩΩÈáçÂûãËµÑÊ∫ê
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', loadLazyResources);
        } else {
            loadLazyResources();
        }
    </script>

    <!-- ‰øùÁïôÂøÖË¶ÅÁöÑÁ´ãÂç≥Âä†ËΩΩÁöÑËÑöÊú¨ -->
    <script src="../utils/loading.js"></script>
    <script src="../utils/notification.js"></script>
    <script src="../utils/ui-helpers.js"></script>

    <!-- UX Enhancement Scripts -->
    
    <script src="../utils/ux-utils.js"></script>
    <script src="../components/enhanced-search.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366F1;
            --primary-dark: #4F46E5;
            --secondary: #EC4899;
            --accent: #14B8A6;
            --gold: #F59E0B;
            --success: #10B981;
            --warning: #F59E0B;
            --danger: #EF4444;
            --info: #3B82F6;

            --dark: #0F172A;
            --darker: #020617;
            --light: #FFFFFF;
            --gray-50: #F8FAFC;
            --gray-100: #F1F5F9;
            --gray-200: #E2E8F0;
            --gray-300: #CBD5E1;
            --gray-400: #94A3B8;
            --gray-500: #64748B;
            --gray-600: #475569;
            --gray-700: #334155;
            --gray-800: #1E293B;
            --gray-900: #0F172A;
        }

        [data-theme="dark"] {
            --primary: #818CF8;
            --primary-dark: #6366F1;
            --secondary: #F472B6;
            --accent: #2DD4BF;
            --gold: #FCD34D;
            --success: #34D399;
            --warning: #FCD34D;
            --danger: #F87171;
            --info: #60A5FA;

            --dark: #F8FAFC;
            --darker: #F1F5F9;
            --light: #0F172A;
            --gray-50: #020617;
            --gray-100: #0F172A;
            --gray-200: #1E293B;
            --gray-300: #334155;
            --gray-400: #475569;
            --gray-500: #64748B;
            --gray-600: #94A3B8;
            --gray-700: #CBD5E1;
            --gray-800: #E2E8F0;
            --gray-900: #F1F5F9;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--light);
            color: var(--dark);
            overflow-x: hidden;
            min-height: 100vh;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* SVGÂõæÊ†áÊ†∑Âºè */
        .meta-icon svg {
            color: var(--primary);
            width: 20px;
            height: 20px;
        }
        
        .logo svg,
        .dropdown-item svg {
            color: var(--primary);
            vertical-align: middle;
        }

        /* È´òÁ´ØËÉåÊôØÊïàÊûú */
        .premium-bg {
            position: fixed;
            inset: 0;
            z-index: -2;
            background: linear-gradient(135deg, #667EEA 0%, #764BA2 100%);
            opacity: 0.03;
        }

        [data-theme="dark"] .premium-bg {
            opacity: 0.1;
        }

        /* Âä®ÊÄÅÂÖâÊïà */
        .glow-effect {
            position: fixed;
            width: 500px;
            height: 500px;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.15) 0%, transparent 70%);
            border-radius: 50%;
            filter: blur(80px);
            animation: float 20s infinite ease-in-out;
            pointer-events: none;
            z-index: -1;
        }

        .glow-effect:nth-child(2) {
            right: -200px;
            top: 60%;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.15) 0%, transparent 70%);
            animation-delay: -10s;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(100px, -100px) scale(1.1); }
            66% { transform: translate(-100px, 100px) scale(0.9); }
        }

        /* ÂØºËà™Ê†è - Áé∞‰ª£ÂåñËÆæËÆ° */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            padding: 1rem 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(99, 102, 241, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] .navbar {
            background: rgba(15, 23, 42, 0.8);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .navbar.scrolled {
            padding: 0.6rem 0;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
        }

        [data-theme="dark"] .navbar.scrolled {
            background: rgba(15, 23, 42, 0.95);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-brand {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.5px;
            text-decoration: none;
        }

        .nav-menu {
            display: flex;
            gap: 2.5rem;
            align-items: center;
        }

        .nav-link {
            color: var(--gray-600);
            text-decoration: none;
            font-weight: 500;
            font-size: 0.95rem;
            position: relative;
            padding: 0.5rem 0;
            transition: all 0.3s ease;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transition: width 0.3s ease;
        }

        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }

        /* ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ */
        .theme-toggle {
            background: var(--light);
            border: 2px solid var(--gray-300);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            border-color: var(--primary);
            transform: scale(1.05);
        }

        /* Áî®Êà∑ËèúÂçïÊ†∑Âºè - ‰∏édashboard‰∏ÄËá¥ */
        .user-menu-container {
            position: relative;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            background: var(--gray-100);
            border: 2px solid var(--gray-200);
            transition: all 0.3s;
        }

        .user-info:hover {
            background: var(--light);
            border-color: var(--primary);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
        }

        .user-info .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            overflow: hidden;
        }

        .user-info .user-avatar img {
            width: 100%;
            height: 100%;
            -o-object-fit: cover;
               object-fit: cover;
        }

        .user-name {
            color: var(--dark);
            font-weight: 500;
        }

        .dropdown-arrow {
            color: var(--gray-600);
            font-size: 0.75rem;
            transition: transform 0.3s;
        }

        .user-menu-container.active .dropdown-arrow {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 10001;
        }

        .dropdown-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .dropdown-item {
            padding: 0.75rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: #333;
            text-decoration: none;
            transition: background 0.2s;
        }

        .dropdown-item:hover {
            background: #f7fafc;
        }

        .dropdown-item:first-child {
            border-radius: 0.5rem 0.5rem 0 0;
        }

        .dropdown-item:last-child {
            border-radius: 0 0 0.5rem 0.5rem;
        }

        .dropdown-divider {
            height: 1px;
            background: #e2e8f0;
            margin: 0.25rem 0;
        }



        /* Èù¢ÂåÖÂ±ëÂØºËà™ */
        .breadcrumb {
            padding: 100px 0 2rem;
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.05) 0%,
            rgba(236, 72, 153, 0.05) 100%);
        }

        .breadcrumb-nav {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 2rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .breadcrumb-nav a {
            color: var(--primary);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        .breadcrumb-nav a:hover {
            color: var(--secondary);
        }

        /* ‰∏ªÂÆπÂô® */
        .course-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        /* ËØæÁ®ã‰ø°ÊÅØÁΩëÊ†º */
        .course-info {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 3rem;
            align-items: start;
        }

        /* ËØæÁ®ãÊ†áÈ¢òÂå∫ */
        .course-header-section {
            margin-bottom: 3rem;
        }

        .course-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 1rem;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            line-height: 1.2;
            letter-spacing: -0.02em;
        }

        .course-subtitle {
            font-size: 1.25rem;
            color: var(--gray-600);
            line-height: 1.6;
            margin-bottom: 2rem;
        }

        /* ËÆ¢ÈòÖÁä∂ÊÄÅ */
        .subscription-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .subscription-status.subscribed {
            background: linear-gradient(135deg,
            rgba(16, 185, 129, 0.1),
            rgba(52, 211, 153, 0.1));
            color: var(--success);
            border: 2px solid var(--success);
        }

        .subscription-status.not-subscribed {
            background: linear-gradient(135deg,
            rgba(245, 158, 11, 0.1),
            rgba(252, 211, 77, 0.1));
            color: var(--warning);
            border: 2px solid var(--warning);
        }

        /* ËØæÁ®ãÂÖÉ‰ø°ÊÅØ */
        .course-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin: 2rem 0;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.95rem;
            color: var(--gray-600);
        }

        .meta-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.1),
            rgba(236, 72, 153, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        /* ÁªüËÆ°Âç°Áâá */
        .course-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin: 3rem 0;
        }

        .stat-card {
            background: var(--light);
            border: 1px solid var(--gray-200);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .stat-card {
            background: var(--gray-800);
            border-color: var(--gray-700);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 60px rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
        }

        .stat-card:hover::before {
            transform: scaleX(1);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--gray-600);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ÂÜÖÂÆπÂç°Áâá */
        .content-card {
            background: var(--light);
            border: 1px solid var(--gray-200);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .content-card {
            background: var(--gray-800);
            border-color: var(--gray-700);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        .content-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--primary), var(--secondary), var(--accent));
        }

        .content-card h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .content-card h3::before {
            content: '';
            width: 4px;
            height: 28px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 2px;
        }

        /* Á´†ËäÇÂàóË°® */
        .chapters-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .load-more-btn {
            width: 100%;
            padding: 1rem;
            border: 2px dashed var(--gray-300);
            background: transparent;
            color: var(--gray-600);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.95rem;
            margin-top: 1rem;
        }

        .load-more-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: var(--primary);
            background-opacity: 0.05;
        }

        [data-theme="dark"] .load-more-btn {
            border-color: var(--gray-600);
            color: var(--gray-400);
        }

        [data-theme="dark"] .load-more-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }

        .chapter-item {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        [data-theme="dark"] .chapter-item {
            background: var(--gray-900);
            border-color: var(--gray-700);
        }

        .chapter-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, var(--primary), var(--secondary));
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .chapter-item:hover {
            transform: translateX(10px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.15);
            border-color: var(--primary);
        }

        .chapter-item:hover::before {
            transform: scaleY(1);
        }

        .chapter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .chapter-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--dark);
        }

        .chapter-badges {
            display: flex;
            gap: 0.5rem;
        }

        .chapter-badge {
            padding: 0.3rem 0.8rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-free {
            background: linear-gradient(135deg, var(--success), var(--accent));
            color: white;
        }

        .badge-premium {
            background: linear-gradient(135deg, var(--gold), var(--warning));
            color: white;
        }

        .badge-duration {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.1),
            rgba(236, 72, 153, 0.1));
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .chapter-description {
            color: var(--gray-600);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Áõ∏ÂÖ≥ËØæÁ®ãÊ†∑Âºè */
        .related-courses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .related-course-card {
            background: var(--light);
            border: 1px solid var(--gray-200);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .related-course-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            border-color: var(--primary);
        }

        .related-course-image {
            height: 140px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            position: relative;
        }

        .related-course-image img {
            width: 100%;
            height: 100%;
            -o-object-fit: cover;
               object-fit: cover;
        }

        .related-course-content {
            padding: 1rem;
        }

        .related-course-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 0.5rem;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .related-course-price {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .related-course-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--gray-500);
        }

        .related-course-difficulty {
            background: var(--gray-100);
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        /* ‰æßËæπÊ†èË¥≠‰π∞Âç°Áâá */
        .course-sidebar {
            position: relative; /* ‰øÆÊîπ‰∏∫relativeÔºåÈÅøÂÖçstickyÂÆö‰ΩçÈóÆÈ¢ò */
        }

        .purchase-card {
            background: var(--light);
            border: 1px solid var(--gray-200);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        [data-theme="dark"] .purchase-card {
            background: var(--gray-800);
            border-color: var(--gray-700);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .course-image {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            margin-bottom: 1.5rem;
            position: relative;
            overflow: hidden;
        }

        .course-image img {
            width: 100%;
            height: 100%;
            -o-object-fit: cover;
               object-fit: cover;
            border-radius: 16px;
        }

        .course-price {
            text-align: center;
            margin: 2rem 0;
        }

        .price-current {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .price-original {
            font-size: 1.2rem;
            color: var(--gray-500);
            text-decoration: line-through;
            margin-left: 0.5rem;
        }

        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            width: 100%;
            padding: 1rem 2rem;
            border-radius: 50px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-enroll {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            margin-bottom: 1rem;
        }

        .btn-enroll:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(99, 102, 241, 0.4);
        }

        .btn-secondary {
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.1),
            rgba(236, 72, 153, 0.1));
            transform: translateY(-2px);
        }

        /* ÁâπÊÄßÂàóË°® */
        .course-features {
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 1px solid var(--gray-200);
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            color: var(--gray-600);
        }

        .feature-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg,
            rgba(99, 102, 241, 0.1),
            rgba(236, 72, 153, 0.1));
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
        }

        /* Âä†ËΩΩÁä∂ÊÄÅ */
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            font-size: 1.2rem;
            color: var(--gray-600);
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-200);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ÈîôËØØÁä∂ÊÄÅ */
        .error {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--danger);
        }

        .error h3 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        /* ÈÄöÁü•Á≥ªÁªü */
        .notification {
            position: fixed;
            top: 100px;
            right: 2rem;
            padding: 1rem 2rem;
            background: var(--light);
            border: 1px solid var(--gray-200);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1001;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-color: var(--success);
            background: linear-gradient(135deg,
            rgba(16, 185, 129, 0.05),
            rgba(52, 211, 153, 0.05));
        }

        .notification.error {
            border-color: var(--danger);
            background: linear-gradient(135deg,
            rgba(239, 68, 68, 0.05),
            rgba(248, 113, 113, 0.05));
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 1200px) {
            .course-info {
                grid-template-columns: 1fr;
            }

            .course-sidebar {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .course-title {
                font-size: 2rem;
            }

            .course-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .course-meta {
                flex-direction: column;
                gap: 1rem;
            }
        }

        /* ÂÜÖÂÆπÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .content-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .content-modal-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
        }

        .content-modal-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            max-height: 90vh;
            background: var(--light);
            border-radius: 24px;
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            animation: modalSlideIn 0.3s ease-out;
        }

        [data-theme="dark"] .content-modal-container {
            background: var(--gray-800);
            box-shadow: 0 25px 100px rgba(0, 0, 0, 0.7);
        }

        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .content-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--gray-200);
            background: linear-gradient(135deg,
                rgba(99, 102, 241, 0.05),
                rgba(236, 72, 153, 0.05));
        }

        [data-theme="dark"] .content-modal-header {
            border-bottom-color: var(--gray-700);
        }

        .content-modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dark);
        }

        .content-modal-close {
            background: none;
            border: none;
            font-size: 2rem;
            color: var(--gray-500);
            cursor: pointer;
            padding: 0;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .content-modal-close:hover {
            background: var(--gray-100);
            color: var(--dark);
        }

        .content-modal-body {
            padding: 2rem;
            max-height: calc(90vh - 100px);
            overflow-y: auto;
        }

        .content-modal-body .loading {
            min-height: 200px;
        }

        #contentModalContent {
            line-height: 1.8;
            color: var(--dark);
        }

        #contentModalContent h1,
        #contentModalContent h2,
        #contentModalContent h3,
        #contentModalContent h4,
        #contentModalContent h5,
        #contentModalContent h6 {
            color: var(--dark);
            margin-top: 2rem;
            margin-bottom: 1rem;
        }

        #contentModalContent p {
            margin-bottom: 1rem;
            color: var(--gray-700);
        }

        #contentModalContent ul,
        #contentModalContent ol {
            margin-bottom: 1rem;
            padding-left: 2rem;
        }

        #contentModalContent li {
            margin-bottom: 0.5rem;
            color: var(--gray-700);
        }

        #contentModalContent pre {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 8px;
            padding: 1rem;
            overflow-x: auto;
            margin: 1rem 0;
        }

        [data-theme="dark"] #contentModalContent pre {
            background: var(--gray-900);
            border-color: var(--gray-700);
        }

        #contentModalContent code {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: 4px;
            padding: 0.2rem 0.4rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        [data-theme="dark"] #contentModalContent code {
            background: var(--gray-900);
            border-color: var(--gray-700);
        }

        /* ÊªöÂä®Êù°ÁæéÂåñ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--gray-100);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--gray-400);
            border-radius: 5px;
            -webkit-transition: background 0.3s ease;
            transition: background 0.3s ease;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--gray-600);
        }

        /* ËÆ¢ÈòÖÂØπËØùÊ°ÜÊ†∑Âºè */
        .subscription-dialog {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .subscription-dialog.show {
            opacity: 1;
            visibility: visible;
        }

        .subscription-dialog-content {
            background: var(--light);
            border-radius: 16px;
            max-width: 800px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            transform: scale(0.9) translateY(20px);
            transition: all 0.3s ease;
        }

        .subscription-dialog.show .subscription-dialog-content {
            transform: scale(1) translateY(0);
        }

        .subscription-dialog-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 24px;
        }

        .subscription-dialog-header h3 {
            font-size: 24px;
            font-weight: 600;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .subscription-dialog-header .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--gray-400);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .subscription-dialog-header .close-btn:hover {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        .subscription-dialog-body {
            padding: 0 24px 24px;
        }

        .dialog-subtitle {
            font-size: 16px;
            color: var(--gray-600);
            margin-bottom: 32px;
            text-align: center;
        }

        .subscription-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .subscription-card {
            position: relative;
            background: var(--light);
            border: 2px solid var(--gray-200);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .subscription-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gray-300);
            transition: all 0.3s ease;
        }

        .subscription-card.featured {
            border-color: var(--primary);
            transform: scale(1.02);
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.15);
        }

        .subscription-card.featured::before {
            background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        }

        .subscription-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.1);
        }

        .subscription-card.featured:hover {
            transform: scale(1.02) translateY(-4px);
        }

        .card-badge {
            position: absolute;
            top: 16px;
            right: 16px;
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 12px;
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 12px;
        }

        .card-badge.badge-featured {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
        }

        .subscription-card h4 {
            font-size: 20px;
            font-weight: 600;
            color: var(--gray-800);
            margin: 8px 0 16px 0;
        }

        .price-section {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 16px;
        }

        .original-price {
            font-size: 16px;
            color: var(--gray-400);
            text-decoration: line-through;
        }

        .price {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
        }

        .price-unit {
            font-size: 14px;
            color: var(--gray-500);
        }

        .discount-tag {
            display: inline-block;
            background: var(--danger);
            color: white;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .benefits-list {
            list-style: none;
            padding: 0;
            margin-bottom: 20px;
        }

        .benefits-list li {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 14px;
            color: var(--gray-600);
        }

        .benefits-list i {
            color: var(--success);
            font-size: 14px;
            flex-shrink: 0;
        }

        .benefits-list i.fa-crown {
            color: var(--gold);
        }

        .included-courses {
            margin-bottom: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--gray-200);
        }

        .included-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--gray-700);
            margin-bottom: 8px;
        }

        .course-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
        }

        .course-tag {
            background: var(--gray-100);
            color: var(--gray-600);
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .subscribe-btn {
            width: 100%;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px;
        }

        .btn-single {
            background: var(--gray-700);
            color: white;
        }

        .btn-single:hover {
            background: var(--gray-800);
        }

        .btn-package {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .btn-package:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .subscribe-btn:disabled {
            background: var(--gray-400);
            cursor: not-allowed;
            transform: none;
        }

        .secure-payment {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 16px;
            background: var(--gray-50);
            border-radius: 8px;
            font-size: 13px;
            color: var(--gray-600);
        }

        .secure-payment i {
            color: var(--success);
        }

        /* Âä†ËΩΩÁä∂ÊÄÅÊ†∑Âºè */
        .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .loading-spinner-container i {
            font-size: 24px;
            color: var(--primary);
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .subscription-options {
                grid-template-columns: 1fr;
            }
            
            .subscription-card.featured {
                transform: none;
            }
            
            .subscription-card.featured:hover {
                transform: translateY(-4px);
            }
        }

        /* ÂÆ¢ÊúçÂæÆ‰ø°Ê†∑Âºè */
        .customer-service {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 16px;
            text-align: center;
            color: white;
        }

        .customer-service-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .customer-service-content {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .wechat-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 16px;
            font-weight: 500;
        }

        .wechat-info i {
            font-size: 20px;
            color: #09bb07;
        }

        .contact-hint {
            font-size: 14px;
            opacity: 0.9;
            margin-top: 8px;
        }
    </style>
  <link rel="stylesheet" href="/assets/ux-enhancements-2fb285cd.css">
</head>
<body>
<!-- È´òÁ´ØËÉåÊôØÊïàÊûú -->
<div class="premium-bg"></div>
<div class="glow-effect"></div>
<div class="glow-effect"></div>

<!-- ÂØºËà™Ê†è -->
<nav class="navbar" id="navbar">
    <div class="nav-container">
        <div class="nav-brand">
            <a href="/home.html" class="logo"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><path d="M22 10v6M2 10l10-5 10 5-10 5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> AI Master Class</a>
        </div>

        <div class="nav-menu">
            <a href="/home.html" class="nav-link">È¶ñÈ°µ</a>
            <a href="courses.html" class="nav-link active">ËØæÁ®ã</a>
            <a href="dashboard.html" class="nav-link">Â≠¶‰π†‰∏≠ÂøÉ</a>
            <a href="profile.html" class="nav-link">‰∏™‰∫∫‰∏≠ÂøÉ</a>

            <!-- ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ -->
            <button class="theme-toggle" id="themeToggle" title="ÂàáÊç¢‰∏ªÈ¢ò">
                <span class="theme-icon">üåô</span>
            </button>
        </div>

        <!-- Áî®Êà∑ËèúÂçï - ‰∏édashboard‰∏ÄËá¥ -->
        <div class="user-menu-container">
            <div class="user-info" id="userInfoButton">
                <div class="user-avatar" id="userAvatar">U</div>
                <span class="user-name" id="userName">Âä†ËΩΩ‰∏≠...</span>
                <span class="dropdown-arrow">‚ñº</span>
            </div>
            <div class="dropdown-menu" id="userDropdown">
                <a href="profile.html" class="dropdown-item">
                    <span>üë§</span> ‰∏™‰∫∫ËµÑÊñô
                </a>
                <a href="dashboard.html" class="dropdown-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><path d="M18 20V10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 20V4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 20v-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> Â≠¶‰π†‰∏≠ÂøÉ
                </a>
                <a href="orders.html" class="dropdown-item">
                    <span>üì¶</span> ÊàëÁöÑËÆ¢Âçï
                </a>
                <a href="certificates.html" class="dropdown-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><path d="M22 10v6M2 10l10-5 10 5-10 5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg> ÊàëÁöÑËØÅ‰π¶
                </a>
                <a href="points-shop.html" class="dropdown-item">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 8px;"><polygon points="12,2 15.09,8.26 22,9.27 17,14.14 18.18,21.02 12,17.77 5.82,21.02 7,14.14 2,9.27 8.91,8.26" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="none"/></svg> ÁßØÂàÜÂïÜÂüé
                </a>
                <div class="dropdown-divider"></div>
                <a href="#" class="dropdown-item" id="logoutButton">
                    <span>üö™</span> ÈÄÄÂá∫ÁôªÂΩï
                </a>
            </div>
        </div>
    </div>
</nav>

<!-- Èù¢ÂåÖÂ±ëÂØºËà™ -->
<div class="breadcrumb">
    <nav class="breadcrumb-nav">
        <a href="/home.html">È¶ñÈ°µ</a>
        <span>/</span>
        <a href="courses.html">ËØæÁ®ã</a>
        <span>/</span>
        <span id="courseNavTitle">ËØæÁ®ãËØ¶ÊÉÖ</span>
    </nav>
</div>

<!-- ‰∏ªÂÜÖÂÆπ -->
<main class="course-container">
    <!-- Âä†ËΩΩÁä∂ÊÄÅ -->
    <div id="loadingState" class="loading">
        <div class="loading-spinner"></div>
        <div class="loading-text">Ê≠£Âú®Âä†ËΩΩËØæÁ®ã‰ø°ÊÅØ...</div>
        <div id="courseLoadingSkeleton"></div>
    </div>

    <!-- ÈîôËØØÁä∂ÊÄÅ -->
    <div id="errorState" class="error" style="display: none;">
        <h3>Âä†ËΩΩÂ§±Ë¥•</h3>
        <p>Êó†Ê≥ïËé∑ÂèñËØæÁ®ã‰ø°ÊÅØÔºåËØ∑Á®çÂêéÈáçËØï</p>
        <button id="reloadButton" class="btn btn-secondary" style="width: auto; padding: 0.8rem 2rem;">ÈáçÊñ∞Âä†ËΩΩ</button>
    </div>

    <!-- ËØæÁ®ãÂÜÖÂÆπ -->
    <div id="courseContent" style="display: none;">
        <div class="course-info">
            <!-- Â∑¶‰æß‰∏ªË¶ÅÂÜÖÂÆπ -->
            <div class="course-main">
                <!-- ËØæÁ®ãÊ†áÈ¢òÂå∫ -->
                <div class="course-header-section">
                    <h1 class="course-title" id="courseTitle">ËØæÁ®ãÊ†áÈ¢ò</h1>
                    <p class="course-subtitle" id="courseSubtitle">ËØæÁ®ãÂâØÊ†áÈ¢ò</p>

                    <div class="subscription-status" id="subscriptionStatus" style="display: none;">
                        <span class="status-icon" id="statusIcon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></span>
                        <span class="status-text" id="statusText">Â∑≤ËÆ¢ÈòÖ</span>
                    </div>
                </div>

                <!-- ËØæÁ®ãÂÖÉ‰ø°ÊÅØ -->
                <div class="course-meta">
                    <div class="meta-item">
                        <div class="meta-icon">üë®‚Äçüè´</div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">ËÆ≤Â∏à</div>
                            <div id="courseInstructor" style="font-weight: 600;">‰∏ì‰∏öËÆ≤Â∏à</div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">ÂàÜÁ±ª</div>
                            <div id="courseCategory" style="font-weight: 600;">AIËØæÁ®ã</div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/><polyline points="12,6 12,12 16,14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">Êó∂Èïø</div>
                            <div id="courseDuration" style="font-weight: 600;">10Â∞èÊó∂</div>
                        </div>
                    </div>
                    <div class="meta-item">
                        <div class="meta-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><polyline points="14,2 14,8 20,8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="16" y1="13" x2="8" y2="13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><line x1="16" y1="17" x2="8" y2="17" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                        <div>
                            <div style="font-size: 0.85rem; color: var(--gray-500);">ËØæÊó∂</div>
                            <div id="courseLessons" style="font-weight: 600;">20ËØæÊó∂</div>
                        </div>
                    </div>
                </div>

                <!-- ÁªüËÆ°‰ø°ÊÅØ -->
                <div class="course-stats">
                    <div class="stat-card">
                        <div class="stat-number" id="enrollmentCount">0</div>
                        <div class="stat-label">Â≠¶‰π†‰∫∫Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="courseRating">5.0</div>
                        <div class="stat-label">ËØæÁ®ãËØÑÂàÜ</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="viewCount">0</div>
                        <div class="stat-label">ÊµèËßàÊ¨°Êï∞</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="difficultyLevel">ÂÖ•Èó®</div>
                        <div class="stat-label">ÈöæÂ∫¶Á≠âÁ∫ß</div>
                    </div>
                </div>

                <!-- ËØæÁ®ã‰ªãÁªç -->
                <div class="content-card">
                    <h3>ËØæÁ®ã‰ªãÁªç</h3>
                    <div id="courseDescription" style="color: var(--gray-600); line-height: 1.8;">
                        ËØæÁ®ãËØ¶ÁªÜ‰ªãÁªçÂÜÖÂÆπ...
                    </div>
                </div>

                <!-- ËØæÁ®ãÁ´†ËäÇ -->
                <div class="content-card">
                    <h3>ËØæÁ®ãÁ´†ËäÇ</h3>
                    <div id="chaptersList" class="chapters-list">
                        <div id="initialChapters">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩÁ´†ËäÇ...</div>
                        </div>
                        <div id="lazyChapters" style="display: none;"></div>
                        <button id="loadMoreChapters" class="load-more-btn" style="display: none;">
                            <i class="fas fa-chevron-down"></i> Âä†ËΩΩÊõ¥Â§öÁ´†ËäÇ
                        </button>
                    </div>
                </div>

                <!-- Áõ∏ÂÖ≥ËØæÁ®ã -->
                <div class="content-card" id="relatedCoursesSection">
                    <h3>Áõ∏ÂÖ≥ËØæÁ®ãÊé®Ëçê</h3>
                    <div id="relatedCoursesList" class="related-courses-grid">
                        <div class="loading">Ê≠£Âú®Âä†ËΩΩÁõ∏ÂÖ≥ËØæÁ®ã...</div>
                    </div>
                </div>
            </div>

            <!-- Âè≥‰æßË¥≠‰π∞Âç°Áâá -->
            <div class="course-sidebar">
                <div class="purchase-card">
                    <div class="course-image" id="courseImage">
                        ü§ñ
                    </div>

                    <div class="course-price">
                        <span class="price-current" id="coursePrice">¬•299</span>
                        <span class="price-original" id="originalPrice" style="display: none;">¬•399</span>
                    </div>

                    <div class="course-actions">
                        <button class="btn btn-enroll" id="enrollBtn">Á´ãÂç≥Êä•Âêç</button>
                        <button class="btn btn-secondary" id="wishlistBtn">Âä†ÂÖ•Êî∂Ëóè</button>
                    </div>

                    <div class="course-features">
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-infinity"></i>
                            </div>
                            <span>Ê∞∏‰πÖËÆøÈóÆÊùÉÈôê</span>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <span>ÊîØÊåÅÁßªÂä®Á´ØÂ≠¶‰π†</span>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-certificate"></i>
                            </div>
                            <span>ÂÆåÊàêËØÅ‰π¶</span>
                        </div>
                        <div class="feature-item">
                            <div class="feature-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <span>Á§æÂå∫ËÆ®ËÆ∫ÊîØÊåÅ</span>
                        </div>
                    </div>
                    
                    <!-- ÂÆ¢ÊúçÂæÆ‰ø°‰ø°ÊÅØ -->
                    <div class="customer-service">
                        <div class="customer-service-title">
                            <i class="fas fa-headset"></i>
                            ‰∏ìÂ±ûÂÆ¢ÊúçÊúçÂä°
                        </div>
                        <div class="customer-service-content">
                            <div class="wechat-info">
                                <i class="fab fa-weixin"></i>
                                <span>ÂæÆ‰ø°: PonnyAll</span>
                            </div>
                        </div>
                        <div class="contact-hint">
                            Ê∑ªÂä†ÂÆ¢ÊúçÂæÆ‰ø°ÔºåËé∑Âæó1ÂØπ1Â≠¶‰π†ÊåáÂØºÂíåÁ≠îÁñëÊîØÊåÅ
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- ÈÄöÁü•Á≥ªÁªü -->
<div id="notification" class="notification">
    <span id="notificationMessage"></span>
</div>


<!-- Scripts -->
<script>
    // APIÈÖçÁΩÆ - ‰ΩøÁî®nginx‰ª£ÁêÜË∑ØÂæÑ
    const hostname = window.location.hostname;
    // ‰∏çÂÜçÁõ¥Êé•ËÆøÈóÆ8070Á´ØÂè£ÔºåËÄåÊòØ‰ΩøÁî®nginx‰ª£ÁêÜÁöÑ/apiË∑ØÂæÑ
    const API_BASE = '/api';  // nginx‰ª£ÁêÜÂà∞localhost:8070/api
    let currentCourse = null;
    let isSubscribed = false;

    // È°µÈù¢Âä†ËΩΩÂÆåÊàêÂêéÂàùÂßãÂåñ
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded, initializing...');
        
        // ÁªëÂÆöÊâÄÊúâ‰∫ã‰ª∂Â§ÑÁêÜÂô®
        bindEventHandlers();
        
        // Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØ
        loadUserInfo();
        
        // ÂàùÂßãÂåñ‰∏ªÈ¢ò
        initTheme();
        
        // Ê£ÄÊü•ËÆ§ËØÅ
        checkAuth();
        
        // Á°Æ‰øùAPIÈÖçÁΩÆÊ≠£Á°Æ
        console.log('API endpoint:', API_BASE);
        
        // Áõ¥Êé•Âä†ËΩΩËØæÁ®ãËØ¶ÊÉÖÔºå‰∏çÈúÄË¶ÅÂª∂Ëøü
        loadCourseDetail();
        
        // ÁõëÂê¨Êù•Ëá™blobÈ°µÈù¢ÁöÑÊ∂àÊÅØ
        window.addEventListener('message', function(event) {
            if (event.data.type === 'chapterLoaded') {
                console.log('Á´†ËäÇÂä†ËΩΩÂÆåÊàê:', event.data);
                showNotification(`Á´†ËäÇ"${event.data.title}"Â∑≤ÊâìÂºÄ`, 'success');
            }
        });
        
        // ÁõëÂê¨È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπ‰∫ã‰ª∂ÔºàÁî®‰∫é‰ªéÊîØ‰ªòÈ°µÈù¢ËøîÂõûÂêéÂà∑Êñ∞ËÆ¢ÈòÖÁä∂ÊÄÅÔºâ
        let lastCheckTime = Date.now();
        window.addEventListener('focus', function() {
            const now = Date.now();
            // Â¶ÇÊûúË∑ùÁ¶ª‰∏äÊ¨°Ê£ÄÊü•Ë∂ÖËøá5ÁßíÔºåÂàôÈáçÊñ∞Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅ
            if (now - lastCheckTime > 5000) {
                lastCheckTime = now;
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('id');
                if (courseId) {
                    console.log('È°µÈù¢Ëé∑ÂæóÁÑ¶ÁÇπÔºåÈáçÊñ∞Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅ');
                    checkSubscriptionStatus(courseId).then(() => {
                        console.log('ËÆ¢ÈòÖÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞');
                    }).catch(err => {
                        console.log('Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅÂ§±Ë¥•:', err);
                    });
                }
            }
        });
        
        // Ê£ÄÊü•ÊòØÂê¶‰ªéÊîØ‰ªòÈ°µÈù¢ËøîÂõû
        const lastPaymentSuccess = localStorage.getItem('lastPaymentSuccess');
        if (lastPaymentSuccess) {
            try {
                const paymentInfo = JSON.parse(lastPaymentSuccess);
                // Â¶ÇÊûúÊîØ‰ªòÊàêÂäüÊó∂Èó¥Âú®5ÂàÜÈíüÂÜÖÔºåÂà∑Êñ∞ËÆ¢ÈòÖÁä∂ÊÄÅ
                if (Date.now() - paymentInfo.timestamp < 300000) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const courseId = urlParams.get('id');
                    if (courseId) {
                        console.log('Ê£ÄÊµãÂà∞ÊúÄËøëÁöÑÊîØ‰ªòÊàêÂäüÔºåÂà∑Êñ∞ËÆ¢ÈòÖÁä∂ÊÄÅ');
                        setTimeout(() => {
                            checkSubscriptionStatus(courseId).then(() => {
                                console.log('ËÆ¢ÈòÖÁä∂ÊÄÅÂ∑≤Êõ¥Êñ∞');
                                // Ê∏ÖÈô§ÊîØ‰ªòÊàêÂäüÊ†áËÆ∞
                                localStorage.removeItem('lastPaymentSuccess');
                            });
                        }, 1000);
                    }
                }
            } catch (e) {
                console.error('Ëß£ÊûêÊîØ‰ªòÊàêÂäü‰ø°ÊÅØÂ§±Ë¥•:', e);
            }
        }
    });
    
    // ÁªëÂÆöÊâÄÊúâ‰∫ã‰ª∂Â§ÑÁêÜÂô®
    function bindEventHandlers() {
        // ‰∏ªÈ¢òÂàáÊç¢ÊåâÈíÆ
        const themeToggle = document.getElementById('themeToggle');
        if (themeToggle) {
            themeToggle.addEventListener('click', toggleTheme);
        }
        
        // Áî®Êà∑ËèúÂçïÊåâÈíÆ
        const userInfoButton = document.getElementById('userInfoButton');
        if (userInfoButton) {
            userInfoButton.addEventListener('click', function(event) {
                toggleUserMenu(event);
            });
        }
        
        // ÈÄÄÂá∫ÁôªÂΩïÊåâÈíÆ
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', function(event) {
                event.preventDefault();
                logout();
            });
        }
        
        // ÈáçÊñ∞Âä†ËΩΩÊåâÈíÆ
        const reloadButton = document.getElementById('reloadButton');
        if (reloadButton) {
            reloadButton.addEventListener('click', loadCourseDetail);
        }
        
        // Êä•ÂêçÊåâÈíÆ
        const enrollBtn = document.getElementById('enrollBtn');
        if (enrollBtn) {
            enrollBtn.addEventListener('click', function() {
                const action = enrollBtn.dataset.action;
                if (action === 'startLearning') {
                    startLearning();
                } else {
                    enrollCourse();
                }
            });
        }
        
        // Êî∂ËóèÊåâÈíÆ
        const wishlistBtn = document.getElementById('wishlistBtn');
        if (wishlistBtn) {
            wishlistBtn.addEventListener('click', addToWishlist);
        }
    }

    // ÂØºËà™Ê†èÊªöÂä®ÊïàÊûú
    window.addEventListener('scroll', () => {
        const navbar = document.getElementById('navbar');
        if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });

    // ‰∏ªÈ¢òÂàáÊç¢
    function toggleTheme() {
        const currentTheme = document.documentElement.getAttribute('data-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        document.documentElement.setAttribute('data-theme', newTheme);
        localStorage.setItem('theme', newTheme);
    }

    // ÂàùÂßãÂåñ‰∏ªÈ¢ò
    function initTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
    }

    // ÊòæÁ§∫ÈÄöÁü•
    // ÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØ
    function showPaymentInfo(paymentData, typeName) {
        // ÂÖ≥Èó≠ËÆ¢ÈòÖÂØπËØùÊ°Ü
        closeSubscriptionDialog();
        
        console.log('ÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØ:', paymentData); // Ë∞ÉËØïËæìÂá∫
        
        // Ëé∑ÂèñÊîØ‰ªò‰ø°ÊÅØ - ÂÖºÂÆπÂ§öÁßçÊï∞ÊçÆÁªìÊûÑ
        const orderNo = paymentData.orderNo || 
                       paymentData.subscription?.orderNo || 
                       paymentData.paymentInfo?.orderNo || 
                       'N/A';
                       
        const amount = paymentData.amount || 
                      paymentData.subscription?.amount || 
                      paymentData.paymentInfo?.amount || 
                      '0.00';
                      
        const qrCode = paymentData.qrCode || 
                      paymentData.paymentInfo?.qrCode || 
                      paymentData.paymentInfo?.qr_code;
        
        console.log('Ëß£ÊûêÂêéÁöÑËÆ¢Âçï‰ø°ÊÅØ:', { orderNo, amount, qrCode });
        
        // ÂàõÂª∫ÊîØ‰ªò‰ø°ÊÅØÂØπËØùÊ°Ü
        const paymentDialog = document.createElement('div');
        paymentDialog.className = 'subscription-dialog-overlay';
        paymentDialog.innerHTML = `
            <div class="subscription-dialog payment-dialog" style="max-width: 400px;">
                <div class="dialog-header">
                    <h3>ÂÆåÊàêÊîØ‰ªò - ${typeName}</h3>
                    <button class="close-btn" onclick="closePaymentDialog()">&times;</button>
                </div>
                <div class="dialog-content">
                    <div class="payment-info">
                        <div class="payment-method">
                            <i class="fab fa-alipay" style="color: #1677ff; font-size: 24px;"></i>
                            <span>ÊîØ‰ªòÂÆùÊâ´Á†ÅÊîØ‰ªò</span>
                        </div>
                        
                        ${qrCode ? `
                            <div class="qr-code-container" style="text-align: center; margin: 20px 0;">
                                <img src="${qrCode}" alt="ÊîØ‰ªò‰∫åÁª¥Á†Å" style="width: 200px; height: 200px;">
                                <p style="font-size: 12px; color: #888; margin-top: 10px;">
                                    ËÆ¢ÂçïÂè∑Ôºö${orderNo}
                                </p>
                            </div>
                        ` : `
                            <div class="qr-code-container" style="text-align: center; margin: 20px 0;">
                                <div class="qr-code-placeholder" style="width: 200px; height: 200px; border: 2px dashed #ddd; margin: 0 auto; display: flex; align-items: center; justify-content: center; font-size: 14px; color: #666;">
                                    <div>
                                        <i class="fas fa-qrcode" style="font-size: 48px; margin-bottom: 10px; display: block;"></i>
                                        ÊîØ‰ªò‰∫åÁª¥Á†ÅÁîüÊàê‰∏≠...
                                        <br><small>ËØ∑‰ΩøÁî®ÊîØ‰ªòÂÆùÊâ´‰∏ÄÊâ´</small>
                                    </div>
                                </div>
                                <p style="font-size: 12px; color: #888; margin-top: 10px;">
                                    ËÆ¢ÂçïÂè∑Ôºö${orderNo}
                                </p>
                            </div>
                        `}
                        
                        <div class="payment-amount">
                            <span>ÊîØ‰ªòÈáëÈ¢ùÔºö</span>
                            <span class="amount" style="color: #e74c3c; font-weight: bold; font-size: 18px;">
                                ¬•${amount}
                            </span>
                        </div>
                        
                        <div class="payment-tips" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                            <p>‚Ä¢ ËØ∑Âú®30ÂàÜÈíüÂÜÖÂÆåÊàêÊîØ‰ªò</p>
                            <p>‚Ä¢ ÊîØ‰ªòÊàêÂäüÂêéÁ≥ªÁªü‰ºöËá™Âä®ÊøÄÊ¥ªÊÇ®ÁöÑËÆ¢ÈòÖ</p>
                            <p>‚Ä¢ Â¶ÇÊúâÈóÆÈ¢òËØ∑ËÅîÁ≥ªÂÆ¢ÊúçÔºöPonnyAll</p>
                        </div>
                    </div>
                </div>
                <div class="dialog-actions">
                    <button class="btn-secondary" onclick="closePaymentDialog()">ÂèñÊ∂àÊîØ‰ªò</button>
                    <button class="btn-primary" onclick="checkPaymentStatus('${orderNo}')">
                        <i class="fas fa-sync-alt"></i> ÊàëÂ∑≤ÂÆåÊàêÊîØ‰ªò
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(paymentDialog);
        
        // Âè™ÊúâÂΩìËÆ¢ÂçïÂè∑ÊúâÊïàÊó∂ÊâçÂêØÂä®ÊîØ‰ªòÁä∂ÊÄÅÊ£ÄÊü•
        if (orderNo && orderNo !== 'N/A') {
            startPaymentStatusCheck(orderNo);
        }
    }
    
    // ÂÖ≥Èó≠ÊîØ‰ªòÂØπËØùÊ°Ü
    function closePaymentDialog() {
        const dialog = document.querySelector('.subscription-dialog-overlay');
        if (dialog) {
            dialog.remove();
        }
        // Ê∏ÖÁêÜÁä∂ÊÄÅÊ£ÄÊü•ÂÆöÊó∂Âô®
        if (window.paymentCheckInterval) {
            clearInterval(window.paymentCheckInterval);
            window.paymentCheckInterval = null;
        }
    }
    
    // ÂêØÂä®ÊîØ‰ªòÁä∂ÊÄÅÊ£ÄÊü•
    function startPaymentStatusCheck(orderNo) {
        if (!orderNo || orderNo === 'N/A' || window.paymentCheckInterval) {
            console.log('Ë∑≥ËøáÊîØ‰ªòÁä∂ÊÄÅÊ£ÄÊü•:', { orderNo, hasInterval: !!window.paymentCheckInterval });
            return;
        }
        
        console.log('ÂºÄÂßãÊ£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅÔºåËÆ¢ÂçïÂè∑:', orderNo);
        
        let checkCount = 0;
        const maxChecks = 60; // ÊúÄÂ§öÊ£ÄÊü•30ÂàÜÈíüÔºà30ÁßíÈó¥ÈöîÔºâ
        
        window.paymentCheckInterval = setInterval(async () => {
            checkCount++;

            try {
                const data = await window.API.order.getOrderStatus(orderNo);

                if (data.code === 200 && data.data && data.data.status === 'paid') {
                    clearInterval(window.paymentCheckInterval);
                    window.paymentCheckInterval = null;
                    closePaymentDialog();
                    showNotification('ÊîØ‰ªòÊàêÂäüÔºÅÊ≠£Âú®ÊøÄÊ¥ªËÆ¢ÈòÖ...', 'success');
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    return;
                }
            } catch (error) {
                console.log('Ê£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅÂ§±Ë¥•:', error);
            }

            // Ë∂ÖËøáÊúÄÂ§ßÊ£ÄÊü•Ê¨°Êï∞ÂêéÂÅúÊ≠¢
            if (checkCount >= maxChecks) {
                clearInterval(window.paymentCheckInterval);
                window.paymentCheckInterval = null;
                showNotification('ÊîØ‰ªòÁä∂ÊÄÅÊ£ÄÊü•Ë∂ÖÊó∂ÔºåÂ¶ÇÂ∑≤ÊîØ‰ªòËØ∑ÊâãÂä®Âà∑Êñ∞È°µÈù¢', 'warning');
            }
        }, 30000); // 30ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
    }
    
    // ÊâãÂä®Ê£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅ
    async function checkPaymentStatus(orderNo) {
        if (!orderNo || orderNo === 'N/A') {
            showNotification('ËÆ¢Âçï‰ø°ÊÅØÊó†ÊïàÔºåËØ∑ÈáçÊñ∞ÂèëËµ∑ÊîØ‰ªò', 'error');
            return;
        }
        
        try {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ê£ÄÊü•‰∏≠...';
            btn.disabled = true;

            const data = await window.API.order.getOrderStatus(orderNo);

            if (data.code === 200 && data.data && data.data.status === 'paid') {
                closePaymentDialog();
                showNotification('ÊîØ‰ªòÊàêÂäüÔºÅÊ≠£Âú®ÊøÄÊ¥ªËÆ¢ÈòÖ...', 'success');
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            } else {
                showNotification('ÊîØ‰ªòÂ∞öÊú™ÂÆåÊàêÔºåËØ∑ÂÆåÊàêÊîØ‰ªòÂêéÂÜçËØï', 'warning');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            console.error('Ê£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅÂ§±Ë¥•:', error);
            showNotification('Ê£ÄÊü•ÊîØ‰ªòÁä∂ÊÄÅÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            if (event.target) {
                event.target.innerHTML = '<i class="fas fa-sync-alt"></i> ÊàëÂ∑≤ÂÆåÊàêÊîØ‰ªò';
                event.target.disabled = false;
            }
        }
    }

    function showNotification(message, type = 'success') {
        if (window.uiHelpers) {
            switch (type) {
                case 'error':
                    window.uiHelpers.showError(message);
                    break;
                case 'warning':
                    window.uiHelpers.showWarning(message);
                    break;
                case 'info':
                    window.uiHelpers.showInfo(message);
                    break;
                default:
                    window.uiHelpers.showSuccess(message);
            }
            return;
        }

        const notification = document.getElementById('notification');
        const messageEl = document.getElementById('notificationMessage');

        if (!notification || !messageEl) {
            return;
        }

        messageEl.textContent = message;
        notification.className = `notification ${type} show`;

        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    // Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
    function checkAuth() {
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');

        console.log('checkAuth Ë∞ÉÁî®:', { token: !!token, user: !!user });

        if (token && user) {
            try {
                const userData = JSON.parse(user);
                console.log('Áî®Êà∑Êï∞ÊçÆ:', userData);
                
                // ËÆæÁΩÆÂÖ®Â±ÄÁî®Êà∑ÂèòÈáèÔºåÁî®‰∫éÂÖ∂‰ªñÂäüËÉΩÊ£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
                window.currentUser = userData;
                
                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');

                if (userNameEl) {
                    const displayName = userData.username || userData.name || 'Áî®Êà∑';
                    userNameEl.textContent = displayName;
                    console.log('ËÆæÁΩÆÁî®Êà∑Âêç:', displayName);
                }
                if (userAvatarEl) {
                    const initials = (userData.username || userData.name || 'U').charAt(0).toUpperCase();
                    userAvatarEl.textContent = initials;
                    console.log('ËÆæÁΩÆÂ§¥ÂÉè:', initials);
                }
            } catch (error) {
                console.error('Error parsing user data:', error);
                window.currentUser = null;
            }
        } else {
            console.log('Áî®Êà∑Êú™ÁôªÂΩï');
            window.currentUser = null;
            
            // ÊòæÁ§∫Êú™ÁôªÂΩïÁä∂ÊÄÅ
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            
            if (userNameEl) {
                userNameEl.textContent = 'Êú™ÁôªÂΩï';
            }
            if (userAvatarEl) {
                userAvatarEl.textContent = 'U';
            }
        }
    }

    // Ê∑ªÂä†ËØ∑Ê±ÇË∂ÖÊó∂Â§ÑÁêÜ
    function fetchWithTimeout(url, options = {}, timeout = 5000) {
        return Promise.race([
            fetch(url, options),
            new Promise((_, reject) => 
                setTimeout(() => reject(new Error('ËØ∑Ê±ÇË∂ÖÊó∂')), timeout)
            )
        ]);
    }

    // Âä†ËΩΩËØæÁ®ãËØ¶ÊÉÖ
    async function loadCourseDetail() {
        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id') || 1; // ÈªòËÆ§ÊòæÁ§∫ËØæÁ®ãID 1

        try {
            showLoading();
            console.log('Âä†ËΩΩËØæÁ®ãËØ¶ÊÉÖ, ID:', courseId);
            console.log('APIÁ´ØÁÇπ:', `${API_BASE}/courses/${courseId}`);

            // Ëé∑ÂèñËØæÁ®ãËØ¶ÊÉÖÔºàËÆæÁΩÆ5ÁßíË∂ÖÊó∂Ôºâ
            const response = await fetchWithTimeout(`${API_BASE}/courses/${courseId}`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`,
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            }, 5000).catch(error => {
                console.error('ÁΩëÁªúËØ∑Ê±ÇÈîôËØØ:', error);
                throw new Error('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËÆæÁΩÆ');
            });

            if (!response) {
                throw new Error('Êó†Ê≥ïËøûÊé•Âà∞ÊúçÂä°Âô®');
            }

            console.log('ÂìçÂ∫îÁä∂ÊÄÅ:', response.status, response.statusText);

            if (!response.ok) {
                if (response.status === 404) {
                    throw new Error('ËØæÁ®ã‰∏çÂ≠òÂú®');
                } else if (response.status === 401) {
                    throw new Error('ËØ∑ÂÖàÁôªÂΩï');
                } else if (response.status === 500) {
                    throw new Error('ÊúçÂä°Âô®ÈîôËØØ');
                } else {
                    throw new Error(`Ëé∑ÂèñËØæÁ®ãÂ§±Ë¥•: ${response.status}`);
                }
            }

            const data = await response.json();

            if (data.success && data.data) {
                // Êñ∞ÁöÑAPIÂìçÂ∫îÊ†ºÂºèÂåÖÂê´course„ÄÅchapters„ÄÅaccessÁ≠â
                const responseData = data.data;
                currentCourse = responseData.course || responseData; // ÂÖºÂÆπÊñ∞ÊóßÊ†ºÂºè
                
                // Â≠òÂÇ®Á´†ËäÇÂíåÊùÉÈôê‰ø°ÊÅØ
                window.courseChapters = responseData.chapters || [];
                window.courseAccess = responseData.access || {};
                
                displayCourse(currentCourse);
                
                // Â¶ÇÊûúAPIÂ∑≤ÁªèËøîÂõûÁ´†ËäÇÔºåÁõ¥Êé•ÊòæÁ§∫ÔºåÂê¶ÂàôÂçïÁã¨Âä†ËΩΩ
                if (window.courseChapters && window.courseChapters.length > 0) {
                    displayChapters(window.courseChapters);
                } else {
                    await loadChapters(courseId);
                }
                
                // Âπ∂Ë°åÂä†ËΩΩÁõ∏ÂÖ≥ËØæÁ®ãÂíåËÆ¢ÈòÖÁä∂ÊÄÅ‰ª•ÊèêÈ´òÊÄßËÉΩ
                const loadPromises = [];
                
                // Â¶ÇÊûúÈúÄË¶ÅÂä†ËΩΩÁõ∏ÂÖ≥ËØæÁ®ã
                if (currentCourse.categoryId) {
                    loadPromises.push(
                        loadRelatedCourses(courseId, currentCourse.categoryId)
                            .catch(err => console.log('Âä†ËΩΩÁõ∏ÂÖ≥ËØæÁ®ãÂ§±Ë¥•:', err))
                    );
                }
                
                // Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅÔºà‰∏çÈòªÂ°ûÈ°µÈù¢ÊòæÁ§∫Ôºâ
                loadPromises.push(
                    checkSubscriptionStatus(courseId)
                        .catch(err => console.log('Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅÂ§±Ë¥•:', err))
                );
                
                // ÊòæÁ§∫ÂÜÖÂÆπÔºà‰∏çÁ≠âÂæÖÂÖ∂‰ªñËØ∑Ê±ÇÔºâ
                showContent();
                
                // Âú®ÂêéÂè∞Âπ∂Ë°åÊâßË°åÂÖ∂‰ªñËØ∑Ê±Ç
                Promise.all(loadPromises).then(() => {
                    console.log('ÊâÄÊúâÈôÑÂä†‰ø°ÊÅØÂä†ËΩΩÂÆåÊàê');
                });
            } else {
                throw new Error(data.message || 'APIËøîÂõûÊï∞ÊçÆÊ†ºÂºè‰∏çÊ≠£Á°Æ');
            }
        } catch (error) {
            console.error('Âä†ËΩΩËØæÁ®ãÂ§±Ë¥•:', error);

            if (window.uiHelpers) {
                window.uiHelpers.handleApiError(error, 'Âä†ËΩΩËØæÁ®ãËØ¶ÊÉÖÂ§±Ë¥•');
            }

            // ÊòæÁ§∫Êõ¥ËØ¶ÁªÜÁöÑÈîôËØØ‰ø°ÊÅØ
            if (error.message && error.message.includes('ÁΩëÁªú')) {
                showError('ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂπ∂Âà∑Êñ∞È°µÈù¢');
            } else if (error.message && error.message.includes('ÁôªÂΩï')) {
                showError('ËØ∑ÂÖàÁôªÂΩïÂÜçÊü•ÁúãËØæÁ®ãËØ¶ÊÉÖ');
            } else {
                showError(error.message || 'Âä†ËΩΩËØæÁ®ãÂ§±Ë¥•');
            }
        }
    }

    // ÊòæÁ§∫ËØæÁ®ã‰ø°ÊÅØ
    function displayCourse(course) {
        document.title = `${course.title} - AI Master Class`;

        document.getElementById('courseNavTitle').textContent = course.title;
        document.getElementById('courseTitle').textContent = course.title;
        document.getElementById('courseSubtitle').textContent = course.subtitle || course.description;
        document.getElementById('courseDescription').textContent = course.description;

        document.getElementById('courseInstructor').textContent = course.instructor || '‰∏ì‰∏öËÆ≤Â∏àÂõ¢Èòü';
        document.getElementById('courseCategory').textContent = course.categoryName || getCategoryName(course.categoryId);
        document.getElementById('courseDuration').textContent = `${course.durationHours || 10} Â∞èÊó∂`;
        document.getElementById('courseLessons').textContent = `${course.lessonCount || 20} ËØæÊó∂`;

        document.getElementById('enrollmentCount').textContent = course.enrollmentCount || 0;
        document.getElementById('courseRating').textContent = course.rating || 5.0;
        document.getElementById('viewCount').textContent = course.viewCount || 0;
        document.getElementById('difficultyLevel').textContent = getDifficultyText(course.difficulty);

        if (course.isFree) {
            document.getElementById('coursePrice').textContent = 'ÂÖçË¥π';
            document.getElementById('originalPrice').style.display = 'none';
        } else {
            // Ê∑ªÂä†ÂÆâÂÖ®Ê£ÄÊü•ÔºåÁ°Æ‰øùpriceÂ≠òÂú®‰∏îÊòØÊï∞Â≠ó
            const price = parseFloat(course.price) || 0;
            document.getElementById('coursePrice').textContent = `¬•${price.toFixed(2)}`;
            
            if (course.originalPrice && course.originalPrice > price) {
                const originalPrice = parseFloat(course.originalPrice) || 0;
                document.getElementById('originalPrice').textContent = `¬•${originalPrice.toFixed(2)}`;
                document.getElementById('originalPrice').style.display = 'inline';
            } else {
                document.getElementById('originalPrice').style.display = 'none';
            }
        }

        const imageEl = document.getElementById('courseImage');
        if (course.coverImage) {
            imageEl.innerHTML = `<img class="lazy-image" data-src="${course.coverImage}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='400'%3E%3Crect fill='%23f0f0f0' width='600' height='400'/%3E%3C/svg%3E" alt="${course.title}">`;

            // Initialize lazy loading for this image
            if (window.UXUtils && window.UXUtils.LazyLoader) {
                const img = imageEl.querySelector('img.lazy-image');
                if (img) {
                    const loader = new window.UXUtils.LazyLoader();
                    loader.observe([img]);
                }
            }
        }
    }

    // Ëé∑ÂèñÂàÜÁ±ªÂêçÁß∞
    function getCategoryName(categoryId) {
        const categories = {
            1: 'ÂâçÁ´ØÂºÄÂèë',
            2: 'ÂêéÁ´ØÂºÄÂèë',
            3: 'ÁßªÂä®ÂºÄÂèë',
            4: 'Êï∞ÊçÆÂ∫ì',
            5: '‰∫∫Â∑•Êô∫ËÉΩ',
            6: '‰∫ëËÆ°ÁÆó'
        };
        return categories[categoryId] || 'AIËØæÁ®ã';
    }

    // Ëé∑ÂèñÈöæÂ∫¶ÊñáÊú¨
    function getDifficultyText(difficulty) {
        const levels = {
            'beginner': 'ÂÖ•Èó®',
            'intermediate': 'ËøõÈò∂',
            'advanced': 'È´òÁ∫ß',
            'expert': '‰∏ìÂÆ∂'
        };
        return levels[difficulty] || 'ÂÖ•Èó®';
    }

    // Âä†ËΩΩÁ´†ËäÇÂàóË°®
    async function loadChapters(courseId) {
        const initialContainer = document.getElementById('initialChapters');

        if (window.uiHelpers && initialContainer) {
            window.uiHelpers.showSkeleton(initialContainer, { type: 'list', count: 4 });
        } else if (initialContainer) {
            initialContainer.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÁ´†ËäÇ...</div>';
        }

        try {
            const response = await fetch(`${API_BASE}/content/courses/${courseId}/chapters`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch chapters');
            }

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                displayChapters(data.data);
            } else {
                displayNoChapters();
            }
        } catch (error) {
            console.error('Error loading chapters:', error);
            if (window.uiHelpers) {
                window.uiHelpers.handleApiError(error, 'Âä†ËΩΩËØæÁ®ãÁ´†ËäÇÂ§±Ë¥•');
            }
            displayNoChapters();
        } finally {
            if (window.uiHelpers && initialContainer) {
                window.uiHelpers.hideSkeleton(initialContainer);
            }
        }
    }

    // ÂàùÂßãÊòæÁ§∫Êï∞Èáè
    const INITIAL_CHAPTERS_DISPLAY = 3;
    let allChapters = [];
    let displayedChapters = 0;

    // ÊòæÁ§∫Á´†ËäÇ
    function displayChapters(chapters) {
        allChapters = chapters;
        displayedChapters = 0;

        const initialContainer = document.getElementById('initialChapters');
        const lazyContainer = document.getElementById('lazyChapters');
        const loadMoreBtn = document.getElementById('loadMoreChapters');

        if (!initialContainer || !lazyContainer || !loadMoreBtn) {
            return;
        }

        if (window.uiHelpers) {
            window.uiHelpers.hideSkeleton(initialContainer);
        }

        // Ê∏ÖÁ©∫‰πãÂâçÁöÑÂÜÖÂÆπ
        initialContainer.innerHTML = '';
        lazyContainer.innerHTML = '';
        lazyContainer.style.display = 'none';

        if (chapters.length === 0) {
            showNoChaptersMessage();
            return;
        }

        // ÊòæÁ§∫ÂàùÂßãÁ´†ËäÇ
        const initialDisplayCount = Math.min(INITIAL_CHAPTERS_DISPLAY, chapters.length);
        displayChapterBatch(0, initialDisplayCount);
        displayedChapters = initialDisplayCount;  // ËÆæÁΩÆÂ∑≤ÊòæÁ§∫ÁöÑÁ´†ËäÇÊï∞Èáè

        // Â¶ÇÊûúÁ´†ËäÇÊï∞ÈáèÂ§ß‰∫éÂàùÂßãÊòæÁ§∫Êï∞ÈáèÔºåÊòæÁ§∫Âä†ËΩΩÊõ¥Â§öÊåâÈíÆ
        if (chapters.length > INITIAL_CHAPTERS_DISPLAY) {
            const remaining = chapters.length - displayedChapters;
            loadMoreBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Âä†ËΩΩÊõ¥Â§öÁ´†ËäÇ (ËøòÊúâ ${remaining} Á´†)`;
            loadMoreBtn.style.display = 'block';
            loadMoreBtn.onclick = loadMoreChapters;
        } else {
            loadMoreBtn.style.display = 'none';
        }
    }

    // ÊòæÁ§∫ÊåáÂÆöËåÉÂõ¥ÁöÑÁ´†ËäÇ
    function displayChapterBatch(startIndex, endIndex) {
        const isInitialBatch = startIndex === 0;
        const targetContainer = isInitialBatch ?
            document.getElementById('initialChapters') :
            document.getElementById('lazyChapters');

        let chaptersHTML = '';

        for (let index = startIndex; index < endIndex; index++) {
            const chapter = allChapters[index];
            if (!chapter) continue;

            // Ê£ÄÊü•Á´†ËäÇËÆøÈóÆÊùÉÈôê
            const isFree = chapter.is_free || chapter.isFree;
            let canAccess = false;

            if (isFree) {
                canAccess = true;
            } else {
                canAccess = chapter.canAccess !== undefined ? chapter.canAccess : false;
            }

            const isLocked = !canAccess;
            const accessReason = chapter.accessReason || '';

            // ÊûÑÂª∫Á´†ËäÇÂæΩÁ´†
            let badgesHTML = '';
            if (isFree) {
                badgesHTML += '<span class="chapter-badge badge-free">ÂÖçË¥πËØïÁúã</span>';
            } else if (canAccess) {
                badgesHTML += '<span class="chapter-badge badge-unlocked">Â∑≤Ëß£ÈîÅ</span>';
            } else {
                badgesHTML += '<span class="chapter-badge badge-locked">üîí ÈúÄËÆ¢ÈòÖ</span>';
            }
            badgesHTML += `<span class="chapter-badge badge-duration">${chapter.duration_minutes || chapter.durationMinutes || 30}ÂàÜÈíü</span>`;

            // ÁîüÊàêÁ´†ËäÇHTML
            chaptersHTML += `
                <div class="chapter-item ${isLocked ? 'chapter-locked' : 'chapter-unlocked'}"
                     data-chapter-id="${chapter.id}" data-can-access="${canAccess ? 'true' : 'false'}">
                    <div class="chapter-header">
                        <div class="chapter-number">Á¨¨${index + 1}Á´†</div>
                        <div class="chapter-content">
                            <div class="chapter-title">${chapter.title}</div>
                            <div class="chapter-badges">
                                ${badgesHTML}
                            </div>
                        </div>
                    </div>
                    <div class="chapter-description">${chapter.description || 'Êú¨Á´†ËäÇÂ∞ÜÊ∑±ÂÖ•ËÆ≤Ëß£Áõ∏ÂÖ≥Áü•ËØÜÁÇπ'}</div>
                    ${!canAccess && accessReason === 'ÈúÄË¶ÅËÆ¢ÈòÖ' ?
                        '<div class="chapter-lock-hint">ËÆ¢ÈòÖËØæÁ®ãÂêéÂç≥ÂèØÂ≠¶‰π†Êú¨Á´†ËäÇ</div>' : ''}
                </div>
            `;
        }

        if (isInitialBatch) {
            targetContainer.innerHTML = chaptersHTML;
        } else {
            targetContainer.innerHTML += chaptersHTML;
            targetContainer.style.display = 'block';
        }

        displayedChapters = endIndex;

        // ÁªëÂÆöÊñ∞Ê∑ªÂä†Á´†ËäÇÁöÑÁÇπÂáª‰∫ã‰ª∂
        bindChapterEvents(targetContainer);
    }

    // ÁªëÂÆöÁ´†ËäÇÁÇπÂáª‰∫ã‰ª∂
    function bindChapterEvents(container) {
        const chapterItems = container.querySelectorAll('.chapter-item:not([data-event-bound])');
        chapterItems.forEach(item => {
            item.setAttribute('data-event-bound', 'true');
            item.addEventListener('click', function() {
                const chapterId = this.dataset.chapterId;
                const canAccess = this.dataset.canAccess === 'true';
                if (canAccess) {
                    window.goToChapter(chapterId);
                } else {
                    window.showSubscribePrompt();
                }
            });
        });
    }

    // Âä†ËΩΩÊõ¥Â§öÁ´†ËäÇ
    function loadMoreChapters() {
        const loadMoreBtn = document.getElementById('loadMoreChapters');
        const originalText = loadMoreBtn.innerHTML;

        // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
        loadMoreBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Âä†ËΩΩ‰∏≠...';
        loadMoreBtn.disabled = true;

        // Ê®°ÊãüÂä†ËΩΩÂª∂ËøüÔºåÊèê‰æõÊõ¥Â•ΩÁöÑÁî®Êà∑‰ΩìÈ™å
        setTimeout(() => {
            const remainingChapters = allChapters.length - displayedChapters;
            const nextBatchSize = Math.min(3, remainingChapters);
            const nextEndIndex = displayedChapters + nextBatchSize;

            // ÊòæÁ§∫‰∏ã‰∏ÄÊâπÁ´†ËäÇ
            displayChapterBatch(displayedChapters, nextEndIndex);

            // Êõ¥Êñ∞Â∑≤ÊòæÁ§∫ÁöÑÁ´†ËäÇÊï∞Èáè
            displayedChapters = nextEndIndex;

            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            loadMoreBtn.innerHTML = originalText;
            loadMoreBtn.disabled = false;

            // Êõ¥Êñ∞ÊåâÈíÆÊñáÊú¨ÔºåÊòæÁ§∫Ââ©‰ΩôÁ´†ËäÇÊï∞
            const remaining = allChapters.length - displayedChapters;
            if (remaining > 0) {
                loadMoreBtn.innerHTML = `<i class="fas fa-chevron-down"></i> Âä†ËΩΩÊõ¥Â§öÁ´†ËäÇ (ËøòÊúâ ${remaining} Á´†)`;
                loadMoreBtn.style.display = 'block';
            } else {
                // ÊâÄÊúâÁ´†ËäÇÈÉΩÂ∑≤Âä†ËΩΩÔºåÊòæÁ§∫‰∏çÂêåÁöÑÊñáÊú¨
                loadMoreBtn.innerHTML = '<i class="fas fa-check-circle"></i> Â∑≤Âä†ËΩΩÂÖ®ÈÉ®Á´†ËäÇ';
                loadMoreBtn.disabled = true;
                loadMoreBtn.style.opacity = '0.7';
                // ‰øùÊåÅÊåâÈíÆÂèØËßÅÔºå‰ΩÜÁ¶ÅÁî®Áä∂ÊÄÅ
                loadMoreBtn.style.display = 'block';
            }
        }, 500);
    }
    
    // Ëé∑ÂèñËØæÁ®ãID‰ªéURL
    function getCourseIdFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('id') || 1;
    }
    
    // ÊòæÁ§∫ËÆ¢ÈòÖÊèêÁ§∫
    function showSubscribePrompt() {
        // Áõ¥Êé•Ê£ÄÊü•localStorage‰∏≠ÁöÑtokenÔºåÊõ¥ÂèØÈù†
        const token = localStorage.getItem('token');
        const user = localStorage.getItem('user');
        
        console.log('ËÆ¢ÈòÖÊ£ÄÊü• - TokenÂ≠òÂú®:', !!token, 'UserÂ≠òÂú®:', !!user);
        
        if (!token || !user) {
            // Êú™ÁôªÂΩïÔºåÊèêÁ§∫ÁôªÂΩï
            if (confirm('ËØ∑ÂÖàÁôªÂΩïÂêéÂÜçËÆ¢ÈòÖËØæÁ®ã')) {
                window.location.href = '/src/pages/login.html?redirect=' + encodeURIComponent(window.location.href);
            }
        } else {
            // Â∑≤ÁôªÂΩïÔºåÊòæÁ§∫ËÆ¢ÈòÖÂØπËØùÊ°Ü
            console.log('Áî®Êà∑Â∑≤ÁôªÂΩïÔºåÊòæÁ§∫ËÆ¢ÈòÖÂØπËØùÊ°Ü');
            showSubscriptionDialog();
        }
    }
    
    // ÊòæÁ§∫ËÆ¢ÈòÖÂØπËØùÊ°Ü
    function showSubscriptionDialog() {
        const courseId = getCourseIdFromUrl();
        
        // ÂÖàÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅÁöÑÂØπËØùÊ°Ü
        showLoadingSubscriptionDialog();
        
        // ÂºÇÊ≠•Ëé∑Âèñ‰ª∑Ê†º‰ø°ÊÅØ
        fetchSubscriptionPrices(courseId);
    }
    
    // ÊòæÁ§∫Âä†ËΩΩ‰∏≠ÁöÑËÆ¢ÈòÖÂØπËØùÊ°Ü
    function showLoadingSubscriptionDialog() {
        const dialogHTML = `
            <div id="subscriptionDialog" class="subscription-dialog">
                <div class="subscription-dialog-content">
                    <div class="subscription-dialog-header">
                        <h3><i class="fas fa-star"></i> ÈÄâÊã©ËÆ¢ÈòÖÊñπÊ°à</h3>
                        <button class="close-btn" onclick="closeSubscriptionDialog()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="subscription-dialog-body">
                        <p class="dialog-subtitle">Ê≠£Âú®Ëé∑Âèñ‰ª∑Ê†º‰ø°ÊÅØ...</p>
                        <div class="loading-spinner-container">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', dialogHTML);
        
        setTimeout(() => {
            const dialog = document.getElementById('subscriptionDialog');
            if (dialog) {
                dialog.classList.add('show');
            }
        }, 10);
    }
    
    // Ëé∑ÂèñËÆ¢ÈòÖ‰ª∑Ê†º‰ø°ÊÅØ
    async function fetchSubscriptionPrices(courseId) {
        try {
            // ‰ªéÂ∑≤Âä†ËΩΩÁöÑËØæÁ®ãÊï∞ÊçÆ‰∏≠Ëé∑ÂèñÂΩìÂâçËØæÁ®ã‰ª∑Ê†º
            let coursePrice = { price: 99, originalPrice: null };
            
            if (currentCourse) {
                coursePrice = {
                    price: currentCourse.price || 99,
                    originalPrice: currentCourse.originalPrice || null
                };
                console.log('‰ΩøÁî®ÂΩìÂâçËØæÁ®ã‰ª∑Ê†º:', coursePrice);
            } else {
                console.log('ÂΩìÂâçËØæÁ®ãÊï∞ÊçÆÊú™Âä†ËΩΩÔºå‰ΩøÁî®ÈªòËÆ§‰ª∑Ê†º');
            }
            
            // Ëé∑ÂèñËØæÁ®ãÂåÖ‰ø°ÊÅØ - ‰ΩøÁî®Â§öÁßçÊñπÂºèÂ∞ùËØïËé∑Âèñ
            let packagePrice = await fetchPackagePrice(courseId);
            
            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè‰æõËÆ¢ÈòÖÊó∂‰ΩøÁî®
            window.fetchedPackageInfo = packagePrice;
            
            // Êõ¥Êñ∞ÂØπËØùÊ°ÜÂÜÖÂÆπ
            updateSubscriptionDialog(coursePrice, packagePrice);
            
        } catch (error) {
            console.error('Ëé∑Âèñ‰ª∑Ê†º‰ø°ÊÅØÊó∂ÂèëÁîüÈîôËØØ:', error);
            // ‰ΩøÁî®ÈªòËÆ§‰ª∑Ê†º
            const coursePrice = { 
                price: currentCourse?.price || 99, 
                originalPrice: currentCourse?.originalPrice || null 
            };
            const packagePrice = getDefaultPackagePrice();
            
            // ‰øùÂ≠òÂà∞ÂÖ®Â±ÄÂèòÈáè‰æõËÆ¢ÈòÖÊó∂‰ΩøÁî®
            window.fetchedPackageInfo = packagePrice;
            
            updateSubscriptionDialog(coursePrice, packagePrice);
        }
    }
    
    // Ëé∑ÂèñËØæÁ®ãÂåÖ‰ª∑Ê†º‰ø°ÊÅØ
    async function fetchPackagePrice(courseId) {
        // Â∞ùËØïÂ§öÁßçÊñπÂºèËé∑ÂèñËØæÁ®ãÂåÖ‰ø°ÊÅØ
        const attemptMethods = [
            // ÊñπÊ≥ï1: Êü•ËØ¢ËØæÁ®ãÊâÄÂ±ûÁöÑËØæÁ®ãÂåÖ
            async () => {
                const response = await fetch(`${API_BASE}/courses/${courseId}/package`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        return parsePackageData(data.data);
                    }
                }
                throw new Error('Package API not available');
            },
            
            // ÊñπÊ≥ï2: Êü•ËØ¢ÊâÄÊúâËØæÁ®ãÂåÖÔºåÊâæÂà∞ÂåÖÂê´ÂΩìÂâçËØæÁ®ãÁöÑÂåÖ
            async () => {
                const response = await fetch(`${API_BASE}/packages`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.data) {
                        // Êü•ÊâæÂåÖÂê´ÂΩìÂâçËØæÁ®ãÁöÑÂåÖ
                        const packages = Array.isArray(data.data) ? data.data : [];
                        const coursePackage = packages.find(pkg => 
                            pkg.courseIds && pkg.courseIds.includes(parseInt(courseId))
                        );
                        if (coursePackage) {
                            return parsePackageData(coursePackage);
                        }
                    }
                }
                throw new Error('Packages API not available');
            },
            
            // ÊñπÊ≥ï3: Êü•ËØ¢ËØæÁ®ãÂàÜÁ±ª‰∏ãÁöÑËØæÁ®ãÂåÖ
            async () => {
                if (currentCourse && currentCourse.categoryId) {
                    const response = await fetch(`${API_BASE}/categories/${currentCourse.categoryId}/packages`, {
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data && data.data.length > 0) {
                            return parsePackageData(data.data[0]); // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÂåÖ
                        }
                    }
                }
                throw new Error('Category packages API not available');
            }
        ];
        
        // ‰æùÊ¨°Â∞ùËØïÂêÑÁßçÊñπÊ≥ï
        for (let i = 0; i < attemptMethods.length; i++) {
            try {
                console.log(`Â∞ùËØïËé∑ÂèñËØæÁ®ãÂåÖ‰ø°ÊÅØ - ÊñπÊ≥ï${i + 1}`);
                const result = await attemptMethods[i]();
                console.log(`ÊñπÊ≥ï${i + 1}ÊàêÂäüËé∑ÂèñËØæÁ®ãÂåÖ‰ø°ÊÅØ:`, result);
                return result;
            } catch (error) {
                console.log(`ÊñπÊ≥ï${i + 1}Â§±Ë¥•:`, error.message);
                continue;
            }
        }
        
        // ÊâÄÊúâÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåÁîüÊàêÂü∫‰∫éÂΩìÂâçËØæÁ®ãÁöÑÊô∫ËÉΩÈªòËÆ§ÂåÖ
        console.log('ÊâÄÊúâAPIÊñπÊ≥ïÈÉΩÂ§±Ë¥•ÔºåÁîüÊàêÊô∫ËÉΩÈªòËÆ§ËØæÁ®ãÂåÖ');
        return generateSmartDefaultPackage();
    }
    
    // Ëß£ÊûêËØæÁ®ãÂåÖÊï∞ÊçÆ
    function parsePackageData(packageInfo) {
        return {
            price: packageInfo.price || packageInfo.currentPrice || 499,
            originalPrice: packageInfo.originalPrice || packageInfo.listPrice || 999,
            courses: packageInfo.courseList || packageInfo.courses || packageInfo.courseNames || [],
            name: packageInfo.name || packageInfo.title || 'AIÂ§ßÂ∏àÁè≠ÂÖ®Â•óËØæÁ®ã'
        };
    }
    
    // ÁîüÊàêÂü∫‰∫éÂΩìÂâçËØæÁ®ãÁöÑÊô∫ËÉΩÈªòËÆ§ÂåÖ
    function generateSmartDefaultPackage() {
        const basePrice = currentCourse?.price || 99;
        const packagePrice = Math.max(399, basePrice * 4); // Ëá≥Â∞ë399ÔºåÊàñÂΩìÂâçËØæÁ®ã‰ª∑Ê†ºÁöÑ4ÂÄç
        const originalPrice = Math.round(packagePrice * 2.2); // Á∫¶5.5Êäò
        
        // Âü∫‰∫éÂΩìÂâçËØæÁ®ãÁîüÊàêÁõ∏ÂÖ≥ËØæÁ®ãÂàóË°®
        const currentTitle = currentCourse?.title || 'ÂΩìÂâçËØæÁ®ã';
        const relatedCourses = [
            currentTitle,
            'PythonÂü∫Á°ÄÂÖ•Èó®',
            'Êú∫Âô®Â≠¶‰π†Ê†∏ÂøÉÁÆóÊ≥ï',
            'Ê∑±Â∫¶Â≠¶‰π†‰∏éÁ•ûÁªèÁΩëÁªú',
            'ËÆ°ÁÆóÊú∫ËßÜËßâÂÆûÊàò',
            'Ëá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ',
            'Âº∫ÂåñÂ≠¶‰π†ÁÆóÊ≥ï',
            'TensorFlowÂÆûÊàòÈ°πÁõÆ',
            'PyTorchÊ∑±Â∫¶Â≠¶‰π†',
            'AIÈ°πÁõÆÁªºÂêàÂÆûÊàò',
            'Êï∞ÊçÆÁßëÂ≠¶‰∏éÂàÜÊûê'
        ];
        
        // ÂéªÈáçÂπ∂ÈôêÂà∂Êï∞Èáè
        const uniqueCourses = [...new Set(relatedCourses)].slice(0, 10);
        
        return {
            price: packagePrice,
            originalPrice: originalPrice,
            courses: uniqueCourses,
            name: 'AIÂ§ßÂ∏àÁè≠ÂÖ®Â•óËØæÁ®ã'
        };
    }
    
    // Ëé∑ÂèñÈªòËÆ§ËØæÁ®ãÂåÖ‰ª∑Ê†º - ÁÆÄÂåñÁâàÊú¨
    function getDefaultPackagePrice() {
        return generateSmartDefaultPackage();
    }
    
    // Êõ¥Êñ∞ËÆ¢ÈòÖÂØπËØùÊ°ÜÂÜÖÂÆπ
    function updateSubscriptionDialog(coursePrice, packagePrice) {
        const dialog = document.getElementById('subscriptionDialog');
        if (!dialog) return;
        
        const coursePriceHtml = coursePrice.originalPrice 
            ? `<span class="original-price">¬•${coursePrice.originalPrice}</span><span class="price">¬•${coursePrice.price}</span>`
            : `<span class="price">¬•${coursePrice.price}</span>`;
        
        const packagePriceHtml = packagePrice.originalPrice 
            ? `<span class="original-price">¬•${packagePrice.originalPrice}</span><span class="price">¬•${packagePrice.price}</span>`
            : `<span class="price">¬•${packagePrice.price}</span>`;
        
        const discountTag = (packagePrice.originalPrice && packagePrice.originalPrice > packagePrice.price) 
            ? `<div class="discount-tag">ÈôêÊó∂${Math.round((1 - packagePrice.price/packagePrice.originalPrice) * 10)}Êäò</div>`
            : '';
        
        const courseTags = (packagePrice.courses && packagePrice.courses.length > 0)
            ? packagePrice.courses.map(course => `<span class="course-tag">${course}</span>`).join('')
            : '<span class="course-tag">PythonÂü∫Á°Ä</span><span class="course-tag">Êú∫Âô®Â≠¶‰π†</span><span class="course-tag">Ê∑±Â∫¶Â≠¶‰π†</span><span class="course-tag">ËÆ°ÁÆóÊú∫ËßÜËßâ</span><span class="course-tag">Ëá™ÁÑ∂ËØ≠Ë®ÄÂ§ÑÁêÜ</span><span class="course-tag">Âº∫ÂåñÂ≠¶‰π†</span><span class="course-tag">Êõ¥Â§ö...</span>';
        
        const contentHTML = `
            <div class="subscription-dialog-header">
                <h3><i class="fas fa-star"></i> ÈÄâÊã©ËÆ¢ÈòÖÊñπÊ°à</h3>
                <button class="close-btn" onclick="closeSubscriptionDialog()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="subscription-dialog-body">
                <p class="dialog-subtitle">ÈÄâÊã©ÊúÄÈÄÇÂêàÊÇ®ÁöÑÂ≠¶‰π†ÊñπÊ°à</p>
                
                <div class="subscription-options">
                    <!-- ÂçïËØæÁ®ãËÆ¢ÈòÖÂç°Áâá -->
                    <div class="subscription-card">
                        <div class="card-badge">ÂçïËØæÁ®ã</div>
                        <h4>ÂΩìÂâçËØæÁ®ã</h4>
                        <div class="price-section">
                            ${coursePriceHtml}
                            <span class="price-unit">/ËØæÁ®ã</span>
                        </div>
                        <ul class="benefits-list">
                            <li><i class="fas fa-check"></i> Ëß£ÈîÅÂΩìÂâçËØæÁ®ãÂÖ®ÈÉ®Á´†ËäÇ</li>
                            <li><i class="fas fa-check"></i> Ê∞∏‰πÖÂ≠¶‰π†ÊùÉÈôê</li>
                            <li><i class="fas fa-check"></i> ËØæÁ®ãËµÑÊñô‰∏ãËΩΩ</li>
                            <li><i class="fas fa-check"></i> Á§æÂå∫ËÆ®ËÆ∫ÊîØÊåÅ</li>
                        </ul>
                        <button class="subscribe-btn btn-single" onclick="subscribeSingleCourse()">
                            <i class="fas fa-shopping-cart"></i>
                            ËÆ¢ÈòÖÊú¨ËØæÁ®ã
                        </button>
                    </div>
                    
                    <!-- ËØæÁ®ãÂåÖËÆ¢ÈòÖÂç°Áâá -->
                    <div class="subscription-card featured">
                        <div class="card-badge badge-featured">ËØæÁ®ãÂåÖ¬∑Êé®Ëçê</div>
                        <h4>AIÂ§ßÂ∏àÁè≠ÂÖ®Â•óËØæÁ®ã</h4>
                        <div class="price-section">
                            ${packagePriceHtml}
                            <span class="price-unit">/ÂÖ®Â•ó</span>
                        </div>
                        ${discountTag}
                        <ul class="benefits-list">
                            <li><i class="fas fa-crown"></i> <strong>Ëß£ÈîÅÂÖ®ÈÉ®ËØæÁ®ã</strong></li>
                            <li><i class="fas fa-check"></i> ÂåÖÂê´Êú¨ËØæÁ®ãÂú®ÂÜÖÁöÑÊâÄÊúâÂÜÖÂÆπ</li>
                            <li><i class="fas fa-check"></i> Êñ∞ËØæÁ®ãÂÖçË¥πÂ≠¶‰π†</li>
                            <li><i class="fas fa-check"></i> 1ÂØπ1‰∏ìÂ±ûËæÖÂØº</li>
                            <li><i class="fas fa-check"></i> ‰ºòÂÖàÊäÄÊúØÊîØÊåÅ</li>
                            <li><i class="fas fa-check"></i> ‰∏ìÂ±ûÂ≠¶‰π†Áæ§ÁªÑ</li>
                        </ul>
                        <div class="included-courses">
                            <p class="included-title">ÂåÖÂê´ËØæÁ®ãÔºö</p>
                            <div class="course-tags">
                                ${courseTags}
                            </div>
                        </div>
                        <button class="subscribe-btn btn-package" onclick="subscribePackage()">
                            <i class="fas fa-rocket"></i>
                            ËÆ¢ÈòÖËØæÁ®ãÂåÖÔºàË∂ÖÂÄºÔºâ
                        </button>
                    </div>
                </div>
                
                <div class="secure-payment">
                    <i class="fas fa-shield-alt"></i>
                    <span>ÂÆâÂÖ®ÊîØ‰ªò‰øùÈöú</span>
                </div>
            </div>
        `;
        
        dialog.querySelector('.subscription-dialog-content').innerHTML = contentHTML;
    }
    
    // ÂÖ≥Èó≠ËÆ¢ÈòÖÂØπËØùÊ°Ü
    window.closeSubscriptionDialog = function() {
        const dialog = document.getElementById('subscriptionDialog');
        if (dialog) {
            dialog.classList.remove('show');
            setTimeout(() => {
                dialog.remove();
            }, 300);
        }
    }
    
    // ËÆ¢ÈòÖÂçï‰∏™ËØæÁ®ã
    window.subscribeSingleCourse = async function() {
        const courseId = getCourseIdFromUrl();
        
        // ‰∏ç‰º†ÈÄí‰ª∑Ê†ºÔºåËÆ©ÊîØ‰ªòÈ°µÈù¢Ëá™Â∑±Ëé∑ÂèñÁúüÂÆû‰ª∑Ê†º
        console.log('Ë∑≥ËΩ¨Âà∞ÊîØ‰ªòÈ°µÈù¢ÔºåËØæÁ®ãID:', courseId);
        
        // Áõ¥Êé•Ë∑≥ËΩ¨Âà∞ÊîØ‰ªòÈ°µÈù¢ÔºåÊîØ‰ªòÈ°µÈù¢‰ºö‰ªéAPIËé∑ÂèñÁúüÂÆû‰ª∑Ê†º
        window.location.href = `payment.html?courseId=${courseId}&type=course`;
    }
    
    // ËÆ¢ÈòÖËØæÁ®ãÂåÖ
    window.subscribePackage = async function() {
        const courseId = getCourseIdFromUrl();
        
        // ‰º†ÈÄíÂéüÂßãËØæÁ®ãIDÂíåËØæÁ®ãÂåÖ‰ø°ÊÅØ
        // courseIdÊòØÁî®Êà∑Ê≠£Âú®Êü•ÁúãÁöÑËØæÁ®ãÔºåbundleId=1ÊòØËØæÁ®ãÂåÖID
        // ‰∏ç‰º†ÈÄí‰ª∑Ê†ºÔºåËÆ©ÊîØ‰ªòÈ°µÈù¢‰ªéAPIËé∑ÂèñÁúüÂÆû‰ª∑Ê†º
        window.location.href = `payment.html?courseId=${courseId}&bundleId=1&type=bundle`;
    }
    
    // Â§ÑÁêÜËÆ¢ÈòÖ - Â∑≤Â∫üÂºÉÔºåÁé∞Âú®Áõ¥Êé•Ë∑≥ËΩ¨Âà∞payment.htmlÈ°µÈù¢
    /*
    async function processSubscription(courseId, subscriptionType, typeName) {
        if (!courseId) {
            showNotification('ËØæÁ®ãIDËé∑ÂèñÂ§±Ë¥•', 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            if (!token) {
                showNotification('ËØ∑ÂÖàÁôªÂΩï', 'error');
                setTimeout(() => {
                    window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.pathname + window.location.search)}`;
                }, 1500);
                return;
            }

            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ËÆ¢ÈòÖ‰∏≠...';
            btn.disabled = true;
            
            // ÂáÜÂ§áÂèÇÊï∞ - Â∞±ÂÉèÁ´ãÂç≥Êä•Âêç‰∏ÄÊ†∑ÁÆÄÂçï
            const formData = new FormData();
            
            if (subscriptionType === 'SINGLE') {
                // ËÆ¢ÈòÖÂçï‰∏™ËØæÁ®ã
                formData.append('subscribableType', 'course');
                formData.append('subscribableId', courseId);
            } else if (subscriptionType === 'PACKAGE') {
                // ËÆ¢ÈòÖËØæÁ®ãÂåÖ - Âõ∫ÂÆö‰ΩøÁî®ËØæÁ®ãÂåÖID‰∏∫1
                formData.append('subscribableType', 'bundle');
                formData.append('subscribableId', '1');
            }
            formData.append('paymentMethod', 'alipay');
            
            const response = await fetch(`${API_BASE}/subscriptions/create`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            });

            const data = await response.json();
            console.log('ËÆ¢ÈòÖAPIÂìçÂ∫î:', data); // Ë∞ÉËØïËæìÂá∫
            
            if (response.ok && data.code === 200) {
                if (!data.data) {
                    console.error('APIËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØÔºåÁº∫Â∞ëdataÂ≠óÊÆµ');
                    showNotification('ÊúçÂä°Âô®ËøîÂõûÊï∞ÊçÆÊ†ºÂºèÈîôËØØ', 'error');
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    return;
                }
                
                const resultData = data.data;
                console.log('Ëß£ÊûêÂêéÁöÑresultData:', resultData);
                
                // Ê£ÄÊü•ÊòØÂê¶ÈúÄË¶ÅÊîØ‰ªò
                if (resultData.needPayment) {
                    // ÈúÄË¶ÅÊîØ‰ªòÔºåÊòæÁ§∫ÊîØ‰ªò‰ø°ÊÅØ
                    const paymentData = {
                        subscription: resultData.subscription,
                        paymentInfo: resultData.paymentInfo,
                        orderNo: resultData.subscription?.orderNo,
                        amount: resultData.subscription?.amount,
                        qrCode: resultData.qrCode,
                        paymentUrl: resultData.paymentUrl
                    };
                    console.log('Â§ÑÁêÜÂêéÁöÑÊîØ‰ªòÊï∞ÊçÆ:', paymentData);
                    showPaymentInfo(paymentData, typeName);
                } else {
                    // Áõ¥Êé•ËÆ¢ÈòÖÊàêÂäüÔºàÂÖçË¥πËØæÁ®ãÔºâ
                    showNotification(`${typeName}ËÆ¢ÈòÖÊàêÂäüÔºÅÊ≠£Âú®Âà∑Êñ∞È°µÈù¢...`, 'success');
                    closeSubscriptionDialog();
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }
                
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.innerHTML = originalText;
                btn.disabled = false;
            } else {
                showNotification(data.message || `${typeName}ËÆ¢ÈòÖÂ§±Ë¥•ÔºåËØ∑ÈáçËØï`, 'error');
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        } catch (error) {
            console.error('ËÆ¢ÈòÖÂ§±Ë¥•:', error);
            showNotification('ËÆ¢ÈòÖÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•', 'error');
            // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
            if (event.target) {
                event.target.disabled = false;
                event.target.innerHTML = event.target.innerHTML.replace('ËÆ¢ÈòÖ‰∏≠...', typeName === 'ËØæÁ®ãÂåÖ' ? 'ËÆ¢ÈòÖËØæÁ®ãÂåÖÔºàË∂ÖÂÄºÔºâ' : 'ËÆ¢ÈòÖÊú¨ËØæÁ®ã');
            }
        }
    }
    */
    
    // Á´ãÂç≥ËÆ¢ÈòÖ - ÂÖºÂÆπÊóßÁöÑÂáΩÊï∞Ë∞ÉÁî®
    window.subscribeNow = function() {
        showSubscriptionDialog();
    }

    // ÊòæÁ§∫Êó†Á´†ËäÇÊ∂àÊÅØ
    function displayNoChapters() {
        const initialContainer = document.getElementById('initialChapters');
        const lazyContainer = document.getElementById('lazyChapters');
        const loadMoreBtn = document.getElementById('loadMoreChapters');

        if (!initialContainer || !lazyContainer || !loadMoreBtn) {
            return;
        }

        if (window.uiHelpers) {
            window.uiHelpers.hideSkeleton(initialContainer);
        }

        initialContainer.innerHTML = `
            <div class="no-chapters-message" style="text-align: center; padding: 3rem 2rem; color: var(--gray-500);">
                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <h3 style="color: var(--gray-600); margin-bottom: 1rem; font-size: 1.2rem;">ÊöÇÊó†Á´†ËäÇÂÜÖÂÆπ</h3>
                <p style="line-height: 1.6; color: var(--gray-500);">
                    ËØ•ËØæÁ®ãÊöÇÊó†ÂèØÁî®Á´†ËäÇÔºåËØ∑ËÅîÁ≥ªÂÆ¢Êúç‰∫ÜËß£ËØ¶ÊÉÖ„ÄÇ
                </p>
                <button id="reloadChaptersBtn" data-course-id="${new URLSearchParams(window.location.search).get('id') || 1}"
                        style="margin-top: 1.5rem; padding: 0.8rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer;">
                    ÈáçÊñ∞Âä†ËΩΩÁ´†ËäÇ
                </button>
            </div>
        `;

        lazyContainer.style.display = 'none';
        loadMoreBtn.style.display = 'none';

        // ÁªëÂÆöÈáçÊñ∞Âä†ËΩΩÁ´†ËäÇÊåâÈíÆ‰∫ã‰ª∂
        const reloadChaptersBtn = initialContainer.querySelector('#reloadChaptersBtn');
        if (reloadChaptersBtn) {
            reloadChaptersBtn.addEventListener('click', function() {
                const courseId = this.dataset.courseId;
                loadChapters(courseId);
            });
        }
    }

    // ÊòæÁ§∫Êó†Á´†ËäÇÊ∂àÊÅØ - ÂÖºÂÆπÊÄßÂáΩÊï∞
    function showNoChaptersMessage() {
        displayNoChapters();
    }

    // Âä†ËΩΩÁõ∏ÂÖ≥ËØæÁ®ã
    async function loadRelatedCourses(currentCourseId, categoryId) {
        try {
            const relatedList = document.getElementById('relatedCoursesList');
            if (!relatedList) return;

            // ÈÄöËøáÂàÜÁ±ªËé∑ÂèñÁõ∏ÂÖ≥ËØæÁ®ã
            let apiUrl = `${API_BASE}/courses`;
            const params = new URLSearchParams({
                page: 1,
                size: 6  // ÊúÄÂ§öÊòæÁ§∫6‰∏™Áõ∏ÂÖ≥ËØæÁ®ã
            });

            // Â¶ÇÊûúÊúâÂàÜÁ±ªIDÔºåÊåâÂàÜÁ±ªÁ≠õÈÄâ
            if (categoryId) {
                params.append('categoryId', categoryId);
            }

            const response = await fetch(`${apiUrl}?${params}`);
            
            if (!response.ok) {
                throw new Error('Failed to fetch related courses');
            }

            const data = await response.json();
            
            if (data.success && data.data && data.data.length > 0) {
                // ËøáÊª§ÊéâÂΩìÂâçËØæÁ®ã
                const relatedCourses = data.data.filter(course => course.id != currentCourseId).slice(0, 4);
                
                if (relatedCourses.length > 0) {
                    displayRelatedCourses(relatedCourses);
                } else {
                    hideRelatedCoursesSection();
                }
            } else {
                // Â¶ÇÊûúÊ≤°ÊúâÂêåÂàÜÁ±ªÁöÑËØæÁ®ãÔºåËé∑ÂèñÂÖ∂‰ªñËØæÁ®ã
                await loadGeneralRelatedCourses(currentCourseId);
            }
        } catch (error) {
            console.error('Error loading related courses:', error);
            await loadGeneralRelatedCourses(currentCourseId);
        }
    }

    // Âä†ËΩΩÈÄöÁî®Áõ∏ÂÖ≥ËØæÁ®ãÔºàÂΩìÊ≤°ÊúâÂêåÂàÜÁ±ªËØæÁ®ãÊó∂Ôºâ
    async function loadGeneralRelatedCourses(currentCourseId) {
        try {
            const response = await fetch(`${API_BASE}/courses?page=1&size=6`);
            
            if (response.ok) {
                const data = await response.json();
                
                if (data.success && data.data && data.data.length > 0) {
                    const relatedCourses = data.data.filter(course => course.id != currentCourseId).slice(0, 4);
                    
                    if (relatedCourses.length > 0) {
                        displayRelatedCourses(relatedCourses);
                    } else {
                        hideRelatedCoursesSection();
                    }
                } else {
                    hideRelatedCoursesSection();
                }
            } else {
                hideRelatedCoursesSection();
            }
        } catch (error) {
            console.error('Error loading general related courses:', error);
            hideRelatedCoursesSection();
        }
    }

    // ÊòæÁ§∫Áõ∏ÂÖ≥ËØæÁ®ã
    function displayRelatedCourses(courses) {
        const relatedList = document.getElementById('relatedCoursesList');
        if (!relatedList) return;

        const coursesHTML = courses.map(course => {
            const difficultyMap = {
                'beginner': 'ÂÖ•Èó®',
                'intermediate': 'ËøõÈò∂', 
                'advanced': 'È´òÁ∫ß'
            };
            const difficulty = difficultyMap[course.difficulty] || 'ÂÖ•Èó®';
            const price = parseFloat(course.price || 0);

            return `
                <div class="related-course-card enhanced-card" data-course-id="${course.id}">
                    <div class="related-course-image">
                        ${course.coverImage ?
                            `<img class="lazy-image related-course-img" data-src="${course.coverImage}" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='200' height='150'%3E%3Crect fill='%23f0f0f0' width='200' height='150'/%3E%3C/svg%3E" alt="${course.title}">` :
                            '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 10v6M2 10l10-5 10 5-10 5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                        }
                    </div>
                    <div class="related-course-content">
                        <div class="related-course-title">${course.title || 'Êú™ÂëΩÂêçËØæÁ®ã'}</div>
                        <div class="related-course-price">
                            ${course.isFree || price === 0 ? 'ÂÖçË¥π' : `¬•${price.toFixed(2)}`}
                        </div>
                        <div class="related-course-meta">
                            <span class="related-course-difficulty">${difficulty}</span>
                            <span>${course.enrollmentCount || 0}‰∫∫Â≠¶‰π†</span>
                        </div>
                    </div>
                </div>
            `;
        }).join('');

        relatedList.innerHTML = coursesHTML;
        
        // ÁªëÂÆöÁõ∏ÂÖ≥ËØæÁ®ãÂç°ÁâáÁÇπÂáª‰∫ã‰ª∂
        const relatedCards = relatedList.querySelectorAll('.related-course-card');
        relatedCards.forEach(card => {
            card.addEventListener('click', function() {
                const courseId = this.dataset.courseId;
                goToRelatedCourse(courseId);
            });
        });
        
        // ÁªëÂÆöÂõæÁâáÈîôËØØÂ§ÑÁêÜ
        const relatedImages = relatedList.querySelectorAll('.related-course-img');
        relatedImages.forEach(img => {
            img.addEventListener('error', function() {
                this.style.display = 'none';
                this.parentElement.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22 10v6M2 10l10-5 10 5-10 5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
            });
        });

        // Initialize lazy loading for related course images
        if (window.UXUtils && window.UXUtils.LazyLoader) {
            const lazyImages = relatedList.querySelectorAll('img.lazy-image');
            if (lazyImages.length > 0) {
                const loader = new window.UXUtils.LazyLoader();
                loader.observe(lazyImages);
            }
        }
    }

    // ÈöêËóèÁõ∏ÂÖ≥ËØæÁ®ãÈÉ®ÂàÜ
    function hideRelatedCoursesSection() {
        const section = document.getElementById('relatedCoursesSection');
        if (section) {
            section.style.display = 'none';
        }
    }

    // Ë∑≥ËΩ¨Âà∞Áõ∏ÂÖ≥ËØæÁ®ãËØ¶ÊÉÖÈ°µ
    function goToRelatedCourse(courseId) {
        window.location.href = `course-detail.html?id=${courseId}`;
    }

    // Ê£ÄÊü•ËÆ¢ÈòÖÁä∂ÊÄÅ
    async function checkSubscriptionStatus(courseId) {
        const token = localStorage.getItem('token');
        if (!token) {
            // Áî®Êà∑Êú™ÁôªÂΩïÔºåËøôÊòØÊ≠£Â∏∏Áä∂ÊÄÅÔºå‰∏çÈúÄË¶ÅÊ£ÄÊü•ËÆ¢ÈòÖ
            updateEnrollButton(false);
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/subscriptions/access/course/${courseId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`
                }
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    isSubscribed = data.data && data.data.hasAccess === true;
                    updateEnrollButton(isSubscribed);
                    console.log('ËÆ¢ÈòÖÁä∂ÊÄÅÊ£ÄÊü•:', { courseId, hasAccess: isSubscribed });
                } else {
                    // APIËøîÂõûÂ§±Ë¥•Ôºå‰ΩÜ‰∏çÊòØÈîôËØØ
                    updateEnrollButton(false);
                }
            } else if (response.status === 401) {
                // 401ÊòØÈ¢ÑÊúüÁöÑÁä∂ÊÄÅÔºàtokenËøáÊúüÊàñÊó†ÊïàÔºâÔºåÈùôÈªòÂ§ÑÁêÜ
                console.log('Áî®Êà∑ËÆ§ËØÅÂ∑≤ËøáÊúüÔºåÈúÄË¶ÅÈáçÊñ∞ÁôªÂΩï');
                updateEnrollButton(false);
                // ÂèØÈÄâÔºöÊ∏ÖÈô§ËøáÊúüÁöÑtoken
                // localStorage.removeItem('token');
                // localStorage.removeItem('user');
            } else if (response.status === 403) {
                // 403Ë°®Á§∫Êó†ÊùÉÈôêÔºå‰πüÊòØÊ≠£Â∏∏Áä∂ÊÄÅ
                console.log('Áî®Êà∑Êó†ÊùÉÈôêËÆøÈóÆÊ≠§ËØæÁ®ã');
                updateEnrollButton(false);
            } else {
                // ÂÖ∂‰ªñHTTPÈîôËØØÊâçËÆ∞ÂΩï
                console.warn('ËÆ¢ÈòÖÁä∂ÊÄÅÊ£ÄÊü•ËøîÂõûÂºÇÂ∏∏:', response.status);
                updateEnrollButton(false);
            }
        } catch (error) {
            // ÁΩëÁªúÈîôËØØÁ≠âÂºÇÂ∏∏ÔºåÈôçÁ∫ßÂ§ÑÁêÜ
            console.log('ËÆ¢ÈòÖÁä∂ÊÄÅÊ£ÄÊü•Â§±Ë¥•Ôºå‰ΩøÁî®ÈªòËÆ§Áä∂ÊÄÅ');
            updateEnrollButton(false);
        }
    }

    // Êõ¥Êñ∞Êä•ÂêçÊåâÈíÆÁä∂ÊÄÅ
    function updateEnrollButton(subscribed) {
        const enrollBtn = document.getElementById('enrollBtn');
        const subscriptionStatus = document.getElementById('subscriptionStatus');
        const statusIcon = document.getElementById('statusIcon');
        const statusText = document.getElementById('statusText');

        if (subscriptionStatus) {
            subscriptionStatus.style.display = 'inline-flex';

            if (subscribed) {
                subscriptionStatus.className = 'subscription-status subscribed';
                statusIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>';
                statusText.textContent = 'Â∑≤ËÆ¢ÈòÖ';
            } else {
                subscriptionStatus.className = 'subscription-status not-subscribed';
                statusIcon.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z" fill="currentColor"/></svg>';
                statusText.textContent = 'Êú™ËÆ¢ÈòÖ';
            }
        }

        if (!enrollBtn) return;

        if (subscribed) {
            enrollBtn.textContent = 'ÂºÄÂßãÂ≠¶‰π†';
            enrollBtn.style.background = 'linear-gradient(135deg, #10B981, #14B8A6)';
            enrollBtn.dataset.action = 'startLearning';
        } else {
            enrollBtn.textContent = currentCourse && currentCourse.isFree ? 'ÂÖçË¥πÂ≠¶‰π†' : 'Á´ãÂç≥Êä•Âêç';
            enrollBtn.style.background = 'linear-gradient(135deg, #6366F1, #EC4899)';
            enrollBtn.dataset.action = 'enrollCourse';
        }
    }

    // Êä•ÂêçËØæÁ®ã
    async function enrollCourse() {
        const token = localStorage.getItem('token');
        const enrollBtn = document.getElementById('enrollBtn');

        if (!token) {
            showNotification('ËØ∑ÂÖàÁôªÂΩï', 'error');
            setTimeout(() => {
                window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.pathname + window.location.search)}`;
            }, 1500);
            return;
        }

        if (!currentCourse) {
            showNotification('ËØæÁ®ã‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•', 'error');
            return;
        }

        const releaseButtonLoading = (() => {
            if (!enrollBtn) {
                return () => {};
            }

            let released = false;

            if (window.uiHelpers) {
                window.uiHelpers.showButtonLoading(enrollBtn);
                return () => {
                    if (!released) {
                        window.uiHelpers.hideButtonLoading(enrollBtn);
                        released = true;
                    }
                };
            }

            const originalText = enrollBtn.dataset.originalText || enrollBtn.textContent;
            enrollBtn.dataset.originalText = originalText;
            enrollBtn.disabled = true;
            enrollBtn.textContent = 'Â§ÑÁêÜ‰∏≠...';

            return () => {
                if (released) {
                    return;
                }
                released = true;
                enrollBtn.disabled = false;
                enrollBtn.textContent = enrollBtn.dataset.originalText || originalText;
            };
        })();

        try {
            if (currentCourse.isFree) {
                const formData = new FormData();
                formData.append('subscribableType', 'course');
                formData.append('subscribableId', currentCourse.id);
                formData.append('paymentMethod', 'free');

                const response = await fetch(`${API_BASE}/subscriptions/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    showNotification('ËÆ¢ÈòÖÊàêÂäüÔºÅ', 'success');
                    isSubscribed = true;
                    updateEnrollButton(true);
                } else {
                    throw new Error(data.message || 'ËÆ¢ÈòÖÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
                }
            } else {
                releaseButtonLoading();
                window.location.href = `payment.html?courseId=${currentCourse.id}&type=course`;
                return;
            }
        } catch (error) {
            console.error('ËÆ¢ÈòÖÂ§±Ë¥•:', error);
            if (window.uiHelpers) {
                window.uiHelpers.handleApiError(error, 'ËÆ¢ÈòÖËØæÁ®ãÂ§±Ë¥•');
            } else {
                showNotification(error.message || 'ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
            }
        } finally {
            releaseButtonLoading();
        }
    }

    // Âä†ÂÖ•Êî∂Ëóè
    async function addToWishlist() {
        const token = localStorage.getItem('token');

        if (!token) {
            showNotification('ËØ∑ÂÖàÁôªÂΩï', 'error');
            setTimeout(() => {
                window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.pathname + window.location.search)}`;
            }, 1500);
            return;
        }

        if (!currentCourse) {
            showNotification('ËØæÁ®ã‰ø°ÊÅØÂä†ËΩΩÂ§±Ë¥•', 'error');
            return;
        }

        try {
            const response = await fetch(`${API_BASE}/wishlist`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    courseId: currentCourse.id
                })
            });

            const data = await response.json();

            if (data.success) {
                showNotification('Â∑≤Âä†ÂÖ•Êî∂ËóèÔºÅ');
            } else if (data.code === 409) {
                showNotification('ËØæÁ®ãÂ∑≤Âú®Êî∂ËóèÂàóË°®‰∏≠');
            } else {
                showNotification(data.message || 'Êî∂ËóèÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
            }
        } catch (error) {
            console.error('Êî∂ËóèÂ§±Ë¥•:', error);
            showNotification('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
        }
    }

    // ÂâçÂæÄÁ´†ËäÇ - ‰ΩøÁî®blobÊñπÂºèÊâìÂºÄ
    function goToChapter(chapterId) {
        // Ê£ÄÊü•Á´†ËäÇÊòØÂê¶Â≠òÂú®
        const chapter = window.courseChapters?.find(ch => ch.id == chapterId);
        if (!chapter) {
            showNotification('Á´†ËäÇ‰∏çÂ≠òÂú®', 'error');
            return;
        }
        
        // Ê£ÄÊü•Á´†ËäÇËÆøÈóÆÊùÉÈôê
        if (chapter.canAccess !== false) {
            loadChapterContent(chapterId);
        } else {
            showNotification('ËØ∑ÂÖàËÆ¢ÈòÖËØæÁ®ãÊâçËÉΩÂ≠¶‰π†', 'error');
        }
    }
    
    // Êö¥Èú≤ÂáΩÊï∞Âà∞ÂÖ®Â±Ä‰ΩúÁî®Âüü
    window.goToChapter = goToChapter;
    window.showSubscribePrompt = showSubscribePrompt;
    window.loadChapterContent = loadChapterContent;

    // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
    function showLoading() {
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const courseContent = document.getElementById('courseContent');

        if (loadingState) {
            loadingState.style.display = 'flex';

            const skeletonContainer = document.getElementById('courseLoadingSkeleton');
            if (window.uiHelpers && skeletonContainer) {
                window.uiHelpers.showSkeleton(skeletonContainer, { type: 'card', count: 2 });
            }
        }

        if (errorState) {
            errorState.style.display = 'none';
        }

        if (courseContent) {
            courseContent.style.display = 'none';
        }
    }

    function clearLoadingSkeleton() {
        if (!window.uiHelpers) return;

        const skeletonContainer = document.getElementById('courseLoadingSkeleton');
        if (skeletonContainer) {
            window.uiHelpers.hideSkeleton(skeletonContainer);
            skeletonContainer.innerHTML = '';
        }
    }

    // ÊòæÁ§∫ÂÜÖÂÆπ
    function showContent() {
        clearLoadingSkeleton();

        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const courseContent = document.getElementById('courseContent');

        if (loadingState) {
            loadingState.style.display = 'none';
        }

        if (errorState) {
            errorState.style.display = 'none';
        }

        if (courseContent) {
            courseContent.style.display = 'block';
        }
    }

    // ÊòæÁ§∫ÈîôËØØ
    function showError(message) {
        clearLoadingSkeleton();

        const loadingState = document.getElementById('loadingState');
        const courseContent = document.getElementById('courseContent');
        const errorState = document.getElementById('errorState');

        if (loadingState) {
            loadingState.style.display = 'none';
        }

        if (courseContent) {
            courseContent.style.display = 'none';
        }

        if (errorState) {
            errorState.style.display = 'block';

            if (message) {
                const messageEl = errorState.querySelector('p');
                if (messageEl) {
                    messageEl.textContent = message;
                }
            }
        }
    }

    // ÂàáÊç¢Áî®Êà∑ËèúÂçï
    function toggleUserMenu(event) {
        if (event) {
            event.stopPropagation();
        }
        const dropdown = document.getElementById('userDropdown');
        const container = document.querySelector('.user-menu-container');
        if (dropdown && container) {
            dropdown.classList.toggle('show');
            container.classList.toggle('active');
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const userMenu = document.querySelector('.user-menu-container');
        if (userMenu && !userMenu.contains(event.target)) {
            const dropdown = document.getElementById('userDropdown');
            if (dropdown) {
                dropdown.classList.remove('show');
                userMenu.classList.remove('active');
            }
        }
    });

    // ÈÄÄÂá∫ÁôªÂΩï
    function handleLogout() {
        logout();
    }
    
    function logout() {
        if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫ÁôªÂΩïÂêóÔºü')) {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = '/home.html';
        }
    }

    // Load user info for dropdown
    async function loadUserInfo() {
        try {
            const savedUser = localStorage.getItem('user');
            let user = null;
            
            // Try to get from API first
            if (localStorage.getItem('token')) {
                try {
                    const response = await fetch(`${API_BASE}/user/profile`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success && data.data) {
                            user = data.data.user || data.data;
                        }
                    }
                } catch (error) {
                    console.log('Using cached user data');
                }
            }
            
            // Fallback to saved user
            if (!user && savedUser) {
                user = JSON.parse(savedUser);
            }
            
            if (user) {
                // Update UI
                document.getElementById('userName').textContent = user.nickname || user.username || 'Áî®Êà∑';
                const avatar = document.getElementById('userAvatar');
                if (user.avatar) {
                    avatar.innerHTML = `<img src="${user.avatar}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                } else {
                    avatar.textContent = (user.nickname || user.username || 'U').charAt(0).toUpperCase();
                }
            } else {
                // ÊòæÁ§∫Êú™ÁôªÂΩïÁä∂ÊÄÅ
                const userNameEl = document.getElementById('userName');
                const userAvatarEl = document.getElementById('userAvatar');
                
                if (userNameEl) {
                    userNameEl.textContent = 'Êú™ÁôªÂΩï';
                }
                if (userAvatarEl) {
                    userAvatarEl.textContent = 'U';
                }
            }
        } catch (error) {
            console.error('Failed to load user info:', error);
        }
    }

    // ÂºÄÂßãÂ≠¶‰π† - ÊâìÂºÄÁ¨¨‰∏Ä‰∏™Á´†ËäÇ
    async function startLearning() {
        try {
            const response = await fetch(`${API_BASE}/content/courses/${currentCourse.id}/chapters`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                }
            });

            if (!response.ok) {
                throw new Error('Failed to fetch chapters');
            }

            const data = await response.json();

            if (data.success && data.data && data.data.length > 0) {
                // ÊâìÂºÄÁ¨¨‰∏Ä‰∏™Á´†ËäÇÁöÑÂÜÖÂÆπ
                loadChapterContent(data.data[0].id);
            } else {
                showNotification('ÊöÇÊó†ÂèØÂ≠¶‰π†ÁöÑÁ´†ËäÇ', 'error');
            }
        } catch (error) {
            console.error('Error starting learning:', error);
            showNotification('Ëé∑ÂèñÁ´†ËäÇÂàóË°®Â§±Ë¥•', 'error');
        }
    }
    
    // Âä†ËΩΩÁ´†ËäÇÂÜÖÂÆπÂáΩÊï∞ - ÁÆÄÂåñÁâàÊú¨ÔºåÈÅøÂÖçÂ§çÊùÇÁöÑiframeÂ§ÑÁêÜ
    async function loadChapterContent(chapterId) {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/content/chapters/${chapterId}`, {
                headers: {
                    'Authorization': `Bearer ${token || ''}`
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            if (data.success && data.data) {
                const chapterData = data.data;
                
                // Ëé∑ÂèñÁ´†ËäÇÊ†áÈ¢òÂíåÂÜÖÂÆπ
                const chapterTitle = (chapterData.chapter && chapterData.chapter.title) || 'Á´†ËäÇÂÜÖÂÆπ';
                let contentHtml = '';
                
                if (chapterData.content && chapterData.content.contentHtml) {
                    contentHtml = chapterData.content.contentHtml;
                } else if (chapterData.chapter && chapterData.chapter.description) {
                    contentHtml = '<h1>' + chapterTitle + '</h1><p>' + chapterData.chapter.description + '</p>';
                } else {
                    contentHtml = '<h1>' + chapterTitle + '</h1><h3>ÊöÇÊó†ÂÜÖÂÆπ</h3><p>ËØ•Á´†ËäÇÂÜÖÂÆπÊ≠£Âú®ÂáÜÂ§á‰∏≠ÔºåÊï¨ËØ∑ÊúüÂæÖÔºÅ</p>';
                }

                // Ê£ÄÊµãÂÜÖÂÆπÁ±ªÂûã
                const isCompleteHTML = contentHtml.includes('<!DOCTYPE') || contentHtml.includes('<html');
                
                if (isCompleteHTML) {
                    // ÂØπ‰∫éÂÆåÊï¥ÁöÑHTMLÈ°µÈù¢Ôºå‰ΩøÁî®Êñ∞Á™óÂè£ÊâìÂºÄ
                    console.log('Ê£ÄÊµãÂà∞ÂÆåÊï¥HTMLÈ°µÈù¢Ôºå‰ΩøÁî®Êñ∞Á™óÂè£ÊâìÂºÄ');
                    openChapterInNewWindow(chapterTitle, contentHtml);
                } else {
                    // ÂØπ‰∫éÁâáÊÆµHTMLÔºå‰ΩøÁî®Ê®°ÊÄÅÊ°ÜÊòæÁ§∫
                    console.log('ÊòæÁ§∫HTMLÁâáÊÆµÂÜÖÂÆπ');
                    showChapterModal(chapterTitle, contentHtml);
                }
            }
        } catch (error) {
            console.error('Âä†ËΩΩÁ´†ËäÇÂÜÖÂÆπÂ§±Ë¥•:', error);
            showNotification(`Âä†ËΩΩÂ§±Ë¥•: ${error.message}`, 'error');
        }
    }

    // Âú®Êñ∞Á™óÂè£‰∏≠ÊâìÂºÄÁ´†ËäÇÂÜÖÂÆπ
    function openChapterInNewWindow(title, htmlContent) {
        // ÂàõÂª∫‰∏Ä‰∏™Êñ∞Á™óÂè£
        const newWindow = window.open('', '_blank', 'width=1200,height=800,menubar=no,toolbar=no,location=no,status=no');
        
        if (newWindow) {
            // ÂßãÁªàÊ≥®ÂÖ•ÂøÖË¶ÅÁöÑÂ∫ìÔºåÁ°Æ‰øùÂÆÉ‰ª¨Âú®ÂÜÖÂÆπ‰πãÂâçÂä†ËΩΩ
            const libraries = `
                <!-- Three.jsÊ†∏ÂøÉÂ∫ì -->
                <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
                
                <!-- Á≠âÂæÖTHREE.jsÂä†ËΩΩÂÆåÊàêÂêéÂÜçÂä†ËΩΩÊâ©Â±ï -->
                <script>
                    // Âä®ÊÄÅÂä†ËΩΩOrbitControls‰ª•Á°Æ‰øùTHREEÂ∑≤ÁªèÂ≠òÂú®
                    function loadThreeExtensions() {
                        if (typeof THREE === 'undefined') {
                            console.warn('Waiting for THREE.js...');
                            setTimeout(loadThreeExtensions, 50);
                            return;
                        }
                        
                        console.log('THREE.js is ready, loading extensions...');
                        
                        // ÂàõÂª∫scriptÊ†áÁ≠æÂä®ÊÄÅÂä†ËΩΩOrbitControls
                        var orbitScript = document.createElement('script');
                        orbitScript.src = '/assets/js/OrbitControls.js';
                        orbitScript.onload = function() {
                            console.log('OrbitControls loaded from local file');
                            if (typeof THREE.OrbitControls !== 'undefined') {
                                console.log('‚úÖ THREE.OrbitControls is ready!');
                            }
                        };
                        orbitScript.onerror = function() {
                            console.warn('Failed to load local OrbitControls, trying CDN...');
                            // Â§áÁî®CDN
                            var cdnScript = document.createElement('script');
                            cdnScript.src = 'https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js';
                            cdnScript.onload = function() {
                                console.log('OrbitControls loaded from CDN');
                            };
                            document.head.appendChild(cdnScript);
                        };
                        document.head.appendChild(orbitScript);
                        
                        // Âä†ËΩΩÂÖ∂‰ªñÊâ©Â±ï
                        var gltfScript = document.createElement('script');
                        gltfScript.src = 'https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js';
                        document.head.appendChild(gltfScript);
                        
                        var objScript = document.createElement('script');
                        objScript.src = 'https://unpkg.com/three@0.128.0/examples/js/loaders/OBJLoader.js';
                        document.head.appendChild(objScript);
                    }
                    
                    // ÂºÄÂßãÂä†ËΩΩÊâ©Â±ï
                    loadThreeExtensions();
                <\/script>
                
                <!-- GSAPÂä®ÁîªÂ∫ì - ÂøÖÈ°ªÂú®ÂÜÖÂÆπ‰πãÂâçÂä†ËΩΩ -->
                <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"><\/script>
                <script>
                    // Á°Æ‰øùGSAPÂú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÂèØÁî®
                    window.gsap = window.gsap || gsap;
                    if (window.gsap && window.ScrollTrigger) {
                        window.gsap.registerPlugin(window.ScrollTrigger);
                    }
                <\/script>
                
                <!-- KaTeXÊï∞Â≠¶ÂÖ¨Âºè -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"><\/script>
                
                <!-- ‰ª£Á†ÅÈ´ò‰∫Æ -->
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"><\/script>
                <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"><\/script>
                
                <!-- Chart.jsÂõæË°® -->
                <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"><\/script>
                
                <!-- Typed.js ÊâìÂ≠óÊú∫ÊïàÊûú -->
                <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.16/typed.umd.js"><\/script>
                
                <!-- Particles.js Á≤íÂ≠êÊïàÊûú -->
                <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"><\/script>
                
                <!-- Tailwind CSS -->
                <script src="https://cdn.tailwindcss.com"><\/script>
                
                <!-- Ê∞¥Âç∞Ê†∑Âºè -->
                <style>
                    /* Á¶ÅÁî®ÊñáÊú¨ÈÄâÊã© */
                    body {
                        -webkit-user-select: none;
                        -moz-user-select: none;
                        -ms-user-select: none;
                        user-select: none;
                        -webkit-touch-callout: none;
                        -webkit-tap-highlight-color: transparent;
                    }
                    
                    /* ÂÖÅËÆ∏ËæìÂÖ•Ê°ÜÂíåÊñáÊú¨Âå∫ÂüüÈÄâÊã© */
                    input, textarea {
                        -webkit-user-select: text;
                        -moz-user-select: text;
                        -ms-user-select: text;
                        user-select: text;
                    }
                    
                    /* Á¶ÅÁî®ÂõæÁâáÊãñÊãΩ */
                    img {
                        -webkit-user-drag: none;
                        -khtml-user-drag: none;
                        -moz-user-drag: none;
                        -o-user-drag: none;
                        user-drag: none;
                        pointer-events: none;
                    }
                    
                    /* Ê∞¥Âç∞ÂÆπÂô®Ê†∑Âºè */
                    .watermark-container {
                        position: fixed;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        pointer-events: none;
                        z-index: 9999;
                        overflow: hidden;
                    }
                    
                    /* Â§ö‰∏™ÊñúÂêëÊ∞¥Âç∞ÁΩëÊ†º */
                    .watermark-grid {
                        position: absolute;
                        top: 0;
                        left: 0;
                        width: 100%;
                        height: 100%;
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        grid-template-rows: repeat(4, 1fr);
                        gap: 20px;
                        padding: 50px;
                    }
                    
                    .watermark-item {
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        transform: rotate(-45deg);
                        font-size: 28px;
                        font-weight: bold;
                        color: rgba(0, 0, 0, 0.04);
                        white-space: nowrap;
                        user-select: none;
                        font-family: 'Arial', sans-serif;
                    }
                    
                    /* ‰∫§Êõø‰∏çÂêåÈÄèÊòéÂ∫¶ÂàõÂª∫Â±ÇÊ¨°ÊÑü */
                    .watermark-item:nth-child(odd) {
                        color: rgba(0, 0, 0, 0.03);
                    }
                    
                    .watermark-item:nth-child(even) {
                        color: rgba(0, 0, 0, 0.05);
                    }
                    
                    .watermark-left {
                        position: absolute;
                        top: 50%;
                        left: 10%;
                        transform: translateY(-50%) rotate(-90deg);
                        font-size: 24px;
                        font-weight: bold;
                        color: rgba(0, 0, 0, 0.08);
                        white-space: nowrap;
                        user-select: none;
                    }
                    
                    .watermark-right {
                        position: absolute;
                        top: 50%;
                        right: 10%;
                        transform: translateY(-50%) rotate(90deg);
                        font-size: 24px;
                        font-weight: bold;
                        color: rgba(0, 0, 0, 0.08);
                        white-space: nowrap;
                        user-select: none;
                    }
                    
                    /* ÈáçÂ§çÊ∞¥Âç∞ËÉåÊôØ */
                    .watermark-pattern {
                        position: absolute;
                        width: 200%;
                        height: 200%;
                        top: -50%;
                        left: -50%;
                        background-image: repeating-linear-gradient(
                            -45deg,
                            transparent,
                            transparent 200px,
                            rgba(0, 0, 0, 0.02) 200px,
                            rgba(0, 0, 0, 0.02) 400px
                        );
                    }
                    
                    /* Ê∑±Ëâ≤Ê®°ÂºèÊ∞¥Âç∞ */
                    @media (prefers-color-scheme: dark) {
                        .watermark-item {
                            color: rgba(255, 255, 255, 0.04);
                        }
                        .watermark-item:nth-child(odd) {
                            color: rgba(255, 255, 255, 0.03);
                        }
                        .watermark-item:nth-child(even) {
                            color: rgba(255, 255, 255, 0.05);
                        }
                        .watermark-left, .watermark-right {
                            color: rgba(255, 255, 255, 0.08);
                        }
                        .watermark-pattern {
                            background-image: repeating-linear-gradient(
                                -45deg,
                                transparent,
                                transparent 200px,
                                rgba(255, 255, 255, 0.02) 200px,
                                rgba(255, 255, 255, 0.02) 400px
                            );
                        }
                    }
                <\/style>
                
                <!-- Ê∑ªÂä†‰∏Ä‰∏™ÂàùÂßãÂåñÊ£ÄÊü•ËÑöÊú¨ -->
                <script>
                    // Á¶ÅÁî®ÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÂíåÊ∫êÁ†ÅÊü•Áúã
                    (function() {
                        // Á¶ÅÁî®Âè≥ÈîÆËèúÂçï
                        document.addEventListener('contextmenu', function(e) {
                            e.preventDefault();
                            return false;
                        }, false);
                        
                        // Á¶ÅÁî®F12ÂíåÂÖ∂‰ªñÂºÄÂèëËÄÖÂ∑•ÂÖ∑Âø´Êç∑ÈîÆ
                        document.addEventListener('keydown', function(e) {
                            // F12
                            if (e.keyCode === 123) {
                                e.preventDefault();
                                return false;
                            }
                            // Ctrl+Shift+I, Ctrl+Shift+J, Ctrl+Shift+C
                            if (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) {
                                e.preventDefault();
                                return false;
                            }
                            // Ctrl+U (Êü•ÁúãÊ∫ê‰ª£Á†Å)
                            if (e.ctrlKey && e.keyCode === 85) {
                                e.preventDefault();
                                return false;
                            }
                            // Ctrl+S (‰øùÂ≠òÈ°µÈù¢)
                            if (e.ctrlKey && e.keyCode === 83) {
                                e.preventDefault();
                                return false;
                            }
                            // Ctrl+A (ÂÖ®ÈÄâ)
                            if (e.ctrlKey && e.keyCode === 65) {
                                e.preventDefault();
                                return false;
                            }
                        }, false);
                        
                        // Ê£ÄÊµãÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÊòØÂê¶ÊâìÂºÄ
                        let devtools = {open: false, orientation: null};
                        const threshold = 160;
                        const emitEvent = function(state, orientation) {
                            if (state) {
                                console.clear();
                                console.log('%cüö´ Á¶ÅÊ≠¢ËÆøÈóÆÔºÅ', 'color: red; font-size: 50px; font-weight: bold;');
                                console.log('%cÂºÄÂèëËÄÖÂ∑•ÂÖ∑Â∑≤Ë¢´Á¶ÅÁî®ÔºåËØ∑ÂÖ≥Èó≠ÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÁªßÁª≠Â≠¶‰π†„ÄÇ', 'color: red; font-size: 20px;');
                                console.log('%cÁâàÊùÉÊâÄÊúâ ¬© www.infofuture.online', 'color: blue; font-size: 16px;');
                                
                                // ÂèØÈÄâÔºöÂÖ≥Èó≠Á™óÂè£ÊàñË∑≥ËΩ¨
                                setTimeout(function() {
                                    // window.close(); // ÂÖ≥Èó≠Á™óÂè£
                                    // ÊàñËÄÖÊòæÁ§∫Ë≠¶ÂëäÈÅÆÁΩ©
                                    const warning = document.createElement('div');
                                    warning.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); color: white; display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 999999; font-size: 24px;';
                                    warning.innerHTML = '<h1 style="color: red; font-size: 48px; margin-bottom: 20px;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="vertical-align: middle; margin-right: 10px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="red"/><line x1="12" y1="9" x2="12" y2="13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="17" r="1" fill="white"/></svg> Ë≠¶Âëä</h1><p>Ê£ÄÊµãÂà∞ÈùûÊ≥ïË∞ÉËØïË°å‰∏∫ÔºÅ</p><p>ËØ∑ÂÖ≥Èó≠ÂºÄÂèëËÄÖÂ∑•ÂÖ∑ÁªßÁª≠Â≠¶‰π†</p><p style="margin-top: 20px; font-size: 16px;">www.infofuture.online</p>';
                                    warning.id = 'devtools-warning';
                                    if (!document.getElementById('devtools-warning')) {
                                        document.body.appendChild(warning);
                                    }
                                }, 100);
                            } else {
                                // ÁßªÈô§Ë≠¶Âëä
                                const warning = document.getElementById('devtools-warning');
                                if (warning) {
                                    warning.remove();
                                }
                            }
                        };
                        
                        // Ê£ÄÊµãÁ™óÂè£Â∞∫ÂØ∏ÂèòÂåñ
                        setInterval(function() {
                            if (window.outerHeight - window.innerHeight > threshold) {
                                if (!devtools.open) {
                                    devtools.open = true;
                                    devtools.orientation = 'vertical';
                                    emitEvent(true, 'vertical');
                                }
                            } else if (window.outerWidth - window.innerWidth > threshold) {
                                if (!devtools.open) {
                                    devtools.open = true;
                                    devtools.orientation = 'horizontal';
                                    emitEvent(true, 'horizontal');
                                }
                            } else {
                                if (devtools.open) {
                                    devtools.open = false;
                                    devtools.orientation = null;
                                    emitEvent(false, null);
                                }
                            }
                        }, 500);
                        
                        // Á¶ÅÁî®ÊñáÊú¨ÈÄâÊã©
                        document.addEventListener('selectstart', function(e) {
                            e.preventDefault();
                            return false;
                        }, false);
                        
                        // Á¶ÅÁî®ÊãñÊãΩ
                        document.addEventListener('dragstart', function(e) {
                            e.preventDefault();
                            return false;
                        }, false);
                        
                        // Á¶ÅÁî®ÊâìÂç∞
                        window.addEventListener('beforeprint', function(e) {
                            e.preventDefault();
                            return false;
                        });
                        
                        // ‰ΩøÁî®debuggerËØ≠Âè•Ê£ÄÊµã
                        (function() {
                            let checkStatus = function() {
                                const startTime = new Date();
                                debugger;
                                const endTime = new Date();
                                if (endTime - startTime > 100) {
                                    emitEvent(true, 'debugger');
                                }
                            };
                            setInterval(checkStatus, 1000);
                        })();
                        
                        // Ê∑∑Ê∑ÜconsoleÊñπÊ≥ï
                        const disableConsole = function() {
                            const methods = ['log', 'debug', 'info', 'warn', 'error', 'table', 'trace', 'dir'];
                            methods.forEach(function(method) {
                                const original = console[method];
                                console[method] = function() {
                                    return false;
                                };
                            });
                        };
                        
                        // Âª∂ËøüÊâßË°åÈÅøÂÖçÂΩ±ÂìçÂàùÂßãÂåñ
                        setTimeout(disableConsole, 5000);
                    })();
                    
                    // Âä†ÂØÜÈÉ®ÂàÜ‰ª£Á†Å
                    eval(function(p,a,c,k,e,d){e=function(c){return c};if(!''.replace(/^/,String)){while(c--){d[c]=k[c]||c}k=[function(e){return d[e]}];e=function(){return'\\w+'};c=1};while(c--){if(k[c]){p=p.replace(new RegExp('\\b'+e(c)+'\\b','g'),k[c])}}return p}('console.log("Content protected by www.infofuture.online");',1,1,''.split('|'),0,{}));
                    
                    // Á≠âÂæÖÊâÄÊúâÂ∫ìÂä†ËΩΩÂÆåÊàê
                    window.addEventListener('DOMContentLoaded', function() {
                        console.log('Libraries check:', {
                            THREE: typeof THREE !== 'undefined',
                            'THREE.OrbitControls': typeof THREE !== 'undefined' && typeof THREE.OrbitControls !== 'undefined',
                            gsap: typeof gsap !== 'undefined',
                            katex: typeof katex !== 'undefined',
                            hljs: typeof hljs !== 'undefined',
                            Chart: typeof Chart !== 'undefined',
                            Typed: typeof Typed !== 'undefined',
                            particlesJS: typeof particlesJS !== 'undefined'
                        });
                    });
                <\/script>
            `;
            
            // Ê£ÄÊü•ÊòØÂê¶ÊòØÂÆåÊï¥ÁöÑHTMLÊñáÊ°£
            const isCompleteHTML = htmlContent.includes('<!DOCTYPE') || htmlContent.includes('<html');
            
            if (isCompleteHTML) {
                // Â¶ÇÊûúÊòØÂÆåÊï¥HTMLÔºåÊô∫ËÉΩÂú∞Ê≥®ÂÖ•Â∫ì
                if (htmlContent.includes('</head>')) {
                    // Âú®</head>‰πãÂâçÊ≥®ÂÖ•Â∫ì
                    htmlContent = htmlContent.replace('</head>', libraries + '\n</head>');
                } else if (htmlContent.includes('<head>')) {
                    // Âú®<head>‰πãÂêéÊ≥®ÂÖ•Â∫ì
                    htmlContent = htmlContent.replace('<head>', '<head>\n' + libraries);
                } else if (htmlContent.includes('<body>')) {
                    // Â¶ÇÊûúÊ≤°ÊúâheadÊ†áÁ≠æÔºåÂú®bodyÂâçÂàõÂª∫headÂπ∂Ê≥®ÂÖ•Â∫ì
                    htmlContent = htmlContent.replace('<body>', '<head>\n' + libraries + '\n</head>\n<body>');
                }
            } else {
                // Â¶ÇÊûú‰∏çÊòØÂÆåÊï¥HTMLÔºåÂàõÂª∫ÂÆåÊï¥ÁªìÊûÑ
                htmlContent = `
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <title>${title}</title>
                        ${libraries}
                        <style>
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                                line-height: 1.6;
                                color: #333;
                                padding: 20px;
                                max-width: 1200px;
                                margin: 0 auto;
                            }
                        </style>
                    </head>
                    <body>
                        ${htmlContent}
                    </body>
                    </html>
                `;
            }
            
            // Áõ¥Êé•ÂÜôÂÖ•HTMLÂÜÖÂÆπ
            newWindow.document.open();
            newWindow.document.write(htmlContent);
            newWindow.document.close();
            
            // ËÆæÁΩÆÊ†áÈ¢ò
            if (!htmlContent.includes('<title>')) {
                newWindow.document.title = title;
            }
            
            // Ê∑ªÂä†Ê∞¥Âç∞
            setTimeout(function() {
                try {
                    // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
                    const savedUser = localStorage.getItem('user');
                    let username = 'Êú™ÁôªÂΩïÁî®Êà∑';
                    if (savedUser) {
                        try {
                            const user = JSON.parse(savedUser);
                            username = user.username || user.nickname || user.email || 'Â≠¶Âëò';
                        } catch (e) {
                            console.log('Failed to parse user info for watermark');
                        }
                    }
                    
                    // ÂàõÂª∫Ê∞¥Âç∞ÂÆπÂô®
                    const watermarkDiv = newWindow.document.createElement('div');
                    watermarkDiv.className = 'watermark-container';
                    
                    // ÁîüÊàêÂ§ö‰∏™Ê∞¥Âç∞È°π
                    let watermarkGridHTML = '<div class="watermark-grid">';
                    for (let i = 0; i < 12; i++) {
                        watermarkGridHTML += '<div class="watermark-item">www.infofuture.online</div>';
                    }
                    watermarkGridHTML += '</div>';
                    
                    watermarkDiv.innerHTML = `
                        <div class="watermark-pattern"></div>
                        ${watermarkGridHTML}
                        <div class="watermark-left">
                            Áî®Êà∑: ${username} | www.infofuture.online
                        </div>
                        <div class="watermark-right">
                            Áî®Êà∑: ${username} | www.infofuture.online
                        </div>
                    `;
                    
                    // Ê∑ªÂä†Âà∞body
                    if (newWindow.document.body) {
                        newWindow.document.body.appendChild(watermarkDiv);
                        console.log('Watermark added successfully');
                    }
                    
                    // Èò≤Ê≠¢Ê∞¥Âç∞Ë¢´Âà†Èô§
                    const observer = new newWindow.MutationObserver(function(mutations) {
                        const watermark = newWindow.document.querySelector('.watermark-container');
                        if (!watermark) {
                            newWindow.document.body.appendChild(watermarkDiv.cloneNode(true));
                        }
                    });
                    
                    observer.observe(newWindow.document.body, {
                        childList: true,
                        subtree: true
                    });
                    
                    // Âú®Êñ∞Á™óÂè£‰∏≠‰πüÊ∑ªÂä†‰øùÊä§Êé™ÊñΩ
                    const protectionScript = newWindow.document.createElement('script');
                    protectionScript.textContent = '(' + function() {
                        // Á¶ÅÁî®Âè≥ÈîÆ
                        document.addEventListener('contextmenu', e => e.preventDefault());
                        
                        // Á¶ÅÁî®ÂºÄÂèëËÄÖÂ∑•ÂÖ∑Âø´Êç∑ÈîÆ
                        document.addEventListener('keydown', function(e) {
                            if (e.keyCode === 123 || // F12
                                (e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 74 || e.keyCode === 67)) || // Ctrl+Shift+I/J/C
                                (e.ctrlKey && e.keyCode === 85)) { // Ctrl+U
                                e.preventDefault();
                                return false;
                            }
                        });
                        
                        // Ê£ÄÊµãÂºÄÂèëËÄÖÂ∑•ÂÖ∑
                        let devtools = {open: false};
                        const threshold = 160;
                        setInterval(function() {
                            if (window.outerHeight - window.innerHeight > threshold || 
                                window.outerWidth - window.innerWidth > threshold) {
                                if (!devtools.open) {
                                    devtools.open = true;
                                    document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#000;color:red;font-size:30px;"><svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" style="margin-right: 15px;"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" fill="red"/><line x1="12" y1="9" x2="12" y2="13" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="12" cy="17" r="1" fill="white"/></svg> Á¶ÅÊ≠¢Ë∞ÉËØïÔºÅËØ∑ÂÖ≥Èó≠ÂºÄÂèëËÄÖÂ∑•ÂÖ∑</div>';
                                }
                            }
                        }, 500);
                        
                        // Á¶ÅÁî®ÈÄâÊã©ÂíåÂ§çÂà∂
                        document.addEventListener('selectstart', e => e.preventDefault());
                        document.addEventListener('copy', e => e.preventDefault());
                        document.addEventListener('cut', e => e.preventDefault());
                        
                        // Ê∏ÖÁ©∫Ââ™Ë¥¥Êùø
                        document.addEventListener('copy', function(e) {
                            e.clipboardData.setData('text/plain', 'ÂÜÖÂÆπÂèóÁâàÊùÉ‰øùÊä§ - www.infofuture.online');
                            e.preventDefault();
                        });
                    }.toString() + ')();';
                    newWindow.document.head.appendChild(protectionScript);
                    
                } catch (error) {
                    console.error('Failed to add watermark:', error);
                }
            }, 500); // Âª∂Ëøü‰∏ÄÁÇπÁ°Æ‰øùÈ°µÈù¢Âä†ËΩΩÂÆåÊàê
            
            // Á≠âÂæÖÂÜÖÂÆπÂä†ËΩΩÂêéÂàùÂßãÂåñÂ∫ì
            newWindow.addEventListener('load', function() {
                // ÂàùÂßãÂåñGSAP
                if (newWindow.gsap && newWindow.ScrollTrigger) {
                    newWindow.gsap.registerPlugin(newWindow.ScrollTrigger);
                }
                
                // ÂàùÂßãÂåñ‰ª£Á†ÅÈ´ò‰∫Æ
                if (newWindow.hljs) {
                    newWindow.hljs.highlightAll();
                }
                
                // ÂàùÂßãÂåñÊï∞Â≠¶ÂÖ¨Âºè
                if (newWindow.renderMathInElement) {
                    newWindow.renderMathInElement(newWindow.document.body, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false}
                        ],
                        throwOnError: false
                    });
                }
            });
            
            showNotification('Á´†ËäÇÂ∑≤Âú®Êñ∞Á™óÂè£ÊâìÂºÄ', 'success');
        } else {
            showNotification('Êó†Ê≥ïÊâìÂºÄÊñ∞Á™óÂè£ÔºåËØ∑Ê£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆ', 'error');
            // ÈôçÁ∫ßÊñπÊ°àÔºö‰ΩøÁî®ÁÆÄÂçïÊ®°ÊÄÅÊ°Ü
            showSimpleModal(title, htmlContent);
        }
    }

    // ÊòæÁ§∫Á´†ËäÇÊ®°ÊÄÅÊ°ÜÔºàÁî®‰∫éHTMLÁâáÊÆµÔºâ
    function showChapterModal(title, htmlContent) {
        // ÁßªÈô§ÂèØËÉΩÂ≠òÂú®ÁöÑÊóßÊ®°ÊÄÅÊ°Ü
        const existingModal = document.getElementById('chapterContentModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Ëé∑ÂèñÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
        const savedUser = localStorage.getItem('user');
        let username = 'Êú™ÁôªÂΩïÁî®Êà∑';
        if (savedUser) {
            try {
                const user = JSON.parse(savedUser);
                username = user.username || user.nickname || user.email || 'Â≠¶Âëò';
            } catch (e) {
                console.log('Failed to parse user info for watermark');
            }
        }
        
        // ÂàõÂª∫Ê®°ÊÄÅÊ°Ü
        const modal = document.createElement('div');
        modal.id = 'chapterContentModal';
        modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        `;
        
        // ÂàõÂª∫ÂÜÖÂÆπÂÆπÂô®
        const container = document.createElement('div');
        container.style.cssText = `
            width: 90%;
            max-width: 1200px;
            height: 90%;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            position: relative;
        `;
        
        // ÂàõÂª∫Â§¥ÈÉ®
        const header = document.createElement('div');
        header.style.cssText = `
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        `;
        header.innerHTML = `
            <h2 style="margin: 0; font-size: 24px;">${title}</h2>
            <button class="modal-close-btn" 
                    style="background: rgba(255,255,255,0.2); border: none; color: white; 
                           padding: 8px 16px; border-radius: 5px; cursor: pointer; font-size: 16px;">
                ‚úï ÂÖ≥Èó≠
            </button>
        `;
        
        // ÂàõÂª∫ÂÜÖÂÆπÂå∫Âüü
        const content = document.createElement('div');
        content.style.cssText = `
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            background: #f9fafb;
            position: relative;
        `;
        content.innerHTML = htmlContent;
        
        // ÂàõÂª∫Ê∞¥Âç∞
        const watermark = document.createElement('div');
        watermark.style.cssText = `
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-items: center;
            padding: 20px;
        `;
        
        // ÁîüÊàêÂ§ö‰∏™Â∞èÊ∞¥Âç∞
        let watermarkHTML = '';
        for (let i = 0; i < 6; i++) {
            watermarkHTML += `
                <div style="transform: rotate(-45deg); font-size: 24px; font-weight: bold; 
                            color: rgba(0, 0, 0, 0.04); white-space: nowrap; user-select: none; 
                            margin: 20px;">
                    www.infofuture.online
                </div>
            `;
        }
        
        watermark.innerHTML = `
            ${watermarkHTML}
            <div style="position: absolute; top: 50%; left: 5%; transform: translateY(-50%) rotate(-90deg); 
                        font-size: 18px; font-weight: bold; color: rgba(0, 0, 0, 0.06); 
                        white-space: nowrap; user-select: none;">
                Áî®Êà∑: ${username} | www.infofuture.online
            </div>
            <div style="position: absolute; top: 50%; right: 5%; transform: translateY(-50%) rotate(90deg); 
                        font-size: 18px; font-weight: bold; color: rgba(0, 0, 0, 0.06); 
                        white-space: nowrap; user-select: none;">
                Áî®Êà∑: ${username} | www.infofuture.online
            </div>
        `;
        content.appendChild(watermark);
        
        // ÁªÑË£ÖÊ®°ÊÄÅÊ°Ü
        container.appendChild(header);
        container.appendChild(content);
        modal.appendChild(container);
        document.body.appendChild(modal);
        
        // ÁªëÂÆöÂÖ≥Èó≠ÊåâÈíÆ‰∫ã‰ª∂
        const closeBtn = header.querySelector('.modal-close-btn');
        if (closeBtn) {
            closeBtn.addEventListener('click', function() {
                const modal = document.getElementById('chapterContentModal');
                if (modal) {
                    modal.remove();
                }
            });
        }
        
        // Ê∑ªÂä†ÂÖ≥Èó≠ÂäüËÉΩÔºàÁÇπÂáªËÉåÊôØÂÖ≥Èó≠Ôºâ
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
        
        // Ê∑ªÂä†ESCÈîÆÂÖ≥Èó≠
        const escHandler = (e) => {
            if (e.key === 'Escape') {
                modal.remove();
                document.removeEventListener('keydown', escHandler);
            }
        };
        document.addEventListener('keydown', escHandler);
        
        // Á¶ÅÊ≠¢ËÉåÊôØÊªöÂä®
        document.body.style.overflow = 'hidden';
        
        // ÊÅ¢Â§çÊªöÂä®ÔºàÂΩìÊ®°ÊÄÅÊ°ÜÂÖ≥Èó≠Êó∂Ôºâ
        const observer = new MutationObserver(() => {
            if (!document.getElementById('chapterContentModal')) {
                document.body.style.overflow = '';
                observer.disconnect();
            }
        });
        observer.observe(document.body, { childList: true });
    }

    // ÁÆÄÂçïÊ®°ÊÄÅÊ°ÜÔºàÈôçÁ∫ßÊñπÊ°àÔºâ
    function showSimpleModal(title, htmlContent) {
        // ÂàõÂª∫‰∏Ä‰∏™ÁÆÄÂçïÁöÑdivÊù•ÊòæÁ§∫ÂÜÖÂÆπ
        const modal = document.createElement('div');
        modal.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: white;
            border: 2px solid #ccc;
            border-radius: 10px;
            overflow: auto;
            z-index: 10001;
            padding: 20px;
            box-shadow: 0 10px 50px rgba(0,0,0,0.5);
        `;
        
        // ÂàõÂª∫‰∏Ä‰∏™‰∏¥Êó∂ÁöÑiframeÊù•ÈöîÁ¶ªÂÜÖÂÆπ
        const iframe = document.createElement('iframe');
        iframe.style.cssText = 'width: 100%; height: 100%; border: none;';
        modal.appendChild(iframe);
        
        // ÂàõÂª∫ËÉåÊôØÈÅÆÁΩ©
        const backdrop = document.createElement('div');
        backdrop.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
        `;
        
        document.body.appendChild(backdrop);
        document.body.appendChild(modal);
        
        // ÂßãÁªàÊ≥®ÂÖ•ÊâÄÊúâÂøÖË¶ÅÁöÑÂ∫ì
        const libraries = `
            <!-- Three.jsÊ†∏ÂøÉÂ∫ì -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"><\/script>
            
            <!-- Three.jsÊâ©Â±ï - ‰ΩøÁî®unpkg CDN -->
            <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"><\/script>
            <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/GLTFLoader.js"><\/script>
            <script src="https://unpkg.com/three@0.128.0/examples/js/loaders/OBJLoader.js"><\/script>
            
            <script>
                // Á°Æ‰øùTHREEÂíåÊâ©Â±ïÂú®ÂÖ®Â±Ä‰ΩúÁî®ÂüüÂèØÁî®
                if (typeof THREE !== 'undefined') {
                    window.THREE = THREE;
                    console.log('THREE.js and extensions loaded in iframe');
                }
            <\/script>
            
            <!-- GSAPÂä®ÁîªÂ∫ì -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/TextPlugin.min.js"><\/script>
            <script>
                window.gsap = window.gsap || gsap;
                if (window.gsap && window.ScrollTrigger) {
                    window.gsap.registerPlugin(window.ScrollTrigger);
                }
            <\/script>
            
            <!-- KaTeXÊï∞Â≠¶ÂÖ¨Âºè -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
            <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"><\/script>
            
            <!-- ‰ª£Á†ÅÈ´ò‰∫Æ -->
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github.min.css">
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/python.min.js"><\/script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/languages/javascript.min.js"><\/script>
            
            <!-- Chart.jsÂõæË°® -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"><\/script>
            
            <!-- Typed.js ÊâìÂ≠óÊú∫ÊïàÊûú -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/typed.js/2.0.16/typed.umd.js"><\/script>
            
            <!-- Particles.js Á≤íÂ≠êÊïàÊûú -->
            <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"><\/script>
            
            <!-- Tailwind CSS -->
            <script src="https://cdn.tailwindcss.com"><\/script>
        `;
        
        // Á°Æ‰øùÂÜÖÂÆπÂåÖÂê´ÂÆåÊï¥ÁöÑHTMLÁªìÊûÑÂíåÊâÄÊúâÂ∫ì
        if (!htmlContent.includes('<!DOCTYPE')) {
            htmlContent = `
                <!DOCTYPE html>
                <html lang="zh-CN">
                <head>
                    <meta charset="UTF-8">
                    <meta name="viewport" content="width=device-width, initial-scale=1.0">
                    <title>${title}</title>
                    ${libraries}
                    <style>
                        body {
                            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', 'Helvetica Neue', Helvetica, Arial, sans-serif;
                            line-height: 1.6;
                            color: #333;
                            padding: 20px;
                        }
                    </style>
                </head>
                <body>
                    ${htmlContent}
                </body>
                </html>
            `;
        } else if (htmlContent.includes('</head>')) {
            // Âú®</head>‰πãÂâçÊ≥®ÂÖ•Â∫ì
            htmlContent = htmlContent.replace('</head>', libraries + '\n</head>');
        } else if (htmlContent.includes('<head>')) {
            // Âú®<head>‰πãÂêéÊ≥®ÂÖ•Â∫ì
            htmlContent = htmlContent.replace('<head>', '<head>\n' + libraries);
        }
        
        // ÂÜôÂÖ•ÂÜÖÂÆπÂà∞iframe
        const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
        iframeDoc.open();
        iframeDoc.write(htmlContent);
        iframeDoc.close();
        
        // ÁÇπÂáªËÉåÊôØÂÖ≥Èó≠
        backdrop.addEventListener('click', () => {
            modal.remove();
            backdrop.remove();
        });
    }

</script>
</body>
</html>
