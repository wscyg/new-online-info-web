<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¤¾åŒºå¹¿åœº - AIå­¦ä¹ å¹³å°</title>
    <meta name="description" content="åˆ†äº«å­¦ä¹ å¿ƒå¾—ï¼Œæ¢ç´¢AIä¸–ç•Œ">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f8f8f8;
            color: #333;
        }

        /* å¯¼èˆªæ  */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            z-index: 1000;
            padding: 0 20px;
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 60px;
        }

        .nav-logo {
            font-size: 1.5rem;
            font-weight: bold;
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-search {
            flex: 1;
            max-width: 500px;
            margin: 0 40px;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 10px 40px 10px 15px;
            border: 1px solid #e8e8e8;
            border-radius: 20px;
            background: #f5f5f5;
            transition: all 0.3s;
        }

        .search-input:focus {
            outline: none;
            background: white;
            border-color: #ff6b6b;
        }

        .search-btn {
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            padding: 8px;
            cursor: pointer;
        }

        .nav-actions {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .publish-btn {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }

        .publish-btn:hover {
            transform: scale(1.05);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-container {
            max-width: 1200px;
            margin: 80px auto 20px;
            padding: 0 20px;
        }

        /* åˆ†ç±»æ ‡ç­¾ */
        .category-tabs {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            overflow-x: auto;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .category-tab {
            padding: 8px 20px;
            border-radius: 20px;
            background: #f5f5f5;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.3s;
            font-weight: 500;
        }

        .category-tab:hover {
            background: #ffe4e4;
        }

        .category-tab.active {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
        }

        /* ç€‘å¸ƒæµå¸ƒå±€ */
        .waterfall-container {
            -moz-column-count: 5;
                 column-count: 5;
            -moz-column-gap: 15px;
                 column-gap: 15px;
        }

        @media (max-width: 1200px) {
            .waterfall-container { -moz-column-count: 4; column-count: 4; }
        }

        @media (max-width: 900px) {
            .waterfall-container { -moz-column-count: 3; column-count: 3; }
        }

        @media (max-width: 600px) {
            .waterfall-container { -moz-column-count: 2; column-count: 2; }
        }

        /* ç¬”è®°å¡ç‰‡ */
        .note-card {
            -moz-column-break-inside: avoid;
                 break-inside: avoid;
            margin-bottom: 15px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: all 0.3s;
            cursor: pointer;
        }

        .note-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .note-cover {
            position: relative;
            width: 100%;
            overflow: hidden;
        }

        .note-cover img {
            width: 100%;
            height: auto;
            display: block;
        }

        .note-type-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
        }

        .note-content {
            padding: 12px;
        }

        .note-title {
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-desc {
            color: #666;
            font-size: 13px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .note-author {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 10px;
            border-top: 1px solid #f0f0f0;
        }

        .author-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .author-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .author-name {
            font-size: 13px;
            color: #333;
        }

        .note-likes {
            display: flex;
            align-items: center;
            gap: 4px;
            color: #999;
            font-size: 13px;
        }

        .like-icon {
            transition: color 0.3s;
        }

        .note-likes:hover .like-icon {
            color: #ff6b6b;
        }

        /* å‘å¸ƒå¼¹çª— */
        .publish-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .publish-modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }

        .form-input,
        .form-textarea {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-input:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #ff6b6b;
        }

        .form-textarea {
            min-height: 150px;
            resize: vertical;
        }

        .image-upload {
            border: 2px dashed #e8e8e8;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .image-upload:hover {
            border-color: #ff6b6b;
            background: #fff5f5;
        }

        .upload-icon {
            font-size: 48px;
            color: #ccc;
            margin-bottom: 10px;
        }

        .upload-text {
            color: #999;
            font-size: 14px;
        }

        .tag-input-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            min-height: 44px;
        }

        .tag-item {
            background: #f5f5f5;
            padding: 4px 12px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .tag-remove {
            cursor: pointer;
            color: #999;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .btn-default {
            background: #f5f5f5;
            color: #666;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff6b6b, #ff8787);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #ff6b6b;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ç©ºçŠ¶æ€ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #666;
        }

        .empty-desc {
            color: #999;
        }
    </style>
  <link rel="stylesheet" href="/assets/theme-b29253a3.css">
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-logo">ç¤¾åŒºå¹¿åœº</div>
            
            <div class="nav-search">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="æœç´¢ç¬”è®°ã€ç”¨æˆ·ã€æ ‡ç­¾...">
                    <button class="search-btn">ğŸ”</button>
                </div>
            </div>
            
            <div class="nav-actions">
                <button class="publish-btn" onclick="showPublishModal()">
                    âœ¨ å‘å¸ƒç¬”è®°
                </button>
                <a href="courses.html" style="text-decoration: none; color: #666;">è¿”å›è¯¾ç¨‹</a>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <div class="main-container">
        <!-- åˆ†ç±»æ ‡ç­¾å’Œæ’åº -->
        <div class="category-tabs">
            <button class="category-tab active" data-category="all">æ¨è</button>
            <button class="category-tab" data-category="interview">é¢è¯•ç»éªŒ</button>
            <button class="category-tab" data-category="offer">Offerè–ªèµ„</button>
            <button class="category-tab" data-category="tech">æŠ€æœ¯æ–‡ç« </button>
            <button class="category-tab" data-category="qa">çƒ­é—¨è®¨è®º</button>
        </div>
        
        <!-- æ’åºé€‰é¡¹ -->
        <div style="margin: 15px 0; text-align: right;">
            <select class="sort-select" style="padding: 8px 16px; border: 1px solid #e8e8e8; border-radius: 20px; background: white; cursor: pointer;" onchange="handleSortChange()">
                <option value="hot">ğŸ”¥ æœ€çƒ­é—¨</option>
                <option value="latest">ğŸ• æœ€æ–°å‘å¸ƒ</option>
                <option value="likes">â¤ï¸ æœ€å¤šç‚¹èµ</option>
                <option value="views">ğŸ‘ æœ€å¤šæµè§ˆ</option>
            </select>
        </div>

        <!-- ç€‘å¸ƒæµå†…å®¹ -->
        <div class="waterfall-container" id="notesContainer">
            <!-- ç¬”è®°å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>

        <!-- åŠ è½½æ›´å¤š -->
        <div class="loading-spinner" id="loadingSpinner" style="display: none;">
            <div class="spinner"></div>
            <p>åŠ è½½ä¸­...</p>
        </div>
    </div>

    <!-- å‘å¸ƒå¼¹çª— -->
    <div class="publish-modal" id="publishModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">å‘å¸ƒç¬”è®°</h3>
                <button class="close-btn" onclick="hidePublishModal()">Ã—</button>
            </div>
            
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">æ ‡é¢˜</label>
                    <input type="text" class="form-input" id="noteTitle" placeholder="è¾“å…¥ç¬”è®°æ ‡é¢˜...">
                </div>
                
                <div class="form-group">
                    <label class="form-label">å†…å®¹</label>
                    <textarea class="form-textarea" id="noteContent" placeholder="åˆ†äº«ä½ çš„å­¦ä¹ å¿ƒå¾—..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">å°é¢å›¾ç‰‡</label>
                    <div class="image-upload" onclick="selectImage()">
                        <div class="upload-icon">ğŸ“·</div>
                        <div class="upload-text">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</div>
                    </div>
                    <input type="file" id="imageInput" accept="image/*" style="display: none;">
                </div>
                
                <div class="form-group">
                    <label class="form-label">æ ‡ç­¾</label>
                    <div class="tag-input-container" id="tagContainer">
                        <input type="text" placeholder="æ·»åŠ æ ‡ç­¾..." style="border: none; outline: none; flex: 1; min-width: 100px;">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">åˆ†ç±»</label>
                    <select class="form-input" id="noteCategory">
                        <option value="ai">äººå·¥æ™ºèƒ½</option>
                        <option value="ml">æœºå™¨å­¦ä¹ </option>
                        <option value="dl">æ·±åº¦å­¦ä¹ </option>
                        <option value="nlp">è‡ªç„¶è¯­è¨€å¤„ç†</option>
                        <option value="cv">è®¡ç®—æœºè§†è§‰</option>
                        <option value="project">é¡¹ç›®å®æˆ˜</option>
                        <option value="interview">é¢è¯•ç»éªŒ</option>
                        <option value="resource">å­¦ä¹ èµ„æº</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-default" onclick="hidePublishModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="publishNote()">å‘å¸ƒ</button>
            </div>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ•°æ®
        const mockNotes = [
            {
                id: 1,
                title: "æ·±åº¦å­¦ä¹ å…¥é—¨ï¼šä»é›¶å¼€å§‹ç†è§£ç¥ç»ç½‘ç»œ",
                description: "æœ¬æ–‡è¯¦ç»†ä»‹ç»äº†ç¥ç»ç½‘ç»œçš„åŸºæœ¬æ¦‚å¿µï¼ŒåŒ…æ‹¬æ„ŸçŸ¥æœºã€å¤šå±‚æ„ŸçŸ¥æœºã€åå‘ä¼ æ’­ç®—æ³•ç­‰æ ¸å¿ƒçŸ¥è¯†ç‚¹...",
                cover: "",
                author: "AIå°è¾¾äºº",
                avatar: "A",
                likes: 1234,
                category: "dl",
                type: "article"
            },
            {
                id: 2,
                title: "ChatGPTåŸç†è§£æï¼šTransformeræ¶æ„æ·±åº¦å‰–æ",
                description: "æ·±å…¥ç†è§£Transformeræ¨¡å‹çš„è‡ªæ³¨æ„åŠ›æœºåˆ¶ã€ä½ç½®ç¼–ç ã€å¤šå¤´æ³¨æ„åŠ›ç­‰å…³é”®æŠ€æœ¯...",
                cover: "",
                author: "æŠ€æœ¯æå®¢",
                avatar: "T",
                likes: 2891,
                category: "nlp",
                type: "video"
            },
            {
                id: 3,
                title: "Pythonæœºå™¨å­¦ä¹ å®æˆ˜é¡¹ç›®ï¼šæˆ¿ä»·é¢„æµ‹ç³»ç»Ÿ",
                description: "ä½¿ç”¨scikit-learnæ„å»ºå®Œæ•´çš„æˆ¿ä»·é¢„æµ‹ç³»ç»Ÿï¼ŒåŒ…æ‹¬æ•°æ®é¢„å¤„ç†ã€ç‰¹å¾å·¥ç¨‹ã€æ¨¡å‹è®­ç»ƒä¸ä¼˜åŒ–...",
                cover: "",
                author: "ä»£ç ä¾ ",
                avatar: "C",
                likes: 567,
                category: "ml",
                type: "project"
            },
            {
                id: 4,
                title: "è®¡ç®—æœºè§†è§‰å…¥é—¨ï¼šOpenCVå›¾åƒå¤„ç†åŸºç¡€",
                description: "ä»é›¶å¼€å§‹å­¦ä¹ OpenCVï¼ŒæŒæ¡å›¾åƒè¯»å–ã€æ˜¾ç¤ºã€åŸºç¡€å˜æ¢ç­‰æ“ä½œ...",
                cover: "",
                author: "è§†è§‰è¾¾äºº",
                avatar: "V",
                likes: 892,
                category: "cv",
                type: "tutorial"
            },
            {
                id: 5,
                title: "AIé¢è¯•å¿…å¤‡ï¼šå¸¸è§ç®—æ³•é¢˜è§£æ",
                description: "æ•´ç†äº†å¤§å‚AIå²—ä½é¢è¯•ä¸­çš„é«˜é¢‘ç®—æ³•é¢˜ï¼ŒåŒ…æ‹¬åŠ¨æ€è§„åˆ’ã€è´ªå¿ƒç®—æ³•ã€å›¾ç®—æ³•ç­‰...",
                cover: "",
                author: "é¢è¯•å®˜",
                avatar: "M",
                likes: 3456,
                category: "interview",
                type: "article"
            },
            {
                id: 6,
                title: "YOLOç›®æ ‡æ£€æµ‹å®æˆ˜ï¼šè®­ç»ƒè‡ªå·±çš„æ•°æ®é›†",
                description: "æ‰‹æŠŠæ‰‹æ•™ä½ ä½¿ç”¨YOLOv5è®­ç»ƒè‡ªå®šä¹‰æ•°æ®é›†ï¼Œå®ç°ç›®æ ‡æ£€æµ‹åŠŸèƒ½...",
                cover: "",
                author: "å®æˆ˜æ´¾",
                avatar: "Y",
                likes: 1789,
                category: "cv",
                type: "project"
            },
            {
                id: 7,
                title: "å¼ºåŒ–å­¦ä¹ å…¥é—¨ï¼šQ-Learningç®—æ³•è¯¦è§£",
                description: "é€šè¿‡ç®€å•çš„ä¾‹å­ç†è§£Q-Learningç®—æ³•çš„åŸç†å’Œå®ç°è¿‡ç¨‹...",
                cover: "",
                author: "RLçˆ±å¥½è€…",
                avatar: "R",
                likes: 654,
                category: "ai",
                type: "article"
            },
            {
                id: 8,
                title: "å¤§æ¨¡å‹å¾®è°ƒæŠ€æœ¯ï¼šLoRAåŸç†ä¸å®è·µ",
                description: "è¯¦è§£LoRAæŠ€æœ¯åŸç†ï¼Œæ•™ä½ å¦‚ä½•é«˜æ•ˆå¾®è°ƒå¤§è¯­è¨€æ¨¡å‹...",
                cover: "",
                author: "æ¨¡å‹ä¸“å®¶",
                avatar: "L",
                likes: 2234,
                category: "dl",
                type: "tutorial"
            }
        ];

        let currentCategory = 'all';
        let isLoading = false;
        let page = 1;

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadNotesFromAPI();
            bindEvents();
        });

        // ä»APIåŠ è½½ç¬”è®°
        async function loadNotesFromAPI() {
            try {
                const token = localStorage.getItem('token');
                const headers = {};
                if (token) {
                    headers['Authorization'] = `Bearer ${token}`;
                }
                
                // è·å–æ’åºå‚æ•°
                const sort = document.querySelector('.sort-select')?.value || 'hot';
                
                const response = await fetch(`/api/community/notes?category=${currentCategory}&sort=${sort}&page=${page}&size=20`, {
                    headers: headers
                });
                const data = await response.json();
                
                if (data.success && data.data) {
                    const container = document.getElementById('notesContainer');
                    
                    // å¦‚æœæ˜¯ç¬¬ä¸€é¡µï¼Œæ¸…ç©ºå®¹å™¨
                    if (page === 1) {
                        container.innerHTML = '';
                    }
                    
                    // æ¸²æŸ“ç¬”è®°
                    data.data.items.forEach(note => {
                        container.innerHTML += createNoteCardFromAPI(note);
                    });
                    
                    // æ›´æ–°åˆ†é¡µçŠ¶æ€
                    if (!data.data.hasNext) {
                        page = -1; // æ²¡æœ‰æ›´å¤šæ•°æ®
                    }
                } else {
                    // APIå¤±è´¥ï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    loadNotes();
                }
            } catch (error) {
                console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
                // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                loadNotes();
            }
        }

        // HTML escaping function to prevent XSS
        function escapeHtml(unsafe) {
            if (unsafe == null) return '';
            return String(unsafe)
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        // Sanitize URL to prevent XSS
        function sanitizeUrl(url) {
            if (!url) return '';
            // Only allow http, https, and data URLs
            if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:')) {
                return url;
            }
            return '';
        }

        // åˆ›å»ºç¬”è®°å¡ç‰‡ï¼ˆAPIæ•°æ®ï¼‰
        function createNoteCardFromAPI(note) {
            const typeLabels = {
                'article': 'ğŸ“ æ–‡ç« ',
                'experience': 'ğŸ’¼ é¢ç»',
                'salary': 'ğŸ’° è–ªèµ„',
                'discussion': 'ğŸ’¬ è®¨è®º',
                'video': 'ğŸ“¹ è§†é¢‘',
                'project': 'ğŸ’» é¡¹ç›®',
                'tutorial': 'ğŸ“š æ•™ç¨‹'
            };

            const categoryLabels = {
                'interview': 'é¢è¯•',
                'offer': 'Offer',
                'tech': 'æŠ€æœ¯',
                'qa': 'é—®ç­”'
            };

            // å¤„ç†å°é¢å›¾ç‰‡
            let coverImage = '';
            if (note.coverImages && note.coverImages.length > 0) {
                coverImage = sanitizeUrl(note.coverImages[0]);
            }

            // å¤„ç†ä½œè€…ä¿¡æ¯
            const author = note.author || {};
            const authorName = escapeHtml(author.nickname || author.username || 'ç”¨æˆ·' + (note.userId || note.user_id));
            const authorAvatar = escapeHtml(author.avatar || authorName.charAt(0).toUpperCase());
            
            // Safely encode values
            const noteId = parseInt(note.id, 10) || 0;

            return `
                <div class="note-card" onclick="viewNoteDetail(${noteId})">
                    <div class="note-cover">
                        <img src="${coverImage}" alt="${escapeHtml(note.title)}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiPkFJPC90ZXh0Pjwvc3ZnPg=='">
                        <div class="note-type-badge">${typeLabels[escapeHtml(note.type)] || 'ğŸ“ ç¬”è®°'}</div>
                        ${note.isHot || note.is_hot ? '<div class="hot-badge" style="position: absolute; top: 10px; right: 10px; background: #ff4444; color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px;">ğŸ”¥ çƒ­é—¨</div>' : ''}
                    </div>
                    <div class="note-content">
                        <h3 class="note-title">${escapeHtml(note.title)}</h3>
                        <p class="note-desc">${escapeHtml(note.summary || note.description || '')}</p>
                        <div class="note-author">
                            <div class="author-info">
                                <div class="author-avatar">${authorAvatar}</div>
                                <span class="author-name">${authorName}</span>
                            </div>
                            <div class="note-likes">
                                <span class="like-icon">â¤ï¸</span>
                                <span>${formatNumber(note.likeCount || note.like_count || 0)}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ ¼å¼åŒ–æ•°å­—
        function formatNumber(num) {
            if (num >= 10000) {
                return (num / 10000).toFixed(1) + 'w';
            }
            if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'k';
            }
            return num.toString();
        }

        // æŸ¥çœ‹ç¬”è®°è¯¦æƒ…
        function viewNoteDetail(id) {
            window.location.href = `note-detail.html?id=${id}`;
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // åˆ†ç±»åˆ‡æ¢
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.category-tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    page = 1;
                    loadNotesFromAPI();
                });
            });

            // æ»šåŠ¨åŠ è½½æ›´å¤š
            window.addEventListener('scroll', () => {
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 100) {
                    if (!isLoading && page < 3) {  // é™åˆ¶æœ€å¤šåŠ è½½3é¡µ
                        loadMoreNotes();
                    }
                }
            });

            // å›¾ç‰‡ä¸Šä¼ 
            document.getElementById('imageInput').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const fileName = e.target.files[0].name;
                    document.querySelector('.upload-text').textContent = fileName;
                }
            });
        }

        // åŠ è½½ç¬”è®°
        function loadNotes() {
            const container = document.getElementById('notesContainer');
            
            // æ ¹æ®åˆ†ç±»ç­›é€‰
            let filteredNotes = currentCategory === 'all' 
                ? mockNotes 
                : mockNotes.filter(note => note.category === currentCategory);
            
            // åªç”Ÿæˆä¸€æ¬¡æ•°æ®ï¼Œé¿å…é‡å¤
            const extendedNotes = [];
            filteredNotes.forEach(note => {
                extendedNotes.push({
                    ...note,
                    id: note.id,
                    cover: note.cover || '',
                    likes: Math.floor(Math.random() * 5000)
                });
            });
            
            // æ¸²æŸ“ç¬”è®°
            extendedNotes.forEach(note => {
                container.innerHTML += createNoteCard(note);
            });
        }

        // åˆ›å»ºç¬”è®°å¡ç‰‡
        function createNoteCard(note) {
            const typeLabels = {
                'article': 'ğŸ“ æ–‡ç« ',
                'video': 'ğŸ“¹ è§†é¢‘',
                'project': 'ğŸ’» é¡¹ç›®',
                'tutorial': 'ğŸ“š æ•™ç¨‹'
            };
            
            return `
                <div class="note-card" onclick="viewNote(${note.id})">
                    <div class="note-cover">
                        <img src="${note.cover}" alt="${note.title}" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iNDAwIiBoZWlnaHQ9IjMwMCIgZmlsbD0iI2Y1ZjVmNSIvPjx0ZXh0IHRleHQtYW5jaG9yPSJtaWRkbGUiIHg9IjIwMCIgeT0iMTUwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMjQiIGZpbGw9IiM5OTkiPkFJPC90ZXh0Pjwvc3ZnPg=='">
                        <div class="note-type-badge">${typeLabels[note.type] || 'ğŸ“ ç¬”è®°'}</div>
                    </div>
                    <div class="note-content">
                        <h3 class="note-title">${note.title}</h3>
                        <p class="note-desc">${note.description}</p>
                        <div class="note-author">
                            <div class="author-info">
                                <div class="author-avatar">${note.avatar}</div>
                                <span class="author-name">${note.author}</span>
                            </div>
                            <div class="note-likes">
                                <span class="like-icon">â¤ï¸</span>
                                <span>${note.likes}</span>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // åŠ è½½æ›´å¤š
        function loadMoreNotes() {
            if (isLoading || page === -1) return;
            
            isLoading = true;
            document.getElementById('loadingSpinner').style.display = 'block';
            
            // å¢åŠ é¡µç å¹¶åŠ è½½
            page++;
            
            // è°ƒç”¨APIåŠ è½½æ›´å¤š
            loadNotesFromAPI().finally(() => {
                isLoading = false;
                document.getElementById('loadingSpinner').style.display = 'none';
            });
        }

        // æŸ¥çœ‹ç¬”è®°
        function viewNote(id) {
            // Validate ID to prevent injection
            const noteId = parseInt(id, 10);
            if (!noteId || noteId < 1) {
                console.error('Invalid note ID');
                return;
            }
            console.log('æŸ¥çœ‹ç¬”è®°:', noteId);
            window.location.href = `note-detail.html?id=${noteId}`;
        }

        // å¤„ç†æ’åºå˜åŒ–
        function handleSortChange() {
            page = 1;
            loadNotesFromAPI();
        }

        // æ˜¾ç¤ºå‘å¸ƒå¼¹çª—
        function showPublishModal() {
            document.getElementById('publishModal').classList.add('show');
        }

        // éšè—å‘å¸ƒå¼¹çª—
        function hidePublishModal() {
            document.getElementById('publishModal').classList.remove('show');
        }

        // é€‰æ‹©å›¾ç‰‡
        function selectImage() {
            document.getElementById('imageInput').click();
        }

        // å‘å¸ƒç¬”è®°
        function publishNote() {
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            const category = document.getElementById('noteCategory').value;
            
            if (!title || !content) {
                alert('è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
                return;
            }
            
            // è¿™é‡Œè°ƒç”¨APIå‘å¸ƒç¬”è®°
            console.log('å‘å¸ƒç¬”è®°:', { title, content, category });
            
            // æ¨¡æ‹Ÿå‘å¸ƒæˆåŠŸ
            alert('å‘å¸ƒæˆåŠŸï¼');
            hidePublishModal();
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('noteTitle').value = '';
            document.getElementById('noteContent').value = '';
            document.getElementById('noteCategory').value = 'ai';
        }
    </script>
</body>
</html>