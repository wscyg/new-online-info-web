<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #0f172a; }
        iframe { width: 100%; height: 100%; border: none; display: none; }
        .status-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; color: white; font-family: sans-serif; text-align: center; padding: 1rem; }
        .status-container h1 { font-size: 1.5rem; }
        .status-container p { color: #cbd5e1; }
        .status-container pre { background: #1e293b; padding: 1rem; border-radius: 8px; margin-top: 1rem; text-align: left; max-width: 90%; overflow-x: auto; font-size: 0.8rem; color: #ef4444; }
    </style>
</head>
<body>
    <div id="status" class="status-container"><h1>ğŸš€ æ­£åœ¨åˆå§‹åŒ–å­¦ä¹ ç¯å¢ƒ...</h1></div>
    <iframe id="contentFrame" sandbox="allow-scripts allow-same-origin"></iframe>

    <script>
        const statusContainer = document.getElementById('status');
        const contentFrame = document.getElementById('contentFrame');

        // å­¦ä¹ ä¼šè¯è·Ÿè¸ªå˜é‡
        let currentSessionId = null;
        let heartbeatInterval = null;
        let currentCourseId = null;
        let currentChapterId = null;

        function showStatus(title, message = '', error = null) {
            let html = `<h1>${title}</h1>`;
            if (message) html += `<p>${message}</p>`;
            if (error) html += `<pre>é”™è¯¯è¯¦æƒ…: ${error.message || JSON.stringify(error)}</pre>`;
            statusContainer.innerHTML = html;
        }

        // è·å–API Base URL
        function getApiBase() {
            return window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                ? 'http://localhost:8080/api'
                : 'http://42.194.245.66/api';
        }

        // å¼€å§‹å­¦ä¹ ä¼šè¯
        async function startStudySession(courseId, chapterId) {
            try {
                const token = localStorage.getItem('token');
                if (!token) {
                    console.log('ç”¨æˆ·æœªç™»å½•ï¼Œè·³è¿‡ä¼šè¯è·Ÿè¸ª');
                    return;
                }

                const response = await fetch(`${getApiBase()}/study-sessions/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        courseId: courseId,
                        chapterId: chapterId,
                        deviceType: 'web'
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.code === 200 && data.data) {
                        currentSessionId = data.data.sessionId;
                        console.log('âœ… å­¦ä¹ ä¼šè¯å·²å¼€å§‹:', currentSessionId);

                        // å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨ï¼ˆæ¯2åˆ†é’Ÿï¼‰
                        startHeartbeat();
                    }
                }
            } catch (error) {
                console.error('å¼€å§‹å­¦ä¹ ä¼šè¯å¤±è´¥:', error);
            }
        }

        // å¿ƒè·³ä¿æŒä¼šè¯æ´»è·ƒ
        async function sendHeartbeat() {
            if (!currentSessionId) return;

            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                await fetch(`${getApiBase()}/study-sessions/heartbeat`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId
                    })
                });
            } catch (error) {
                console.error('å¿ƒè·³å‘é€å¤±è´¥:', error);
            }
        }

        // å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨
        function startHeartbeat() {
            if (heartbeatInterval) {
                clearInterval(heartbeatInterval);
            }

            // æ¯2åˆ†é’Ÿå‘é€ä¸€æ¬¡å¿ƒè·³
            heartbeatInterval = setInterval(() => {
                sendHeartbeat();
            }, 120000); // 120ç§’ = 2åˆ†é’Ÿ
        }

        // ç»“æŸå­¦ä¹ ä¼šè¯
        async function endStudySession() {
            if (!currentSessionId) return;

            try {
                const token = localStorage.getItem('token');
                if (!token) return;

                // ä½¿ç”¨ keepalive ç¡®ä¿è¯·æ±‚åœ¨é¡µé¢å¸è½½æ—¶ä¹Ÿèƒ½å‘é€
                await fetch(`${getApiBase()}/study-sessions/end`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: currentSessionId
                    }),
                    keepalive: true
                });

                console.log('âœ… å­¦ä¹ ä¼šè¯å·²ç»“æŸ');

                // æ¸…ç†
                if (heartbeatInterval) {
                    clearInterval(heartbeatInterval);
                    heartbeatInterval = null;
                }
                currentSessionId = null;
            } catch (error) {
                console.error('ç»“æŸå­¦ä¹ ä¼šè¯å¤±è´¥:', error);
            }
        }

        // é¡µé¢å¸è½½æ—¶ç»“æŸä¼šè¯
        window.addEventListener('beforeunload', () => {
            endStudySession();
        });

        // é¡µé¢éšè—æ—¶ä¹Ÿç»“æŸä¼šè¯ï¼ˆç”¨æˆ·åˆ‡æ¢æ ‡ç­¾é¡µæˆ–æœ€å°åŒ–ï¼‰
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                endStudySession();
            }
        });

        (async function loadChapter() {
            try {
                // 1. è·å– chapterId
                const urlParams = new URLSearchParams(window.location.search);
                const chapterId = urlParams.get('chapterId');
                const courseId = urlParams.get('courseId');

                if (!chapterId) throw new Error('URLä¸­ç¼ºå°‘ chapterId å‚æ•°');

                // ä¿å­˜å½“å‰è¯¾ç¨‹å’Œç« èŠ‚ID
                currentChapterId = chapterId;
                currentCourseId = courseId;

                showStatus('ğŸš€ æ­£åœ¨è·å–ç« èŠ‚å†…å®¹...', `ç« èŠ‚ID: ${chapterId}`);

                // 2. è·å–åç«¯çš„JSONå“åº”
                const apiBase = getApiBase();
                const response = await fetch(`${apiBase}/content/chapters/${chapterId}`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token') || ''}` }
                });
                if (!response.ok) throw new Error(`æœåŠ¡å™¨è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€: ${response.status}`);

                const data = await response.json();
                console.log('APIå“åº”æ•°æ®:', data);

                if (data.code !== 200 || !data.data?.content?.contentHtml) {
                    console.error('APIå“åº”æ ¼å¼ä¸æ­£ç¡®:', data);
                    throw new Error(data.message || 'APIå“åº”æ ¼å¼ä¸æ­£ç¡®æˆ–æœªåŒ…å«HTMLå†…å®¹');
                }

                // å¦‚æœè¿”å›çš„æ•°æ®ä¸­åŒ…å«courseIdï¼Œä½¿ç”¨å®ƒ
                if (data.data.courseId) {
                    currentCourseId = data.data.courseId;
                }

                let htmlText = data.data.content.contentHtml;
                console.log('è·å–åˆ°HTMLå†…å®¹é•¿åº¦:', htmlText.length);

                // 3. å¤„ç†åç«¯è¿”å›çš„HTMLå†…å®¹
                let processedHtml = htmlText;

                // æ·»åŠ å®‰å…¨çš„CSPå¤´éƒ¨
                const cspMeta = `<meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; img-src 'self' data: https:;">`;

                // æ³¨å…¥baseæ ‡ç­¾å’Œå¯¼èˆªä¿®å¤è„šæœ¬
                const baseTag = `<base href="${window.location.origin}/">`;
                const navFixScript = `
                    <script>
                        // é˜²æ­¢ç« èŠ‚å†…å¯¼èˆªè·³è½¬
                        document.addEventListener('DOMContentLoaded', function() {
                            // ç§»é™¤æˆ–ç¦ç”¨å¯¼èˆªé“¾æ¥
                            const navLinks = document.querySelectorAll('nav a, .nav a');
                            navLinks.forEach(link => {
                                link.addEventListener('click', function(e) {
                                    e.preventDefault();
                                    // æ»šåŠ¨åˆ°å¯¹åº”é”šç‚¹è€Œä¸æ˜¯è·³è½¬
                                    const href = this.getAttribute('href');
                                    if (href && href.startsWith('#')) {
                                        const target = document.querySelector(href);
                                        if (target) {
                                            target.scrollIntoView({ behavior: 'smooth' });
                                        }
                                    }
                                });
                            });

                            // å¤„ç†å¯èƒ½å¯¼è‡´é¡µé¢è·³è½¬çš„å…¶ä»–é“¾æ¥
                            const allLinks = document.querySelectorAll('a[href]');
                            allLinks.forEach(link => {
                                const href = link.getAttribute('href');
                                // å¦‚æœæ˜¯å¤–éƒ¨é“¾æ¥æˆ–ä¼šå¯¼è‡´è·³è½¬çš„é“¾æ¥ï¼Œåœ¨æ–°çª—å£æ‰“å¼€
                                if (href && !href.startsWith('#') && !href.startsWith('javascript:')) {
                                    link.setAttribute('target', '_blank');
                                    link.setAttribute('rel', 'noopener noreferrer');
                                }
                            });
                        });
                    </script>
                `;
                processedHtml = processedHtml.replace(/<head>/i, `<head>\n    ${cspMeta}\n    ${baseTag}\n    ${navFixScript}`);

                // 5. åˆ›å»º Blob å¹¶åŠ è½½åˆ° iframe
                const blob = new Blob([processedHtml], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                contentFrame.src = blobUrl;

                contentFrame.onload = () => {
                    statusContainer.style.display = 'none';
                    contentFrame.style.display = 'block';
                    console.log('âœ… ç« èŠ‚å†…å®¹åŠ è½½å®Œæˆ');

                    // ç« èŠ‚åŠ è½½å®Œæˆåï¼Œå¼€å§‹å­¦ä¹ ä¼šè¯
                    if (currentCourseId && currentChapterId) {
                        startStudySession(currentCourseId, currentChapterId);
                    }
                };

            } catch (error) {
                console.error('åŠ è½½ç« èŠ‚çš„å®Œæ•´æµç¨‹å¤±è´¥:', error);
                showStatus('âŒ åŠ è½½ç« èŠ‚å¤±è´¥', 'æ— æ³•æ­£ç¡®åŠ è½½å­¦ä¹ å†…å®¹ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–è”ç³»ç®¡ç†å‘˜ã€‚', error);
            }
        })();
    </script>
</body>
</html>