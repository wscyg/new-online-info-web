<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>安全支付 - AI 信息未来</title>
    <meta name="description" content="安全便捷的支付体验，多种支付方式">
    
    <style>
        /* === 支付页面样式 === */
        body {
            min-height: 100vh;
            padding-top: 48px;
        }

        main {
            padding: 48px 0 80px;
        }

        /* === 支付步骤 === */
        .payment-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-bottom: 48px;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .step-circle {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 17px;
            font-weight: 600;
            color: var(--text-tertiary);
            transition: all var(--transition-normal);
        }

        .step.active .step-circle {
            background: var(--accent);
            border-color: var(--accent);
            color: #fff;
        }

        .step-label {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .step.active .step-label {
            color: var(--text-primary);
            font-weight: 500;
        }

        .step-line {
            width: 60px;
            height: 2px;
            background: var(--border-color);
            margin-bottom: 28px;
        }

        /* === 支付布局 === */
        .payment-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 32px;
            max-width: 1024px;
            margin: 0 auto;
            padding: 0 22px;
        }

        /* === 支付方式 === */
        .payment-section {
            margin-bottom: 32px;
        }

        .section-header {
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .section-subtitle {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .payment-methods {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-method {
            display: flex;
            align-items: center;
            padding: 20px;
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .payment-method:hover {
            border-color: var(--accent);
        }

        .payment-method.active {
            border-color: var(--accent);
            background: rgba(0, 113, 227, 0.05);
        }

        .payment-method.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .payment-method.disabled:hover {
            border-color: var(--border-color);
        }

        .method-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 16px;
            flex-shrink: 0;
        }

        .method-icon svg {
            width: 32px;
            height: 32px;
        }

        .method-info {
            flex: 1;
        }

        .method-name {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .method-desc {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .method-tag {
            font-size: 12px;
            color: #ff3b30;
            margin-left: 8px;
        }

        .method-check {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .payment-method.active .method-check {
            border-color: var(--accent);
            background: var(--accent);
        }

        .payment-method.active .method-check::after {
            content: '✓';
            color: #fff;
            font-size: 14px;
            font-weight: 600;
        }

        /* === 推荐人 === */
        .referrer-section {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 20px;
            margin-bottom: 32px;
        }

        .referrer-title {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .referrer-optional {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-left: 4px;
        }

        .referrer-input {
            width: 100%;
            margin-top: 12px;
            padding: 14px 16px;
            font-size: 17px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            transition: all var(--transition-fast);
        }

        .referrer-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.1);
        }

        .referrer-hint {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-top: 8px;
        }

        .referrer-status {
            margin-top: 8px;
            padding: 8px 12px;
            border-radius: var(--radius-sm);
            font-size: 13px;
            display: none;
        }

        .referrer-status.valid {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
            display: block;
        }

        .referrer-status.invalid {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
            display: block;
        }

        /* === 支付按钮 === */
        .payment-action {
            position: sticky;
            top: 64px;
        }

        .btn-pay {
            width: 100%;
            padding: 18px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: var(--radius-full);
            font-size: 19px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-pay:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(0, 113, 227, 0.3);
        }

        .btn-pay:active {
            transform: translateY(0);
        }

        .btn-pay:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .payment-security {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 24px;
            margin-top: 16px;
        }

        .security-item {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .security-icon {
            width: 14px;
            height: 14px;
        }

        /* === 订单摘要 === */
        .order-summary {
            position: sticky;
            top: 64px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 16px;
        }

        .order-number {
            font-size: 13px;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .order-item {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .item-cover {
            width: 80px;
            height: 80px;
            border-radius: var(--radius-md);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
        }

        .item-title {
            font-size: 17px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .item-meta {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .price-divider {
            height: 1px;
            background: var(--border-color);
            margin: 20px 0;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-size: 15px;
        }

        .price-label {
            color: var(--text-secondary);
        }

        .price-value {
            color: var(--text-primary);
            font-weight: 500;
        }

        .price-total {
            font-size: 19px;
            font-weight: 600;
        }

        .price-total .price-value {
            color: var(--accent);
            font-size: 24px;
        }

        .security-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            background: rgba(52, 199, 89, 0.1);
            border-radius: var(--radius-md);
            color: #34c759;
            font-size: 13px;
            font-weight: 500;
            margin-top: 16px;
        }

        /* === 免费课程提示 === */
        .free-notice {
            background: linear-gradient(135deg, #34c759, #30d158);
            color: #fff;
            border-radius: var(--radius-lg);
            padding: 24px;
            text-align: center;
            margin-bottom: 32px;
        }

        .free-notice h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .free-notice p {
            font-size: 15px;
            opacity: 0.9;
        }

        /* === 模态框 === */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-normal);
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            padding: 32px;
            max-width: 480px;
            width: 90%;
            box-shadow: var(--shadow-lg);
            transform: scale(0.95);
            transition: transform var(--transition-normal);
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .modal-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .modal-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 24px;
        }

        .confirm-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .confirm-row:last-child {
            border-bottom: none;
        }

        .confirm-label {
            font-size: 15px;
            color: var(--text-secondary);
        }

        .confirm-value {
            font-size: 15px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
        }

        .modal-actions .btn {
            flex: 1;
        }

        .btn-cancel {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .btn-cancel:hover {
            background: var(--bg-hover);
        }

        /* === 成功动画 === */
        .success-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: #34c759;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 48px;
            animation: successPulse 0.6s ease-out;
        }

        @keyframes successPulse {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.1);
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .success-message {
            text-align: center;
            margin-bottom: 32px;
        }

        .success-message h3 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        .success-message p {
            font-size: 15px;
        }

        .success-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* === 响应式 === */
        @media (max-width: 768px) {
            .payment-layout {
                grid-template-columns: 1fr;
            }

            .order-summary {
                position: static;
            }

            .payment-steps {
                gap: 12px;
            }

            .step-line {
                width: 30px;
            }

            .step-circle {
                width: 40px;
                height: 40px;
            }
        }
    </style>
  <link rel="stylesheet" href="/assets/apple-design-5104bdc3.css">
</head>
<body data-theme="light">
    <!-- 导航栏 -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="../index.html" class="nav-logo">AI 信息未来</a>
            <div class="nav-menu">
                <a href="../index.html" class="nav-link">首页</a>
                <a href="courses.html" class="nav-link">课程</a>
                <a href="community.html" class="nav-link">社区</a>
                <a href="arena.html" class="nav-link">PK竞技</a>
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="切换主题">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"/>
                        <line x1="12" y1="1" x2="12" y2="3"/>
                        <line x1="12" y1="21" x2="12" y2="23"/>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                        <line x1="1" y1="12" x2="3" y2="12"/>
                        <line x1="21" y1="12" x2="23" y2="12"/>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                    </svg>
                </button>
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" onclick="toggleUserMenu()">
                        <span id="userInitial">U</span>
                    </div>
                    <div class="dropdown" id="userDropdown">
                        <div class="dropdown-item" onclick="goToProfile()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                            <span>个人中心</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item" onclick="logout()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                                <polyline points="16 17 21 12 16 7"/>
                                <line x1="21" y1="12" x2="9" y2="12"/>
                            </svg>
                            <span>退出登录</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main>
        <div class="container">
            <!-- 支付步骤 -->
            <div class="payment-steps">
                <div class="step active">
                    <div class="step-circle">1</div>
                    <div class="step-label">确认订单</div>
                </div>
                <div class="step-line"></div>
                <div class="step active">
                    <div class="step-circle">2</div>
                    <div class="step-label">选择支付</div>
                </div>
                <div class="step-line"></div>
                <div class="step">
                    <div class="step-circle">3</div>
                    <div class="step-label">支付完成</div>
                </div>
            </div>

            <!-- 免费课程提示 -->
            <div id="freeNotice" class="free-notice" style="display: none;">
                <h3>免费课程</h3>
                <p>这是一门免费课程，您可以直接开始学习</p>
            </div>

            <!-- 支付布局 -->
            <div class="payment-layout">
                <!-- 左侧：支付方式 -->
                <div>
                    <!-- 支付方式选择 -->
                    <div class="payment-section">
                        <div class="section-header">
                            <h2 class="section-title">选择支付方式</h2>
                            <p class="section-subtitle">安全快捷的支付体验</p>
                        </div>

                        <div class="payment-methods">
                            <!-- 支付宝 -->
                            <div class="payment-method active" data-method="alipay" onclick="selectPaymentMethod('alipay')">
                                <div class="method-icon">
                                    <svg viewBox="0 0 1024 1024" fill="#00A0E9">
                                        <path d="M512 0C228.4 0 0 228.4 0 512s228.4 512 512 512 512-228.4 512-512S795.6 0 512 0z"/>
                                        <path d="M780.8 612.8c-12.8 8-156.8 68-292.8 68-80.8 0-144-35.2-152-96 0-57.6 64-103.6 176-103.6 104 0 200 56 200 104v8H336c8 64 80 112 176 112 104 0 192-48 200-112 8-32 32-56 68.8 19.2z" fill="#fff"/>
                                    </svg>
                                </div>
                                <div class="method-info">
                                    <div class="method-name">支付宝</div>
                                    <div class="method-desc">支持余额、余额宝、银行卡支付</div>
                                </div>
                                <div class="method-check"></div>
                            </div>

                            <!-- 微信支付 -->
                            <div class="payment-method disabled" data-method="wechat">
                                <div class="method-icon">
                                    <svg viewBox="0 0 1024 1024" fill="#09BB07">
                                        <path d="M664.2 370.4c-12.8 0-25.3.8-37.6 2.3C585.8 264.2 469 192 334.3 192 166.9 192 32 302.8 32 442.3c0 89.6 48.2 163.2 128.5 220.3l-32.1 96.3L238 711.4c40.1 8 73.4 16.1 112.7 16.1 12.8 0 25.3-.8 37.6-2.3 40.8 108.5 157.6 180.7 292.3 180.7 40.1 0 80.2-8 120.3-16.1l89.4 48.2-24.1-80.2c64.2-48.2 104.3-113.1 104.3-188.5 0-139.5-128.5-250.3-306.5-298.9z m-408.2 58.2c-20.1 0-36.2-16.1-36.2-36.2s16.1-36.2 36.2-36.2 36.2 16.1 36.2 36.2-16.1 36.2-36.2 36.2z m192.5 0c-20.1 0-36.2-16.1-36.2-36.2s16.1-36.2 36.2-36.2 36.2 16.1 36.2 36.2-16.1 36.2-36.2 36.2z"/>
                                    </svg>
                                </div>
                                <div class="method-info">
                                    <div class="method-name">
                                        微信支付
                                        <span class="method-tag">即将开通</span>
                                    </div>
                                    <div class="method-desc">微信安全支付，支持零钱、银行卡</div>
                                </div>
                                <div class="method-check"></div>
                            </div>

                            <!-- 银行卡 -->
                            <div class="payment-method disabled" data-method="card">
                                <div class="method-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="var(--text-secondary)" stroke-width="2">
                                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                                        <line x1="1" y1="10" x2="23" y2="10"/>
                                    </svg>
                                </div>
                                <div class="method-info">
                                    <div class="method-name">
                                        银行卡支付
                                        <span class="method-tag">即将开通</span>
                                    </div>
                                    <div class="method-desc">支持储蓄卡、信用卡直接支付</div>
                                </div>
                                <div class="method-check"></div>
                            </div>
                        </div>
                    </div>

                    <!-- 推荐人信息 -->
                    <div class="referrer-section">
                        <div class="referrer-title">
                            推荐人信息
                            <span class="referrer-optional">(可选)</span>
                        </div>
                        <input
                            type="text"
                            id="referrerCode"
                            class="referrer-input"
                            placeholder="请输入推荐人ID或手机号"
                            maxlength="50"
                        >
                        <div class="referrer-hint">填写推荐人信息可获得额外优惠和积分奖励</div>
                        <div id="referrerStatus" class="referrer-status"></div>
                    </div>

                    <!-- 支付按钮 -->
                    <div class="payment-action">
                        <button class="btn-pay" id="payButton" onclick="processPay()">
                            <span>立即支付 </span>
                            <span id="payAmount">¥0.00</span>
                        </button>
                        <div class="payment-security">
                            <div class="security-item">
                                <svg class="security-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="11" width="18" height="11" rx="2"/>
                                    <path d="M7 11V7a5 5 0 0 1 10 0v4"/>
                                </svg>
                                <span>银行级加密</span>
                            </div>
                            <div class="security-item">
                                <svg class="security-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                                </svg>
                                <span>实时风控</span>
                            </div>
                            <div class="security-item">
                                <svg class="security-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="20 6 9 17 4 12"/>
                                </svg>
                                <span>资金保障</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧：订单摘要 -->
                <div class="order-summary">
                    <div class="summary-card">
                        <div class="order-number">订单号: <span id="orderNumber">-</span></div>

                        <!-- 订单内容 -->
                        <div id="orderItems"></div>

                        <div class="price-divider"></div>

                        <!-- 价格明细 -->
                        <div id="priceBreakdown"></div>

                        <div class="price-divider"></div>

                        <!-- 总价 -->
                        <div class="price-row price-total">
                            <span class="price-label">实付金额</span>
                            <span class="price-value" id="totalAmount">¥0.00</span>
                        </div>

                        <!-- 安全标识 -->
                        <div class="security-badge">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
                            </svg>
                            <span>安全支付保障</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 支付确认模态框 -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-icon">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <line x1="1" y1="10" x2="23" y2="10"/>
                    </svg>
                </div>
                <h3 class="modal-title">确认支付</h3>
            </div>
            <div class="modal-body">
                <div class="confirm-row">
                    <span class="confirm-label">支付方式</span>
                    <span class="confirm-value" id="confirmMethod">支付宝</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-label">支付金额</span>
                    <span class="confirm-value" id="confirmAmount">¥0.00</span>
                </div>
                <div class="confirm-row">
                    <span class="confirm-label">课程名称</span>
                    <span class="confirm-value" id="confirmCourse">-</span>
                </div>
                <div class="confirm-row" id="confirmReferrerRow" style="display: none;">
                    <span class="confirm-label">推荐人</span>
                    <span class="confirm-value" id="confirmReferrer">-</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-cancel" onclick="hidePaymentModal()">取消</button>
                <button class="btn btn-primary" onclick="confirmPayment()">确认支付</button>
            </div>
        </div>
    </div>

    <!-- 支付成功模态框 -->
    <div id="successModal" class="modal">
        <div class="modal-content">
            <div class="success-icon">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="3">
                    <polyline points="20 6 9 17 4 12"/>
                </svg>
            </div>
            <div class="success-message">
                <h3>支付成功！</h3>
                <p>恭喜您成功购买课程，现在就开始学习吧</p>
            </div>
            <div class="success-actions">
                <button class="btn btn-primary" onclick="startLearning()">立即学习</button>
                <button class="btn btn-secondary" onclick="viewOrder()">查看订单</button>
            </div>
        </div>
    </div>

    <!-- 脚本 -->
    <script>
        const API_BASE = '/api';
        let courseData = null;
        let orderData = null;
        let currentPaymentMethod = 'alipay';
        let referrerValidationTimeout;

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 检查认证
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html?redirect=' + encodeURIComponent(window.location.pathname + window.location.search);
                return;
            }

            // 加载主题
            loadTheme();

            // 加载用户信息
            await loadUserInfo();

            // 获取课程ID
            const urlParams = new URLSearchParams(window.location.search);
            const courseId = urlParams.get('courseId');
            const orderId = urlParams.get('orderId');

            if (orderId) {
                // 从订单加载
                await loadOrderData(orderId);
            } else if (courseId) {
                // 从课程创建订单
                await loadCourseData(courseId);
            } else {
                showToast('缺少必要参数');
                setTimeout(() => window.location.href = 'courses.html', 2000);
            }

            // 初始化推荐人验证
            initReferrerValidation();

            // 从URL获取推荐人
            const referrer = urlParams.get('referrer') || urlParams.get('ref');
            if (referrer) {
                document.getElementById('referrerCode').value = referrer;
                validateReferrer(referrer);
            }
        });

        // 加载用户信息
        async function loadUserInfo() {
            try {
                const response = await fetch(`${API_BASE}/user/profile`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('加载用户信息失败');
                const result = await response.json();
                const user = result?.data?.user;
                const initial = user?.username ? user.username.charAt(0).toUpperCase() : 'U';
                document.getElementById('userInitial').textContent = initial;
            } catch (error) {
                console.error('加载用户信息失败:', error);
            }
        }

        // 加载课程数据
        async function loadCourseData(courseId) {
            try {
                const response = await fetch(`${API_BASE}/courses/${courseId}`);
                if (!response.ok) throw new Error('加载课程失败');

                const result = await response.json();
                courseData = result?.data?.course;
                if (!courseData) throw new Error(result?.message || '课程数据为空');

                // 检查是否免费课程
                if (courseData.price === 0 || courseData.isFree) {
                    showFreeCourse();
                    return;
                }

                // 订单号由后端创建订单时生成
                document.getElementById('orderNumber').textContent = '待创建';

                // 显示订单信息
                displayOrderInfo();
            } catch (error) {
                console.error('加载课程失败:', error);
                showToast('加载课程信息失败');
            }
        }

        // 加载订单数据
        async function loadOrderData(orderId) {
            try {
                const response = await fetch(`${API_BASE}/orders/${orderId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) throw new Error('加载订单失败');

                const result = await response.json();
                orderData = result?.data;
                if (!orderData) throw new Error(result?.message || '订单数据为空');

                document.getElementById('orderNumber').textContent = orderData.orderNo || String(orderId);
                displayOrderInfo();
            } catch (error) {
                console.error('加载订单失败:', error);
                showToast('加载订单信息失败');
            }
        }

	        // 显示订单信息
	        function displayOrderInfo() {
	            const data = orderData || courseData;
	            if (!data) return;

	            const isOrder = !!data.orderNo || data.finalAmount != null;
	            const title = data.title || data.courseName || '课程';

            // 订单项
            const orderItems = document.getElementById('orderItems');
            orderItems.innerHTML = `
                <div class="order-item">
                    <div class="item-cover"></div>
                    <div class="item-info">
                        <div class="item-title">${title}</div>
                        <div class="item-meta">${data.instructor || data.teacher || '在线学习'}</div>
                    </div>
                </div>
            `;

	            // 价格明细
	            const price = isOrder
	                ? parseFloat(data.originalAmount ?? data.finalAmount ?? 0)
	                : parseFloat(data.price ?? data.amount ?? 0);
            const discount = isOrder
                ? parseFloat(data.discountAmount ?? 0)
                : parseFloat(data.discount ?? 0);
            const finalPrice = isOrder
                ? parseFloat(data.finalAmount ?? (price - discount))
                : (price - discount);

	            const priceBreakdown = document.getElementById('priceBreakdown');
	            const priceLabel = (isOrder && data.orderType === 'vip_subscription') ? '会员价格' : '课程价格';
	            let html = `<div class="price-row">
	                <span class="price-label">${priceLabel}</span>
	                <span class="price-value">¥${price.toFixed(2)}</span>
	            </div>`;

            if (discount > 0) {
                html += `<div class="price-row">
                    <span class="price-label">优惠折扣</span>
                    <span class="price-value" style="color: #ff3b30;">-¥${discount.toFixed(2)}</span>
                </div>`;
            }

            priceBreakdown.innerHTML = html;

            // 总价
            document.getElementById('totalAmount').textContent = `¥${finalPrice.toFixed(2)}`;
            document.getElementById('payAmount').textContent = `¥${finalPrice.toFixed(2)}`;
            document.getElementById('confirmAmount').textContent = `¥${finalPrice.toFixed(2)}`;
            document.getElementById('confirmCourse').textContent = title;
        }

        // 显示免费课程
        function showFreeCourse() {
            document.getElementById('freeNotice').style.display = 'block';
            document.querySelector('.payment-layout').style.display = 'none';

            setTimeout(() => {
                window.location.href = `course-detail.html?id=${courseData.id}`;
            }, 2000);
        }

        // 选择支付方式
        function selectPaymentMethod(method) {
            const methods = document.querySelectorAll('.payment-method');
            methods.forEach(m => {
                if (m.dataset.method === method && !m.classList.contains('disabled')) {
                    m.classList.add('active');
                    currentPaymentMethod = method;
                } else {
                    m.classList.remove('active');
                }
            });

            // 更新确认框
            const methodNames = {
                'alipay': '支付宝',
                'wechat': '微信支付',
                'card': '银行卡支付'
            };
            document.getElementById('confirmMethod').textContent = methodNames[method] || '支付宝';
        }

        // 推荐人验证
        function initReferrerValidation() {
            const input = document.getElementById('referrerCode');
            input.addEventListener('input', (e) => {
                const value = e.target.value.trim();
                clearTimeout(referrerValidationTimeout);

                const status = document.getElementById('referrerStatus');
                status.className = 'referrer-status';

                if (!value) return;

                if (value.length < 3) {
                    status.textContent = '推荐人信息至少需要3个字符';
                    status.className = 'referrer-status invalid';
                    return;
                }

                referrerValidationTimeout = setTimeout(() => {
                    validateReferrer(value);
                }, 800);
            });
        }

        // 验证推荐人
        async function validateReferrer(code) {
            const status = document.getElementById('referrerStatus');

            // 简单的格式验证
            const validPatterns = [
                /^[0-9]{6,12}$/,
                /^1[3-9]\d{9}$/,
                /^[a-zA-Z0-9]{6,20}$/
            ];

            const isValid = validPatterns.some(pattern => pattern.test(code));

            if (isValid) {
                status.textContent = '推荐人验证成功！您将获得额外积分奖励';
                status.className = 'referrer-status valid';
            } else {
                status.textContent = '推荐人不存在，请检查输入是否正确';
                status.className = 'referrer-status invalid';
            }
        }

        // 处理支付
        function processPay() {
            const payButton = document.getElementById('payButton');
            if (payButton.disabled) return;

            // 显示确认框
            showPaymentModal();
        }

        // 显示支付确认框
        function showPaymentModal() {
            const modal = document.getElementById('paymentModal');
            modal.classList.add('show');

            // 更新推荐人信息
            const referrerCode = document.getElementById('referrerCode').value.trim();
            const referrerRow = document.getElementById('confirmReferrerRow');
            if (referrerCode) {
                document.getElementById('confirmReferrer').textContent = referrerCode;
                referrerRow.style.display = 'flex';
            } else {
                referrerRow.style.display = 'none';
            }
        }

        // 隐藏支付确认框
        function hidePaymentModal() {
            document.getElementById('paymentModal').classList.remove('show');
        }

        // 确认支付
        async function confirmPayment() {
            hidePaymentModal();

            const payButton = document.getElementById('payButton');
            payButton.disabled = true;
            payButton.innerHTML = '<span>处理中...</span>';

            try {
                const urlParams = new URLSearchParams(window.location.search);
                const courseId = urlParams.get('courseId');
                const referrerCode = document.getElementById('referrerCode').value.trim();

                // 1) 获取/创建订单
                let order = orderData;
                let needPayment = true;

                if (!order) {
                    if (!courseId) throw new Error('缺少courseId');

                    const params = new URLSearchParams({ paymentMethod: currentPaymentMethod });
                    if (referrerCode) params.append('referrerCode', referrerCode);

                    const response = await fetch(`${API_BASE}/orders/subscribe/course/${courseId}?${params}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        }
                    });
                    if (!response.ok) throw new Error('创建订单失败');

                    const result = await response.json();
                    order = result?.data?.order;
                    needPayment = !!result?.data?.needPayment;
                    if (!order) throw new Error(result?.message || '订单创建失败');

                    orderData = order;
                    document.getElementById('orderNumber').textContent = order.orderNo || '已创建';
                    displayOrderInfo();
                } else {
                    needPayment = (order.finalAmount ?? 0) > 0;
                }

                // 2) 免费订单直接成功
                if (!needPayment) {
                    showSuccessModal();
                    return;
                }

                // 3) 仅先支持支付宝
                if (currentPaymentMethod !== 'alipay') {
                    showToast('该支付方式暂未开通');
                    payButton.disabled = false;
                    payButton.innerHTML = '<span>立即支付 </span><span id="payAmount">¥0.00</span>';
                    return;
                }

                await createAlipayPayment(order);
            } catch (error) {
                console.error('支付失败:', error);
                showToast('支付失败，请重试');
                payButton.disabled = false;
                payButton.innerHTML = '<span>立即支付 </span><span id="payAmount">¥0.00</span>';
            }
        }

        // 创建支付宝支付
        async function createAlipayPayment(order) {
            try {
                const response = await fetch(`${API_BASE}/payment/alipay/create`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        orderNo: order.orderNo,
                        amount: order.finalAmount,
                        subject: order.title || '课程订阅',
                        body: order.description || order.title || '课程订阅支付'
                    })
                });

                if (!response.ok) throw new Error('创建支付失败');

                const result = await response.json();

                const formHtml = result?.data?.formHtml || result?.data?.form;
                if (formHtml) {
                    const container = document.createElement('div');
                    container.style.display = 'none';
                    container.innerHTML = formHtml;
                    document.body.appendChild(container);
                    const form = container.querySelector('form');
                    if (!form) throw new Error('支付表单为空');
                    form.submit();
                } else {
                    showToast('支付创建失败');
                }
            } catch (error) {
                console.error('创建支付失败:', error);
                throw error;
            }
        }

        // 显示支付成功
        function showSuccessModal() {
            document.getElementById('successModal').classList.add('show');
        }

	        // 开始学习
	        function startLearning() {
	            const urlParams = new URLSearchParams(window.location.search);
	            const courseId = urlParams.get('courseId');
	            if (courseId) {
	                window.location.href = `course-detail.html?id=${courseId}`;
	                return;
	            }
	            if (orderData && orderData.orderType === 'vip_subscription') {
	                window.location.href = 'vip.html';
	                return;
	            }
	            window.location.href = 'courses.html';
	        }

        // 查看订单
        function viewOrder() {
            window.location.href = 'profile.html?tab=orders';
        }

        // 主题切换
        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
        }

        // 用户菜单
        function toggleUserMenu() {
            document.getElementById('userDropdown').classList.toggle('show');
        }

        function goToProfile() {
            window.location.href = 'profile.html';
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // 通知
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // 点击外部关闭下拉菜单
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('userDropdown').classList.remove('show');
            }
        });
    </script>
</body>
</html>
