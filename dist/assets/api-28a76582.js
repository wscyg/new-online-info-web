const c="http://42.194.245.66/api";class h{constructor(){this.token=localStorage.getItem("token")}setToken(t){this.token=t,localStorage.setItem("token",t)}clearToken(){this.token=null,localStorage.removeItem("token"),localStorage.removeItem("user")}async request(t,e={}){const s={"Content-Type":"application/json",...e.headers};this.token&&(s.Authorization=`Bearer ${this.token}`);try{const r=await fetch(`${c}${t}`,{...e,headers:s,mode:"cors",credentials:"include"}),o=await r.json();if(!r.ok)throw r.status===401&&(console.error("=== API 401错误 ==="),console.error("请求URL:",`${c}${t}`),console.error("Token存在:",!!this.token),console.error("即将清除token并跳转到登录页"),this.clearToken(),window.location.href="/login"),new Error(o.message||`HTTP error! status: ${r.status}`);return o}catch(r){throw console.error("API Request Error:",r),r}}async get(t,e={}){const s=new URLSearchParams(e).toString(),r=s?`${t}?${s}`:t;return this.request(r,{method:"GET"})}async post(t,e={}){return this.request(t,{method:"POST",body:JSON.stringify(e)})}async put(t,e={}){return this.request(t,{method:"PUT",body:JSON.stringify(e)})}async delete(t){return this.request(t,{method:"DELETE"})}async uploadFile(t,e,s={}){const r=new FormData;r.append("file",e),Object.keys(s).forEach(p=>{r.append(p,s[p])});const o={};this.token&&(o.Authorization=`Bearer ${this.token}`);const i=await fetch(`${c}${t}`,{method:"POST",headers:o,body:r,mode:"cors",credentials:"include"}),u=await i.json();if(!i.ok)throw new Error(u.message||`HTTP error! status: ${i.status}`);return u}}class y{constructor(t){this.api=t}async register(t){const e=await this.api.post("/auth/register",t);return e.data&&e.data.token&&(this.api.setToken(e.data.token),localStorage.setItem("user",JSON.stringify(e.data.user))),e}async login(t){const e={loginAccount:t.username||t.loginAccount,password:t.password,loginType:t.loginType||"password",deviceType:"web"},s=await this.api.post("/auth/login",e);return s.data&&s.data.token&&(this.api.setToken(s.data.token),localStorage.setItem("user",JSON.stringify(s.data.user))),s}async checkUsername(t){return this.api.get("/auth/check-username",{username:t})}async checkEmail(t){return this.api.get("/auth/check-email",{email:t})}async checkPhone(t){return this.api.get("/auth/check-phone",{phone:t})}logout(){this.api.clearToken(),window.location.href="/"}}class g{constructor(t){this.api=t}async getProfile(){return this.api.get("/user/profile")}async updateProfile(t){return this.api.put("/user/profile",t)}async changePassword(t){return this.api.put("/user/password",t)}async getStats(){return this.api.get("/user/stats")}async dailyCheckin(){return this.api.post("/user/checkin")}async uploadAvatar(t){return this.api.uploadFile("/user/avatar",t)}async getReferralCode(){return this.api.get("/user/referral-code")}}class m{constructor(t){this.api=t}async getCourses(t={}){return this.api.get("/courses",t)}async getCourseById(t){return this.api.get(`/courses/${t}`)}async getCourseBySlug(t){return this.api.get(`/courses/slug/${t}`)}async getCoursesByCategory(t,e={}){return this.api.get(`/courses/category/${t}`,e)}async getRecommendedCourses(){return this.api.get("/courses/recommended")}async getHotCourses(){return this.api.get("/courses/hot")}async getFreeCourses(){return this.api.get("/courses/free")}async searchCourses(t,e={}){return this.api.get("/courses/search",{keyword:t,...e})}async getCourseStats(t){return this.api.get(`/courses/${t}/stats`)}async checkSubscriptionStatus(t){return this.api.get(`/courses/${t}/subscription-status`)}async purchaseCourse(t){return this.api.post(`/courses/${t}/purchase`)}}class l{constructor(t){this.api=t}async getCourseChapters(t){return this.api.get(`/content/courses/${t}/chapters`)}async getChapterDetails(t){return this.api.get(`/content/chapters/${t}`)}async searchContent(t,e={}){return this.api.get("/content/search",{keyword:t,...e})}async updateChapterProgress(t,e){return this.api.post(`/content/chapters/${t}/progress`,{progress:e})}async getUserCourseProgress(t){return this.api.get(`/content/courses/${t}/my-progress`)}}class d{constructor(t){this.api=t}async startLearningChapter(t){return this.api.post(`/learning/start/${t}`)}async updateProgress(t){return this.api.post("/learning/progress/update",t)}async getCourseProgress(t){return this.api.get(`/learning/progress/course/${t}`)}async getStatistics(){return this.api.get("/learning/statistics")}}class P{constructor(t){this.api=t}async createAlipayPayment(t){return this.api.post("/payment/alipay/create",t)}async createPayment(t){return this.api.post("/payment/create",t)}async getPaymentStatus(t){return this.api.get(`/payment/status/${t}`)}async createPointsPayment(t){return this.api.post("/payment/points/create",t)}async requestRefund(t){return this.api.post("/payment/refund",t)}async getPaymentRecords(t={}){return this.api.get("/payment/records",t)}}class A{constructor(t){this.api=t}async createOrder(t){return this.api.post("/orders/create",t)}async subscribeCourse(t){return this.api.post(`/orders/subscribe/course/${t}`)}async getSubscriptions(t={}){return this.api.get("/orders/subscriptions",t)}async checkAccess(t){return this.api.get("/orders/access-check",t)}async cancelSubscription(t){return this.api.post(`/orders/cancel/${t}`)}async subscribeVIP(t){return this.api.post("/orders/vip/subscribe",t)}}class k{constructor(t){this.api=t}async createRoom(t){return this.api.post("/studyrooms/create",t)}async joinRoom(t){return this.api.post(`/studyrooms/${t}/join`)}async leaveRoom(t){return this.api.post(`/studyrooms/${t}/leave`)}async getRoomsList(t={}){return this.api.get("/studyrooms/list",t)}async sendMessage(t,e){return this.api.post(`/studyrooms/${t}/message`,{message:e})}async getRoomMessages(t,e={}){return this.api.get(`/studyrooms/${t}/messages`,e)}}class w{constructor(t){this.api=t}async getBalance(){return this.api.get("/points/balance")}async getHistory(t={}){return this.api.get("/points/history",t)}async dailyCheckin(){return this.api.post("/points/checkin")}async getStatistics(){return this.api.get("/points/statistics")}async redeemPoints(t){return this.api.post("/points/redeem",t)}}class I{constructor(t){this.api=t}async createComment(t){return this.api.post("/comments/create",t)}async getComments(t={}){return this.api.get("/comments/list",t)}async likeComment(t){return this.api.post(`/comments/${t}/like`)}async deleteComment(t){return this.api.delete(`/comments/${t}`)}async getUserComments(t={}){return this.api.get("/comments/user",t)}async getHotComments(t={}){return this.api.get("/comments/hot",t)}}class C{constructor(t){this.api=t}async getUserAchievements(){return this.api.get("/achievements/user")}async getAllAchievements(){return this.api.get("/achievements/all")}async initializeAchievements(){return this.api.post("/achievements/initialize")}}const n=new h,$=new y(n),S=new g(n),f=new m(n),v=new l(n),T=new d(n),b=new P(n),R=new A(n),E=new k(n),U=new w(n),O=new I(n),q=new C(n);window.API={auth:$,user:S,course:f,content:v,learning:T,payment:b,order:R,studyRoom:E,points:U,comment:O,achievement:q,service:n};
