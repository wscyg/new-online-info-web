<!-- ç« èŠ‚å­¦ä¹ å¡ç‰‡ç»„ä»¶ -->
<style>
.chapter-card {
    background: white;
    border-radius: 24px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    transition: all 0.3s ease;
}

.chapter-card:hover {
    transform: translateY(-4px);
    box-shadow: 0 15px 50px rgba(0, 0, 0, 0.15);
}

.chapter-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    position: relative;
    overflow: hidden;
}

.chapter-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -10%;
    width: 300px;
    height: 300px;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    border-radius: 50%;
}

.chapter-number {
    display: inline-block;
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
    margin-bottom: 1rem;
}

.chapter-title {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 1;
}

.chapter-meta {
    display: flex;
    gap: 1.5rem;
    font-size: 0.9rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
}

.chapter-meta-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.chapter-content {
    padding: 2rem;
}

.content-section {
    margin-bottom: 2rem;
}

.content-section-title {
    font-size: 1.5rem;
    font-weight: 700;
    color: #2d3748;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.content-section-title::before {
    content: '';
    width: 4px;
    height: 1.5rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border-radius: 2px;
}

.content-text {
    font-size: 1.05rem;
    line-height: 1.8;
    color: #4a5568;
    margin-bottom: 1.5rem;
}

.content-text p {
    margin-bottom: 1rem;
}

.content-text h1, .content-text h2, .content-text h3 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: #2d3748;
}

.content-text h1 {
    font-size: 2rem;
    font-weight: 800;
}

.content-text h2 {
    font-size: 1.5rem;
    font-weight: 700;
}

.content-text h3 {
    font-size: 1.25rem;
    font-weight: 600;
}

.content-text ul, .content-text ol {
    margin-left: 2rem;
    margin-bottom: 1rem;
}

.content-text li {
    margin-bottom: 0.5rem;
}

.content-text pre {
    background: #2d3748;
    color: #e2e8f0;
    padding: 1.5rem;
    border-radius: 12px;
    overflow-x: auto;
    margin-bottom: 1rem;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
}

.content-text code {
    background: #edf2f7;
    color: #e53e3e;
    padding: 0.2rem 0.5rem;
    border-radius: 4px;
    font-size: 0.9em;
    font-family: 'Monaco', 'Courier New', monospace;
}

.content-text pre code {
    background: none;
    color: inherit;
    padding: 0;
}

.content-text blockquote {
    border-left: 4px solid #667eea;
    padding-left: 1.5rem;
    margin: 1.5rem 0;
    color: #718096;
    font-style: italic;
}

.content-text img {
    max-width: 100%;
    border-radius: 12px;
    margin: 1.5rem 0;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.content-text table {
    width: 100%;
    border-collapse: collapse;
    margin: 1.5rem 0;
}

.content-text th, .content-text td {
    border: 1px solid #e2e8f0;
    padding: 0.75rem;
    text-align: left;
}

.content-text th {
    background: #f7fafc;
    font-weight: 600;
}

/* çŸ¥è¯†ç‚¹å¡ç‰‡ */
.knowledge-card {
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
    border-left: 4px solid #3b82f6;
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1.5rem 0;
}

.knowledge-title {
    font-size: 1.1rem;
    font-weight: 700;
    color: #1e40af;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.knowledge-content {
    color: #334155;
    line-height: 1.7;
}

/* ç¤ºä¾‹ä»£ç å¡ç‰‡ */
.example-card {
    background: #2d3748;
    border-radius: 12px;
    overflow: hidden;
    margin: 1.5rem 0;
}

.example-header {
    background: #1a202c;
    padding: 0.75rem 1.5rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.example-title {
    color: #e2e8f0;
    font-size: 0.9rem;
    font-weight: 600;
}

.example-lang {
    background: #4a5568;
    color: #e2e8f0;
    padding: 0.25rem 0.75rem;
    border-radius: 12px;
    font-size: 0.75rem;
}

.example-code {
    padding: 1.5rem;
    color: #e2e8f0;
    font-family: 'Monaco', 'Courier New', monospace;
    font-size: 0.9rem;
    line-height: 1.6;
    overflow-x: auto;
}

/* æ³¨æ„äº‹é¡¹å¡ç‰‡ */
.note-card {
    background: linear-gradient(135deg, #fef3c7 0%, #fef9c3 100%);
    border-left: 4px solid #f59e0b;
    padding: 1.5rem;
    border-radius: 12px;
    margin: 1.5rem 0;
}

.note-card.warning {
    background: linear-gradient(135deg, #fef2f2 0%, #fee2e2 100%);
    border-left-color: #ef4444;
}

.note-card.success {
    background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
    border-left-color: #10b981;
}

.note-title {
    font-size: 1.1rem;
    font-weight: 700;
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.note-card .note-title {
    color: #92400e;
}

.note-card.warning .note-title {
    color: #991b1b;
}

.note-card.success .note-title {
    color: #065f46;
}

/* ç« èŠ‚å¯¼èˆª */
.chapter-nav {
    display: flex;
    justify-content: space-between;
    padding: 2rem;
    border-top: 1px solid #e2e8f0;
}

.nav-btn {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 1rem 1.5rem;
    background: white;
    border: 2px solid #e2e8f0;
    border-radius: 12px;
    font-weight: 600;
    color: #4a5568;
    cursor: pointer;
    transition: all 0.3s;
    text-decoration: none;
}

.nav-btn:hover {
    background: #f7fafc;
    border-color: #667eea;
    color: #667eea;
    transform: translateY(-2px);
}

.nav-btn.disabled {
    opacity: 0.4;
    cursor: not-allowed;
}

.nav-btn.disabled:hover {
    transform: none;
    border-color: #e2e8f0;
}

.nav-btn-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.nav-btn-primary:hover {
    background: linear-gradient(135deg, #5a67d8 0%, #6b3fa0 100%);
    color: white;
}

/* å­¦ä¹ è¿›åº¦æ¡ */
.progress-section {
    padding: 1.5rem 2rem;
    background: #f7fafc;
    border-bottom: 1px solid #e2e8f0;
}

.progress-info {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 0.75rem;
}

.progress-label {
    font-size: 0.9rem;
    color: #718096;
}

.progress-percent {
    font-size: 1.25rem;
    font-weight: 700;
    color: #667eea;
}

.progress-bar {
    height: 8px;
    background: #e2e8f0;
    border-radius: 10px;
    overflow: hidden;
}

.progress-fill {
    height: 100%;
    background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
    transition: width 0.5s ease;
    border-radius: 10px;
}

/* åŠ è½½çŠ¶æ€ */
.loading-skeleton {
    animation: skeleton-loading 1s linear infinite alternate;
}

@keyframes skeleton-loading {
    0% { opacity: 0.5; }
    100% { opacity: 1; }
}

/* å“åº”å¼ */
@media (max-width: 768px) {
    .chapter-header {
        padding: 1.5rem;
    }

    .chapter-title {
        font-size: 1.5rem;
    }

    .chapter-content {
        padding: 1.5rem;
    }

    .content-section-title {
        font-size: 1.25rem;
    }

    .chapter-nav {
        flex-direction: column;
        gap: 1rem;
    }

    .nav-btn {
        width: 100%;
        justify-content: center;
    }
}
</style>

<script>
/**
 * åˆ›å»ºç« èŠ‚å­¦ä¹ å¡ç‰‡
 * @param {Object} chapter - ç« èŠ‚æ•°æ®
 * @param {Object} content - ç« èŠ‚å†…å®¹
 * @param {Object} options - é…ç½®é€‰é¡¹
 * @returns {string} HTMLå­—ç¬¦ä¸²
 */
function createChapterCard(chapter, content, options = {}) {
    const {
        showProgress = true,
        showNav = true,
        progress = 0,
        prevChapter = null,
        nextChapter = null
    } = options;

    return `
        <div class="chapter-card" data-chapter-id="${chapter.id}">
            ${showProgress ? `
                <div class="progress-section">
                    <div class="progress-info">
                        <span class="progress-label">å­¦ä¹ è¿›åº¦</span>
                        <span class="progress-percent">${progress}%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progress}%"></div>
                    </div>
                </div>
            ` : ''}

            <div class="chapter-header">
                <div class="chapter-number">ç¬¬ ${chapter.sequence || chapter.id} ç« </div>
                <h1 class="chapter-title">${chapter.title}</h1>
                <div class="chapter-meta">
                    ${chapter.duration ? `
                        <div class="chapter-meta-item">
                            <span>â±ï¸</span>
                            <span>${chapter.duration}åˆ†é’Ÿ</span>
                        </div>
                    ` : ''}
                    ${chapter.difficulty ? `
                        <div class="chapter-meta-item">
                            <span>ğŸ“Š</span>
                            <span>${getDifficultyText(chapter.difficulty)}</span>
                        </div>
                    ` : ''}
                    <div class="chapter-meta-item">
                        <span>ğŸ‘ï¸</span>
                        <span>${chapter.views || 0} å­¦ä¹ </span>
                    </div>
                </div>
            </div>

            <div class="chapter-content">
                ${content.content_html || formatContent(content.content_text) || '<p>æš‚æ— å†…å®¹</p>'}
            </div>

            ${showNav ? `
                <div class="chapter-nav">
                    ${prevChapter ? `
                        <a href="#" class="nav-btn" onclick="loadChapter(${prevChapter.id}); return false;">
                            <span>â†</span>
                            <span>ä¸Šä¸€ç« </span>
                        </a>
                    ` : '<div></div>'}

                    ${nextChapter ? `
                        <a href="#" class="nav-btn nav-btn-primary" onclick="loadChapter(${nextChapter.id}); return false;">
                            <span>ä¸‹ä¸€ç« </span>
                            <span>â†’</span>
                        </a>
                    ` : `
                        <button class="nav-btn nav-btn-primary" onclick="completeChapter(${chapter.id})">
                            <span>âœ“ å®Œæˆå­¦ä¹ </span>
                        </button>
                    `}
                </div>
            ` : ''}
        </div>
    `;
}

/**
 * æ ¼å¼åŒ–å†…å®¹æ–‡æœ¬ä¸ºHTML
 */
function formatContent(text) {
    if (!text) return '';

    // ç®€å•çš„Markdownæ ·å¼è½¬æ¢
    text = text
        // ä»£ç å—
        .replace(/```(\w+)?\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
        // è¡Œå†…ä»£ç 
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        // æ ‡é¢˜
        .replace(/^### (.+)$/gm, '<h3>$1</h3>')
        .replace(/^## (.+)$/gm, '<h2>$1</h2>')
        .replace(/^# (.+)$/gm, '<h1>$1</h1>')
        // ç²—ä½“
        .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
        // æ–œä½“
        .replace(/\*(.+?)\*/g, '<em>$1</em>')
        // é“¾æ¥
        .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>')
        // æ®µè½
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>');

    return `<p>${text}</p>`;
}

/**
 * è·å–éš¾åº¦æ–‡æœ¬
 */
function getDifficultyText(difficulty) {
    const map = {
        'beginner': 'å…¥é—¨',
        'intermediate': 'ä¸­çº§',
        'advanced': 'é«˜çº§',
        'easy': 'ç®€å•',
        'medium': 'ä¸­ç­‰',
        'hard': 'å›°éš¾'
    };
    return map[difficulty] || difficulty;
}

/**
 * åˆ›å»ºçŸ¥è¯†ç‚¹å¡ç‰‡
 */
function createKnowledgeCard(title, content) {
    return `
        <div class="knowledge-card">
            <div class="knowledge-title">
                <span>ğŸ’¡</span>
                <span>${title}</span>
            </div>
            <div class="knowledge-content">${content}</div>
        </div>
    `;
}

/**
 * åˆ›å»ºç¤ºä¾‹ä»£ç å¡ç‰‡
 */
function createExampleCard(code, language = 'javascript', title = 'ç¤ºä¾‹ä»£ç ') {
    return `
        <div class="example-card">
            <div class="example-header">
                <div class="example-title">${title}</div>
                <div class="example-lang">${language}</div>
            </div>
            <pre class="example-code"><code>${escapeHtml(code)}</code></pre>
        </div>
    `;
}

/**
 * åˆ›å»ºæ³¨æ„äº‹é¡¹å¡ç‰‡
 */
function createNoteCard(content, type = 'note') {
    const icons = {
        note: 'ğŸ’¡',
        warning: 'âš ï¸',
        success: 'âœ“'
    };

    const titles = {
        note: 'æç¤º',
        warning: 'æ³¨æ„',
        success: 'é‡ç‚¹'
    };

    return `
        <div class="note-card ${type}">
            <div class="note-title">
                <span>${icons[type]}</span>
                <span>${titles[type]}</span>
            </div>
            <div>${content}</div>
        </div>
    `;
}

/**
 * è½¬ä¹‰HTML
 */
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return text.replace(/[&<>"']/g, m => map[m]);
}

/**
 * åŠ è½½ç« èŠ‚å†…å®¹
 */
async function loadChapter(chapterId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/content/chapters/${chapterId}`, {
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (!response.ok) {
            throw new Error('åŠ è½½å¤±è´¥');
        }

        const data = await response.json();

        if (data.code === 200) {
            // æ¸²æŸ“ç« èŠ‚å†…å®¹
            renderChapter(data.data);

            // æ»šåŠ¨åˆ°é¡¶éƒ¨
            window.scrollTo({ top: 0, behavior: 'smooth' });

            // æ›´æ–°è¿›åº¦
            updateProgress(chapterId, 0);
        } else {
            alert(data.message || 'åŠ è½½ç« èŠ‚å¤±è´¥');
        }
    } catch (error) {
        console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
        alert('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•');
    }
}

/**
 * å®Œæˆç« èŠ‚å­¦ä¹ 
 */
async function completeChapter(chapterId) {
    try {
        const token = localStorage.getItem('token');
        const response = await fetch(`/content/chapters/${chapterId}/progress?progressPercent=100`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });

        if (response.ok) {
            alert('ğŸ‰ æ­å–œå®Œæˆæœ¬ç« å­¦ä¹ ï¼');
            // å¯ä»¥è·³è½¬åˆ°ä¸‹ä¸€ç« æˆ–è¯¾ç¨‹åˆ—è¡¨
        }
    } catch (error) {
        console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error);
    }
}

/**
 * æ›´æ–°å­¦ä¹ è¿›åº¦
 */
async function updateProgress(chapterId, percent) {
    try {
        const token = localStorage.getItem('token');
        await fetch(`/content/chapters/${chapterId}/progress?progressPercent=${percent}`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        });
    } catch (error) {
        console.error('æ›´æ–°è¿›åº¦å¤±è´¥:', error);
    }
}

/**
 * æ¸²æŸ“ç« èŠ‚å†…å®¹
 */
function renderChapter(chapterData) {
    const container = document.getElementById('chapterContainer');
    if (!container) return;

    const html = createChapterCard(
        chapterData.chapter,
        chapterData.content,
        {
            showProgress: true,
            showNav: true,
            progress: chapterData.progress || 0,
            prevChapter: chapterData.prevChapter,
            nextChapter: chapterData.nextChapter
        }
    );

    container.innerHTML = html;
}
</script>
