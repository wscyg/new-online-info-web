<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ ä¸­å¿ƒ - AIæœªæ¥å­¦é™¢</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0f172a;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        #contentContainer {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
        }
        
        .loading-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-size: 1.5rem;
            background: #0f172a;
        }
        
        .content-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            background: white;
            overflow-y: auto;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        /* é˜²æ­¢å³é”®å’Œé€‰æ‹© */
        .content-wrapper {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* é˜²æ­¢æ‹–æ‹½ */
        .content-wrapper * {
            -webkit-user-drag: none;
            user-drag: none;
        }
        
        /* æ°´å°æ•ˆæœ */
        .watermark {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
            background-image: repeating-linear-gradient(
                45deg,
                transparent,
                transparent 200px,
                rgba(0,0,0,0.02) 200px,
                rgba(0,0,0,0.02) 250px
            );
        }
        
        .watermark::before {
            content: attr(data-watermark);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 3rem;
            color: rgba(0,0,0,0.05);
            white-space: nowrap;
            z-index: 1001;
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-container">ğŸš€ æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</div>
    <div id="contentContainer" style="display: none;">
        <div class="content-wrapper" id="contentWrapper"></div>
        <div class="watermark" id="watermark" data-watermark="AIæœªæ¥å­¦é™¢"></div>
    </div>

    <script>
        // ç®€å•çš„åŠ å¯†/è§£å¯†å·¥å…·
        class SimpleEncrypt {
            static encrypt(text, key = 'aifl2024') {
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    const keyChar = key[i % key.length];
                    const encryptedChar = String.fromCharCode(text.charCodeAt(i) ^ keyChar.charCodeAt(0));
                    result += encryptedChar;
                }
                return btoa(result);
            }
            
            static decrypt(encryptedText, key = 'aifl2024') {
                try {
                    const text = atob(encryptedText);
                    let result = '';
                    for (let i = 0; i < text.length; i++) {
                        const keyChar = key[i % key.length];
                        const decryptedChar = String.fromCharCode(text.charCodeAt(i) ^ keyChar.charCodeAt(0));
                        result += decryptedChar;
                    }
                    return result;
                } catch (e) {
                    console.error('è§£å¯†å¤±è´¥:', e);
                    return null;
                }
            }
        }

        // é«˜çº§é˜²è°ƒè¯•æªæ–½
        (function() {
            'use strict';
            
            // æ£€æµ‹è°ƒè¯•å™¨
            let isDebugging = false;
            function detectDebugger() {
                const start = new Date();
                debugger;
                const end = new Date();
                if (end - start > 100) {
                    isDebugging = true;
                    document.body.innerHTML = '<div style="color: white; text-align: center; margin-top: 50vh;">æ£€æµ‹åˆ°è°ƒè¯•è¡Œä¸ºï¼Œå†…å®¹å·²è¢«ä¿æŠ¤</div>';
                    return true;
                }
                return false;
            }
            
            // å®šæœŸæ£€æµ‹
            setInterval(() => {
                if (!isDebugging) {
                    detectDebugger();
                }
            }, 3000);
            
            // ç¦ç”¨å³é”®èœå•
            document.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                return false;
            });
            
            // ç¦ç”¨å¼€å‘è€…å·¥å…·å¿«æ·é”®
            document.addEventListener('keydown', function(e) {
                const forbiddenKeys = [
                    123, // F12
                    {ctrl: true, shift: true, key: 73}, // Ctrl+Shift+I
                    {ctrl: true, shift: true, key: 67}, // Ctrl+Shift+C
                    {ctrl: true, key: 85}, // Ctrl+U
                    {ctrl: true, key: 83}, // Ctrl+S
                    {ctrl: true, key: 65}, // Ctrl+A (å…¨é€‰)
                    {ctrl: true, key: 67}, // Ctrl+C (å¤åˆ¶)
                ];
                
                if (e.keyCode === 123) {
                    e.preventDefault();
                    return false;
                }
                
                if ((e.ctrlKey && e.shiftKey && (e.keyCode === 73 || e.keyCode === 67)) ||
                    (e.ctrlKey && (e.keyCode === 85 || e.keyCode === 83 || e.keyCode === 65 || e.keyCode === 67))) {
                    e.preventDefault();
                    return false;
                }
            });
            
            // æ£€æµ‹çª—å£å¤§å°å˜åŒ–ï¼ˆå¼€å‘è€…å·¥å…·æ‰“å¼€ï¼‰
            let windowHeight = window.innerHeight;
            let windowWidth = window.innerWidth;
            
            setInterval(() => {
                if (window.innerHeight < windowHeight * 0.7 || 
                    window.innerWidth < windowWidth * 0.7) {
                    if (!isDebugging) {
                        isDebugging = true;
                        document.body.innerHTML = '<div style="color: white; text-align: center; margin-top: 50vh;">è¯·å…³é—­å¼€å‘è€…å·¥å…·</div>';
                    }
                }
            }, 1000);
            
            // ç¦ç”¨é€‰æ‹©å’Œæ‹–æ‹½
            document.onselectstart = () => false;
            document.ondragstart = () => false;
            
        })();

        // å†…å®¹ä¿æŠ¤çš„æ›¿æ¢å‡½æ•°
        function replaceExternalLibs(htmlContent) {
            const replacements = {
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css': '/lib/highlightjs/github-dark.min.css',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css': '/lib/katex/katex.min.css',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js': '/lib/highlightjs/highlight.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js': '/lib/katex/katex.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js': '/lib/katex/auto-render.min.js',
                'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css': '/lib/highlightjs/github-dark.min.css',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css': '/lib/katex/katex.min.css',
                'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js': '/lib/highlightjs/highlight.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js': '/lib/katex/katex.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js': '/lib/katex/auto-render.min.js'
            };
            
            let modifiedHtml = htmlContent;
            for (const [cdnUrl, localUrl] of Object.entries(replacements)) {
                modifiedHtml = modifiedHtml.split(cdnUrl).join(localUrl);
            }
            
            return modifiedHtml;
        }

        // åˆ†ç‰‡æ¸²æŸ“å‡½æ•°ï¼Œé¿å…ä¸€æ¬¡æ€§æš´éœ²å…¨éƒ¨å†…å®¹
        function renderContentInChunks(htmlContent) {
            const contentWrapper = document.getElementById('contentWrapper');
            
            // æ¸…ç†å†…å®¹ï¼Œç§»é™¤è„šæœ¬æ ‡ç­¾
            const cleanedContent = htmlContent
                .replace(/<script(?!.*src=)[^>]*>[\s\S]*?<\/script>/gi, '') // åªç§»é™¤å†…è”è„šæœ¬
                .replace(/on\w+\s*=\s*["'][^"']*["']/gi, '') // ç§»é™¤äº‹ä»¶å¤„ç†å™¨
                .replace(/javascript:/gi, 'blocked:'); // é˜»æ­¢javascriptåè®®
            
            // åˆ†ç‰‡å¤„ç†å†…å®¹
            const parser = new DOMParser();
            const doc = parser.parseFromString(cleanedContent, 'text/html');
            const elements = Array.from(doc.body.children);
            
            // åˆ†æ‰¹æ¸²æŸ“ï¼Œé˜²æ­¢ä¸€æ¬¡æ€§æš´éœ²æ‰€æœ‰å†…å®¹
            let index = 0;
            const renderBatch = () => {
                if (index >= elements.length) {
                    // æ¸²æŸ“å®Œæˆåæ‰§è¡Œå¿…è¦çš„è„šæœ¬
                    setTimeout(executeScripts, 100);
                    return;
                }
                
                const batchSize = Math.min(5, elements.length - index);
                for (let i = 0; i < batchSize; i++) {
                    const element = elements[index + i];
                    if (element) {
                        contentWrapper.appendChild(element.cloneNode(true));
                    }
                }
                
                index += batchSize;
                setTimeout(renderBatch, 50); // å»¶è¿Ÿæ¸²æŸ“ä¸‹ä¸€æ‰¹
            };
            
            renderBatch();
        }

        // æ‰§è¡Œå¿…è¦çš„è„šæœ¬
        function executeScripts() {
            const contentWrapper = document.getElementById('contentWrapper');
            
            // æ‰§è¡Œä»£ç é«˜äº®
            if (typeof hljs !== 'undefined') {
                hljs.highlightAll();
            }
            
            // æ‰§è¡Œæ•°å­¦å…¬å¼æ¸²æŸ“
            if (typeof renderMathInElement !== 'undefined') {
                renderMathInElement(contentWrapper, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ],
                    throwOnError: false
                });
            }
            
            // é‡æ–°åº”ç”¨æ ·å¼
            setTimeout(() => {
                const styles = contentWrapper.querySelectorAll('style');
                styles.forEach(style => {
                    if (style.textContent.includes('animation') || 
                        style.textContent.includes('keyframes')) {
                        const newStyle = document.createElement('style');
                        newStyle.textContent = style.textContent;
                        document.head.appendChild(newStyle);
                    }
                });
            }, 200);
        }

        // ä¸»åŠ è½½å‡½æ•°
        (async function () {
            const loadingIndicator = document.getElementById('loading');
            const contentContainer = document.getElementById('contentContainer');
            const watermark = document.getElementById('watermark');
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const chapterId = urlParams.get('chapterId');
                if (!chapterId) {
                    throw new Error('URLä¸­æœªæ‰¾åˆ°ç« èŠ‚ID (chapterId)');
                }
                
                // è®¾ç½®ç”¨æˆ·æ°´å°
                const userInfo = localStorage.getItem('userInfo');
                if (userInfo) {
                    try {
                        const user = JSON.parse(userInfo);
                        watermark.setAttribute('data-watermark', 
                            `AIæœªæ¥å­¦é™¢ - ${user.username || 'ç”¨æˆ·'} - ${new Date().toLocaleDateString()}`);
                    } catch (e) {
                        // ä½¿ç”¨é»˜è®¤æ°´å°
                    }
                }
                
                const response = await fetch(`/api/content/chapters/${chapterId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`æ— æ³•è·å–ç« èŠ‚å†…å®¹ï¼ŒæœåŠ¡å™¨çŠ¶æ€: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.code === 200 && data.data && data.data.content) {
                    let htmlContent;
                    
                    // æ£€æŸ¥å†…å®¹æ˜¯å¦åŠ å¯†
                    if (data.data.content.encrypted && data.data.content.encryptedHtml) {
                        // è§£å¯†å†…å®¹
                        htmlContent = SimpleEncrypt.decrypt(data.data.content.encryptedHtml);
                        if (!htmlContent) {
                            throw new Error('å†…å®¹è§£å¯†å¤±è´¥');
                        }
                    } else if (data.data.content.contentHtml) {
                        // ä½¿ç”¨åŸå§‹å†…å®¹
                        htmlContent = data.data.content.contentHtml;
                    } else {
                        throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆå†…å®¹');
                    }
                    
                    // æ›¿æ¢å¤–éƒ¨åº“
                    const processedHtml = replaceExternalLibs(htmlContent);
                    
                    // åˆ†ç‰‡æ¸²æŸ“å†…å®¹
                    renderContentInChunks(processedHtml);
                    
                    // æ˜¾ç¤ºå†…å®¹
                    loadingIndicator.style.display = 'none';
                    contentContainer.style.display = 'block';
                    
                } else {
                    throw new Error(data.message || 'æœªæ‰¾åˆ°ç« èŠ‚å†…å®¹');
                }
                
            } catch (error) {
                console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
                loadingIndicator.textContent = `âŒ åŠ è½½å¤±è´¥: ${error.message}`;
            }
        })();

        // æ¸…ç†æªæ–½
        window.addEventListener('beforeunload', function() {
            // æ¸…ç†æ•æ„Ÿæ•°æ®
            document.getElementById('contentWrapper').innerHTML = '';
        });
        
        // é˜²æ­¢é€šè¿‡consoleè·å–å†…å®¹
        (function() {
            const originalLog = console.log;
            console.log = function(...args) {
                // è¿‡æ»¤æ•æ„Ÿä¿¡æ¯
                const filteredArgs = args.map(arg => 
                    typeof arg === 'string' && arg.length > 1000 ? '[å†…å®¹å·²è¿‡æ»¤]' : arg
                );
                originalLog.apply(console, filteredArgs);
            };
        })();
        
    </script>
    
    <!-- é¢„åŠ è½½å¿…è¦çš„åº“ -->
    <link rel="stylesheet" href="/lib/katex/katex.min.css">
    <link rel="stylesheet" href="/lib/highlightjs/github-dark.min.css">
    <script src="/lib/highlightjs/highlight.min.js"></script>
    <script src="/lib/katex/katex.min.js"></script>
    <script src="/lib/katex/auto-render.min.js"></script>
</body>
</html>