<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç­¾åˆ°é‡Œç¨‹ç¢‘ - AIæœªæ¥å­¦é™¢</title>
    <!-- APIé…ç½® -->
    <script src="../config/api-config.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            color: white;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        /* ç”¨æˆ·è¿›åº¦å¡ç‰‡ */
        .progress-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .progress-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .progress-title {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .progress-subtitle {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .stats-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 1.5rem;
            border-radius: 1rem;
            text-align: center;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
        }

        /* é‡Œç¨‹ç¢‘æ—¶é—´çº¿ */
        .milestones-container {
            position: relative;
        }

        .milestone-item {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: white;
            position: relative;
            transition: all 0.3s;
        }

        .milestone-item:hover {
            transform: translateX(10px);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .milestone-item.completed {
            background: rgba(16, 185, 129, 0.2);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .milestone-item.current {
            background: rgba(245, 158, 11, 0.2);
            border-color: rgba(245, 158, 11, 0.8);
            box-shadow: 0 0 30px rgba(245, 158, 11, 0.4);
        }

        .milestone-header {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            margin-bottom: 1rem;
        }

        .milestone-icon {
            font-size: 3rem;
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 1rem;
        }

        .milestone-info {
            flex: 1;
        }

        .milestone-day {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .milestone-name {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .milestone-status {
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.9rem;
            font-weight: bold;
        }

        .status-completed {
            background: rgba(16, 185, 129, 0.3);
            color: #10b981;
        }

        .status-current {
            background: rgba(245, 158, 11, 0.3);
            color: #f59e0b;
        }

        .status-locked {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
        }

        .milestone-rewards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .reward-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 1rem;
            border-radius: 0.75rem;
            text-align: center;
        }

        .reward-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .reward-label {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        .reward-value {
            font-size: 1.1rem;
            font-weight: bold;
            margin-top: 0.25rem;
        }

        .milestone-description {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            opacity: 0.9;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar-container {
            margin: 2rem 0;
        }

        .progress-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
            border-radius: 10px;
            transition: width 1s ease-out;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            color: white;
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* å“åº”å¼ */
        @media (max-width: 768px) {
            .title {
                font-size: 1.5rem;
            }

            .stats-row {
                grid-template-columns: 1fr 1fr;
            }

            .milestone-header {
                flex-direction: column;
                text-align: center;
            }

            .milestone-rewards {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨æ  -->
        <div class="top-bar">
            <a href="dashboard.html" class="back-btn">â† è¿”å›</a>
            <div class="title">ğŸ“† ç­¾åˆ°é‡Œç¨‹ç¢‘</div>
            <div></div>
        </div>

        <!-- åŠ è½½çŠ¶æ€ -->
        <div class="loading" id="loading">
            <div class="loading-spinner"></div>
            <p>åŠ è½½ç­¾åˆ°æ•°æ®ä¸­...</p>
        </div>

        <!-- ç”¨æˆ·è¿›åº¦ -->
        <div class="progress-card" id="progressCard" style="display: none;">
            <div class="progress-header">
                <div class="progress-title">ğŸ”¥ æ‚¨çš„ç­¾åˆ°è¿›åº¦</div>
                <div class="progress-subtitle" id="progressSubtitle">ç»§ç»­åŠ æ²¹ï¼Œå‘ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘å‰è¿›ï¼</div>
            </div>

            <div class="stats-row">
                <div class="stat-box">
                    <div class="stat-label">å½“å‰è¿ç»­</div>
                    <div class="stat-value" id="consecutiveDays">0</div>
                    <div class="stat-label">å¤©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ç´¯è®¡ç­¾åˆ°</div>
                    <div class="stat-value" id="totalDays">0</div>
                    <div class="stat-label">å¤©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">æœ€é•¿è¿ç»­</div>
                    <div class="stat-value" id="maxConsecutive">0</div>
                    <div class="stat-label">å¤©</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">ç´¯è®¡ç§¯åˆ†</div>
                    <div class="stat-value" id="totalPoints">0</div>
                    <div class="stat-label">åˆ†</div>
                </div>
            </div>

            <!-- è·ç¦»ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘ -->
            <div class="progress-bar-container" id="nextMilestoneProgress" style="display: none;">
                <div class="progress-bar-label">
                    <span>è·ç¦»ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘:</span>
                    <span id="progressText">0/0 å¤©</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-bar-fill" id="progressFill" style="width: 0%"></div>
                </div>
            </div>
        </div>

        <!-- é‡Œç¨‹ç¢‘åˆ—è¡¨ -->
        <div class="milestones-container" id="milestonesContainer" style="display: none;">
            <!-- å°†ç”±JSåŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>

    <script>
        let userStats = null;

        // é¡µé¢åŠ è½½
        document.addEventListener('DOMContentLoaded', function() {
            loadMilestones();
        });

        // åŠ è½½é‡Œç¨‹ç¢‘æ•°æ®
        async function loadMilestones() {
            try {
                const token = apiClient.getToken();
                if (!token) {
                    window.location.href = 'login.html';
                    return;
                }

                // è·å–ç”¨æˆ·ç­¾åˆ°ç»Ÿè®¡
                const statsResponse = await apiClient.get(API_ENDPOINTS.CHECKIN.STATS);
                userStats = statsResponse.data.stats;

                // è·å–æ‰€æœ‰é‡Œç¨‹ç¢‘å¥–åŠ±
                const milestonesResponse = await apiClient.get('/checkin/milestones');
                const milestones = milestonesResponse.data || getDefaultMilestones();

                renderProgress();
                renderMilestones(milestones);

                document.getElementById('loading').style.display = 'none';
                document.getElementById('progressCard').style.display = 'block';
                document.getElementById('milestonesContainer').style.display = 'block';

            } catch (error) {
                console.error('åŠ è½½é‡Œç¨‹ç¢‘å¤±è´¥:', error);

                // ä½¿ç”¨é»˜è®¤æ•°æ®
                userStats = {
                    currentConsecutiveDays: 0,
                    totalCheckinDays: 0,
                    maxConsecutiveDays: 0,
                    totalPointsEarned: 0
                };

                renderProgress();
                renderMilestones(getDefaultMilestones());

                document.getElementById('loading').style.display = 'none';
                document.getElementById('progressCard').style.display = 'block';
                document.getElementById('milestonesContainer').style.display = 'block';
            }
        }

        // æ¸²æŸ“ç”¨æˆ·è¿›åº¦
        function renderProgress() {
            document.getElementById('consecutiveDays').textContent = userStats.currentConsecutiveDays || 0;
            document.getElementById('totalDays').textContent = userStats.totalCheckinDays || 0;
            document.getElementById('maxConsecutive').textContent = userStats.maxConsecutiveDays || 0;
            document.getElementById('totalPoints').textContent = userStats.totalPointsEarned || 0;

            // è®¡ç®—ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘
            const currentDays = userStats.currentConsecutiveDays || 0;
            const milestones = [1, 3, 7, 15, 30, 50, 100, 180, 365];
            const nextMilestone = milestones.find(m => m > currentDays);

            if (nextMilestone) {
                const progress = (currentDays / nextMilestone) * 100;
                document.getElementById('progressText').textContent = `${currentDays}/${nextMilestone} å¤©`;
                document.getElementById('progressFill').style.width = `${progress}%`;
                document.getElementById('nextMilestoneProgress').style.display = 'block';
                document.getElementById('progressSubtitle').textContent =
                    `è¿˜éœ€ ${nextMilestone - currentDays} å¤©åˆ°è¾¾ ${nextMilestone} å¤©é‡Œç¨‹ç¢‘ï¼`;
            }
        }

        // æ¸²æŸ“é‡Œç¨‹ç¢‘åˆ—è¡¨
        function renderMilestones(milestones) {
            const container = document.getElementById('milestonesContainer');
            const currentDays = userStats.currentConsecutiveDays || 0;

            milestones.sort((a, b) => a.milestoneDays - b.milestoneDays);

            container.innerHTML = milestones.map(milestone => {
                const isCompleted = currentDays >= milestone.milestoneDays;
                const isCurrent = !isCompleted && milestone.milestoneDays === getNextMilestone(currentDays, milestones);
                const statusClass = isCompleted ? 'completed' : (isCurrent ? 'current' : '');
                const statusText = isCompleted ? 'âœ… å·²å®Œæˆ' : (isCurrent ? 'ğŸ¯ è¿›è¡Œä¸­' : 'ğŸ”’ æœªè§£é”');
                const statusBadge = isCompleted ? 'status-completed' : (isCurrent ? 'status-current' : 'status-locked');

                return `
                    <div class="milestone-item ${statusClass}">
                        <div class="milestone-header">
                            <div class="milestone-icon">${getMilestoneIcon(milestone.milestoneDays)}</div>
                            <div class="milestone-info">
                                <div class="milestone-day">ç¬¬ ${milestone.milestoneDays} å¤©</div>
                                <div class="milestone-name">${milestone.badgeName || milestone.description || 'ç­¾åˆ°å¥–åŠ±'}</div>
                            </div>
                            <div class="milestone-status ${statusBadge}">${statusText}</div>
                        </div>

                        <div class="milestone-rewards">
                            <div class="reward-item">
                                <div class="reward-icon">ğŸ’</div>
                                <div class="reward-label">ç§¯åˆ†å¥–åŠ±</div>
                                <div class="reward-value">${milestone.points}</div>
                            </div>
                            ${milestone.treasureBox ? `
                                <div class="reward-item">
                                    <div class="reward-icon">ğŸ“¦</div>
                                    <div class="reward-label">å®ç®±</div>
                                    <div class="reward-value">${milestone.treasureBox}</div>
                                </div>
                            ` : ''}
                            ${milestone.badgeName ? `
                                <div class="reward-item">
                                    <div class="reward-icon">ğŸ…</div>
                                    <div class="reward-label">å‹‹ç« </div>
                                    <div class="reward-value">${milestone.badgeName}</div>
                                </div>
                            ` : ''}
                            ${milestone.titleName ? `
                                <div class="reward-item">
                                    <div class="reward-icon">ğŸ‘‘</div>
                                    <div class="reward-label">ç§°å·</div>
                                    <div class="reward-value">${milestone.titleName}</div>
                                </div>
                            ` : ''}
                            ${getExtraRewards(milestone.milestoneDays)}
                        </div>

                        ${milestone.description ? `
                            <div class="milestone-description">
                                ğŸ“ ${milestone.description}
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // è·å–é‡Œç¨‹ç¢‘å›¾æ ‡
        function getMilestoneIcon(days) {
            if (days === 1) return 'ğŸŒ±';
            if (days === 3) return 'ğŸŒ¿';
            if (days === 7) return 'ğŸŒ³';
            if (days === 15) return 'ğŸ‹';
            if (days === 30) return 'ğŸ†';
            if (days === 50) return 'ğŸ’«';
            if (days === 100) return 'ğŸ”¥';
            if (days === 180) return 'â­';
            if (days === 365) return 'ğŸ‘‘';
            return 'ğŸ';
        }

        // è·å–é¢å¤–å¥–åŠ±
        function getExtraRewards(days) {
            let rewards = [];
            if (days === 7) rewards.push('<div class="reward-item"><div class="reward-icon">ğŸ›¡ï¸</div><div class="reward-label">é“å…·</div><div class="reward-value">ä¿æŠ¤å¡ x1</div></div>');
            if (days === 30) rewards.push('<div class="reward-item"><div class="reward-icon">ğŸ›¡ï¸</div><div class="reward-label">é“å…·</div><div class="reward-value">ä¿æŠ¤å¡ x2<br>è¡¥ç­¾å¡ x1</div></div>');
            if (days === 100) rewards.push('<div class="reward-item"><div class="reward-icon">ğŸ›¡ï¸</div><div class="reward-label">é“å…·</div><div class="reward-value">ä¿æŠ¤å¡ x5<br>è¡¥ç­¾å¡ x3</div></div>');
            return rewards.join('');
        }

        // è·å–ä¸‹ä¸€ä¸ªé‡Œç¨‹ç¢‘
        function getNextMilestone(currentDays, milestones) {
            const next = milestones.find(m => m.milestoneDays > currentDays);
            return next ? next.milestoneDays : null;
        }

        // é»˜è®¤é‡Œç¨‹ç¢‘æ•°æ®
        function getDefaultMilestones() {
            return [
                { milestoneDays: 1, points: 15, description: 'æ¯æ—¥ç­¾åˆ°åŸºç¡€å¥–åŠ±' },
                { milestoneDays: 3, points: 50, treasureBox: 'æ™®é€šå®ç®±', description: 'è¿ç»­ç­¾åˆ°3å¤©å¥–åŠ±' },
                { milestoneDays: 7, points: 150, treasureBox: 'ç¨€æœ‰å®ç®±', badgeName: 'å‘¨å­¦éœ¸', description: 'è¿ç»­ç­¾åˆ°7å¤©å¥–åŠ±' },
                { milestoneDays: 15, points: 500, treasureBox: 'å²è¯—å®ç®±', badgeName: 'åŠæœˆè¾¾äºº', description: 'è¿ç»­ç­¾åˆ°15å¤©å¥–åŠ±' },
                { milestoneDays: 30, points: 1500, treasureBox: 'ä¼ è¯´å®ç®±', badgeName: 'æœˆåº¦å­¦ç¥', titleName: 'æœˆåº¦å­¦ç¥', description: 'è¿ç»­ç­¾åˆ°30å¤©å¥–åŠ±' },
                { milestoneDays: 50, points: 2000, treasureBox: 'ä¼ è¯´å®ç®±', badgeName: 'äº”åæ—¥åšæŒè€…', description: 'è¿ç»­ç­¾åˆ°50å¤©å¥–åŠ±' },
                { milestoneDays: 100, points: 8000, treasureBox: 'ç¥è¯å®ç®±', badgeName: 'ç™¾æ—¥åšæŒ', titleName: 'ç™¾æ—¥åšæŒè€…', description: 'è¿ç»­ç­¾åˆ°100å¤©æ°¸ä¹…å¥–åŠ±' },
                { milestoneDays: 180, points: 10000, treasureBox: 'ç¥è¯å®ç®±', titleName: 'åŠå¹´å­¦éœ¸', description: 'è¿ç»­ç­¾åˆ°180å¤©æ°¸ä¹…ç§°å·' },
                { milestoneDays: 365, points: 50000, treasureBox: 'è‡³å°Šå®ç®±', badgeName: 'å¹´åº¦åšæŒä¹‹ç‹', titleName: 'å­¦ä¹ ä¹‹ç¥', description: 'è¿ç»­ç­¾åˆ°365å¤©ç»ˆæå¥–åŠ±' }
            ];
        }
    </script>
</body>
</html>
