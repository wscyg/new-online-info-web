<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯¾ç¨‹ç¼–è¾‘å™¨ - å·¦æ¨¡æ¿å³JSON</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="stylesheet" href="/assets/skins/app-shell.css">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500&family=Noto+Sans+SC:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg-dark: #0f0f1a;
            --bg-panel: #1a1a2e;
            --border: rgba(255,255,255,0.08);
            --text: #ffffff;
            --text-muted: rgba(255,255,255,0.6);
            --accent: #667eea;
            --accent-secondary: #764ba2;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-dark);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* é¡¶éƒ¨å·¥å…·æ  */
        .toolbar {
            height: 56px;
            background: var(--bg-panel);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .toolbar-title {
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .toolbar-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: none;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            color: var(--text-muted);
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* ç»Ÿä¸€è¾“å…¥ä¸æŒ‰é’®è´¨æ„Ÿ */
        .btn {
            letter-spacing: 0.01em;
            box-shadow: 0 10px 26px rgba(0,0,0,0.22);
        }
        .btn-secondary {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.12);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.12);
        }
        .template-select,
        .course-select,
        .json-editor {
            border: 1px solid rgba(255,255,255,0.12);
            box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
        }
        .template-select:focus,
        .course-select:focus,
        .json-editor:focus {
            border-color: rgba(102, 126, 234, 0.65);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        /* ä¸»å†…å®¹åŒº */
        .main-container {
            display: flex;
            height: calc(100vh - 56px);
        }

        /* å·¦ä¾§é¢„è§ˆåŒº */
        .preview-panel {
            flex: 1;
            position: relative;
            border-right: 1px solid var(--border);
            background: #0a0a0f;
        }

        .preview-header {
            height: 40px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .preview-title {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .preview-controls {
            display: flex;
            gap: 8px;
        }

        .preview-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .preview-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text);
        }

        .template-select {
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: rgba(255,255,255,0.02);
            color: var(--text);
            font-size: 12px;
            padding: 0 8px;
            outline: none;
        }
        .template-select:focus {
            border-color: var(--accent);
        }

        .preview-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .preview-iframe-container {
            height: calc(100% - 40px);
            position: relative;
        }

        .preview-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #0a0a0f;
        }

        /* å³ä¾§ç¼–è¾‘åŒº */
        .editor-panel {
            width: 50%;
            min-width: 400px;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            background: var(--bg-panel);
        }

        .editor-header {
            height: 40px;
            background: rgba(255,255,255,0.02);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
        }

        .editor-tabs {
            display: flex;
            gap: 4px;
        }

        .editor-tab {
            padding: 6px 12px;
            border-radius: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .editor-tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .editor-tab.active {
            background: var(--accent);
            color: white;
        }

        .editor-body {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .json-editor {
            width: 100%;
            height: 100%;
            background: #1e1e2e;
            color: #e4e4e7;
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        .json-editor:focus {
            box-shadow: inset 0 0 0 1px var(--accent);
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            height: 28px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            font-size: 11px;
            color: var(--text-muted);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-dot.success { background: #10b981; }
        .status-dot.error { background: #ef4444; }
        .status-dot.warning { background: #f59e0b; }

        /* åˆ†å‰²çº¿æ‹–æ‹½ */
        .resizer {
            width: 4px;
            cursor: col-resize;
            background: var(--border);
            transition: background 0.2s;
        }

        .resizer:hover {
            background: var(--accent);
        }

        /* è¯¾ç¨‹é€‰æ‹©å™¨ */
        .course-selector {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .course-select {
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px 12px;
            color: var(--text);
            font-size: 13px;
            min-width: 200px;
            cursor: pointer;
        }

        .course-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* é¡µé¢é€‰æ‹©å™¨ */
        .page-nav {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
        }

        .page-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-nav-btn:hover:not(:disabled) {
            background: rgba(255,255,255,0.05);
            color: var(--text);
        }

        .page-nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .page-dots {
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
        }

        .page-dot {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .page-dot:hover {
            background: rgba(255,255,255,0.05);
        }

        .page-dot.active {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .page-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-left: auto;
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(10,10,15,0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 16px;
            z-index: 100;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 13px;
            color: var(--text-muted);
        }

        .hidden { display: none !important; }

        /* æ–°å¢æ ·å¼ - ç¼–è¾‘å™¨å¢å¼º */
        .editor-view-toggle {
            display: flex;
            gap: 4px;
        }

        .view-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .view-btn:hover {
            background: rgba(255,255,255,0.1);
        }

        .editor-pane {
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .pane-header {
            padding: 8px 12px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pane-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text);
        }

        .pane-hint {
            font-size: 11px;
            color: var(--text-muted);
        }

        .template-tabs {
            display: flex;
            gap: 2px;
            padding: 6px 8px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--border);
        }

        .template-tab {
            padding: 4px 10px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-muted);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .template-tab:hover {
            background: rgba(255,255,255,0.05);
        }

        .template-tab.active {
            background: var(--accent);
            color: white;
        }

        .template-editor {
            flex: 1;
        }

        /* åˆ†å±æ¨¡å¼ */
        .editor-split {
            display: flex;
            height: 100%;
        }

        .split-left, .split-right {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
        }

        .split-divider {
            width: 4px;
            background: var(--border);
            cursor: col-resize;
            transition: background 0.2s;
        }

        .split-divider:hover {
            background: var(--accent);
        }

        .split-json, .split-template {
            flex: 1;
            font-size: 11px;
        }

        /* ç¼–è¾‘å™¨å†…textareaæ ·å¼è°ƒæ•´ */
        .editor-pane .json-editor,
        .editor-split .json-editor {
            flex: 1;
            height: auto;
        }

        /* Toastæç¤º */
        .toast {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 12px 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            border-radius: 8px;
            font-size: 13px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }

        .toast.error {
            background: rgba(239, 68, 68, 0.9);
        }

        @keyframes slideIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* å¿«æ·é”®æç¤º */
        .shortcut-hint {
            position: fixed;
            bottom: 50px;
            right: 20px;
            padding: 12px 16px;
            background: rgba(0,0,0,0.8);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 11px;
            color: var(--text-muted);
            z-index: 100;
        }

        .shortcut-hint kbd {
            padding: 2px 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            font-family: var(--font-mono, monospace);
        }

        /* çŠ¶æ€æ å¢å¼º */
        .status-center {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-separator {
            color: var(--border);
        }

        #templateStatus {
            color: var(--accent);
        }

        #currentTabInfo {
            font-size: 10px;
            padding: 2px 8px;
            background: rgba(255,255,255,0.05);
            border-radius: 4px;
        }

        /* ===== è§†è§‰ç²¾ä¿®è¦†ç›– ===== */
        body {
            background:
                radial-gradient(900px 520px at 12% 12%, rgba(102, 126, 234, 0.18), transparent 55%),
                radial-gradient(700px 420px at 88% 78%, rgba(118, 75, 162, 0.16), transparent 55%),
                var(--bg-dark);
        }
        .toolbar {
            background: linear-gradient(135deg, rgba(26, 26, 46, 0.98), rgba(18, 18, 32, 0.96));
            box-shadow: 0 12px 40px rgba(0,0,0,0.35);
        }
        .toolbar-title {
            text-shadow: 0 10px 26px rgba(102, 126, 234, 0.25);
        }
        .btn {
            border-radius: 10px;
        }
        .btn-primary {
            box-shadow: 0 12px 32px rgba(102, 126, 234, 0.35);
        }
        .btn-primary:hover {
            box-shadow: 0 16px 38px rgba(102, 126, 234, 0.45);
        }
        .course-select,
        .template-select {
            background: rgba(255,255,255,0.04);
            border-color: rgba(255,255,255,0.14);
        }
        .preview-panel,
        .editor-panel {
            background: linear-gradient(180deg, rgba(10,10,15,0.95), rgba(10,10,15,0.88));
        }
        .preview-header,
        .editor-header {
            background: rgba(255,255,255,0.03);
        }
        .json-editor {
            background: rgba(10,10,15,0.7);
        }
        .status-bar {
            background: rgba(0,0,0,0.35);
            border-top: 1px solid rgba(255,255,255,0.08);
        }
    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å·¥å…·æ  -->
    <div class="toolbar">
        <div class="toolbar-left">
            <a href="template-course-manage.html" class="btn btn-secondary">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                è¿”å›
            </a>
            <span class="toolbar-title">è¯¾ç¨‹å¯è§†åŒ–ç¼–è¾‘å™¨</span>
        </div>

        <div class="course-selector">
            <select class="course-select" id="courseSelect">
                <option value="">é€‰æ‹©è¯¾ç¨‹...</option>
            </select>
            <button class="btn btn-secondary" id="newCourseBtn">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                æ–°å»º
            </button>
        </div>

        <div class="toolbar-actions">
            <button class="btn btn-secondary" id="templateDocsBtn" title="æŸ¥çœ‹æ¨¡ç‰ˆè§„åˆ™ï¼Œå¤åˆ¶ç»™AIç”ŸæˆJSON" onclick="showTemplateRulesModal()">
                ğŸ“– æ¨¡ç‰ˆè§„åˆ™
            </button>
            <button class="btn btn-secondary" id="formatBtn" title="æ ¼å¼åŒ–JSON">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 6h16M4 12h10M4 18h14"/>
                </svg>
                æ ¼å¼åŒ–
            </button>
            <button class="btn btn-secondary" id="validateBtn" title="æ ¡éªŒJSONæ ¼å¼">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M9 11l3 3L22 4M21 12v7a2 2 0 01-2 2H5a2 2 0 01-2-2V5a2 2 0 012-2h11"/>
                </svg>
                æ ¡éªŒ
            </button>
            <button class="btn btn-secondary" id="regressionBtn" title="è¿è¡Œç¦»çº¿æ¸²æŸ“å›å½’ï¼ˆå¼€å‘è€…ç”¨ï¼‰">
                å›å½’æ£€æŸ¥
            </button>
            <button class="btn btn-secondary" id="exportHtmlBtn" title="å¯¼å‡ºå½“å‰é¢„è§ˆä¸ºHTMLæ–‡ä»¶ï¼ˆç”¨äºå‘å¸ƒå‰æ ¸å¯¹ï¼‰">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                å¯¼å‡ºHTML
            </button>
            <button class="btn btn-secondary" id="previewDraftBtn" title="ä¸ä¿å­˜åˆ°åç«¯ï¼Œç›´æ¥ç”¨å½“å‰JSONç”Ÿæˆé¢„è§ˆé“¾æ¥æ‰“å¼€">
                è‰ç¨¿é¢„è§ˆ
            </button>
            <button class="btn btn-secondary" id="openOnlinePreviewBtn" title="æ‰“å¼€çº¿ä¸Š course-viewerï¼ˆæŒ‰å½“å‰courseIdï¼‰">
                æ‰“å¼€çº¿ä¸Šé¢„è§ˆ
            </button>
            <button class="btn btn-secondary" id="copyPreviewLinkBtn" title="å¤åˆ¶é¢„è§ˆé“¾æ¥åˆ°å‰ªè´´æ¿">
                å¤åˆ¶é¢„è§ˆé“¾æ¥
            </button>
            <button class="btn btn-secondary" id="saveTemplateBtn" title="ä¿å­˜è‡ªå®šä¹‰æ¨¡æ¿æ ·å¼">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                    <circle cx="8.5" cy="8.5" r="1.5"/>
                    <polyline points="21,15 16,10 5,21"/>
                </svg>
                å­˜æ¨¡æ¿
            </button>
            <button class="btn btn-primary" id="saveBtn" title="ä¿å­˜è¯¾ç¨‹å†…å®¹ (Ctrl+S)">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                    <polyline points="17,21 17,13 7,13 7,21"/>
                    <polyline points="7,3 7,8 15,8"/>
                </svg>
                ä¿å­˜
            </button>
            <button class="btn btn-primary" id="publishBtn" title="å‘å¸ƒè¯¾ç¨‹">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                </svg>
                å‘å¸ƒ
            </button>
            <button class="btn btn-secondary" id="openChapterViewerBtn" title="æ‰“å¼€ç« èŠ‚æŸ¥çœ‹å™¨ï¼ˆåç«¯ content_html / content_data å…¼å®¹é¢„è§ˆï¼‰">
                ç« èŠ‚é¢„è§ˆ
            </button>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-container">
        <!-- å·¦ä¾§é¢„è§ˆåŒº -->
        <div class="preview-panel" id="previewPanel">
            <div class="preview-header">
                <span class="preview-title">å®æ—¶é¢„è§ˆ</span>
                <div class="preview-controls">
                    <select class="template-select" id="templateSelect" title="é€‰æ‹©æ¨¡æ¿">
                        <option value="chapter2">chapter2ï¼ˆç‚«é…·ç¿»é¡µ + æ‰“å­—æœº + å¯è§†åŒ–ï¼‰</option>
                        <option value="gpt-course">gpt-courseï¼ˆç»ç’ƒæ€æ‚å¿—é£æ ¼ï¼‰</option>
                        <option value="nordic">nordicï¼ˆæç®€åŒ—æ¬§ï¼‰</option>
                        <option value="magazine">magazineï¼ˆæ‚å¿—å™äº‹ï¼‰</option>
                        <option value="particle">particleï¼ˆç²’å­å®‡å®™ï¼‰</option>
                    </select>
                    <button class="preview-btn active" data-device="desktop" title="æ¡Œé¢">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                            <line x1="8" y1="21" x2="16" y2="21"/>
                            <line x1="12" y1="17" x2="12" y2="21"/>
                        </svg>
                    </button>
                    <button class="preview-btn" data-device="tablet" title="å¹³æ¿">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="4" y="2" width="16" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                    </button>
                    <button class="preview-btn" data-device="mobile" title="æ‰‹æœº">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                    </button>
                    <button class="preview-btn" id="refreshPreviewBtn" title="åˆ·æ–°">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M23 4v6h-6M1 20v-6h6"/>
                            <path d="M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15"/>
                        </svg>
                    </button>
                    <button class="preview-btn" id="fullscreenBtn" title="å…¨å±">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                        </svg>
                    </button>
                </div>
            </div>

            <!-- é¡µé¢å¯¼èˆª -->
            <div class="page-nav" id="pageNav">
                <button class="page-nav-btn" id="prevPageBtn" disabled>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6"/>
                    </svg>
                </button>
                <div class="page-dots" id="pageDots"></div>
                <button class="page-nav-btn" id="nextPageBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
                <span class="page-info" id="pageInfo">ç¬¬ 1 é¡µ / å…± 8 é¡µ</span>
            </div>

            <div class="preview-iframe-container">
                <iframe class="preview-iframe" id="previewFrame" src="about:blank"></iframe>
                <div class="loading-overlay" id="previewLoading">
                    <div class="loading-spinner"></div>
                    <span class="loading-text">åŠ è½½é¢„è§ˆ...</span>
                </div>
            </div>
        </div>

        <!-- æ‹–æ‹½åˆ†å‰²çº¿ -->
        <div class="resizer" id="resizer"></div>

        <!-- å³ä¾§ç¼–è¾‘åŒº -->
        <div class="editor-panel" id="editorPanel">
            <div class="editor-header">
                <div class="editor-tabs">
                    <button class="editor-tab active" data-tab="json">ğŸ“ JSONå†…å®¹</button>
                    <button class="editor-tab" data-tab="template">ğŸ¨ æ¨¡æ¿ä»£ç </button>
                    <button class="editor-tab" data-tab="split">â— åˆ†å±æ¨¡å¼</button>
                </div>
                <div class="editor-view-toggle">
                    <button class="view-btn" id="copyJsonBtn" title="å¤åˆ¶JSON">ğŸ“‹</button>
                    <button class="view-btn" id="copyTemplateBtn" title="å¤åˆ¶æ¨¡æ¿">ğŸ“‹</button>
                    <button class="view-btn" id="resetTemplateBtn" title="é‡ç½®æ¨¡æ¿">ğŸ”„</button>
                </div>
            </div>

            <div class="editor-body">
                <!-- JSONç¼–è¾‘å™¨ -->
                <div class="editor-pane" id="jsonPane">
                    <div class="pane-header">
                        <span class="pane-title">è¯¾ç¨‹å†…å®¹ JSON</span>
                        <span class="pane-hint">ç¼–è¾‘è¯¾ç¨‹ç»“æ„ã€é¡µé¢ã€ç»„ä»¶</span>
                    </div>
                    <textarea class="json-editor" id="jsonEditor" spellcheck="false" placeholder="åœ¨æ­¤è¾“å…¥æˆ–ç²˜è´´è¯¾ç¨‹JSON..."></textarea>
                </div>

                <!-- æ¨¡æ¿ä»£ç ç¼–è¾‘å™¨ -->
                <div class="editor-pane hidden" id="templatePane">
                    <div class="pane-header">
                        <span class="pane-title">æ¨¡æ¿æ¸²æŸ“ä»£ç </span>
                        <span class="pane-hint">CSSæ ·å¼ + ç»„ä»¶æ¸²æŸ“å‡½æ•°</span>
                    </div>
                    <div class="template-tabs">
                        <button class="template-tab active" data-section="css">ğŸ¨ CSSæ ·å¼</button>
                        <button class="template-tab" data-section="render">âš™ï¸ æ¸²æŸ“å‡½æ•°</button>
                        <button class="template-tab" data-section="preview">ğŸ‘ï¸ é¢„è§ˆHTML</button>
                    </div>
                    <textarea class="json-editor template-editor" id="templateEditor" spellcheck="false"></textarea>
                </div>

                <!-- åˆ†å±æ¨¡å¼ -->
                <div class="editor-split hidden" id="splitPane">
                    <div class="split-left">
                        <div class="pane-header">
                            <span class="pane-title">ğŸ“ JSON</span>
                        </div>
                        <textarea class="json-editor split-json" id="splitJsonEditor" spellcheck="false"></textarea>
                    </div>
                    <div class="split-divider"></div>
                    <div class="split-right">
                        <div class="pane-header">
                            <span class="pane-title">ğŸ¨ æ¨¡æ¿</span>
                        </div>
                        <textarea class="json-editor split-template" id="splitTemplateEditor" spellcheck="false"></textarea>
                    </div>
                </div>
            </div>

            <div class="status-bar">
                <div class="status-indicator">
                    <span class="status-dot success" id="statusDot"></span>
                    <span id="statusText">å°±ç»ª</span>
                </div>
                <div class="status-center">
                    <span id="jsonStats">0 é¡µ Â· 0 ç»„ä»¶</span>
                    <span class="status-separator">|</span>
                    <span id="templateStatus">é»˜è®¤æ¨¡æ¿</span>
                </div>
                <span id="currentTabInfo">JSONæ¨¡å¼</span>
            </div>
        </div>
    </div>

    <!-- æ ¡éªŒæŠ¥å‘ŠæŠ½å±‰ï¼ˆæ”¾åœ¨ body å°¾éƒ¨ï¼Œé¿å…å½±å“å¸ƒå±€ï¼‰ -->
    <div class="drawer-backdrop" id="validationBackdrop"></div>
    <aside class="drawer" id="validationDrawer" aria-hidden="true">
        <div class="drawer-header">
            <div>
                <div class="drawer-title">æ ¡éªŒæŠ¥å‘Š</div>
                <div class="drawer-sub" id="validationSub">â€”</div>
            </div>
            <div class="drawer-actions">
                <button class="btn btn-secondary" id="autoFixBtn" title="è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜ï¼ˆversion/templateId/pagesç­‰ï¼‰">è‡ªåŠ¨ä¿®å¤</button>
                <button class="btn btn-secondary" id="copyValidationBtn" title="å¤åˆ¶æ ¡éªŒæŠ¥å‘Š">å¤åˆ¶</button>
                <button class="btn btn-secondary" id="closeValidationBtn" title="å…³é—­">å…³é—­</button>
            </div>
        </div>
        <div class="drawer-body">
            <div class="val-summary" id="validationSummary"></div>
            <div class="val-list" id="validationList"></div>
        </div>
    </aside>

    <!-- æ¸²æŸ“å¼•æ“ä¾èµ– -->
    <script></script>
    <script src="/js/format-migrator.js"></script>
    <script src="/js/unified-course-renderer.js"></script>
    <script src="/js/course-json-validator.js"></script>
    <script src="/js/json-path-locator.js"></script>

    <script>
        // APIé…ç½® - é»˜è®¤ä½¿ç”¨ç»å¯¹è·¯å¾„
        const API_BASE = localStorage.getItem('ADMIN_API_BASE') || '/api';

        // è·å–è®¤è¯headers
        function getAuthHeaders() {
            const token = localStorage.getItem('token') || sessionStorage.getItem('token');
            return token ? { 'Authorization': `Bearer ${token}` } : {};
        }

        // çŠ¶æ€
        let currentCourse = null;
        let currentPage = 0;
        let totalPages = 0;
        let isDirty = false;
        let debounceTimer = null;
        let currentTab = 'json';
        let currentTemplateSection = 'css';
        let customTemplateStyles = null;
        let customRenderFunctions = null;
        let lastValidationResult = null;
        
                
        const NORDIC_TEMPLATE_HTML = `<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" /><title>nordic</title></head><body><div style=\"padding:16px;color:#fff;background:#111;border-radius:12px;\">æ¨¡æ¿æœªå†…è”</div><!-- TEMPLATE_PAGES_START --><!-- TEMPLATE_PAGES_END -->    <script src="/js/app-shell.js"></script>
    
</body></html>`;
        const MAGAZINE_TEMPLATE_HTML = `<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" /><title>magazine</title></head><body><div style=\"padding:16px;color:#fff;background:#111;border-radius:12px;\">æ¨¡æ¿æœªå†…è”</div><!-- TEMPLATE_PAGES_START --><!-- TEMPLATE_PAGES_END --></body></html>`;
        const PARTICLE_TEMPLATE_HTML = `<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" /><title>particle</title></head><body><div style=\"padding:16px;color:#fff;background:#111;border-radius:12px;\">æ¨¡æ¿æœªå†…è”</div><!-- TEMPLATE_PAGES_START --><!-- TEMPLATE_PAGES_END --></body></html>`;
const GPT_COURSE_TEMPLATE_HTML = `<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" /><title>gpt-course</title></head><body><div style=\"padding:16px;color:#fff;background:#111;border-radius:12px;\">æ¨¡æ¿æœªå†…è”</div><!-- TEMPLATE_PAGES_START --><!-- TEMPLATE_PAGES_END --></body></html>`;
// å†…è”æ¨¡æ¿ï¼šä¿è¯é¢„è§ˆ Blob æ— éœ€é¢å¤–ç½‘ç»œ/æ–‡ä»¶ä¾èµ–
        // æ³¨æ„ï¼šæ¨¡æ¿æœ¬èº«ä»ä¼šå¼•ç”¨æœ¬é¡¹ç›®çš„ js/cssï¼ˆåŒæºå¯åŠ è½½ï¼‰
                const CHAPTER2_TEMPLATE_HTML = `<!doctype html><html lang="zh-CN"><head><meta charset="UTF-8" /><meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover" /><title>chapter2</title></head><body><div style=\"padding:16px;color:#fff;background:#111;border-radius:12px;\">æ¨¡æ¿æœªå†…è”</div><!-- TEMPLATE_PAGES_START --><!-- TEMPLATE_PAGES_END --></body></html>`;
// DOMå…ƒç´ 
        const courseSelect = document.getElementById('courseSelect');
        const jsonEditor = document.getElementById('jsonEditor');
        const templateEditor = document.getElementById('templateEditor');
        const templateSelect = document.getElementById('templateSelect');
        const splitJsonEditor = document.getElementById('splitJsonEditor');
        const splitTemplateEditor = document.getElementById('splitTemplateEditor');
        const previewFrame = document.getElementById('previewFrame');
        const previewLoading = document.getElementById('previewLoading');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const jsonStats = document.getElementById('jsonStats');
        const pageDots = document.getElementById('pageDots');
        const pageInfo = document.getElementById('pageInfo');

        // åˆå§‹åŒ–
        async function init() {
            await loadCourseList();
            setupEventListeners();
            setupResizer();
            loadSavedTemplate();
            loadSavedTemplateSelection();
            setupTemplateSelect();
            await hydrateTemplateSelectFromManifest();
            ensureJsonEditorHasContent();

            // æ£€æŸ¥URLå‚æ•°
            const params = new URLSearchParams(window.location.search);
            const courseId = params.get('id');
            // é»˜è®¤ä¸è‡ªåŠ¨åŠ è½½ï¼ˆé¿å…åç«¯æœªå¯åŠ¨/æœªç™»å½•æ—¶å¼¹é”™å½±å“ç¼–è¾‘ä½“éªŒï¼‰
            if (courseId) {
                courseSelect.value = courseId;
                setStatus('success', 'å·²é€‰æ‹©è¯¾ç¨‹IDï¼ˆæœªè‡ªåŠ¨åŠ è½½ï¼‰ï¼Œç‚¹å‡»"åŠ è½½"æ‰‹åŠ¨æ‹‰å–');
            }

            // åˆå§‹åŒ–æ—¶ç«‹å³æ›´æ–°é¢„è§ˆå’Œå¯¼èˆª
            updateStats();
            updatePageNav();
            updatePreview();

            // æ˜¾ç¤ºå¿«æ·é”®æç¤º
            showShortcutHint();
        }

        function loadSavedTemplateSelection() {
            if (!templateSelect) return;
            const saved = localStorage.getItem('courseEditorTemplateId');
            if (saved) templateSelect.value = saved;
        }

        function setupTemplateSelect() {
            if (!templateSelect) return;
            templateSelect.addEventListener('change', () => {
                localStorage.setItem('courseEditorTemplateId', templateSelect.value);
                updatePreview();
            });
        }

        async function hydrateTemplateSelectFromManifest() {
            if (!templateSelect || !window.UnifiedCourseRenderer) return;
            try {
                window.UnifiedCourseRenderer.init({ templateBasePath: '' });
                const templates = await window.UnifiedCourseRenderer.getTemplates();
                if (!Array.isArray(templates) || templates.length === 0) return;

                const selected = templateSelect.value;
                templateSelect.innerHTML = '';
                templates.forEach(t => {
                    const opt = document.createElement('option');
                    opt.value = t.id;
                    opt.textContent = t.name ? `${t.id}ï¼ˆ${t.name}ï¼‰` : t.id;
                    templateSelect.appendChild(opt);
                });
                // æ¢å¤ç”¨æˆ·é€‰æ‹©
                const saved = localStorage.getItem('courseEditorTemplateId');
                const next = saved || selected;
                if (next && Array.from(templateSelect.options).some(o => o.value === next)) {
                    templateSelect.value = next;
                }
            } catch (e) {
                // ä¸é˜»æ–­ï¼šmanifest å¤±è´¥åˆ™ä½¿ç”¨é™æ€é€‰é¡¹
                console.warn('hydrateTemplateSelectFromManifest failed:', e);
            }
        }

        // æ˜¾ç¤ºå¿«æ·é”®æç¤º
        function showShortcutHint() {
            const hint = document.createElement('div');
            hint.className = 'shortcut-hint';
            hint.innerHTML = `
                <kbd>Ctrl+S</kbd> ä¿å­˜ &nbsp;
                <kbd>Ctrl+1/2/3</kbd> åˆ‡æ¢æ ‡ç­¾ &nbsp;
                <kbd>Ctrl+R</kbd> åˆ·æ–°é¢„è§ˆ
            `;
            document.body.appendChild(hint);
            setTimeout(() => hint.remove(), 5000);
        }

        function getDefaultExampleCourseV2() {
            return {
                version: "2.0",
                id: "example-course",
                title: "ç¤ºä¾‹è¯¾ç¨‹ï¼ˆç²˜è´´ä½ çš„JSONå³å¯æ›¿æ¢ï¼‰",
                subtitle: "ç”¨äºéªŒè¯æ¨¡æ¿æ¸²æŸ“ä¸å¯¼å‡º",
                templateId: "chapter2",
                accent: "cyan",
                pages: [
                    {
                        id: "hero",
                        page: 0,
                        kind: "hero",
                        accent: "cyan",
                        dataTitle: "ç¤ºä¾‹",
                        dataSub: "Hero é¡µ",
                        header: {
                            badge: { text: "DEMO" },
                            badgeHtml: "",
                            title: "è¯¾ç¨‹ç¼–è¾‘å™¨éªŒè¯é¡µ",
                            subtitle: "ç²˜è´´ JSON â†’ é¢„è§ˆæ¸²æŸ“ â†’ å¯¼å‡º HTML",
                            extraHtml: "",
                            delay: 200,
                            speed: 28,
                        },
                        blocks: [],
                    },
                    {
                        id: "blocks",
                        page: 1,
                        kind: "section",
                        accent: "purple",
                        dataTitle: "ç»„ä»¶ç¤ºä¾‹",
                        dataSub: "blocks æ¸²æŸ“",
                        header: {
                            label: "Demo",
                            title: "å¸¸ç”¨ Block å±•ç¤º",
                            descHtml: "ç¡®è®¤ cardsGrid / codeBlock / living ç­‰äº¤äº’æ˜¯å¦å®Œæ•´ç”Ÿæ•ˆ",
                        },
                        blocks: [
                            { type: "microLead", text: "æœ¬é¡µè·¯çº¿ï¼šâ‘  cardsGrid â‘¡ codeBlock â‘¢ living â‘£ callout" },
                            {
                                type: "cardsGrid",
                                columns: 2,
                                cards: [
                                    { accent: "cyan", icon: "ğŸ§©", title: "cardsGrid", text: "å¡ç‰‡å¸ƒå±€æ˜¯å¦æ­£ç¡®" },
                                    { accent: "purple", icon: "ğŸ§ ", title: "living", text: "ç‚¹å‡»ä»£ç è¡Œè”åŠ¨å³ä¾§" },
                                ],
                            },
                            {
                                type: "codeBlock",
                                file: "demo.py",
                                code: "def hello():\n    return 'hello'\n",
                            },
                            {
                                type: "living",
                                title: "é€è¡Œå¯è§†åŒ–ï¼ˆç‚¹å‡»å·¦ä¾§ï¼‰",
                                vizTitle: "visualization",
                                hint: "æç¤ºï¼šç‚¹å‡»å·¦ä¾§ä»£ç è¡Œ",
                                steps: [
                                    { id: "s1", label: "QKV", code: "qkv = Wqkv @ x", viz: { bullets: ["æŠ•å½±åˆ° Q/K/V"] } },
                                    { id: "s2", label: "Attention", code: "attn = softmax(q @ k.T) @ v", viz: { bullets: ["æ³¨æ„åŠ›æƒé‡", "åŠ æƒæ±‚å’Œ"] } },
                                ],
                            },
                            { type: "callout", title: "å¯¼å‡º", tag: "Tip", bodyHtml: "<p>ç‚¹å‡»é¡¶éƒ¨â€œå¯¼å‡ºHTMLâ€ä¿å­˜å½“å‰é¢„è§ˆæ–‡ä»¶ã€‚</p>" },
                        ],
                    },
                ],
            };
        }

        function ensureJsonEditorHasContent() {
            const raw = (jsonEditor && jsonEditor.value) ? String(jsonEditor.value).trim() : "";
            if (raw) return;
            const example = getDefaultExampleCourseV2();
            jsonEditor.value = JSON.stringify(example, null, 2);
            setStatus("success", "å·²è½½å…¥ç¤ºä¾‹JSONï¼ˆç›´æ¥ç²˜è´´ä½ çš„JSONè¦†ç›–å³å¯ï¼‰");
        }

        // æ˜¾ç¤ºToast
        function showToast(message, isError = false) {
            const toast = document.createElement('div');
            toast.className = 'toast' + (isError ? ' error' : '');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function escapeHtml(text) {
            if (text === undefined || text === null) return '';
            const div = document.createElement('div');
            div.textContent = String(text);
            return div.innerHTML;
        }

        function openValidationDrawer() {
            const drawer = document.getElementById('validationDrawer');
            const backdrop = document.getElementById('validationBackdrop');
            if (!drawer || !backdrop) return;
            drawer.classList.add('open');
            backdrop.classList.add('open');
            drawer.setAttribute('aria-hidden', 'false');
        }

        function closeValidationDrawer() {
            const drawer = document.getElementById('validationDrawer');
            const backdrop = document.getElementById('validationBackdrop');
            if (!drawer || !backdrop) return;
            drawer.classList.remove('open');
            backdrop.classList.remove('open');
            drawer.setAttribute('aria-hidden', 'true');
        }

        function renderValidationDrawer(result) {
            const sub = document.getElementById('validationSub');
            const summary = document.getElementById('validationSummary');
            const list = document.getElementById('validationList');
            if (!sub || !summary || !list) return;

            if (!result) {
                sub.textContent = 'â€”';
                summary.innerHTML = '';
                list.innerHTML = '';
                return;
            }

            const ok = !!result.ok;
            const count = (result.errors || []).length;
            sub.textContent = ok ? 'é€šè¿‡ï¼ˆschema v2ï¼‰' : `å¤±è´¥ï¼ˆ${count} é¡¹ï¼‰`;
            summary.innerHTML = `
                <div style="font-weight:700; font-size:13px; color:rgba(255,255,255,.92);">
                    ${ok ? 'å¯ä»¥å‘å¸ƒ' : 'é˜»æ­¢å‘å¸ƒ'}
                </div>
                <div class="val-badges">
                    <span class="badge ${ok ? 'ok' : 'bad'}">${ok ? 'OK' : 'FAIL'}</span>
                    <span class="badge">${count} errors</span>
                    <span class="badge">version: ${(result.normalized && result.normalized.version) ? escapeHtml(result.normalized.version) : 'â€”'}</span>
                    <span class="badge">templateId: ${(result.normalized && result.normalized.templateId) ? escapeHtml(result.normalized.templateId) : 'â€”'}</span>
                </div>
            `;

            list.innerHTML = '';
            // åˆ†ç»„ï¼šæŒ‰ pages[i] èšåˆï¼Œå‡å°‘å™ªå£°
            const errors = Array.isArray(result.errors) ? result.errors : [];
            const groups = new Map();
            const order = [];
            errors.forEach((e) => {
                const m = String(e.path || '').match(/pages\\[(\\d+)\\]/);
                const key = m ? `pages[${m[1]}]` : '$';
                if (!groups.has(key)) { groups.set(key, []); order.push(key); }
                groups.get(key).push(e);
            });

            order.forEach((key) => {
                const header = document.createElement('div');
                header.className = 'val-item';
                header.style.cursor = 'default';
                header.innerHTML = `<div class="val-path">${escapeHtml(key)}</div><div class="val-msg">å…± ${(groups.get(key) || []).length} é¡¹</div>`;
                list.appendChild(header);

                (groups.get(key) || []).forEach((e, idx) => {
                const item = document.createElement('div');
                item.className = 'val-item';
                item.dataset.path = e.path || '$';
                item.dataset.index = String(idx);
                item.innerHTML = `
                    <div class="val-path">${escapeHtml(e.path || '$')}</div>
                    <div class="val-msg">${escapeHtml(e.message || '')}</div>
                    ${e.error ? `<div class="val-error">${escapeHtml(e.error)}</div>` : ''}
                `;
                item.addEventListener('click', () => {
                    try { locateJsonPathInEditor(e.path || '$'); } catch (_) {}
                });
                list.appendChild(item);
                });
            });
        }

        function locateJsonPathInEditor(path) {
            const text = String(jsonEditor.value || '');
            if (!path || path === '$') {
                jsonEditor.focus();
                jsonEditor.setSelectionRange(0, 0);
                return;
            }

            if (window.JsonPathLocator && typeof window.JsonPathLocator.locatePathRange === 'function') {
                const range = window.JsonPathLocator.locatePathRange(text, path);
                if (range && Number.isFinite(range.start) && Number.isFinite(range.end)) {
                    jsonEditor.focus();
                    jsonEditor.setSelectionRange(range.start, range.end);
                    return;
                }
            }

            // å…œåº•ï¼šæ—§ç²—å®šä½
            const mKey = path.match(/\.([a-zA-Z0-9_]+)$/);
            const needle = mKey ? `"${mKey[1]}"` : '';
            const at = needle ? text.indexOf(needle) : -1;
            jsonEditor.focus();
            jsonEditor.setSelectionRange(at !== -1 ? at : 0, Math.min((at !== -1 ? at : 0) + 200, text.length));
        }

        function downloadTextFile(filename, content, mime = 'text/plain') {
            const blob = new Blob([content], { type: mime });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            a.remove();
            setTimeout(() => URL.revokeObjectURL(url), 2000);
        }

        // åŠ è½½ä¿å­˜çš„æ¨¡æ¿
        function loadSavedTemplate() {
            const savedStyles = localStorage.getItem('customTemplateStyles');
            const savedRender = localStorage.getItem('customRenderFunctions');
            if (savedStyles) {
                customTemplateStyles = savedStyles;
            }
            if (savedRender) {
                customRenderFunctions = savedRender;
            }
            updateTemplateEditor();
            // æ›´æ–°çŠ¶æ€æ 
            const templateStatus = document.getElementById('templateStatus');
            if (templateStatus) {
                templateStatus.textContent = customTemplateStyles ? 'ğŸ¨ è‡ªå®šä¹‰æ¨¡æ¿' : 'é»˜è®¤æ¨¡æ¿';
            }
        }

        // æ›´æ–°æ¨¡æ¿ç¼–è¾‘å™¨å†…å®¹
        function updateTemplateEditor() {
            const section = currentTemplateSection;
            if (section === 'css') {
                templateEditor.value = customTemplateStyles || getTemplateStyles();
            } else if (section === 'render') {
                templateEditor.value = customRenderFunctions || getRenderFunctionsSource();
            } else if (section === 'preview') {
                try {
                    const courseData = JSON.parse(jsonEditor.value);
                    templateEditor.value = generatePreviewHtml(courseData, currentPage);
                } catch (e) {
                    templateEditor.value = '// JSONè§£æé”™è¯¯ï¼Œæ— æ³•ç”Ÿæˆé¢„è§ˆ';
                }
            }
        }

        // è·å–æ¸²æŸ“å‡½æ•°æºç 
        function getRenderFunctionsSource() {
            return `// ç»„ä»¶æ¸²æŸ“å‡½æ•°
// ä¿®æ”¹è¿™äº›å‡½æ•°æ¥è‡ªå®šä¹‰ç»„ä»¶çš„æ¸²æŸ“æ–¹å¼

function renderComponent(component) {
    const content = component.content || {};

    switch (component.type) {
        case 'hero':
            return \`
                <span class="hero-badge">
                    <span class="hero-badge-dot"></span>
                    \${content.badge || 'AI è¯¾ç¨‹'}
                </span>
                <h1 class="hero-title">
                    <span class="hero-title-gradient">
                        <span class="typing-text" data-text="\${content.title || ''}">\${content.title || ''}</span>
                    </span>
                </h1>
                <p class="hero-subtitle">
                    <span class="typing-text" data-text="\${content.subtitle || ''}">\${content.subtitle || ''}</span>
                </p>
            \`;

        case 'heading':
            const level = content.level || 2;
            return \`
                <span class="section-label">\${content.icon || ''} \${content.label || ''}</span>
                <h\${level} class="section-title">
                    <span class="typing-text" data-text="\${content.text || ''}">\${content.text || ''}</span>
                </h\${level}>
            \`;

        case 'paragraph':
            return \`<p class="section-desc">\${content.html || content.text || ''}</p>\`;

        case 'cards-grid':
            const cards = (content.cards || []).map((card, i) => \`
                <div class="glass-card" data-delay="\${i * 150}">
                    <div class="card-icon \${card.iconClass || ''}">\${card.icon || ''}</div>
                    <h3 class="card-title">\${card.title || ''}</h3>
                    \${card.subtitle ? \`<p class="card-subtitle">\${card.subtitle}</p>\` : ''}
                    <p class="card-text">\${card.description || ''}</p>
                </div>
            \`).join('');
            return \`<div class="cards-grid">\${cards}</div>\`;

        case 'formula-box':
            return \`
                <div class="formula-box">
                    <div class="formula-label">\${content.label || 'å…¬å¼'}</div>
                    <div class="formula-main">\${content.formula || content.html || ''}</div>
                    \${content.explanation ? \`<p class="formula-desc">\${content.explanation}</p>\` : ''}
                </div>
            \`;

        case 'sticky-note':
            return \`
                <div class="sticky-note \${content.color || 'yellow'}">
                    <div class="sticky-title">\${content.title || ''}</div>
                    <p class="sticky-text">\${content.text || content.content || ''}</p>
                </div>
            \`;

        case 'code-block':
            return \`
                <div class="code-container">
                    <div class="code-header">
                        <div class="code-dots">
                            <span class="code-dot red"></span>
                            <span class="code-dot yellow"></span>
                            <span class="code-dot green"></span>
                        </div>
                        <span class="code-lang">\${content.language || 'python'}</span>
                    </div>
                    <div class="code-body">
                        <pre>\${escapeHtml(content.code || '')}</pre>
                    </div>
                </div>
            \`;

        // æ›´å¤šç»„ä»¶ç±»å‹...
        default:
            return \`<div class="unknown-component">[\${component.type}]</div>\`;
    }
}`;
        }

        // åˆ‡æ¢ç¼–è¾‘å™¨æ ‡ç­¾
        function switchTab(tab) {
            currentTab = tab;
            const jsonPane = document.getElementById('jsonPane');
            const templatePane = document.getElementById('templatePane');
            const splitPane = document.getElementById('splitPane');
            const currentTabInfo = document.getElementById('currentTabInfo');
            const templateStatus = document.getElementById('templateStatus');

            // æ›´æ–°æ ‡ç­¾æ ·å¼
            document.querySelectorAll('.editor-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.tab === tab);
            });

            // åˆ‡æ¢é¢æ¿
            jsonPane.classList.toggle('hidden', tab !== 'json');
            templatePane.classList.toggle('hidden', tab !== 'template');
            splitPane.classList.toggle('hidden', tab !== 'split');

            // æ›´æ–°çŠ¶æ€æ 
            const tabNames = { json: 'JSONæ¨¡å¼', template: 'æ¨¡æ¿æ¨¡å¼', split: 'åˆ†å±æ¨¡å¼' };
            currentTabInfo.textContent = tabNames[tab];

            // æ›´æ–°æ¨¡æ¿çŠ¶æ€
            templateStatus.textContent = customTemplateStyles ? 'ğŸ¨ è‡ªå®šä¹‰æ¨¡æ¿' : 'é»˜è®¤æ¨¡æ¿';

            // åŒæ­¥å†…å®¹
            if (tab === 'template') {
                updateTemplateEditor();
            } else if (tab === 'split') {
                splitJsonEditor.value = jsonEditor.value;
                splitTemplateEditor.value = customTemplateStyles || getTemplateStyles();
            }
        }

        // åˆ‡æ¢æ¨¡æ¿å­æ ‡ç­¾
        function switchTemplateSection(section) {
            currentTemplateSection = section;
            document.querySelectorAll('.template-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.section === section);
            });
            updateTemplateEditor();
        }

        // ä¿å­˜æ¨¡æ¿
        function saveTemplate() {
            const templateStatus = document.getElementById('templateStatus');
            if (currentTemplateSection === 'css') {
                customTemplateStyles = templateEditor.value;
                localStorage.setItem('customTemplateStyles', customTemplateStyles);
                showToast('CSSæ ·å¼å·²ä¿å­˜');
            } else if (currentTemplateSection === 'render') {
                customRenderFunctions = templateEditor.value;
                localStorage.setItem('customRenderFunctions', customRenderFunctions);
                showToast('æ¸²æŸ“å‡½æ•°å·²ä¿å­˜');
            }
            // æ›´æ–°çŠ¶æ€æ 
            templateStatus.textContent = customTemplateStyles ? 'ğŸ¨ è‡ªå®šä¹‰æ¨¡æ¿' : 'é»˜è®¤æ¨¡æ¿';
            updatePreview();
        }

        // é‡ç½®æ¨¡æ¿
        function resetTemplate() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ¨¡æ¿å—ï¼Ÿ')) {
                localStorage.removeItem('customTemplateStyles');
                localStorage.removeItem('customRenderFunctions');
                customTemplateStyles = null;
                customRenderFunctions = null;
                updateTemplateEditor();
                updatePreview();
                // æ›´æ–°çŠ¶æ€æ 
                document.getElementById('templateStatus').textContent = 'é»˜è®¤æ¨¡æ¿';
                showToast('æ¨¡æ¿å·²é‡ç½®');
            }
        }

        // åŠ è½½è¯¾ç¨‹åˆ—è¡¨
        async function loadCourseList() {
            try {
                const res = await fetch(`${API_BASE}/course-templates/courses`, {
                    headers: getAuthHeaders()
                });
                const result = await res.json();

                if (result.code === 0 && result.data) {
                    courseSelect.innerHTML = '<option value="">é€‰æ‹©è¯¾ç¨‹...</option>';
                    result.data.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course.courseId;
                        option.textContent = `${course.title} (${course.status === 'published' ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'})`;
                        courseSelect.appendChild(option);
                    });
                }
            } catch (e) {
                console.error('åŠ è½½è¯¾ç¨‹åˆ—è¡¨å¤±è´¥:', e);
            }
        }

        // åŠ è½½è¯¾ç¨‹
        async function loadCourse(courseId) {
            if (!courseId) return;

            previewLoading.classList.remove('hidden');
            setStatus('loading', 'åŠ è½½ä¸­...');

            try {
                const res = await fetch(`${API_BASE}/course-templates/courses/by-course-id/${courseId}/content`, {
                    headers: getAuthHeaders()
                });
                const data = await res.json();

                if (data.pages || data.title) {
                    currentCourse = data;
                    jsonEditor.value = JSON.stringify(data, null, 2);
                    updateStats();
                    updatePageNav();
                    updatePreview();
                    setStatus('success', 'å·²åŠ è½½');
                    isDirty = false;
                } else {
                    throw new Error(data.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (e) {
                console.error('åŠ è½½è¯¾ç¨‹å¤±è´¥:', e);
                setStatus('error', 'åŠ è½½å¤±è´¥: ' + e.message);
            } finally {
                previewLoading.classList.add('hidden');
            }
        }

        // æ›´æ–°é¢„è§ˆ
        async function updatePreview() {
            // é¢„è§ˆ loadingï¼šè¿›å…¥æ›´æ–°æ—¶æ˜¾ç¤ºï¼Œå®Œæˆåéšè—
            if (previewLoading) previewLoading.classList.remove('hidden');
            try {
                const courseData = JSON.parse(jsonEditor.value);
                const previewHtml = await generatePreviewHtml(courseData, currentPage);

                const blob = new Blob([previewHtml], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                previewFrame.src = url;
                previewFrame.onload = () => {
                    if (previewLoading) previewLoading.classList.add('hidden');
                };
                previewFrame.onerror = () => {
                    if (previewLoading) previewLoading.classList.add('hidden');
                    setStatus('error', 'é¢„è§ˆiframeåŠ è½½å¤±è´¥');
                };

                setTimeout(() => URL.revokeObjectURL(url), 5000);
                setStatus('success', 'é¢„è§ˆå·²æ›´æ–°');
            } catch (e) {
                setStatus('error', 'é¢„è§ˆç”Ÿæˆå¤±è´¥: ' + (e && e.message ? e.message : String(e)));
            } finally {
                // å…œåº•ï¼šé¿å… onload ä¸è§¦å‘æ—¶ä¸€ç›´è½¬åœˆ
                setTimeout(() => {
                    if (previewLoading) previewLoading.classList.add('hidden');
                }, 800);
            }
        }

        // ç”Ÿæˆé¢„è§ˆHTMLï¼ˆä½¿ç”¨ç”¨æˆ·æä¾›çš„ç²¾ç¾æ¨¡æ¿ï¼‰
        async function generatePreviewHtml(courseData, pageIndex = 0) {
            const v2 = (window.FormatMigrator ? window.FormatMigrator.ensureV2(courseData) : courseData);
            const selectedTemplateId = (templateSelect && templateSelect.value) ? templateSelect.value : (v2.templateId || 'chapter2');

            if (!window.UnifiedCourseRenderer) {
                throw new Error('UnifiedCourseRenderer not loaded');
            }

            // ç»Ÿä¸€èµ°åŒä¸€æ¡æ¸²æŸ“é“¾è·¯ï¼šmanifest.json -> template.html -> ChapterTemplateEngine.applyTemplate
            window.UnifiedCourseRenderer.init({ templateBasePath: '' });
            const html = await window.UnifiedCourseRenderer.renderCourse(v2, null, { templateId: selectedTemplateId });

            // ç¼–è¾‘å™¨éœ€è¦å›ºå®šæ‰“å¼€åˆ°å½“å‰é¡µï¼ˆå¦‚æœæ¨¡æ¿æä¾› goToPage åˆ™è°ƒç”¨ï¼Œå¦åˆ™å…œåº• classï¼‰
            const bootScript = `
<script>
  (function(){
    try {
      var target = ${pageIndex};
      if (typeof window.goToPage === 'function') {
        window.goToPage(target);
      } else {
        var pages = Array.from(document.querySelectorAll('.page'));
        pages.forEach(function(p, i){
          p.classList.remove('active'); p.classList.remove('prev');
          if (i === target) p.classList.add('active');
          else if (i < target) p.classList.add('prev');
        });
      }
    } catch(e) {}
  })();
<\/script>`;

            return html.replace(new RegExp("<\\\\/body>", "i"), `${bootScript}\\n</body>`);
        }

        // overrideTemplatePrimaryStyle / getTemplateHtmlById å·²åºŸå¼ƒï¼šç»Ÿä¸€ç”± UnifiedCourseRenderer + manifest è´Ÿè´£åŠ è½½æ¨¡æ¿

        // ç”Ÿæˆå•ä¸ªé¡µé¢HTML
        function generatePageHtml(page, index, activeClass) {
            // å…¼å®¹ä¸¤ç§æ ¼å¼ï¼š
            // 1. page.components æ•°ç»„æ ¼å¼
            // 2. page.blocks æ•°ç»„æ ¼å¼ (schema v2.0)
            // 3. page.type + page.content ç›´æ¥æ ¼å¼
            let components = page.components || page.blocks || [];

            // å¦‚æœé¡µé¢æœ¬èº«æœ‰typeï¼Œå°†å…¶ä½œä¸ºä¸€ä¸ªç»„ä»¶å¤„ç†
            if (page.type && !components.length) {
                components = [{ type: page.type, content: page.content || {} }];
            }

            const isHero = page.type === 'hero' || page.layout === 'hero' || components.some(c => c.type === 'hero');

            let innerHtml = '';

            components.forEach(component => {
                innerHtml += renderComponent(component);
            });

            return `
                <section class="page ${isHero ? 'hero-page' : ''} ${activeClass}" data-page="${index}">
                    <div class="page-inner">
                        ${innerHtml}
                    </div>
                </section>
            `;
        }

        // æ¸²æŸ“ç»„ä»¶
        function renderComponent(component) {
            const content = component.content || component;

            switch (component.type) {
                // æ”¯æŒ schema v2.0 å—ç±»å‹
                case 'html':
                    return content.html || '';
                case 'bridgeRow':
                    return `
                        <div class="bridge-row">
                            <span class="prev">${content.prevLabel}: ${content.prev}</span>
                            <span class="current">${content.currentLabel}: ${content.current}</span>
                            <span class="next">${content.nextLabel}: ${content.next}</span>
                        </div>
                    `;
                case 'microLead':
                    return `<div class="micro-lead">${content.text}</div>`;
                case 'keyline':
                    return `<div class="keyline"><span class="dot">${content.dot}</span>${content.html}</div>`;
                case 'accordion':
                    return `
                        <div class="accordion ${content.open ? 'open' : ''}">
                            <div class="accordion-summary">${content.summary} <span class="badge">${content.badge}</span></div>
                            <div class="accordion-content">${content.contentHtml}</div>
                        </div>
                    `;
                case 'thinkBox':
                    return `
                        <div class="think-box">
                            <h4>${content.title}</h4>
                            <p>${content.text}</p>
                        </div>
                    `;
                case 'prose':
                    return `<div class="prose">${content.paragraphs.map(p => `<p>${p}</p>`).join('')}</div>`;
                case 'callout':
                    return `
                        <div class="callout">
                            <h4>${content.title} <span class="tag">${content.tag}</span></h4>
                            <div class="callout-body">${content.bodyHtml}</div>
                        </div>
                    `;
                case 'codeBlock':
                    return `
                        <div class="code-container">
                            <div class="code-header">
                                <div class="code-dots"><span class="code-dot red"></span><span class="code-dot yellow"></span><span class="code-dot green"></span></div>
                                <span class="code-lang">${escapeHtml(content.file || content.filename || content.title || 'code')}</span>
                            </div>
                            <div class="code-body"><pre>${escapeHtml(content.code || '')}</pre></div>
                        </div>
                    `;
                case 'living':
                    return `
                        <div class="living">
                            <div class="code-panel">
                                <div class="code-panel-head">
                                    <div class="code-dots"><span class="code-dot red"></span><span class="code-dot yellow"></span><span class="code-dot green"></span></div>
                                    <div class="code-panel-title">${escapeHtml(content.title || content.codeTitle || 'ä»£ç ï¼ˆé€è¡Œå¯è§†åŒ–ï¼šç‚¹å‡»å·¦ä¾§ï¼‰')}</div>
                                </div>
                                <div class="code-lines">
                                    ${(content.steps || []).map((step, idx) => {
                                        const id = escapeHtml(step.id || `step-${idx + 1}`);
                                        const label = escapeHtml(step.label || `Step ${idx + 1}`);
                                        const hint = escapeHtml(step.hint || '');
                                        const hintAttr = hint ? ` data-hint="${hint}"` : '';
                                        const active = (step.active || (!(content.steps || []).some(s => s && s.active) && idx === 0)) ? ' active' : '';
                                        const lineHtml = escapeHtml((step.code || step.text || '')).replace(/\n/g, '<br/>');
                                        return `<div class="code-line${active}" data-target="${id}" data-label="${label}"${hintAttr}>${lineHtml}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                            <div class="visual-panel">
                                <div class="visual-head">
                                    <div class="visual-title">${escapeHtml(content.vizTitle || 'visualization')}</div>
                                    <div class="visual-title" data-role="viz-label"></div>
                                    <div class="hint" data-role="viz-hint">${escapeHtml(content.hint || 'æç¤ºï¼šç‚¹å‡»å·¦ä¾§ä»£ç è¡Œ')}</div>
                                </div>
                                <div class="visual-body">
                                    ${(content.steps || []).map((step, idx) => {
                                        const id = escapeHtml(step.id || `step-${idx + 1}`);
                                        const active = (step.active || (!(content.steps || []).some(s => s && s.active) && idx === 0)) ? ' active' : '';
                                        // ç®€åŒ–ï¼šç¼–è¾‘å™¨é‡Œå…ˆä»¥ vizHtml/viz.html ä¸ºä¸»ï¼Œç¼ºå¤±åˆ™å…œåº•å±•ç¤º bullets
                                        const viz = step.viz || {};
                                        const body = step.vizHtml || viz.html || (Array.isArray(viz.bullets) ? `<ul class="viz-list">${viz.bullets.map(b => `<li><span class="viz-dot">!</span><span>${escapeHtml(b)}</span></li>`).join('')}</ul>` : '');
                                        return `<div class="viz-step${active}" data-step="${id}"><div class="viz-card">${body}</div></div>`;
                                    }).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                case 'cardsGrid':
                    return `
                        <div class="cards-grid" style="--grid-cols:${Number(content.columns || content.cols || 3)}">
                            <div class="cards-container">
                                ${(content.cards || []).map(card => `
                                    <div class="grid-card" ${card.accent ? `data-accent="${escapeHtml(card.accent)}"` : ''}>
                                        ${card.icon ? `<div class="card-icon">${escapeHtml(card.icon)}</div>` : ''}
                                        <div class="card-head">
                                            <div class="card-title">${escapeHtml(card.title || '')}</div>
                                            ${card.subtitle ? `<div class="card-subtitle">${escapeHtml(card.subtitle)}</div>` : ''}
                                        </div>
                                        <div class="card-body">
                                            ${card.text ? escapeHtml(card.text) : ''}
                                            ${Array.isArray(card.bullets) ? `<ul class="card-bullets">${card.bullets.map(b => `<li>${escapeHtml(b)}</li>`).join('')}</ul>` : ''}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                case 'diagram':
                    return `
                        <div class="diagram">
                            ${content.svg}
                            ${content.caption ? `<p class="diagram-caption">${content.caption}</p>` : ''}
                        </div>
                    `;
                case 'timeline':
                    return `
                        <div class="timeline">
                            ${content.items.map(item => `
                                <div class="timeline-item">
                                    <span class="timeline-year">${item.year || item.date}</span>
                                    <h4>${item.title}</h4>
                                    <p>${item.text}</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                case 'table':
                    return `
                        <div class="data-table">
                            ${content.caption ? `<p class="table-caption">${content.caption}</p>` : ''}
                            <table>
                                ${content.headers ? `<thead><tr>${content.headers.map(h => `<th>${h}</th>`).join('')}</tr></thead>` : ''}
                                <tbody>
                                    ${content.rows.map(row => `<tr>${row.map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                case 'formulaBox':
                    return `
                        <div class="formula-box">
                            <span class="formula-label">${content.label}</span>
                            <div class="formula-main">${content.math}</div>
                            ${content.desc ? `<p class="formula-desc">${content.desc}</p>` : ''}
                        </div>
                    `;
                case 'exampleBox':
                    return `
                        <div class="example-box ${content.variant}">
                            <span class="example-icon">${content.icon}</span>
                            <h4>${content.title}</h4>
                            ${content.code ? `<pre><code>${escapeHtml(content.code)}</code></pre>` : ''}
                            ${content.note ? `<p class="example-note">${content.note}</p>` : ''}
                        </div>
                    `;
                case 'mathBlock':
                    return `
                        <div class="math-block">
                            <span class="math-label">${content.label}</span>
                            <div class="math-main">${content.math}</div>
                            ${content.note ? `<p class="math-note">${content.note}</p>` : ''}
                        </div>
                    `;
                case 'quoteBox':
                    return `
                        <div class="quote-box">
                            <blockquote>${content.quote}</blockquote>
                            ${content.author ? `<cite>${content.author}${content.source ? `, ${content.source}` : ''}</cite>` : ''}
                        </div>
                    `;
                case 'stickyNote':
                    return `
                        <div class="sticky-note ${content.color || 'yellow'}" style="transform: rotate(${content.rotate || 0}deg)">
                            <h4>${content.title}</h4>
                            <p>${content.text}</p>
                        </div>
                    `;
                case 'labCard':
                    return `
                        <div class="lab-card">
                            <span class="lab-icon">${content.icon}</span>
                            <h4>${content.title}</h4>
                            <p class="lab-description">${content.description}</p>
                            ${content.tags ? `<div class="lab-tags">${content.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}</div>` : ''}
                            ${content.link ? `<a href="${content.link}" class="lab-link">æŸ¥çœ‹è¯¦æƒ…</a>` : ''}
                        </div>
                    `;
                case 'codeDiagramSplit':
                    return `
                        <div class="code-diagram-split">
                            <div class="code-section">
                                <h4>${content.codeTitle}</h4>
                                <pre><code>${escapeHtml(content.code)}</code></pre>
                            </div>
                            <div class="diagram-section">
                                <h4>${content.diagramTitle}</h4>
                                ${content.diagramSvg}
                                ${content.diagramCaption ? `<p class="diagram-caption">${content.diagramCaption}</p>` : ''}
                            </div>
                        </div>
                    `;
                case 'pageTransition':
                    return `
                        <div class="page-transition">
                            <span class="transition-from">${content.from}</span>
                            <span class="transition-arrow">â†’</span>
                            <span class="transition-to">${content.to}</span>
                            <p class="transition-text">${content.text}</p>
                        </div>
                    `;

                // ä¿ç•™åŸæœ‰çš„ç»„ä»¶ç±»å‹æ”¯æŒ
                case 'hero':
                    return `
                        <span class="hero-badge">
                            <span class="hero-badge-dot"></span>
                            ${content.badge || 'AI è¯¾ç¨‹'}
                        </span>
                        <h1 class="hero-title">
                            <span class="hero-title-gradient">
                                <span class="typing-text" data-text="${content.title || ''}">${content.title || ''}</span>
                            </span>
                        </h1>
                        <p class="hero-subtitle">
                            <span class="typing-text" data-text="${content.subtitle || ''}" data-delay="600">${content.subtitle || ''}</span>
                        </p>
                    `;

                case 'heading':
                    const level = content.level || 2;
                    return `
                        <span class="section-label">${content.icon || ''} ${content.label || ''}</span>
                        <h${level} class="section-title">
                            <span class="typing-text" data-text="${content.text || ''}">${content.text || ''}</span>
                        </h${level}>
                    `;

                case 'paragraph':
                    return `<p class="section-desc">${content.html || content.text || ''}</p>`;

                case 'cards-grid':
                    const cards = (content.cards || []).map((card, i) => `
                        <div class="glass-card" data-delay="${i * 150}">
                            <div class="card-icon ${card.iconClass || ''}">${card.icon || ''}</div>
                            <h3 class="card-title">${card.title || ''}</h3>
                            ${card.subtitle ? `<p class="card-subtitle">${card.subtitle}</p>` : ''}
                            <p class="card-text">${card.description || ''}</p>
                        </div>
                    `).join('');
                    return `<div class="cards-grid">${cards}</div>`;

                case 'formula-box':
                    return `
                        <div class="formula-box">
                            <div class="formula-label">${content.label || 'å…¬å¼'}</div>
                            <div class="formula-main">${content.formula || content.html || ''}</div>
                            ${content.explanation ? `<p class="formula-desc">${content.explanation}</p>` : ''}
                        </div>
                    `;

                case 'sticky-note':
                    return `
                        <div class="sticky-note ${content.color || 'yellow'}" data-delay="${content.delay || 400}">
                            <div class="sticky-title">${content.title || ''}</div>
                            <p class="sticky-text">${content.text || content.content || ''}</p>
                        </div>
                    `;

                case 'timeline':
                    const items = (content.items || []).map((item, i) => `
                        <div class="timeline-item" data-delay="${i * 150}">
                            <span class="timeline-year">${item.year || item.date || ''}</span>
                            <h4 class="timeline-title">${item.title || ''}</h4>
                            <p class="timeline-desc">${item.description || ''}</p>
                        </div>
                    `).join('');
                    return `<div class="timeline">${items}</div>`;

                case 'diagram':
                    return `
                        <div class="diagram-container">
                            ${content.svg || ''}
                            ${content.caption ? `<p class="diagram-caption">${content.caption}</p>` : ''}
                        </div>
                    `;

                case 'code-block':
                    return `
                        <div class="code-container">
                            <div class="code-header">
                                <div class="code-dots">
                                    <span class="code-dot red"></span>
                                    <span class="code-dot yellow"></span>
                                    <span class="code-dot green"></span>
                                </div>
                                <span class="code-lang">${content.language || 'python'}</span>
                            </div>
                            <div class="code-body">
                                <pre>${escapeHtml(content.code || '')}</pre>
                            </div>
                        </div>
                    `;

                case 'key-points':
                    const points = (content.points || []).map(p => `<li>${p}</li>`).join('');
                    return `
                        <div class="key-points">
                            <h4>${content.icon || 'â­'} ${content.title || 'è¦ç‚¹'}</h4>
                            <ul>${points}</ul>
                        </div>
                    `;

                case 'callout':
                    return `
                        <div class="sticky-note ${content.type === 'tip' ? 'blue' : content.type === 'warning' ? 'yellow' : 'green'}">
                            <div class="sticky-title">${content.title || ''}</div>
                            <p class="sticky-text">${content.text || ''}</p>
                        </div>
                    `;

                case 'socratic-dialogue':
                    const dialogues = (content.dialogues || []).map(d => `
                        <div class="dialogue-item ${d.role}">
                            <div class="dialogue-avatar">${d.role === 'teacher' ? 'ğŸ‘¨â€ğŸ«' : 'ğŸ§‘â€ğŸ“'}</div>
                            <div class="dialogue-content">
                                <div class="dialogue-name">${d.name || ''}</div>
                                <div class="dialogue-text">${d.text || ''}</div>
                                ${d.thought ? `<div class="dialogue-thought">ğŸ’­ ${d.thought}</div>` : ''}
                            </div>
                        </div>
                    `).join('');
                    return `<div class="socratic-dialogues">${dialogues}</div>`;

                default:
                    return `<div class="unknown-component">[${component.type}]</div>`;
            }
        }

        function renderLivingCode(steps) {
            return steps.map((step, index) => `
                <div class="living-step">
                    <div class="step-number">Step ${index + 1}</div>
                    <div class="step-content">
                        ${step.html || `<pre><code>${escapeHtml(step.code || '')}</code></pre>`}
                    </div>
                </div>
            `).join('');
        }

        function escapeHtml(text) {
            return text.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        }

        // è·å–æ¨¡æ¿æ ·å¼
        function getTemplateStyles() {
            return `
                :root {
                    --color-primary: #667eea;
                    --color-secondary: #764ba2;
                    --color-accent-pink: #f093fb;
                    --color-accent-cyan: #4facfe;
                    --color-accent-teal: #00f2fe;
                    --color-text: #ffffff;
                    --color-text-muted: rgba(255, 255, 255, 0.7);
                    --color-glass: rgba(255, 255, 255, 0.04);
                    --color-glass-border: rgba(255, 255, 255, 0.08);
                    --font-display: 'Syne', sans-serif;
                    --font-serif: 'Noto Serif SC', serif;
                    --font-sans: 'Noto Sans SC', sans-serif;
                    --font-mono: 'JetBrains Mono', monospace;
                    --font-handwriting: 'Caveat', cursive;
                }
                * { margin: 0; padding: 0; box-sizing: border-box; }
                html, body { overflow: hidden; height: 100%; width: 100%; }
                body { font-family: var(--font-sans); background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); color: var(--color-text); line-height: 1.7; }

                .bg-container { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 0; }
                .glass-orb { position: absolute; border-radius: 50%; filter: blur(80px); opacity: 0.5; animation: orbFloat 25s ease-in-out infinite; }
                .glass-orb-1 { width: 700px; height: 700px; background: linear-gradient(135deg, #667eea, #764ba2); top: -250px; right: -200px; }
                .glass-orb-2 { width: 600px; height: 600px; background: linear-gradient(135deg, #f093fb, #f5576c); bottom: -200px; left: -200px; animation-delay: -8s; }
                .glass-orb-3 { width: 500px; height: 500px; background: linear-gradient(135deg, #4facfe, #00f2fe); top: 40%; left: 30%; animation-delay: -16s; }
                @keyframes orbFloat { 0%, 100% { transform: translate3d(0, 0, 0) scale(1); } 25% { transform: translate3d(40px, -40px, 0) scale(1.08); } 50% { transform: translate3d(-30px, 30px, 0) scale(0.95); } 75% { transform: translate3d(-40px, -30px, 0) scale(1.03); } }

                .grid-overlay { position: fixed; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.015) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.015) 1px, transparent 1px); background-size: 60px 60px; pointer-events: none; z-index: 1; }

                .pages-wrapper { position: relative; width: 100%; height: 100vh; overflow: hidden; z-index: 10; }
                .page { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; padding: 80px 100px; opacity: 0; transform: translate3d(100%, 0, 0); transition: all 0.8s cubic-bezier(0.16, 1, 0.3, 1); overflow-y: auto; }
                .page.active { opacity: 1; transform: translate3d(0, 0, 0); }
                .page.prev { transform: translate3d(-100%, 0, 0); }
                .page-inner { max-width: 1200px; margin: 0 auto; width: 100%; }

                .hero-page { text-align: center; justify-content: center; align-items: center; }
                .hero-badge { display: inline-flex; align-items: center; gap: 10px; padding: 12px 24px; background: var(--color-glass); backdrop-filter: blur(10px); border: 1px solid var(--color-glass-border); border-radius: 100px; font-size: 14px; font-weight: 500; color: rgba(255, 255, 255, 0.9); margin-bottom: 32px; }
                .hero-badge-dot { width: 10px; height: 10px; background: linear-gradient(135deg, var(--color-accent-cyan), var(--color-accent-teal)); border-radius: 50%; animation: pulse 2s ease infinite; }
                @keyframes pulse { 0%, 100% { opacity: 1; transform: scale(1); } 50% { opacity: 0.8; transform: scale(0.9); } }
                .hero-title { font-family: var(--font-display); font-size: clamp(56px, 10vw, 120px); font-weight: 800; letter-spacing: -0.04em; line-height: 1.05; margin-bottom: 32px; }
                .hero-title-gradient { background: linear-gradient(135deg, #fff 0%, #a5b4fc 40%, #818cf8 70%, #667eea 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
                .hero-subtitle { font-size: 20px; color: var(--color-text-muted); max-width: 700px; margin: 0 auto; line-height: 1.9; }

                .section-label { display: inline-flex; align-items: center; gap: 12px; font-size: 13px; font-weight: 600; letter-spacing: 0.15em; text-transform: uppercase; color: var(--color-accent-cyan); margin-bottom: 16px; }
                .section-label::before { content: ''; width: 24px; height: 2px; background: linear-gradient(90deg, var(--color-accent-cyan), transparent); }
                .section-title { font-family: var(--font-serif); font-size: clamp(32px, 5vw, 52px); font-weight: 600; letter-spacing: -0.02em; line-height: 1.2; margin-bottom: 20px; }
                .section-desc { font-size: 17px; color: var(--color-text-muted); max-width: 680px; line-height: 1.9; }

                .cards-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-top: 40px; }
                .glass-card { background: var(--color-glass); backdrop-filter: blur(20px); border: 1px solid var(--color-glass-border); border-radius: 24px; padding: 32px; transition: all 0.5s cubic-bezier(0.16, 1, 0.3, 1); opacity: 0; transform: translate3d(0, 40px, 0) scale(0.98); }
                .glass-card.visible { opacity: 1; transform: translate3d(0, 0, 0) scale(1); }
                .glass-card:hover { background: rgba(255, 255, 255, 0.08); border-color: rgba(255, 255, 255, 0.2); transform: translate3d(0, -8px, 0) scale(1.02); }
                .card-icon { width: 64px; height: 64px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-family: var(--font-display); font-size: 28px; font-weight: 800; margin-bottom: 20px; background: rgba(255, 255, 255, 0.03); }
                .card-icon.q { color: #a5b4fc; }
                .card-icon.k { color: #f9a8d4; }
                .card-icon.v { color: #67e8f9; }
                .card-title { font-family: var(--font-serif); font-size: 20px; font-weight: 600; margin-bottom: 8px; }
                .card-subtitle { font-family: var(--font-mono); font-size: 12px; color: var(--color-accent-cyan); margin-bottom: 12px; opacity: 0.8; }
                .card-text { font-size: 14px; color: var(--color-text-muted); line-height: 1.75; }

                .sticky-note { position: relative; padding: 24px 28px; margin-top: 32px; border-radius: 4px; box-shadow: 4px 4px 15px rgba(0, 0, 0, 0.3); opacity: 0; transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }
                .sticky-note.fly-in { opacity: 1; }
                .sticky-note.yellow { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); transform: rotate(-1.5deg) translate3d(80px, 0, 0); }
                .sticky-note.yellow.fly-in { transform: rotate(-1.5deg) translate3d(0, 0, 0); }
                .sticky-note.pink { background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 100%); transform: rotate(1.5deg) translate3d(80px, 0, 0); }
                .sticky-note.pink.fly-in { transform: rotate(1.5deg) translate3d(0, 0, 0); }
                .sticky-note.blue { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); transform: rotate(-0.5deg) translate3d(80px, 0, 0); }
                .sticky-note.blue.fly-in { transform: rotate(-0.5deg) translate3d(0, 0, 0); }
                .sticky-note.green { background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%); transform: rotate(1deg) translate3d(80px, 0, 0); }
                .sticky-note.green.fly-in { transform: rotate(1deg) translate3d(0, 0, 0); }
                .sticky-note::before { content: ''; position: absolute; top: -8px; left: 50%; transform: translateX(-50%); width: 20px; height: 20px; background: radial-gradient(circle at 30% 30%, #f87171 0%, #dc2626 60%, #991b1b 100%); border-radius: 50%; box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3); }
                .sticky-title { font-family: var(--font-handwriting); font-size: 18px; font-weight: 700; color: #374151; margin-bottom: 10px; text-decoration: underline wavy rgba(0, 0, 0, 0.2); text-underline-offset: 4px; }
                .sticky-text { font-family: var(--font-handwriting); font-size: 17px; font-weight: 500; color: #4b5563; line-height: 1.6; }

                .formula-box { background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.05)); border: 1px solid rgba(102, 126, 234, 0.25); border-radius: 20px; padding: 36px; margin: 36px 0; text-align: center; opacity: 0; transform: scale(0.9); transition: all 0.8s ease; }
                .formula-box.visible { opacity: 1; transform: scale(1); }
                .formula-label { font-size: 11px; font-weight: 600; letter-spacing: 0.12em; text-transform: uppercase; color: var(--color-accent-cyan); margin-bottom: 16px; }
                .formula-main { font-family: var(--font-mono); font-size: clamp(16px, 2.5vw, 26px); font-weight: 500; color: white; }
                .formula-desc { font-size: 13px; color: var(--color-text-muted); margin-top: 16px; }

                .diagram-container { background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(20px); border: 1px solid var(--color-glass-border); border-radius: 24px; padding: 40px; margin-top: 40px; opacity: 0; transform: translate3d(0, 30px, 0); transition: all 0.8s ease; }
                .diagram-container.visible { opacity: 1; transform: translate3d(0, 0, 0); }
                .diagram-container svg { width: 100%; max-width: 800px; height: auto; margin: 0 auto; display: block; }
                .diagram-caption { text-align: center; font-size: 12px; color: rgba(255,255,255,0.5); margin-top: 20px; font-style: italic; }

                .timeline { margin-top: 36px; position: relative; padding-left: 36px; }
                .timeline::before { content: ''; position: absolute; left: 7px; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, var(--color-primary), var(--color-secondary), var(--color-accent-cyan)); }
                .timeline-item { position: relative; padding: 16px 0 32px; opacity: 0; transform: translate3d(-20px, 0, 0); transition: all 0.6s ease; }
                .timeline-item.visible { opacity: 1; transform: translate3d(0, 0, 0); }
                .timeline-item::before { content: ''; position: absolute; left: -32px; top: 20px; width: 12px; height: 12px; border-radius: 50%; background: var(--color-primary); box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.25); }
                .timeline-year { font-family: var(--font-mono); font-size: 13px; font-weight: 500; color: var(--color-accent-cyan); margin-bottom: 6px; }
                .timeline-title { font-family: var(--font-serif); font-size: 18px; font-weight: 600; margin-bottom: 6px; }
                .timeline-desc { font-size: 13px; color: var(--color-text-muted); line-height: 1.7; }

                .code-container { background: rgba(0, 0, 0, 0.5); border: 1px solid var(--color-glass-border); border-radius: 16px; overflow: hidden; margin-top: 24px; }
                .code-header { display: flex; align-items: center; justify-content: space-between; padding: 12px 18px; background: rgba(255, 255, 255, 0.03); border-bottom: 1px solid var(--color-glass-border); }
                .code-dots { display: flex; gap: 6px; }
                .code-dot { width: 10px; height: 10px; border-radius: 50%; }
                .code-dot.red { background: #ff5f57; }
                .code-dot.yellow { background: #febc2e; }
                .code-dot.green { background: #28c840; }
                .code-lang { font-family: var(--font-mono); font-size: 11px; color: rgba(255,255,255,0.4); }
                .code-body { padding: 18px; overflow-x: auto; }
                .code-body pre { font-family: var(--font-mono); font-size: 12px; line-height: 1.8; color: #e4e4e7; }

                .socratic-dialogues { margin-top: 24px; }
                .dialogue-item { display: flex; gap: 16px; padding: 16px; margin-bottom: 16px; background: var(--color-glass); border-radius: 16px; }
                .dialogue-avatar { font-size: 32px; }
                .dialogue-content { flex: 1; }
                .dialogue-name { font-weight: 600; font-size: 14px; margin-bottom: 6px; color: var(--color-accent-cyan); }
                .dialogue-text { font-size: 14px; line-height: 1.7; color: var(--color-text-muted); }
                .dialogue-thought { font-size: 13px; color: rgba(255,255,255,0.5); margin-top: 8px; font-style: italic; }

                .key-points { margin-top: 24px; padding: 24px; background: var(--color-glass); border-radius: 16px; }
                .key-points h4 { font-size: 16px; margin-bottom: 16px; }
                .key-points ul { list-style: none; }
                .key-points li { padding: 8px 0; border-bottom: 1px solid var(--color-glass-border); font-size: 14px; color: var(--color-text-muted); }
                .key-points li:last-child { border-bottom: none; }

                .page-nav { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; align-items: center; gap: 12px; z-index: 100; }
                .nav-dots { display: flex; gap: 10px; padding: 12px 20px; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px); border: 1px solid var(--color-glass-border); border-radius: 50px; }
                .nav-dot { width: 8px; height: 8px; border-radius: 50%; background: rgba(255, 255, 255, 0.25); cursor: pointer; transition: all 0.3s ease; }
                .nav-dot.active { background: var(--color-accent-cyan); transform: scale(1.3); box-shadow: 0 0 10px var(--color-accent-cyan); }
                .page-btn { width: 48px; height: 48px; border-radius: 50%; background: rgba(0, 0, 0, 0.4); backdrop-filter: blur(10px); border: 1px solid var(--color-glass-border); color: white; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; }
                .page-btn:hover:not(:disabled) { background: rgba(102, 126, 234, 0.4); border-color: var(--color-primary); transform: scale(1.1); }
                .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
                .page-counter { font-family: var(--font-mono); font-size: 13px; color: var(--color-text-muted); min-width: 50px; text-align: center; }

                @media (max-width: 1024px) {
                    .page { padding: 60px 40px; }
                    .cards-grid { grid-template-columns: 1fr; }
                }
                @media (max-width: 768px) {
                    .page { padding: 60px 20px; }
                    .glass-orb { opacity: 0.3; }
                }
            `;
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            try {
                const data = JSON.parse(jsonEditor.value);
                let pageCount = 0;
                let componentCount = 0;

                if (data.chapters) {
                    data.chapters.forEach(ch => {
                        if (ch.pages) {
                            pageCount += ch.pages.length;
                            ch.pages.forEach(p => {
                                if (p.components) componentCount += p.components.length;
                            });
                } else if (data.pages) {
                    pageCount = data.pages.length;
                    data.pages.forEach(p => {
                        if (p.components) componentCount += p.components.length;
                    });
                }

                jsonStats.textContent = `${pageCount} é¡µ Â· ${componentCount} ç»„ä»¶`;
                totalPages = pageCount;
            } catch (e) {
                jsonStats.textContent = 'JSON è§£æé”™è¯¯';
            }
        }

        // æ›´æ–°é¡µé¢å¯¼èˆª
        function updatePageNav() {
            pageDots.innerHTML = '';
            for (let i = 0; i < totalPages; i++) {
                const dot = document.createElement('button');
                dot.className = `page-dot ${i === currentPage ? 'active' : ''}`;
                dot.textContent = i + 1;
                dot.onclick = () => {
                    currentPage = i;
                    updatePageNav();
                    updatePreview();
                };
                pageDots.appendChild(dot);
            }
            pageInfo.textContent = `ç¬¬ ${currentPage + 1} é¡µ / å…± ${totalPages} é¡µ`;
            document.getElementById('prevPageBtn').disabled = currentPage === 0;
            document.getElementById('nextPageBtn').disabled = currentPage >= totalPages - 1;
        }

        // è®¾ç½®çŠ¶æ€
        function setStatus(type, text) {
            statusDot.className = 'status-dot ' + type;
            statusText.textContent = text;
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // è¯¾ç¨‹é€‰æ‹©
            courseSelect.addEventListener('change', () => {
                loadCourse(courseSelect.value);
            });

            // æ–°å»ºè¯¾ç¨‹ï¼ˆç« èŠ‚ï¼‰- æœ€ç®€åˆ›å»ºï¼šç”Ÿæˆ courseId å¹¶ç”¨å½“å‰ JSON ä¿å­˜
            document.getElementById('newCourseBtn').addEventListener('click', async () => {
                try {
                    const raw = (jsonEditor && jsonEditor.value) ? String(jsonEditor.value).trim() : '';
                    let data;
                    if (raw) {
                        data = JSON.parse(raw);
                    } else if (window.CourseJsonValidator) {
                        data = (await window.CourseJsonValidator.validateCourseJson(getDefaultExampleCourseV2())).normalized;
                    } else {
                        data = getDefaultExampleCourseV2();
                    }

                    const suggested = `CHAP-${Math.random().toString(36).slice(2, 8).toUpperCase()}`;
                    const courseId = prompt('è¯·è¾“å…¥æ–°è¯¾ç¨‹IDï¼ˆç”¨äºä¸Šçº¿URLï¼‰ï¼Œå»ºè®®æ ¼å¼ï¼šCHAP-XXXXXX', suggested);
                    if (!courseId) return;
                    const trimmed = String(courseId).trim();
                    if (!trimmed) return;

                    data.id = trimmed;
                    if (!data.templateId && templateSelect && templateSelect.value) data.templateId = templateSelect.value;
                    jsonEditor.value = JSON.stringify(data, null, 2);
                    updateStats();
                    updatePageNav();

                    // ç›´æ¥ä¿å­˜åˆ°åç«¯ï¼ˆç®¡ç†ç«¯å‘ç‰ˆå…¥å£ï¼‰
                    courseSelect.value = trimmed;
                    await saveCourse();
                    showToast('å·²åˆ›å»ºå¹¶ä¿å­˜: ' + trimmed);
                } catch (e) {
                    setStatus('error', 'æ–°å»ºå¤±è´¥: ' + (e.message || String(e)));
                    showToast('æ–°å»ºå¤±è´¥: ' + (e.message || String(e)), true);

            // JSONç¼–è¾‘å™¨å˜åŒ–
            jsonEditor.addEventListener('input', () => {
                isDirty = true;
                setStatus('warning', 'æœªä¿å­˜');

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updateStats();
                    updatePageNav();
                    updatePreview();
                    // åŒæ­¥åˆ°åˆ†å±æ¨¡å¼
                    if (currentTab === 'split') {
                        splitJsonEditor.value = jsonEditor.value;
                    }
                }, 500);
            });

            // åˆ†å±JSONç¼–è¾‘å™¨
            splitJsonEditor.addEventListener('input', () => {
                jsonEditor.value = splitJsonEditor.value;
                isDirty = true;
                setStatus('warning', 'æœªä¿å­˜');
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updateStats();
                    updatePageNav();
                    updatePreview();
                }, 500);
            });

            // åˆ†å±æ¨¡æ¿ç¼–è¾‘å™¨
            splitTemplateEditor.addEventListener('input', () => {
                customTemplateStyles = splitTemplateEditor.value;
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    updatePreview();
                }, 500);
            });

            // æ¨¡æ¿ç¼–è¾‘å™¨å˜åŒ–
            templateEditor.addEventListener('input', () => {
                if (currentTemplateSection === 'css') {
                    customTemplateStyles = templateEditor.value;
                } else if (currentTemplateSection === 'render') {
                    customRenderFunctions = templateEditor.value;
                }
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(updatePreview, 500);
            });

            // ç¼–è¾‘å™¨æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.editor-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTab(tab.dataset.tab);
                });
            });

            // æ¨¡æ¿å­æ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.template-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchTemplateSection(tab.dataset.section);
                });
            });

            // å¤åˆ¶JSONæŒ‰é’®
            document.getElementById('copyJsonBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(jsonEditor.value);
                showToast('JSONå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });

            // å¤åˆ¶æ¨¡æ¿æŒ‰é’®
            document.getElementById('copyTemplateBtn').addEventListener('click', () => {
                navigator.clipboard.writeText(customTemplateStyles || getTemplateStyles());
                showToast('æ¨¡æ¿ä»£ç å·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });

            // é‡ç½®æ¨¡æ¿æŒ‰é’®
            document.getElementById('resetTemplateBtn').addEventListener('click', resetTemplate);

            // ä¿å­˜æ¨¡æ¿æŒ‰é’®
            document.getElementById('saveTemplateBtn').addEventListener('click', () => {
                saveTemplate();
            });

            // æ ¼å¼åŒ–
            document.getElementById('formatBtn').addEventListener('click', () => {
                try {
                    const data = JSON.parse(jsonEditor.value);
                    jsonEditor.value = JSON.stringify(data, null, 2);
                    setStatus('success', 'å·²æ ¼å¼åŒ–');
                } catch (e) {
                    setStatus('error', 'JSONæ ¼å¼é”™è¯¯');

            // æ ¡éªŒ
            document.getElementById('validateBtn').addEventListener('click', async () => {
                try {
                    if (!window.CourseJsonValidator) {
                        throw new Error('CourseJsonValidator æœªåŠ è½½');
                    }
                    const res = await window.CourseJsonValidator.validateCourseJson(jsonEditor.value);
                    lastValidationResult = res;
                    renderValidationDrawer(res);
                    openValidationDrawer();
                    if (res.ok) {
                        setStatus('success', 'æ ¡éªŒé€šè¿‡');
                        showToast('æ ¡éªŒé€šè¿‡ï¼ˆschema v2ï¼‰');
                    } else {
                        setStatus('error', `æ ¡éªŒå¤±è´¥: ${res.errors.length} é¡¹`);
                        showToast(`æ ¡éªŒå¤±è´¥ï¼š${res.errors.length}é¡¹`, true);
                    }
                } catch (e) {
                    setStatus('error', 'æ ¡éªŒå¼‚å¸¸: ' + e.message);
                    showToast('æ ¡éªŒå¼‚å¸¸: ' + e.message, true);

            // å›å½’æ£€æŸ¥ï¼ˆå‰ç«¯ç‰ˆæœ¬ï¼‰ï¼šç”¨å½“å‰ JSON è°ƒç”¨æ¸²æŸ“å™¨ï¼Œæ£€æµ‹ unknown-block / throw
            document.getElementById('regressionBtn')?.addEventListener('click', async () => {
                try {
                    const raw = String(jsonEditor.value || '').trim();
                    if (!raw) {
                        showToast('JSONä¸ºç©º', true);
                        return;
                    }
                    const parsed = JSON.parse(raw);
                    const cfg = window.FormatMigrator ? window.FormatMigrator.ensureV2(parsed) : parsed;
                    const pages = Array.isArray(cfg.pages) ? cfg.pages : [];
                    const unknown = [];
                    if (window.ChapterTemplateEngine) {
                        pages.forEach(p => (p.blocks || []).forEach(b => {
                            if (!b || typeof b !== 'object') return;
                            try {
                                const html = window.ChapterTemplateEngine.renderBlock(b);
                                if (typeof html === 'string' && html.includes('unknown-block')) {
                                    unknown.push({ pageId: p.id, type: b.type });
                                }
                            } catch (e) {
                                unknown.push({ pageId: p.id, type: b.type, error: e.message || String(e) });
                            }
                        }));
                    }
                    if (unknown.length) {
                        showToast(`å›å½’å¤±è´¥ï¼š${unknown.length} ä¸ª block ä¸æ”¯æŒ/æŠ¥é”™`, true);
                        alert('å›å½’å¤±è´¥ï¼ˆå‰ 20 é¡¹ï¼‰ï¼š\n' + unknown.slice(0, 20).map(x => `${x.pageId}: ${x.type}${x.error ? ' (' + x.error + ')' : ''}`).join('\n'));
                        return;
                    }
                    // å°è¯•å®Œæ•´æ¸²æŸ“ï¼ˆæ¨¡æ¿åŠ è½½ç”± UnifiedCourseRenderer è´Ÿè´£ï¼‰
                    if (window.UnifiedCourseRenderer) {
                        await window.UnifiedCourseRenderer.renderCourse(cfg, null, { templateId: cfg.templateId || (templateSelect ? templateSelect.value : 'chapter2') });
                    }
                    showToast('å›å½’é€šè¿‡');
                } catch (e) {
                    showToast('å›å½’å¼‚å¸¸: ' + (e.message || String(e)), true);

            // è‰ç¨¿é¢„è§ˆï¼šä¸å†™åç«¯ï¼Œç›´æ¥ç”¨ base64 json æ‰“å¼€ course-viewer
            document.getElementById('previewDraftBtn').addEventListener('click', async () => {
                try {
                    const raw = (jsonEditor && jsonEditor.value) ? String(jsonEditor.value).trim() : '';
                    if (!raw) {
                        showToast('JSONä¸ºç©º', true);
                        return;
                    }
                    // æ ¡éªŒé€šè¿‡å†é¢„è§ˆï¼ˆå‡å°‘ç©ºç™½é¡µï¼‰
                    if (window.CourseJsonValidator) {
                        const check = await window.CourseJsonValidator.validateCourseJson(raw);
                        if (!check.ok) {
                            showToast(`æ ¡éªŒå¤±è´¥ï¼š${check.errors.length}é¡¹ï¼ˆå…ˆä¿®å¤å†é¢„è§ˆï¼‰`, true);
                            return;
                        }
                    }
                    const base64 = btoa(unescape(encodeURIComponent(raw)));
                    const url = `/src/pages/course-viewer.html?json=${encodeURIComponent(base64)}`;
                    window.open(url, '_blank');
                } catch (e) {
                    showToast('è‰ç¨¿é¢„è§ˆå¤±è´¥: ' + (e.message || String(e)), true);

            // æ‰“å¼€çº¿ä¸Šé¢„è§ˆï¼ˆæŒ‰ courseIdï¼‰
            document.getElementById('openOnlinePreviewBtn').addEventListener('click', () => {
                try {
                    const data = JSON.parse(jsonEditor.value);
                    const courseId = courseSelect.value || data.id;
                    if (!courseId) {
                        showToast('ç¼ºå°‘ courseIdï¼ˆè¯·å…ˆæ–°å»ºæˆ–åœ¨JSONä¸­è®¾ç½® idï¼‰', true);
                        return;
                    }
                    const url = `/src/pages/course-viewer.html?id=${encodeURIComponent(courseId)}`;
                    window.open(url, '_blank');
                } catch (e) {
                    showToast('æ‰“å¼€å¤±è´¥: ' + (e.message || String(e)), true);

            // å¤åˆ¶é¢„è§ˆé“¾æ¥ï¼šä¼˜å…ˆå¤åˆ¶çº¿ä¸Šé“¾æ¥ï¼Œå¦åˆ™å¤åˆ¶è‰ç¨¿é“¾æ¥
            document.getElementById('copyPreviewLinkBtn').addEventListener('click', async () => {
                try {
                    let url = '';
                    try {
                        const data = JSON.parse(jsonEditor.value);
                        const courseId = courseSelect.value || data.id;
                        if (courseId) url = `${location.origin}/src/pages/course-viewer.html?id=${encodeURIComponent(courseId)}`;
                    } catch (e) {}
                    if (!url) {
                        const raw = (jsonEditor && jsonEditor.value) ? String(jsonEditor.value).trim() : '';
                        const base64 = btoa(unescape(encodeURIComponent(raw)));
                        url = `${location.origin}/src/pages/course-viewer.html?json=${encodeURIComponent(base64)}`;
                    }
                    await navigator.clipboard.writeText(url);
                    showToast('å·²å¤åˆ¶é“¾æ¥');
                } catch (e) {
                    showToast('å¤åˆ¶å¤±è´¥: ' + (e.message || String(e)), true);

            // å¯¼å‡ºHTMLï¼ˆå‘å¸ƒå‰æ ¸å¯¹/å­˜æ¡£ï¼‰
            document.getElementById('exportHtmlBtn').addEventListener('click', () => {
                try {
                    const data = JSON.parse(jsonEditor.value);
                    const html = generatePreviewHtml(data, currentPage);
                    const safeId = (data && (data.id || data.title)) ? String(data.id || data.title) : 'course';
                    const filename = safeId.replace(/[\\/:*?"<>|\\s]+/g, '_').slice(0, 80) + '.html';
                    downloadTextFile(filename, html, 'text/html');
                    setStatus('success', 'å·²å¯¼å‡º: ' + filename);
                    showToast('å·²å¯¼å‡ºHTML: ' + filename);
                } catch (e) {
                    setStatus('error', 'å¯¼å‡ºå¤±è´¥: ' + e.message);
                    showToast('å¯¼å‡ºå¤±è´¥: ' + e.message, true);

            // ä¿å­˜
            document.getElementById('saveBtn').addEventListener('click', async () => {
                await saveCourse();
                // åŒæ—¶ä¿å­˜æ¨¡æ¿ï¼ˆå¦‚æœæœ‰ä¿®æ”¹ï¼‰
                if (customTemplateStyles || customRenderFunctions) {
                    saveTemplate();

            // å‘å¸ƒ
            document.getElementById('publishBtn').addEventListener('click', publishCourse);

            // æ‰“å¼€ç« èŠ‚æŸ¥çœ‹å™¨ï¼ˆç”¨äºéªŒè¯åç«¯ chapter_contents çš„ html/json åŒæ¨¡å¼ï¼‰
            // ä¸å½±å“ TemplateCourse çš„ JSON æ¨¡æ¿ä½“ç³»ï¼Œåªæ˜¯è¡¥ä¸€ä¸ªå…¼å®¹å…¥å£
            const openChapterViewerBtn = document.getElementById('openChapterViewerBtn');
            if (openChapterViewerBtn) {
                openChapterViewerBtn.addEventListener('click', () => {
                    // ä¼˜å…ˆï¼šç›´æ¥ç”¨å½“å‰ JSON é¢„è§ˆï¼ˆjson base64ï¼‰ï¼Œç”¨äºâ€œç« èŠ‚JSONæ¨¡å¼â€å¿«é€ŸéªŒè¯
                    try {
                        const raw = (jsonEditor && jsonEditor.value) ? String(jsonEditor.value).trim() : '';
                        if (raw) {
                            const base64 = btoa(unescape(encodeURIComponent(raw)));
                            window.open(`/src/pages/chapter-viewer.html?json=${encodeURIComponent(base64)}`, '_blank');
                            return;
                        }
                    } catch (e) {}
                    // å…œåº•ï¼šè¾“å…¥ chapterId é¢„è§ˆåç«¯ chapter_contentsï¼ˆhtml/jsonï¼‰
                    const rawId = prompt('è¾“å…¥ chapterIdï¼ˆæ•°å­—ï¼‰ç”¨äºé¢„è§ˆç« èŠ‚å†…å®¹ï¼š');
                    if (!rawId) return;
                    const chapterId = String(rawId).trim();
                    window.open(`/src/pages/chapter-viewer.html?chapterId=${encodeURIComponent(chapterId)}`, '_blank');
                });
            }

            // æ ¡éªŒæŠ½å±‰æŒ‰é’®
            document.getElementById('closeValidationBtn')?.addEventListener('click', closeValidationDrawer);
            document.getElementById('validationBackdrop')?.addEventListener('click', closeValidationDrawer);
            document.getElementById('copyValidationBtn')?.addEventListener('click', async () => {
                try {
                    const res = lastValidationResult;
                    if (!res) return;
                    const lines = [];
                    lines.push(res.ok ? 'æ ¡éªŒé€šè¿‡' : `æ ¡éªŒå¤±è´¥ï¼ˆ${(res.errors || []).length}é¡¹ï¼‰`);
                    lines.push('');
                    lines.push('è¯·æŒ‰ä»¥ä¸‹é”™è¯¯ä¿®å¤ JSONï¼ˆschema v2ï¼‰ï¼Œä¿®å¤åé‡æ–°æ ¡éªŒï¼š');
                    lines.push('');
                    (res.errors || []).forEach(e => {
                        lines.push(`- path: ${e.path}`);
                        lines.push(`  message: ${e.message}`);
                        if (e.error) lines.push(`  error: ${e.error}`);
                    });
                    await navigator.clipboard.writeText(lines.join('\n'));
                    showToast('æ ¡éªŒæŠ¥å‘Šå·²å¤åˆ¶');
                } catch (e) {
                    showToast('å¤åˆ¶å¤±è´¥: ' + (e.message || String(e)), true);

            document.getElementById('autoFixBtn')?.addEventListener('click', () => {
                try {
                    const raw = String(jsonEditor.value || '').trim();
                    if (!raw) return;
                    let obj = JSON.parse(raw);
                    // å°½é‡å…ˆè¿ç§»åˆ° v2
                    if (window.FormatMigrator) obj = window.FormatMigrator.ensureV2(obj);

                    // è§„åˆ™ï¼šç¼ºä»€ä¹ˆè¡¥ä»€ä¹ˆï¼ˆåªè¡¥å®‰å…¨å­—æ®µï¼Œä¸åšå†…å®¹é‡å†™ï¼‰
                    if (!obj.version) obj.version = '2.0';
                    if (!obj.templateId && templateSelect && templateSelect.value) obj.templateId = templateSelect.value;
                    if (!obj.title) obj.title = 'æœªå‘½åè¯¾ç¨‹';
                    if (!Array.isArray(obj.pages)) obj.pages = [];
                    if (obj.pages.length === 0) {
                        obj.pages.push({
                            id: 'hero',
                            kind: 'hero',
                            accent: obj.accent || 'cyan',
                            dataTitle: obj.title || 'è¯¾ç¨‹',
                            dataSub: obj.subtitle || '',
                            header: { badge: { text: 'NEW' }, title: obj.title || 'æœªå‘½åè¯¾ç¨‹', subtitle: obj.subtitle || '', badgeHtml: '', extraHtml: '' },
                            blocks: []
                        });
                    }

                    jsonEditor.value = JSON.stringify(obj, null, 2);
                    isDirty = true;
                    updateStats();
                    updatePageNav();
                    updatePreview();
                    showToast('å·²è‡ªåŠ¨ä¿®å¤å¸¸è§å­—æ®µ');
                    // é‡æ–°æ ¡éªŒå¹¶åˆ·æ–°æŠ½å±‰
                    if (window.CourseJsonValidator) {
                        const res = await window.CourseJsonValidator.validateCourseJson(jsonEditor.value);
                        lastValidationResult = res;
                        renderValidationDrawer(res);
                    }
                } catch (e) {
                    showToast('è‡ªåŠ¨ä¿®å¤å¤±è´¥: ' + (e.message || String(e)), true);

            // åˆ·æ–°é¢„è§ˆ
            document.getElementById('refreshPreviewBtn').addEventListener('click', updatePreview);

            // å…¨å±
            document.getElementById('fullscreenBtn').addEventListener('click', () => {
                previewFrame.requestFullscreen();
            });

            // é¡µé¢å¯¼èˆª
            document.getElementById('prevPageBtn').addEventListener('click', () => {
                if (currentPage > 0) {
                    currentPage--;
                    updatePageNav();
                    updatePreview();

            document.getElementById('nextPageBtn').addEventListener('click', () => {
                if (currentPage < totalPages - 1) {
                    currentPage++;
                    updatePageNav();
                    updatePreview();

            // è®¾å¤‡åˆ‡æ¢
            document.querySelectorAll('.preview-btn[data-device]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.preview-btn[data-device]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');

                    const device = btn.dataset.device;
                    const frame = previewFrame;
                    if (device === 'mobile') {
                        frame.style.width = '375px';
                        frame.style.margin = '0 auto';
                    } else if (device === 'tablet') {
                        frame.style.width = '768px';
                        frame.style.margin = '0 auto';
                    } else {
                        frame.style.width = '100%';
                        frame.style.margin = '0';
            });

            // ç›‘å¬iframeæ¶ˆæ¯
            window.addEventListener('message', (e) => {
                if (e.data.type === 'pageChange') {
                    currentPage = e.data.page;
                    updatePageNav();

            // é”®ç›˜å¿«æ·é”®
            document.addEventListener('keydown', (e) => {
                // Ctrl+S ä¿å­˜
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    saveCourse();
                }
                // Ctrl+1/2/3 åˆ‡æ¢æ ‡ç­¾
                if (e.ctrlKey && e.key === '1') {
                    e.preventDefault();
                    switchTab('json');
                }
                if (e.ctrlKey && e.key === '2') {
                    e.preventDefault();
                    switchTab('template');
                }
                if (e.ctrlKey && e.key === '3') {
                    e.preventDefault();
                    switchTab('split');
                }
                // Ctrl+R åˆ·æ–°é¢„è§ˆ
                if (e.ctrlKey && e.key === 'r') {
                    e.preventDefault();
                    updatePreview();
        }

        // ä¿å­˜è¯¾ç¨‹
        async function saveCourse() {
            try {
                // ä¿å­˜é—¨ç¦ï¼šå…ˆæ ¡éªŒï¼ˆé¿å…æŠŠæ˜æ˜¾é”™è¯¯å†™å…¥åç«¯ï¼‰
                if (window.CourseJsonValidator) {
                    const check = await window.CourseJsonValidator.validateCourseJson(jsonEditor.value);
                    lastValidationResult = check;
                    renderValidationDrawer(check);
                    if (!check.ok) {
                        openValidationDrawer();
                        setStatus('error', `ä¿å­˜è¢«æ‹¦æˆªï¼šæ ¡éªŒå¤±è´¥ï¼ˆ${check.errors.length}é¡¹ï¼‰`);
                        return;
                    }
                }

                const data = JSON.parse(jsonEditor.value);
                const courseId = courseSelect.value || data.id;

                if (!courseId) {
                    setStatus('error', 'è¯·é€‰æ‹©æˆ–åˆ›å»ºè¯¾ç¨‹');
                    return;
                }

                setStatus('loading', 'ä¿å­˜ä¸­...');

                // è¿™é‡Œè°ƒç”¨ä¿å­˜API
                const res = await fetch(`${API_BASE}/course-templates/courses/by-course-id/${courseId}/content`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders()
                    },
                    body: JSON.stringify(data)
                });

                const result = await res.json();
                if (result.code === 0) {
                    setStatus('success', 'å·²ä¿å­˜');
                    isDirty = false;
                } else {
                    throw new Error(result.message);
                }
            } catch (e) {
                setStatus('error', 'ä¿å­˜å¤±è´¥: ' + e.message);
            }
        }

        // å‘å¸ƒè¯¾ç¨‹
        async function publishCourse() {
            // å‘å¸ƒé—¨ç¦ï¼šå¿…é¡»å…ˆé€šè¿‡æ ¡éªŒ
            if (!window.CourseJsonValidator) {
                alert('ç¼ºå°‘æ ¡éªŒå™¨ï¼šCourseJsonValidator æœªåŠ è½½');
                return;
            }
            const check = await window.CourseJsonValidator.validateCourseJson(jsonEditor.value);
            lastValidationResult = check;
            renderValidationDrawer(check);
            if (!check.ok) {
                openValidationDrawer();
                showToast(`å‘å¸ƒè¢«æ‹¦æˆªï¼šæ ¡éªŒå¤±è´¥ï¼ˆ${check.errors.length}é¡¹ï¼‰`, true);
                return;
            }

            if (isDirty) await saveCourse();

            // å‘å¸ƒåŠ¨ä½œï¼šä¼˜å…ˆè°ƒç”¨åç«¯ by-course-id publishï¼ˆæœ€ç¨³å®šï¼‰
            try {
                const data = JSON.parse(jsonEditor.value);
                const courseId = courseSelect.value || data.id;
                if (!courseId) {
                    setStatus('error', 'ç¼ºå°‘ courseId');
                    return;
                }
                const pub = await fetch(`${API_BASE}/course-templates/courses/by-course-id/${courseId}/publish`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', ...getAuthHeaders() },
                    body: JSON.stringify({ publishUrl: '' })
                });
                const pubRes = await pub.json();
                if (pubRes.code === 0) {
                    setStatus('success', 'å·²å‘å¸ƒ');
                    const url = `/src/pages/course-viewer.html?id=${encodeURIComponent(courseId)}`;
                    window.open(url, '_blank');
                } else {
                    throw new Error(pubRes.message || 'å‘å¸ƒå¤±è´¥');
                }
            } catch (e) {
                setStatus('error', 'å‘å¸ƒå¤±è´¥: ' + (e.message || String(e)));
                showToast('å‘å¸ƒå¤±è´¥ï¼ˆå·²ä¿å­˜ï¼‰: ' + (e.message || String(e)), true);
            }
        }

        // æ‹–æ‹½åˆ†å‰²çº¿
        function setupResizer() {
            const resizer = document.getElementById('resizer');
            const previewPanel = document.getElementById('previewPanel');
            const editorPanel = document.getElementById('editorPanel');
            let isResizing = false;

            resizer.addEventListener('mousedown', (e) => {
                isResizing = true;
                document.body.style.cursor = 'col-resize';
            });

            document.addEventListener('mousemove', (e) => {
                if (!isResizing) return;
                const containerWidth = document.body.clientWidth;
                const newEditorWidth = containerWidth - e.clientX;

                if (newEditorWidth >= 400 && newEditorWidth <= 800) {
                    editorPanel.style.width = newEditorWidth + 'px';

            document.addEventListener('mouseup', () => {
                isResizing = false;
                document.body.style.cursor = '';
            });
        }

        // ========== æ¨¡ç‰ˆè§„åˆ™åŠŸèƒ½ ==========
        const DEFAULT_TEMPLATE_RULES = `# è¯¾ç¨‹æ¨¡æ¿è§„åˆ™ - AIè¯¾ç¨‹JSONç”ŸæˆæŒ‡å—

è¯·å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªè¯¾ç¨‹JSONï¼Œéœ€è¦ç¬¦åˆä»¥ä¸‹è§„åˆ™ï¼š

## ä¸€ã€JSONåŸºæœ¬ç»“æ„
\`\`\`json
{
  "id": "course-unique-id",
  "title": "è¯¾ç¨‹æ ‡é¢˜",
  "pages": [
    {
      "id": "page-1",
      "layout": "hero | content",
      "components": [/* ç»„ä»¶æ•°ç»„ */]
    }
  ]
}
\`\`\`

## äºŒã€é¡µé¢å¸ƒå±€ (layout)
- \`hero\` - å…¨å±å±…ä¸­å¤§æ ‡é¢˜ï¼Œç”¨äºå°é¢
- \`content\` - æ ‡å‡†å†…å®¹é¡µï¼Œç”¨äºçŸ¥è¯†ç‚¹

## ä¸‰ã€ç»„ä»¶ç±»å‹ï¼ˆ12ç§ï¼‰

### 1. hero - å°é¢å¤§æ ‡é¢˜ â­å¿…ç”¨
\`\`\`json
{"type": "hero", "content": {"badge": "ğŸš€ AI è¯¾ç¨‹", "title": "ä¸»æ ‡é¢˜", "subtitle": "å‰¯æ ‡é¢˜"}}
\`\`\`

### 2. heading - ç« èŠ‚æ ‡é¢˜
\`\`\`json
{"type": "heading", "content": {"icon": "ğŸ§ ", "label": "CHAPTER 01", "text": "ç« èŠ‚å", "level": 2}}
\`\`\`

### 3. paragraph - æ–‡æœ¬æ®µè½
\`\`\`json
{"type": "paragraph", "content": {"text": "æ™®é€šæ–‡æœ¬", "html": "æ”¯æŒ<strong>HTML</strong>"}}
\`\`\`

### 4. cards-grid - å¡ç‰‡ç½‘æ ¼ â­å¸¸ç”¨
\`\`\`json
{"type": "cards-grid", "content": {"cards": [
  {"icon": "Q", "iconClass": "q", "title": "Query", "subtitle": "æŸ¥è¯¢", "description": "è¯´æ˜"},
  {"icon": "K", "iconClass": "k", "title": "Key", "subtitle": "é”®", "description": "è¯´æ˜"},
  {"icon": "V", "iconClass": "v", "title": "Value", "subtitle": "å€¼", "description": "è¯´æ˜"}
]}}
\`\`\`
iconClass: q(è“ç´«), k(ç²‰è‰²), v(é’è‰²)

### 5. formula-box - å…¬å¼æ¡†
\`\`\`json
{"type": "formula-box", "content": {"label": "æ ¸å¿ƒå…¬å¼", "formula": "E=mcÂ²", "explanation": "è§£é‡Š"}}
\`\`\`

### 6. sticky-note - ä¾¿ç­¾çº¸ â­å¸¸ç”¨
\`\`\`json
{"type": "sticky-note", "content": {"color": "yellow", "title": "ğŸ’¡ æ´å¯Ÿ", "text": "å†…å®¹"}}
\`\`\`
color: yellow, pink, blue, green

### 7. code-block - ä»£ç å—
\`\`\`json
{"type": "code-block", "content": {"language": "python", "code": "print('Hello')"}}
\`\`\`

### 8. timeline - æ—¶é—´çº¿
\`\`\`json
{"type": "timeline", "content": {"items": [
  {"year": "2017", "title": "æ ‡é¢˜", "description": "æè¿°"}
]}}
\`\`\`

### 9. key-points - è¦ç‚¹åˆ—è¡¨
\`\`\`json
{"type": "key-points", "content": {"icon": "â­", "title": "è¦ç‚¹", "points": ["1", "2", "3"]}}
\`\`\`

### 10. callout - æç¤ºæ¡†
\`\`\`json
{"type": "callout", "content": {"type": "tip", "title": "ğŸ’¡ æç¤º", "text": "å†…å®¹"}}
\`\`\`
type: tip(è“), warning(é»„), success(ç»¿)

### 11. socratic-dialogue - å¯¹è¯
\`\`\`json
{"type": "socratic-dialogue", "content": {"dialogues": [
  {"role": "teacher", "name": "è€å¸ˆ", "text": "é—®é¢˜"},
  {"role": "student", "name": "å­¦ç”Ÿ", "text": "å›ç­”", "thought": "æƒ³æ³•"}
]}}
\`\`\`

### 12. diagram - SVGå›¾è¡¨
\`\`\`json
{"type": "diagram", "content": {"svg": "<svg>...</svg>", "caption": "è¯´æ˜"}}
\`\`\`

## å››ã€CSSæ ·å¼å˜é‡
--color-primary: #667eea (è“ç´«)
--color-secondary: #764ba2 (ç´«)
--color-accent-cyan: #4facfe (é’)
--color-accent-pink: #f093fb (ç²‰)

## äº”ã€å®Œæ•´ç¤ºä¾‹
\`\`\`json
{
  "id": "transformer-basics",
  "title": "Transformeræ·±åº¦è§£æ",
  "pages": [
    {"id": "cover", "layout": "hero", "components": [
      {"type": "hero", "content": {"badge": "ğŸ§  æ·±åº¦å­¦ä¹ ", "title": "Transformer", "subtitle": "Attention is All You Need"}}
    ]},
    {"id": "intro", "layout": "content", "components": [
      {"type": "heading", "content": {"icon": "ğŸ¯", "label": "01", "text": "è‡ªæ³¨æ„åŠ›æœºåˆ¶", "level": 2}},
      {"type": "paragraph", "content": {"text": "è‡ªæ³¨æ„åŠ›æœºåˆ¶æ˜¯Transformerçš„æ ¸å¿ƒåˆ›æ–°..."}},
      {"type": "cards-grid", "content": {"cards": [
        {"icon": "Q", "iconClass": "q", "title": "Query", "description": "æŸ¥è¯¢å‘é‡"},
        {"icon": "K", "iconClass": "k", "title": "Key", "description": "é”®å‘é‡"},
        {"icon": "V", "iconClass": "v", "title": "Value", "description": "å€¼å‘é‡"}
      ]}},
      {"type": "sticky-note", "content": {"color": "yellow", "title": "ğŸ’¡ ç›´è§‰", "text": "Qé—®Kç­”ï¼ŒVæ˜¯å†…å®¹"}}
    ]}
  ]
}
\`\`\`

---
è¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™ï¼Œå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªå…³äºã€Œ[ä½ çš„è¯¾ç¨‹ä¸»é¢˜]ã€çš„è¯¾ç¨‹JSONï¼Œè¦æ±‚ï¼š
1. åŒ…å«5-8ä¸ªé¡µé¢
2. ç¬¬ä¸€é¡µå¿…é¡»æ˜¯heroå°é¢
3. ä½¿ç”¨å¤šç§ç»„ä»¶ï¼ˆå¡ç‰‡ã€å…¬å¼ã€ä¾¿ç­¾ã€ä»£ç ç­‰ï¼‰
4. å†…å®¹ä¸“ä¸šå‡†ç¡®ã€é€šä¿—æ˜“æ‡‚
5. é€‚å½“ä½¿ç”¨emoji`;

        function showTemplateRulesModal() {
            // åŠ è½½ä¿å­˜çš„è§„åˆ™æˆ–ä½¿ç”¨é»˜è®¤
            const savedRules = localStorage.getItem('courseTemplateRules');
            document.getElementById('templateRulesContent').value = savedRules || DEFAULT_TEMPLATE_RULES;
            document.getElementById('templateRulesModal').classList.add('active');
            updateRulesStatus();
        }

        function closeTemplateRulesModal() {
            document.getElementById('templateRulesModal').classList.remove('active');
        }

        function copyTemplateRules() {
            const rulesText = document.getElementById('templateRulesContent').value;
            navigator.clipboard.writeText(rulesText).then(() => {
                showToast('å·²å¤åˆ¶æ¨¡ç‰ˆè§„åˆ™åˆ°å‰ªè´´æ¿ï¼');
            }).catch(() => {
                showToast('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©å¤åˆ¶', true);
            });
        }

        function saveTemplateRules() {
            const rulesText = document.getElementById('templateRulesContent').value;
            localStorage.setItem('courseTemplateRules', rulesText);
            showToast('æ¨¡ç‰ˆè§„åˆ™å·²ä¿å­˜ï¼');
            updateRulesStatus();
        }

        function resetTemplateRules() {
            if (confirm('ç¡®å®šè¦é‡ç½®ä¸ºé»˜è®¤æ¨¡ç‰ˆè§„åˆ™å—ï¼Ÿæ‚¨çš„è‡ªå®šä¹‰ä¿®æ”¹å°†ä¸¢å¤±ã€‚')) {
                localStorage.removeItem('courseTemplateRules');
                document.getElementById('templateRulesContent').value = DEFAULT_TEMPLATE_RULES;
                showToast('å·²é‡ç½®ä¸ºé»˜è®¤æ¨¡ç‰ˆè§„åˆ™');
                updateRulesStatus();
            }
        }

        function updateRulesStatus() {
            const savedRules = localStorage.getItem('courseTemplateRules');
            const statusEl = document.getElementById('rulesStatus');
            if (statusEl) {
                if (savedRules) {
                    statusEl.textContent = 'ğŸ“ å·²è‡ªå®šä¹‰';
                    statusEl.style.color = '#10b981';
                } else {
                    statusEl.textContent = 'ğŸ“„ é»˜è®¤è§„åˆ™';
                    statusEl.style.color = '#6b7280';
                }
            }
        }

        // å¯åŠ¨
        init();
        });
    </script>

    <!-- æ¨¡ç‰ˆè§„åˆ™æ¨¡æ€æ¡† -->
    <div class="modal-overlay" id="templateRulesModal">
        <div class="modal" style="max-width: 800px; max-height: 90vh;">
            <div class="modal-header">
                <h3 class="modal-title">ğŸ“– æ¨¡ç‰ˆè§„åˆ™ - å¤åˆ¶ç»™AIç”ŸæˆJSON</h3>
                <button class="modal-close" onclick="closeTemplateRulesModal()">&times;</button>
            </div>
            <div class="modal-body" style="overflow-y: hidden; max-height: calc(90vh - 140px); padding: 0; display: flex; flex-direction: column;">
                <div style="background: #f59e0b; color: #78350f; padding: 12px 20px; font-size: 14px; display: flex; justify-content: space-between; align-items: center;">
                    <span>ğŸ’¡ <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong>ç¼–è¾‘è§„åˆ™ â†’ ä¿å­˜ â†’ å¤åˆ¶ç»™AI â†’ AIç”ŸæˆJSON â†’ ç²˜è´´åˆ°ç¼–è¾‘å™¨</span>
                    <span id="rulesStatus" style="font-size: 12px;">ğŸ“„ é»˜è®¤è§„åˆ™</span>
                </div>
                <textarea id="templateRulesContent" style="flex: 1; background: #1e1e2e; color: #e4e4e7; padding: 20px; margin: 0; font-family: 'JetBrains Mono', monospace; font-size: 12px; line-height: 1.6; border: none; resize: none; outline: none; min-height: 400px;"># è¯¾ç¨‹æ¨¡æ¿è§„åˆ™ - AIè¯¾ç¨‹JSONç”ŸæˆæŒ‡å—

è¯·å¸®æˆ‘ç”Ÿæˆä¸€ä¸ªè¯¾ç¨‹JSONï¼Œéœ€è¦ç¬¦åˆä»¥ä¸‹è§„åˆ™ï¼š

## ä¸€ã€JSONåŸºæœ¬ç»“æ„
```json
{
  "id": "course-unique-id",
  "title": "è¯¾ç¨‹æ ‡é¢˜",
  "pages": [
    {
      "id": "page-1",
      "layout": "hero | content",
      "components": [/* ç»„ä»¶æ•°ç»„ */]
    }
  ]
}
```

## äºŒã€é¡µé¢å¸ƒå±€ (layout)
- `hero` - å…¨å±å±…ä¸­å¤§æ ‡é¢˜ï¼Œç”¨äºå°é¢
- `content` - æ ‡å‡†å†…å®¹é¡µï¼Œç”¨äºçŸ¥è¯†ç‚¹

## ä¸‰ã€ç»„ä»¶ç±»å‹ï¼ˆ12ç§ï¼‰

### 1. hero - å°é¢å¤§æ ‡é¢˜ â­å¿…ç”¨
```json
{
  "type": "hero",
  "content": {
    "badge": "ğŸš€ AI è¯¾ç¨‹",
    "title": "è¯¾ç¨‹ä¸»æ ‡é¢˜",
    "subtitle": "å‰¯æ ‡é¢˜è¯´æ˜"
  }
}
```

### 2. heading - ç« èŠ‚æ ‡é¢˜
```json
{
  "type": "heading",
  "content": {
    "icon": "ğŸ§ ",
    "label": "CHAPTER 01",
    "text": "ç« èŠ‚åç§°",
    "level": 2
  }
}
```

### 3. paragraph - æ–‡æœ¬æ®µè½
```json
{
  "type": "paragraph",
  "content": {
    "text": "æ™®é€šæ–‡æœ¬",
    "html": "æ”¯æŒ&lt;strong&gt;HTML&lt;/strong&gt;å¯Œæ–‡æœ¬"
  }
}
```

### 4. cards-grid - å¡ç‰‡ç½‘æ ¼ â­å¸¸ç”¨
```json
{
  "type": "cards-grid",
  "content": {
    "cards": [
      {"icon": "Q", "iconClass": "q", "title": "Query", "subtitle": "æŸ¥è¯¢", "description": "è¯´æ˜æ–‡å­—"},
      {"icon": "K", "iconClass": "k", "title": "Key", "subtitle": "é”®", "description": "è¯´æ˜æ–‡å­—"},
      {"icon": "V", "iconClass": "v", "title": "Value", "subtitle": "å€¼", "description": "è¯´æ˜æ–‡å­—"}
    ]
  }
}
```
iconClass: q(è“ç´«), k(ç²‰è‰²), v(é’è‰²)

### 5. formula-box - å…¬å¼æ¡†
```json
{
  "type": "formula-box",
  "content": {
    "label": "æ ¸å¿ƒå…¬å¼",
    "formula": "Attention(Q,K,V) = softmax(QK&lt;sup&gt;T&lt;/sup&gt;/âˆšd&lt;sub&gt;k&lt;/sub&gt;)V",
    "explanation": "å…¬å¼è§£é‡Šè¯´æ˜"
  }
}
```

### 6. sticky-note - ä¾¿ç­¾çº¸ â­å¸¸ç”¨
```json
{
  "type": "sticky-note",
  "content": {
    "color": "yellow",
    "title": "ğŸ’¡ å…³é”®æ´å¯Ÿ",
    "text": "ä¾¿ç­¾å†…å®¹"
  }
}
```
color: yellow, pink, blue, green

### 7. code-block - ä»£ç å—
```json
{
  "type": "code-block",
  "content": {
    "language": "python",
    "code": "import torch\\nprint('Hello')"
  }
}
```

### 8. timeline - æ—¶é—´çº¿
```json
{
  "type": "timeline",
  "content": {
    "items": [
      {"year": "2017", "title": "äº‹ä»¶æ ‡é¢˜", "description": "äº‹ä»¶æè¿°"},
      {"year": "2020", "title": "äº‹ä»¶æ ‡é¢˜", "description": "äº‹ä»¶æè¿°"}
    ]
  }
}
```

### 9. key-points - è¦ç‚¹åˆ—è¡¨
```json
{
  "type": "key-points",
  "content": {
    "icon": "â­",
    "title": "æœ¬èŠ‚è¦ç‚¹",
    "points": ["è¦ç‚¹1", "è¦ç‚¹2", "è¦ç‚¹3"]
  }
}
```

### 10. callout - æç¤ºæ¡†
```json
{
  "type": "callout",
  "content": {
    "type": "tip",
    "title": "ğŸ’¡ å°æç¤º",
    "text": "æç¤ºå†…å®¹"
  }
}
```
type: tip(è“), warning(é»„), success(ç»¿)

### 11. socratic-dialogue - å¯¹è¯
```json
{
  "type": "socratic-dialogue",
  "content": {
    "dialogues": [
      {"role": "teacher", "name": "è€å¸ˆ", "text": "é—®é¢˜"},
      {"role": "student", "name": "å­¦ç”Ÿ", "text": "å›ç­”", "thought": "å†…å¿ƒæƒ³æ³•"}
    ]
  }
}
```

### 12. diagram - SVGå›¾è¡¨
```json
{
  "type": "diagram",
  "content": {
    "svg": "&lt;svg&gt;...&lt;/svg&gt;",
    "caption": "å›¾è¡¨è¯´æ˜"
  }
}
```

## å››ã€CSSæ ·å¼å˜é‡ï¼ˆäº†è§£å³å¯ï¼‰
```css
--color-primary: #667eea;     /* ä¸»è‰²-è“ç´« */
--color-secondary: #764ba2;   /* æ¬¡è‰²-ç´« */
--color-accent-cyan: #4facfe; /* å¼ºè°ƒ-é’ */
--color-accent-pink: #f093fb; /* å¼ºè°ƒ-ç²‰ */
```

## äº”ã€å®Œæ•´ç¤ºä¾‹
```json
{
  "id": "transformer-basics",
  "title": "Transformeræ·±åº¦è§£æ",
  "pages": [
    {
      "id": "cover",
      "layout": "hero",
      "components": [
        {"type": "hero", "content": {"badge": "ğŸ§  æ·±åº¦å­¦ä¹ ", "title": "Transformer", "subtitle": "Attention is All You Need"}}
      ]
    },
    {
      "id": "intro",
      "layout": "content",
      "components": [
        {"type": "heading", "content": {"icon": "ğŸ¯", "label": "CHAPTER 01", "text": "è‡ªæ³¨æ„åŠ›æœºåˆ¶", "level": 2}},
        {"type": "paragraph", "content": {"text": "è‡ªæ³¨æ„åŠ›æœºåˆ¶æ˜¯Transformerçš„æ ¸å¿ƒåˆ›æ–°..."}},
        {"type": "cards-grid", "content": {"cards": [
          {"icon": "Q", "iconClass": "q", "title": "Query", "description": "æŸ¥è¯¢å‘é‡"},
          {"icon": "K", "iconClass": "k", "title": "Key", "description": "é”®å‘é‡"},
          {"icon": "V", "iconClass": "v", "title": "Value", "description": "å€¼å‘é‡"}
        ]}},
        {"type": "formula-box", "content": {"label": "æ ¸å¿ƒå…¬å¼", "formula": "Attention(Q,K,V) = softmax(QK&lt;sup&gt;T&lt;/sup&gt;/âˆšd)V"}},
        {"type": "sticky-note", "content": {"color": "yellow", "title": "ğŸ’¡ ç›´è§‰", "text": "Qé—®Kç­”ï¼ŒVæ˜¯å†…å®¹"}}
      ]
    }
  ]
}
```

---
è¯·æ ¹æ®ä»¥ä¸Šè§„åˆ™ï¼Œå¸®æˆ‘ç”Ÿæˆä¸€ä¸ªå…³äºã€Œ[ä½ çš„è¯¾ç¨‹ä¸»é¢˜]ã€çš„è¯¾ç¨‹JSONï¼Œè¦æ±‚ï¼š
1. åŒ…å«5-8ä¸ªé¡µé¢
2. ç¬¬ä¸€é¡µå¿…é¡»æ˜¯heroå°é¢
3. ä½¿ç”¨å¤šç§ç»„ä»¶ï¼ˆå¡ç‰‡ã€å…¬å¼ã€ä¾¿ç­¾ã€ä»£ç ç­‰ï¼‰
4. å†…å®¹ä¸“ä¸šå‡†ç¡®ã€é€šä¿—æ˜“æ‡‚
5. é€‚å½“ä½¿ç”¨emoji</textarea>
            </div>
            <div class="modal-footer" style="display: flex; justify-content: space-between;">
                <div>
                    <button class="btn btn-secondary" onclick="resetTemplateRules()" style="color: #ef4444;">
                        ğŸ”„ é‡ç½®é»˜è®¤
                    </button>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn btn-secondary" onclick="closeTemplateRulesModal()">å…³é—­</button>
                    <button class="btn btn-primary" onclick="saveTemplateRules()" style="background: linear-gradient(135deg, #3b82f6, #1d4ed8);">
                        ğŸ’¾ ä¿å­˜è§„åˆ™
                    </button>
                    <button class="btn btn-primary" onclick="copyTemplateRules()" style="background: linear-gradient(135deg, #10b981, #059669);">
                        ğŸ“‹ å¤åˆ¶ç»™AI
                    </button>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal {
            background: var(--bg-panel);
            border-radius: 16px;
            width: 90%;
            border: 1px solid var(--border);
            transform: scale(0.9);
            transition: transform 0.3s;
        }
        .modal-overlay.active .modal {
            transform: scale(1);
        }
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-title {
            font-size: 16px;
            font-weight: 600;
        }
        .modal-close {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(255,255,255,0.2);
            color: var(--text);
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* ===== Validation Drawer ===== */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: min(520px, 92vw);
            background: rgba(10,10,20,0.92);
            backdrop-filter: blur(12px);
            border-left: 1px solid var(--border);
            box-shadow: -20px 0 60px rgba(0,0,0,0.35);
            z-index: 20000;
            transform: translate3d(100%,0,0);
            transition: transform 0.25s ease;
            display: flex;
            flex-direction: column;
        }
        .drawer.open { transform: translate3d(0,0,0); }
        .drawer-header {
            padding: 14px 16px;
            border-bottom: 1px solid var(--border);
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
        }
        .drawer-title { font-weight: 700; font-size: 13px; color: var(--text); }
        .drawer-sub { font-size: 12px; color: var(--text-muted); }
        .drawer-actions { display:flex; gap: 8px; align-items:center; }
        .drawer-body { padding: 12px; overflow:auto; display:flex; flex-direction:column; gap: 10px; }
        .val-summary {
            padding: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
        }
        .val-badges { display:flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
        .badge {
            font-size: 12px;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.10);
            background: rgba(255,255,255,0.06);
            color: rgba(255,255,255,0.86);
        }
        .badge.ok { border-color: rgba(34,197,94,0.35); background: rgba(34,197,94,0.12); }
        .badge.bad { border-color: rgba(239,68,68,0.35); background: rgba(239,68,68,0.12); }
        .val-list { display:flex; flex-direction:column; gap: 8px; }
        .val-item {
            padding: 10px 10px;
            border: 1px solid rgba(255,255,255,0.10);
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
            transition: transform 0.12s ease, background 0.12s ease;
        }
        .val-item:hover { background: rgba(255,255,255,0.05); transform: translateY(-1px); }
        .val-path { font-family: var(--font-mono, monospace); font-size: 12px; color: rgba(255,255,255,0.85); }
        .val-msg { margin-top: 6px; font-size: 12px; color: var(--text-muted); white-space: pre-wrap; }
        .val-error { margin-top: 6px; font-size: 12px; color: rgba(255,255,255,0.7); }
        .drawer-backdrop{
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.45);
            z-index: 19999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.18s ease;
        }
        .drawer-backdrop.open{ opacity: 1; pointer-events: auto; }
    </style>
</body>
</html>
