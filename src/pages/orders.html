<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的订单 - AI 信息未来</title>
    <link rel="stylesheet" href="/assets/skins/app-shell.css">
<link rel="stylesheet" href="../styles/apple-design.css">
    <style>
        /* 订单页面专属样式 */
        body {
            padding-top: 48px;
            background: var(--bg-secondary);
        }

        /* Hero 区域 */
        .orders-hero {
            padding: 64px 0 40px;
            text-align: center;
        }

        .orders-hero h1 {
            font-size: 48px;
            font-weight: 700;
            margin-bottom: 12px;
            letter-spacing: -0.03em;
        }

        .orders-hero p {
            font-size: 19px;
            color: var(--text-secondary);
        }

        /* 标签页 */
        .tabs {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 6px;
            display: flex;
            gap: 6px;
            margin-bottom: 32px;
        }

        .tab {
            flex: 1;
            padding: 12px 16px;
            border-radius: var(--radius-md);
            font-size: 15px;
            font-weight: 500;
            color: var(--text-secondary);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent);
            color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .tab-count {
            font-size: 13px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: var(--radius-full);
            background: rgba(255, 255, 255, 0.2);
            min-width: 24px;
            text-align: center;
        }

        .tab:not(.active) .tab-count {
            background: var(--bg-hover);
            color: var(--text-tertiary);
        }

        .tab-refresh {
            flex: 0 0 auto;
            padding: 12px 20px;
        }

        /* 订单列表容器 */
        .orders-container {
            background: var(--bg-card);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: 32px;
            min-height: 400px;
        }

        /* ===== 视觉精修覆盖 ===== */
        .orders-hero {
            position: relative;
        }
        .orders-hero::after {
            content: '';
            position: absolute;
            inset: auto 0 0 0;
            height: 60px;
            background: linear-gradient(180deg, rgba(255,255,255,0), rgba(245,245,247,1));
            pointer-events: none;
        }
        .tabs {
            background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.8));
            box-shadow: var(--shadow-sm);
        }
        .tab.active {
            box-shadow: 0 12px 28px rgba(0, 113, 227, 0.2);
        }
        .order-item {
            background: var(--bg-tertiary);
            border-color: transparent;
            box-shadow: var(--shadow-sm);
        }
        .order-item:hover {
            box-shadow: var(--shadow-lg);
        }
        .action-btn {
            border-radius: 999px;
        }

        /* 订单项 */
        .order-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            margin-bottom: 16px;
            transition: all var(--transition-fast);
        }

        .order-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-card);
        }

        .order-info {
            flex: 1;
        }

        .order-title {
            font-size: 19px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .order-meta {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 4px;
            font-family: var(--font-mono);
        }

        .order-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .order-status {
            padding: 6px 14px;
            border-radius: var(--radius-full);
            font-size: 13px;
            font-weight: 600;
            white-space: nowrap;
        }

        .status-active {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }

        .status-pending {
            background: rgba(255, 159, 10, 0.1);
            color: #ff9f0a;
        }

        .status-expired,
        .status-cancelled {
            background: rgba(142, 142, 147, 0.1);
            color: var(--text-tertiary);
        }

        /* 操作按钮 */
        .action-btn {
            padding: 10px 20px;
            border-radius: var(--radius-full);
            font-size: 15px;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .btn-pay {
            background: var(--accent);
            color: #fff;
        }

        .btn-pay:hover {
            background: var(--accent-hover);
        }

        .btn-cancel {
            background: var(--bg-hover);
            color: var(--text-secondary);
        }

        .btn-cancel:hover {
            background: rgba(255, 59, 48, 0.1);
            color: #ff3b30;
        }

        .btn-secondary {
            background: rgba(0, 122, 255, 0.12);
            color: #007aff;
        }

        .btn-secondary:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .btn-learn {
            background: rgba(52, 199, 89, 0.1);
            color: #34c759;
        }

        .btn-learn:hover {
            background: #34c759;
            color: #fff;
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 80px 32px;
        }

        .empty-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-size: 24px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state p {
            font-size: 17px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        /* 加载状态 */
        .loading-state {
            text-align: center;
            padding: 80px 32px;
        }

        .error-state {
            text-align: center;
            padding: 80px 32px;
        }

        .error-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            opacity: 0.3;
        }

        /* 提示文本 */
        .timeout-tip {
            color: #ff9f0a;
            font-size: 13px;
            margin-left: 8px;
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .orders-hero h1 {
                font-size: 32px;
            }

            .order-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .order-actions {
                width: 100%;
                justify-content: flex-end;
            }

            .tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .tab {
                flex: 0 0 auto;
                min-width: 100px;
            }
        }

        /* ===== 视觉精修覆盖 ===== */
        body {
            background:
                radial-gradient(1100px 700px at 18% 12%, rgba(59,130,246,0.12), transparent 60%),
                radial-gradient(900px 600px at 80% 20%, rgba(99,102,241,0.16), transparent 55%),
                linear-gradient(180deg, #f7f8ff 0%, #f5f7ff 50%, #f1f5ff 100%);
        }
        .orders-hero h1 {
            text-shadow: 0 14px 30px rgba(15, 23, 42, 0.12);
        }
        .tabs {
            border: 1px solid rgba(148, 163, 184, 0.24);
        }
        .tab {
            font-weight: 600;
        }
        .tab.active {
            box-shadow: 0 12px 28px rgba(99, 102, 241, 0.2);
        }
        .orders-container {
            border: 1px solid rgba(148, 163, 184, 0.24);
            box-shadow: 0 20px 50px rgba(15, 23, 42, 0.12);
        }
        .order-item {
            background: linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.92));
        }
        .action-btn {
            border-radius: 999px;
            font-weight: 600;
        }
        .btn-pay {
            box-shadow: 0 12px 26px rgba(79, 70, 229, 0.22);
        }
        .btn-pay:hover {
            box-shadow: 0 16px 32px rgba(79, 70, 229, 0.28);
        }

        /* SVG 图标样式 */
        .icon {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        .icon-sm {
            width: 16px;
            height: 16px;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="home.html" class="nav-logo">AI 信息未来</a>
            <div class="nav-menu">
                <a href="home.html" class="nav-link">首页</a>
                <a href="courses.html" class="nav-link">课程</a>
                <a href="online-plaza.html" class="nav-link">在线广场</a>
                <a href="pk-arena.html" class="nav-link">PK竞技</a>
                <a href="community.html" class="nav-link">社区</a>
            </div>
            <div class="nav-actions">
                <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
                    <svg class="sun-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M10 2a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2z"/>
                    </svg>
                    <svg class="moon-icon" width="20" height="20" viewBox="0 0 20 20" fill="currentColor" style="display:none;">
                        <path d="M17.293 13.293A8 8 0 116.707 2.707a8.001 8.001 0 1010.586 10.586z"/>
                    </svg>
                </button>
                <div id="authArea"></div>
            </div>
        </div>
    </nav>

    <!-- 主内容 -->
    <main class="container">
        <!-- Hero 区域 -->
        <div class="orders-hero">
            <h1>我的订单</h1>
            <p>管理您的课程订阅和购买记录</p>
        </div>

        <!-- 标签页 -->
        <div class="tabs">
            <button class="tab active" data-status="all" onclick="filterOrders('all')">
                全部订单
                <span class="tab-count" id="totalCount">0</span>
            </button>
            <button class="tab" data-status="pending" onclick="filterOrders('pending')">
                待支付
                <span class="tab-count" id="pendingCount">0</span>
            </button>
            <button class="tab" data-status="active" onclick="filterOrders('active')">
                已完成
                <span class="tab-count" id="activeCount">0</span>
            </button>
            <button class="tab" data-status="cancelled" onclick="filterOrders('cancelled')">
                已取消
                <span class="tab-count" id="cancelledCount">0</span>
            </button>
            <button class="tab" data-status="expired" onclick="filterOrders('expired')">
                已过期
                <span class="tab-count" id="expiredCount">0</span>
            </button>
            <button class="tab tab-refresh" onclick="loadOrders()">
                <svg class="icon icon-sm" viewBox="0 0 24 24">
                    <path d="M5.46257 4.43262C7.21556 2.91688 9.5007 2 12 2C17.5228 2 22 6.47715 22 12C22 14.1361 21.3302 16.1158 20.1892 17.7406L17 12H20C20 7.58172 16.4183 4 12 4C9.84982 4 7.89777 4.84827 6.46023 6.22842L5.46257 4.43262ZM18.5374 19.5674C16.7844 21.0831 14.4993 22 12 22C6.47715 22 2 17.5228 2 12C2 9.86386 2.66979 7.88416 3.8108 6.25944L7 12H4C4 16.4183 7.58172 20 12 20C14.1502 20 16.1022 19.1517 17.5398 17.7716L18.5374 19.5674Z"/>
                </svg>
            </button>
        </div>

        <!-- 订单列表容器 -->
        <div class="orders-container">
            <!-- 加载状态 -->
            <div id="loadingState" class="loading-state">
                <div class="spinner"></div>
                <p style="margin-top: 16px; color: var(--text-secondary);">正在加载订单信息...</p>
            </div>

            <!-- 错误状态 -->
            <div id="errorState" class="error-state" style="display: none;">
                <svg class="error-icon" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C17.5228 2 22 6.47715 22 12C22 17.5228 17.5228 22 12 22ZM11 15V17H13V15H11ZM11 7V13H13V7H11Z"/>
                </svg>
                <h3>加载失败</h3>
                <p id="errorMessage">无法获取订单信息，请稍后重试</p>
                <button class="btn btn-primary" onclick="loadOrders()">重新加载</button>
            </div>

            <!-- 订单列表 -->
            <div id="ordersContent" style="display: none;">
                <!-- 订单将通过 JS 动态加载 -->
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script>
        const API_BASE = '/api';
        let allOrders = [];
        let currentFilter = 'all';

        // 主题切换
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon(theme);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            updateThemeIcon(newTheme);
        }

        function updateThemeIcon(theme) {
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (theme === 'dark') {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
            } else {
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
            }
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('username');
            window.location.href = 'login.html';
        }

        // 加载订单
        async function loadOrders() {
            try {
                showLoading();

                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/orders/my/merged?size=100`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                const data = await response.json();

                if (data.success && data.data) {
                    allOrders = data.data.orders || data.data.subscriptions || [];

                    // 预处理订单数据
                    allOrders = allOrders.map(order => {
                        order.formattedAmount = formatAmount(order);
                        return order;
                    });

                    updateOrderStats(allOrders);
                    filterOrders(currentFilter);
                    showContent();
                } else {
                    showError(data.message || '获取订单失败');
                }
            } catch (error) {
                console.error('加载订单失败:', error);
                showError('网络连接失败，请检查网络后重试');
            }
        }

        // 更新订单统计
        function updateOrderStats(orders) {
            const stats = {
                total: orders.length,
                pending: 0,
                active: 0,
                cancelled: 0,
                expired: 0
            };

            orders.forEach(order => {
                const status = normalizeStatus(order);
                if (status === 'pending') stats.pending++;
                else if (status === 'paid') stats.active++;
                else if (status === 'cancelled') stats.cancelled++;
                else if (status === 'expired') stats.expired++;
            });

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('pendingCount').textContent = stats.pending;
            document.getElementById('activeCount').textContent = stats.active;
            document.getElementById('cancelledCount').textContent = stats.cancelled;
            document.getElementById('expiredCount').textContent = stats.expired;
        }

        // 筛选订单
        function filterOrders(status) {
            currentFilter = status;

            // 更新标签状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.dataset.status === status) {
                    tab.classList.add('active');
                }
            });

            // 筛选订单
            let filteredOrders = allOrders;
            if (status !== 'all') {
                filteredOrders = allOrders.filter(order => normalizeStatus(order) === status);
            }

            displayOrders(filteredOrders);
        }

        // 显示订单列表
        function displayOrders(orders) {
            const container = document.getElementById('ordersContent');

            if (!orders || orders.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg class="empty-icon" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M6.5 2H17.5C17.776 2 18 2.224 18 2.5V21.5C18 21.776 17.776 22 17.5 22H6.5C6.224 22 6 21.776 6 21.5V2.5C6 2.224 6.224 2 6.5 2ZM8 4V20H16V4H8Z"/>
                        </svg>
                        <h3>暂无订单</h3>
                        <p>您还没有购买任何课程</p>
                        <a href="/src/pages/courses.html" class="btn btn-primary">浏览课程</a>
                    </div>
                `;
                return;
            }

            const ordersHTML = orders.map(order => {
                const statusClass = getStatusClass(order.status);
                const statusText = getStatusText(order.status);
                const isPayable = order.status === 'pending' && isOrderPayable(order.createdAt);
                const actionButtons = getActionButtons(order, isPayable);
                const orderType = order.orderType || order.type || order.subscribableType || '';
                const orderTypeLabel = orderType === 'bundle_subscription' || orderType === 'bundle'
                    ? '<span class="badge badge-primary">课程包</span>'
                    : (orderType === 'course_product'
                        ? '<span class="badge">课程产品</span>'
                        : '<span class="badge">单课程</span>');

                const displayTitle = order.title || order.courseName || '未知课程';
                return `
                    <div class="order-item">
                        <div class="order-info">
                            <div class="order-title">
                                ${displayTitle}
                                ${orderTypeLabel}
                            </div>
                            <div class="order-meta">订单号: ${order.orderNo}</div>
                            <div class="order-meta">创建时间: ${formatDate(order.createdAt)}</div>
                            <div class="order-meta">
                                支付方式: ${getPaymentMethodText(order.paymentMethod)} |
                                金额: ¥${order.formattedAmount}
                                ${!isPayable && order.status === 'pending' ? '<span class="timeout-tip">(订单已超时)</span>' : ''}
                            </div>
                        </div>
                        <div class="order-actions">
                            <span class="order-status ${statusClass}">${statusText}</span>
                            ${actionButtons}
                            ${order.status === 'pending' ? `
                                <button class="action-btn btn-secondary" onclick="syncOrder('${order.orderNo}')">
                                    同步支付
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = ordersHTML;
        }

        // 获取操作按钮
        function getActionButtons(order, isPayable) {
            const status = normalizeStatus(order);
            if (status === 'pending') {
                return `
                    <button class="action-btn btn-pay" onclick="continuePayment('${order.id}', '${order.orderNo}', '${order.courseName || '课程'}', ${order.amount}, '${order.subscribableType || order.type || 'course'}', ${order.subscribableId || order.courseId || 1})">
                        立即支付
                    </button>
                    <button class="action-btn btn-cancel" onclick="cancelOrder('${order.id}', '${order.courseName || '课程'}')">
                        取消订单
                    </button>
                `;
            } else if (status === 'paid') {
                return `
                    <button class="action-btn btn-learn" onclick="goToLearn('${order.type || order.subscribableType || ''}', '${order.productId || ''}', '${order.subscribableId || order.courseId || ''}')">
                        去学习
                    </button>
                `;
            }
            return '';
        }

        function normalizeStatus(order) {
            if (!order) return 'pending';
            if (order.status) {
                if (order.status === 'active') return 'paid';
                return order.status;
            }
            return order.paymentStatus || 'pending';
        }

        // 继续支付
        async function continuePayment(subscriptionId, orderNo, courseName, amount, subscribableType, subscribableId) {
            try {
                const type = subscribableType || '';
                const isBundle = type === 'bundle' || type === 'bundle_subscription';
                const isCourseProduct = type === 'course_product';

                const params = new URLSearchParams({
                    orderNo: orderNo,
                    continuePayment: 'true'
                });

                if (isBundle) params.set('bundleId', subscribableId);
                if (isCourseProduct) params.set('productId', subscribableId);
                if (!isBundle && !isCourseProduct) params.set('courseId', subscribableId);

                window.location.href = `payment.html?${params.toString()}`;
            } catch (error) {
                console.error('继续支付失败:', error);
                alert('支付失败，请稍后重试');
            }
        }

        // 取消订单
        async function cancelOrder(subscriptionId, courseName) {
            if (!confirm(`确定要取消订单吗？\n课程：${courseName}`)) {
                return;
            }

            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/orders/cancel/${subscriptionId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`

                const data = await response.json();

                if (data.success) {
                    alert('订单已取消');
                    loadOrders();
                } else {
                    alert(`取消失败：${data.message || '未知错误'}`);
                }
            } catch (error) {
                console.error('取消订单失败:', error);
                alert('取消订单失败，请稍后重试');
            }
        }

        async function syncOrder(orderNo) {
            try {
                const token = localStorage.getItem('token');
                const res = await fetch(`${API_BASE}/orders/sync/${encodeURIComponent(orderNo)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.success) {
                    showToast('同步成功');
                    loadOrders();
                } else {
                    showToast(data.message || '同步失败');
                }
            } catch (e) {
                showToast('同步失败，请稍后重试');
            }
        }

        // 去学习
        function goToLearn(type, productId, courseId) {
            if (type === 'course_product' && productId) {
                window.location.href = `course-detail.html?productId=${encodeURIComponent(productId)}`;
                return;
            }
            if (courseId) {
                window.location.href = `course-detail.html?id=${encodeURIComponent(courseId)}`;
                return;
            }
            window.location.href = 'my-courses.html';
        }

        // 工具函数
        function isOrderPayable(createdAt) {
            if (!createdAt) return false;
            const orderTime = new Date(createdAt);
            const now = new Date();
            const diffMinutes = (now - orderTime) / (1000 * 60);
            return diffMinutes <= 30;
        }

        function getStatusClass(status) {
            const classes = {
                'active': 'status-active',
                'paid': 'status-active',
                'pending': 'status-pending',
                'expired': 'status-expired',
                'cancelled': 'status-cancelled'
            };
            return classes[status] || 'status-pending';
        }

        function getStatusText(status) {
            const texts = {
                'active': '已支付',
                'paid': '已支付',
                'pending': '待支付',
                'expired': '已过期',
                'cancelled': '已取消'
            };
            return texts[status] || '未知';
        }

        function getPaymentMethodText(method) {
            const methods = {
                'alipay': '支付宝',
                'wechat': '微信支付',
                'card': '银行卡',
                'balance': '账户余额',
                'free': '免费'
            };
            return methods[method] || '未知';
        }

        function formatDate(dateString) {
            if (!dateString) return '未知时间';

            if (Array.isArray(dateString) && dateString.length >= 3) {
                const [year, month, day, hour = 0, minute = 0, second = 0] = dateString;
                const date = new Date(year, month - 1, day, hour, minute, second);
                return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
            }

            const date = new Date(dateString);
            if (isNaN(date.getTime())) return '时间格式错误';
            return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN');
        }

        function formatAmount(order) {
            if (typeof order === 'number') {
                return order.toFixed(2);
            }

            if (typeof order === 'object' && order !== null) {
                const possibleFields = ['finalAmount', 'amount', 'price', 'totalAmount', 'finalPrice', 'cost'];
                for (const field of possibleFields) {
                    const value = order[field];
                    if (value !== null && value !== undefined) {
                        const num = parseFloat(value);
                        if (!isNaN(num)) {
                            return num.toFixed(2);
                        }
                    }
                }
            }

            if (typeof order === 'string') {
                const num = parseFloat(order);
                if (!isNaN(num)) {
                    return num.toFixed(2);
                }
            }

            return '0.00';
        }

        function showLoading() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('ordersContent').style.display = 'none';
        }

        function showError(message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
            document.getElementById('ordersContent').style.display = 'none';
            document.getElementById('errorMessage').textContent = message;
        }

        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('ordersContent').style.display = 'block';
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);

            if (!window.AppShell || !window.AppShell.getToken || !window.AppShell.getToken()) {
                if (window.AppShell && window.AppShell.showLoginBanner) { window.AppShell.showLoginBanner(); }
            } else {
                                loadOrders();

                // 自动刷新待支付订单
                setInterval(() => {
                    if (currentFilter === 'pending' || currentFilter === 'all') {
                        loadOrders();
                    }
                }, 30000);
    </script>
    <script src="/js/app-shell.js"></script>
    
</body>
</html>
