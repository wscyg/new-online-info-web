<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证状态测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .status-box {
            background: #f5f5f5;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .status-item {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
        }
        .button-group {
            margin: 20px 0;
        }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .log-box {
            background: #222;
            color: #0f0;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
    </style>
</head>
<body>
    <h1>认证状态测试页面</h1>
    
    <div class="status-box">
        <h2>当前状态</h2>
        <div id="status"></div>
    </div>
    
    <div class="button-group">
        <button onclick="checkStatus()">刷新状态</button>
        <button onclick="simulateLogin()">模拟登录</button>
        <button onclick="clearAuth()">清除认证</button>
        <button onclick="testPageJump()">测试页面跳转</button>
    </div>
    
    <div class="status-box">
        <h2>操作日志</h2>
        <div class="log-box" id="log"></div>
    </div>
    
    <div class="button-group">
        <h3>快速跳转</h3>
        <button onclick="window.location.href='/src/pages/courses.html'">课程页</button>
        <button onclick="window.location.href='/src/pages/profile.html'">个人中心</button>
        <button onclick="window.location.href='/src/pages/qa.html'">问答页</button>
        <button onclick="window.location.href='/src/pages/login.html'">登录页</button>
    </div>

    <script>
        const logBox = document.getElementById('log');
        const statusBox = document.getElementById('status');
        
        function log(message, type = 'info') {
            const time = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            logBox.innerHTML += `<div class="${className}">[${time}] ${message}</div>`;
            logBox.scrollTop = logBox.scrollHeight;
        }
        
        function checkStatus() {
            const token = localStorage.getItem('token');
            const user = localStorage.getItem('user');
            const refreshToken = localStorage.getItem('refreshToken');
            
            let userObj = null;
            try {
                if (user) {
                    userObj = JSON.parse(user);
                }
            } catch (e) {
                log('用户数据解析失败: ' + e.message, 'error');
            }
            
            statusBox.innerHTML = `
                <div class="status-item">
                    <strong>Token:</strong> ${token ? '✅ 存在 (长度: ' + token.length + ')' : '❌ 不存在'}
                </div>
                <div class="status-item">
                    <strong>Refresh Token:</strong> ${refreshToken ? '✅ 存在' : '❌ 不存在'}
                </div>
                <div class="status-item">
                    <strong>User Data:</strong> ${user ? '✅ 存在' : '❌ 不存在'}
                </div>
                ${userObj ? `
                <div class="status-item">
                    <strong>用户名:</strong> ${userObj.username || userObj.nickname || userObj.loginAccount || 'N/A'}
                </div>
                <div class="status-item">
                    <strong>邮箱:</strong> ${userObj.email || 'N/A'}
                </div>
                ` : ''}
            `;
            
            log('状态检查完成', 'success');
        }
        
        function simulateLogin() {
            // 模拟登录，设置假数据
            const fakeToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IlRlc3QgVXNlciIsImlhdCI6MTUxNjIzOTAyMn0.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c';
            const fakeUser = {
                id: 1,
                username: 'testuser',
                nickname: '测试用户',
                email: 'test@example.com',
                loginAccount: 'testuser',
                loginTime: new Date().toISOString()
            };
            
            localStorage.setItem('token', fakeToken);
            localStorage.setItem('user', JSON.stringify(fakeUser));
            localStorage.setItem('refreshToken', 'fake-refresh-token');
            
            log('模拟登录成功', 'success');
            checkStatus();
        }
        
        function clearAuth() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            localStorage.removeItem('refreshToken');
            
            log('认证信息已清除', 'warning');
            checkStatus();
        }
        
        function testPageJump() {
            log('准备跳转到课程页面...', 'info');
            setTimeout(() => {
                window.location.href = '/src/pages/courses.html';
            }, 1000);
        }
        
        // 监听localStorage变化
        window.addEventListener('storage', function(e) {
            log(`Storage事件: ${e.key} 被修改 (来自: ${e.url})`, 'warning');
            checkStatus();
        });
        
        // 页面加载时检查状态
        document.addEventListener('DOMContentLoaded', function() {
            log('页面加载完成', 'success');
            checkStatus();
            
            // 监控localStorage
            const originalSetItem = localStorage.setItem;
            const originalRemoveItem = localStorage.removeItem;
            
            localStorage.setItem = function(key, value) {
                log(`localStorage.setItem: ${key}`, 'info');
                return originalSetItem.apply(this, arguments);
            };
            
            localStorage.removeItem = function(key) {
                log(`localStorage.removeItem: ${key}`, 'warning');
                return originalRemoveItem.apply(this, arguments);
            };
        });
    </script>
</body>
</html>