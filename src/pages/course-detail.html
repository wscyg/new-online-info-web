<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>课程详情 - AI 信息未来</title>
    <link rel="stylesheet" href="/assets/skins/app-shell.css">
<link rel="stylesheet" href="../styles/apple-design.css">
    <style>
        /* ==================== 课程详情 - 单屏布局设计 ==================== */

        /* 动画定义 */
        @keyframes gradientShift {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* ========== 新版单屏布局 ========== */
        .course-page {
            min-height: calc(100vh - 64px);
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            padding: 40px 0;
        }

        .course-page-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 60px;
            align-items: start;
        }

        /* 左侧面板 */
        .course-left-panel {
            position: sticky;
            top: 100px;
            color: white;
            animation: slideInUp 0.5s ease-out;
        }

        .course-left-panel .course-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255,255,255,0.6);
            margin-bottom: 20px;
        }

        .course-left-panel .course-breadcrumb a {
            color: rgba(255,255,255,0.6);
            text-decoration: none;
            transition: color 0.2s;
        }

        .course-left-panel .course-breadcrumb a:hover {
            color: white;
        }

        .course-left-panel .course-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .course-left-panel .course-title {
            font-size: 36px;
            font-weight: 800;
            line-height: 1.2;
            margin-bottom: 16px;
            color: white;
            letter-spacing: -0.02em;
        }

        .course-left-panel .course-subtitle {
            font-size: 16px;
            line-height: 1.6;
            color: rgba(255,255,255,0.75);
            margin-bottom: 24px;
        }

        .course-meta-row {
            display: flex;
            gap: 24px;
            margin-bottom: 28px;
            flex-wrap: wrap;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
        }

        .meta-item svg {
            width: 18px;
            height: 18px;
            opacity: 0.7;
        }

        .meta-item strong {
            color: white;
            font-weight: 700;
        }

        /* 购买区域 */
        .purchase-section {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 28px;
            border: 1px solid rgba(255,255,255,0.15);
            margin-bottom: 24px;
        }

        .price-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .purchase-section .course-price {
            font-size: 36px;
            font-weight: 800;
            color: white;
        }

        .purchase-section .course-price.free {
            color: #4ade80;
        }

        .purchase-section .original-price {
            font-size: 16px;
            color: rgba(255,255,255,0.5);
            text-decoration: line-through;
        }

        .purchase-section .discount-badge {
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .purchase-section .enroll-btn {
            width: 100%;
            padding: 18px;
            font-size: 17px;
            font-weight: 700;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .purchase-section .enroll-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .purchase-section .enroll-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
        }

        .purchase-section .enroll-btn.enrolled {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .feature-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
        }

        .feature-tag {
            padding: 6px 12px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            font-size: 12px;
            color: rgba(255,255,255,0.8);
        }

        /* 讲师简略信息 */
        .instructor-mini {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: rgba(255,255,255,0.08);
            border-radius: 14px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .instructor-mini .instructor-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .instructor-mini .instructor-name {
            font-size: 15px;
            font-weight: 600;
            color: white;
            margin-bottom: 2px;
        }

        .instructor-mini .instructor-title {
            font-size: 13px;
            color: rgba(255,255,255,0.6);
        }

        /* 右侧面板 - 课程大纲 */
        .course-right-panel {
            background: rgba(255,255,255,0.98);
            border-radius: 24px;
            padding: 32px;
            max-height: calc(100vh - 140px);
            overflow-y: auto;
            animation: slideInRight 0.5s ease-out 0.1s both;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .course-right-panel .outline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e5e7eb;
        }

        .course-right-panel .outline-title {
            font-size: 22px;
            font-weight: 700;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .course-right-panel .outline-title::before {
            content: '';
            width: 5px;
            height: 24px;
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            border-radius: 3px;
        }

        .course-right-panel .outline-meta {
            font-size: 14px;
            color: #6b7280;
            padding: 6px 14px;
            background: #f3f4f6;
            border-radius: 20px;
        }

        .chapter-list-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* 章节项样式 - 右侧面板内 */
        .course-right-panel .chapter-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .course-right-panel .chapter-item:hover {
            background: linear-gradient(135deg, rgba(99,102,241,0.08), rgba(139,92,246,0.08));
            border-color: #6366f1;
            transform: translateX(4px);
        }

        .course-right-panel .chapter-item .chapter-number {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            flex-shrink: 0;
        }

        .course-right-panel .chapter-item .chapter-info h3 {
            font-size: 15px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 3px;
        }

        .course-right-panel .chapter-item .chapter-info p {
            font-size: 13px;
            color: #6b7280;
        }

        .course-right-panel .chapter-item.locked {
            opacity: 0.6;
        }

        .course-right-panel .chapter-free-tag {
            padding: 4px 10px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
        }

        .course-right-panel .chapter-status-tag {
            padding: 4px 10px;
            font-size: 11px;
            font-weight: 600;
            border-radius: 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .course-right-panel .chapter-status-tag.completed {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }
        .course-right-panel .chapter-status-tag.in-progress {
            background: rgba(99, 102, 241, 0.12);
            color: #4f46e5;
            border: 1px solid rgba(99, 102, 241, 0.25);
        }
        .course-right-panel .chapter-status-tag svg {
            width: 14px;
            height: 14px;
        }

        /* 进度条 */
        .progress-section {
            margin-bottom: 16px;
        }

        .progress-label {
            display: flex;
            justify-content: space-between;
            font-size: 13px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 8px;
        }

        .progress-track {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #4ade80);
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        /* 响应式 */
        @media (max-width: 1100px) {
            .course-page-container {
                grid-template-columns: 1fr;
                gap: 40px;
                padding: 0 24px;
            }

            .course-left-panel {
                position: relative;
                top: 0;
            }

            .course-right-panel {
                max-height: none;
            }
        }

        /* 隐藏旧的tabs和其他元素 */
        .tabs-container, .course-main, .related-section, .course-hero {
            display: none !important;
        }

        /* ========== 推荐课程区域 ========== */
        .recommended-section {
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            padding: 60px 0 80px;
        }

        .recommended-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 40px;
        }

        .recommended-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .recommended-title {
            font-size: 28px;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .recommended-title::before {
            content: '';
            width: 5px;
            height: 28px;
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            border-radius: 3px;
        }

        .view-all-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: color 0.2s;
        }

        .view-all-link:hover {
            color: #8b5cf6;
        }

        .recommended-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 24px;
        }

        .recommend-card {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s ease;
            cursor: pointer;
            text-decoration: none;
            display: block;
        }

        .recommend-card:hover {
            transform: translateY(-6px);
            border-color: rgba(139, 92, 246, 0.5);
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            background: rgba(255,255,255,0.08);
        }

        .recommend-card-cover {
            height: 140px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .recommend-card-cover::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.05'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
        }

        .recommend-card-cover svg {
            width: 48px;
            height: 48px;
            color: rgba(255,255,255,0.9);
        }

        .recommend-card-cover .course-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 4px 10px;
            background: rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .recommend-card-body {
            padding: 16px;
        }

        .recommend-card-title {
            font-size: 15px;
            font-weight: 600;
            color: white;
            margin-bottom: 8px;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .recommend-card-meta {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }

        .recommend-card-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .recommend-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        .recommend-card-price {
            font-size: 16px;
            font-weight: 700;
            color: #4ade80;
        }

        .recommend-card-price.paid {
            color: #f59e0b;
        }

        .recommend-card-btn {
            padding: 6px 14px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .recommend-card:hover .recommend-card-btn {
            transform: scale(1.05);
        }

        @media (max-width: 1200px) {
            .recommended-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 900px) {
            .recommended-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .recommended-grid {
                grid-template-columns: 1fr;
            }
            .recommended-container {
                padding: 0 20px;
            }
        }

        /* ===== 视觉精修覆盖 ===== */
        .course-page {
            position: relative;
            overflow: hidden;
        }
        .course-page::before {
            content: '';
            position: absolute;
            inset: -20% -20% auto -20%;
            height: 60%;
            background: radial-gradient(circle at 20% 20%, rgba(124, 58, 237, 0.35), transparent 60%),
                        radial-gradient(circle at 80% 0%, rgba(59, 130, 246, 0.28), transparent 55%);
            pointer-events: none;
            z-index: 0;
        }
        .course-page-container {
            position: relative;
            z-index: 1;
        }
        .purchase-section {
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.35);
            border: 1px solid rgba(255,255,255,0.2);
        }
        .purchase-section .enroll-btn.primary {
            letter-spacing: 0.02em;
            box-shadow: 0 18px 40px rgba(99, 102, 241, 0.45);
        }
        .purchase-section .enroll-btn.primary:hover {
            box-shadow: 0 22px 50px rgba(99, 102, 241, 0.55);
        }

        .course-right-panel {
            background: rgba(255,255,255,0.96);
            border: 1px solid rgba(255,255,255,0.6);
        }
        .course-right-panel .outline-header {
            border-bottom: 1px solid #e5e7eb;
        }
        .course-right-panel .chapter-item {
            background: #ffffff;
            box-shadow: 0 8px 22px rgba(15, 23, 42, 0.08);
        }
        .course-right-panel .chapter-item:hover {
            box-shadow: 0 12px 28px rgba(79, 70, 229, 0.2);
        }

        .chapter-item {
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.06);
            box-shadow: 0 10px 26px rgba(15, 23, 42, 0.08);
        }
        .chapter-item:hover {
            box-shadow: 0 16px 36px rgba(79, 70, 229, 0.22);
        }
        .chapter-item .chapter-info h3 {
            font-size: 16px;
            font-weight: 600;
        }

        /* 顶部Hero区域 - 全新设计 */
        .course-hero {
            background: linear-gradient(-45deg, #0f0c29, #302b63, #24243e, #0f0c29);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
            padding: 120px 0 100px;
            position: relative;
            overflow: hidden;
        }

        .course-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.15) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(99, 102, 241, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 40%, rgba(139, 92, 246, 0.1) 0%, transparent 40%);
            animation: float 20s ease-in-out infinite;
        }

        .course-hero::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%239C92AC' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            opacity: 0.5;
        }

        .course-hero-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            position: relative;
            z-index: 1;
        }

        .course-hero-grid {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 60px;
            align-items: start;
        }

        @media (max-width: 1024px) {
            .course-hero-grid {
                grid-template-columns: 1fr;
                gap: 40px;
            }
        }

        /* 左侧课程信息 */
        .course-info {
            color: white;
        }

        .course-breadcrumb {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 24px;
        }

        .course-breadcrumb a {
            color: rgba(255, 255, 255, 0.7);
            text-decoration: none;
            transition: color 0.2s;
        }

        .course-breadcrumb a:hover {
            color: white;
        }

        .course-badges {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .course-badge {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        .course-badge.category {
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            color: white;
        }

        .course-badge.difficulty {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .course-badge.new {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .course-badge.hot {
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
        }

        .course-title {
            font-size: 48px;
            font-weight: 800;
            line-height: 1.15;
            margin-bottom: 20px;
            color: white;
            letter-spacing: -0.02em;
            animation: slideInUp 0.6s ease-out;
            text-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        .course-subtitle {
            font-size: 19px;
            line-height: 1.7;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 32px;
            animation: slideInUp 0.6s ease-out 0.1s both;
            max-width: 600px;
        }

        .course-stats {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 32px;
            animation: slideInUp 0.6s ease-out 0.2s both;
        }

        .course-stat {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .course-stat:hover {
            background: rgba(255, 255, 255, 0.12);
            transform: translateY(-2px);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .course-stat-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(139, 92, 246, 0.3));
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.2);
        }

        .course-stat-icon svg {
            width: 22px;
            height: 22px;
            color: #a5b4fc;
        }

        .course-stat-value {
            font-size: 24px;
            font-weight: 800;
            color: white;
            line-height: 1;
        }

        .course-stat-label {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.65);
            margin-top: 2px;
        }

        /* 讲师信息 */
        .instructor-card {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .instructor-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .instructor-info {
            flex: 1;
        }

        .instructor-name {
            font-size: 16px;
            font-weight: 600;
            color: white;
            margin-bottom: 4px;
        }

        .instructor-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.7);
        }

        .instructor-badge {
            padding: 6px 12px;
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 500;
        }

        /* 右侧卡片 */
        .course-sidebar {
            position: sticky;
            top: 80px;
        }

        .course-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            overflow: hidden;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.25),
                        0 10px 30px rgba(0, 0, 0, 0.1),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.3);
            animation: slideInUp 0.6s ease-out 0.3s both;
            transition: transform 0.4s ease, box-shadow 0.4s ease;
        }

        .course-purchase-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 35px 100px rgba(0, 0, 0, 0.3),
                        0 15px 40px rgba(0, 0, 0, 0.15),
                        inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .course-preview {
            position: relative;
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f64f59 100%);
            background-size: 200% 200%;
            animation: gradientShift 8s ease infinite;
            overflow: hidden;
        }

        .course-preview::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, transparent 50%, rgba(0,0,0,0.4) 100%);
        }

        .course-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .course-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.4s ease;
            cursor: pointer;
        }

        .course-preview:hover .course-preview-overlay {
            opacity: 1;
        }

        .play-btn {
            width: 80px;
            height: 80px;
            background: rgba(255, 255, 255, 0.98);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .play-btn svg {
            width: 34px;
            height: 34px;
            color: #6366f1;
            margin-left: 6px;
        }

        .course-preview:hover .play-btn {
            transform: scale(1.15);
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.4);
        }

        .course-card-body {
            padding: 32px;
        }

        .price-section {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 12px;
        }

        .course-price {
            font-size: 42px;
            font-weight: 800;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .course-price.free {
            background: linear-gradient(135deg, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .original-price {
            font-size: 18px;
            color: var(--text-tertiary);
            text-decoration: line-through;
        }

        .discount-badge {
            padding: 6px 14px;
            background: linear-gradient(135deg, #ef4444, #f97316);
            color: white;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
            animation: pulse-glow 2s ease-in-out infinite;
        }

        .price-note {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: 24px;
        }

        .enroll-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: 700;
            border-radius: 16px;
            border: none;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }

        .enroll-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .enroll-btn:hover::before {
            left: 100%;
        }

        .enroll-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6, #a855f7);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
        }

        .enroll-btn.primary:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.5);
            background-position: 100% 100%;
        }

        .enroll-btn.enrolled {
            background: linear-gradient(135deg, #10b981, #059669, #047857);
            background-size: 200% 200%;
            color: white;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
        }

        .enroll-btn.enrolled:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
        }

        .share-btn {
            width: 100%;
            padding: 16px;
            margin-top: 14px;
            font-size: 15px;
            font-weight: 600;
            border-radius: 14px;
            border: 2px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .share-btn:hover {
            border-color: #6366f1;
            color: #6366f1;
            background: rgba(99, 102, 241, 0.05);
            transform: translateY(-2px);
        }

        .course-features {
            margin-top: 28px;
            padding-top: 28px;
            border-top: 1px solid var(--border-color);
        }

        .course-feature {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 0;
            font-size: 15px;
            color: var(--text-secondary);
            transition: color 0.2s;
        }

        .course-feature:hover {
            color: var(--text-primary);
        }

        .course-feature svg {
            width: 22px;
            height: 22px;
            color: #10b981;
            flex-shrink: 0;
        }

        /* 学习进度（已报名用户） */
        .progress-section {
            margin-bottom: 20px;
            padding: 16px;
            background: var(--bg-secondary);
            border-radius: 12px;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .progress-percent {
            font-size: 14px;
            font-weight: 600;
            color: var(--primary);
        }

        .progress-bar {
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #6366f1);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* 主内容区域 */
        .course-main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        /* 标签导航 */
        .tabs-container {
            position: sticky;
            top: 64px;
            background: var(--bg-primary);
            z-index: 50;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 40px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            padding: 16px 0;
            overflow-x: auto;
        }

        .tab-btn {
            padding: 14px 28px;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-secondary);
            background: transparent;
            border: 2px solid transparent;
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            position: relative;
        }

        .tab-btn:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            color: white;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-color: transparent;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .tab-panel {
            display: none;
            padding-bottom: 60px;
            animation: slideInUp 0.4s ease-out;
        }

        .tab-panel.active {
            display: block;
        }

        /* 课程大纲 - 全新设计 */
        .outline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border-color);
        }

        .outline-title {
            font-size: 28px;
            font-weight: 800;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .outline-title::before {
            content: '';
            width: 6px;
            height: 28px;
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            border-radius: 3px;
        }

        .outline-meta {
            font-size: 15px;
            color: var(--text-secondary);
            padding: 8px 16px;
            background: var(--bg-secondary);
            border-radius: 20px;
        }

        .chapter-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chapter-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .chapter-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        /* 扁平章节列表样式 - 全新设计 */
        .chapter-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px 28px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            margin-bottom: 14px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }

        .chapter-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #6366f1, #8b5cf6);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .chapter-item:hover {
            border-color: #6366f1;
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.15);
            transform: translateY(-4px) scale(1.01);
        }

        .chapter-item:hover::before {
            opacity: 1;
        }

        .chapter-item.accessible {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.03), rgba(139, 92, 246, 0.03));
        }

        .chapter-item.locked {
            opacity: 0.65;
            background: var(--bg-secondary);
        }

        .chapter-item.locked:hover {
            transform: none;
            box-shadow: none;
            border-color: var(--border-color);
        }

        .chapter-item .chapter-left {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }

        .chapter-item .chapter-number {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .chapter-item:hover .chapter-number {
            transform: scale(1.1) rotate(-3deg);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
        }

        .chapter-item .chapter-info h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
            transition: color 0.2s;
        }

        .chapter-item:hover .chapter-info h3 {
            color: #6366f1;
        }

        .chapter-item .chapter-info p {
            font-size: 14px;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .chapter-item .chapter-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chapter-item .chapter-duration {
            font-size: 14px;
            color: var(--text-tertiary);
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .chapter-item .chapter-free-tag {
            padding: 6px 14px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-size: 13px;
            font-weight: 600;
            border-radius: 20px;
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .chapter-item .lock-icon {
            width: 22px;
            height: 22px;
            color: var(--text-tertiary);
            opacity: 0.7;
        }

        .chapter-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 24px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .chapter-header:hover {
            background: var(--bg-secondary);
        }

        .chapter-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chapter-number {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, var(--primary), #6366f1);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 700;
            color: white;
            flex-shrink: 0;
        }

        .chapter-info h3 {
            font-size: 17px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .chapter-info p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chapter-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .chapter-meta {
            text-align: right;
        }

        .chapter-count {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .chapter-duration {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .chapter-toggle {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s;
        }

        .chapter-toggle svg {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
        }

        .chapter-card.expanded .chapter-toggle {
            transform: rotate(180deg);
        }

        .lesson-list {
            padding: 0 24px 24px;
            display: none;
        }

        .chapter-card.expanded .lesson-list {
            display: block;
        }

        .lesson-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px;
            margin-top: 10px;
            background: var(--bg-secondary);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 1px solid transparent;
        }

        .lesson-item:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.08));
            transform: translateX(8px);
            border-color: rgba(99, 102, 241, 0.2);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
        }

        .lesson-item.completed {
            border-left: 4px solid #10b981;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(5, 150, 105, 0.05));
        }

        .lesson-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .lesson-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .lesson-item:hover .lesson-icon {
            transform: scale(1.1);
        }

        .lesson-icon.video {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .lesson-icon.text {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
        }

        .lesson-icon.quiz {
            background: linear-gradient(135deg, #f59e0b, #ef4444);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
        }

        .lesson-icon svg {
            width: 22px;
            height: 22px;
            color: white;
        }

        .lesson-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            transition: color 0.2s;
        }

        .lesson-item:hover .lesson-title {
            color: #6366f1;
        }

        .lesson-meta {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .lesson-right {
            display: flex;
            align-items: center;
            gap: 14px;
        }

        .lesson-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lesson-status.completed {
            background: #10b981;
        }

        .lesson-status.completed svg {
            width: 14px;
            height: 14px;
            color: white;
        }

        .lesson-status.locked svg {
            width: 16px;
            height: 16px;
            color: var(--text-tertiary);
        }

        /* 评价区域 */
        .reviews-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .reviews-summary {
            display: flex;
            align-items: center;
            gap: 24px;
        }

        .rating-big {
            text-align: center;
        }

        .rating-value {
            font-size: 56px;
            font-weight: 700;
            color: var(--text-primary);
            line-height: 1;
        }

        .rating-stars {
            display: flex;
            gap: 4px;
            justify-content: center;
            margin-top: 8px;
        }

        .rating-stars svg {
            width: 20px;
            height: 20px;
            color: #fbbf24;
        }

        .rating-count {
            font-size: 14px;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .rating-bars {
            flex: 1;
            max-width: 300px;
        }

        .rating-bar-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .rating-bar-label {
            font-size: 13px;
            color: var(--text-secondary);
            width: 20px;
        }

        .rating-bar-track {
            flex: 1;
            height: 8px;
            background: var(--bg-tertiary);
            border-radius: 4px;
            overflow: hidden;
        }

        .rating-bar-fill {
            height: 100%;
            background: #fbbf24;
            border-radius: 4px;
        }

        .rating-bar-count {
            font-size: 13px;
            color: var(--text-tertiary);
            width: 30px;
            text-align: right;
        }

        .review-list {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .review-card {
            padding: 24px;
            background: var(--bg-secondary);
            border-radius: 16px;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }

        .review-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }

        .review-user-info {
            flex: 1;
        }

        .review-username {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .review-date {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        .review-rating {
            display: flex;
            gap: 3px;
        }

        .review-rating svg {
            width: 16px;
            height: 16px;
        }

        .review-rating svg.filled {
            color: #fbbf24;
        }

        .review-rating svg.empty {
            color: var(--border-color);
        }

        .review-content {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-secondary);
        }

        /* 问答区域 */
        .qa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .ask-btn {
            padding: 12px 24px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ask-btn:hover {
            background: var(--primary-hover);
        }

        /* 相关课程 */
        .related-section {
            padding: 60px 0;
            background: var(--bg-secondary);
        }

        .related-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 32px;
            text-align: center;
        }

        .related-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 24px;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
        }

        @media (max-width: 900px) {
            .related-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .related-grid {
                grid-template-columns: 1fr;
            }
        }

        .related-card {
            background: var(--bg-primary);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.3s;
            cursor: pointer;
        }

        .related-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.12);
        }

        .related-cover {
            aspect-ratio: 16/9;
            background: linear-gradient(135deg, #3b82f6, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .related-cover svg {
            width: 48px;
            height: 48px;
            color: white;
            opacity: 0.8;
        }

        .related-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .related-body {
            padding: 20px;
        }

        .related-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .related-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .related-price {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
        }

        .related-price.free {
            color: #10b981;
        }

        .related-students {
            font-size: 13px;
            color: var(--text-tertiary);
        }

        /* 空状态 */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            color: var(--text-tertiary);
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-primary);
            color: var(--bg-primary);
            padding: 14px 28px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 500;
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
            pointer-events: none; /* 隐藏时不阻挡点击 */
        }

            .toast.show {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
                pointer-events: auto; /* 显示时允许交互 */
            }

            /* Unlock Modal */
            .unlock-modal {
                position: fixed;
                inset: 0;
                display: none;
                z-index: 9999;
            }

            .unlock-modal.show {
                display: block;
            }

            .unlock-modal-backdrop {
                position: absolute;
                inset: 0;
                background: rgba(0, 0, 0, 0.55);
                backdrop-filter: blur(6px);
            }

            .unlock-modal-card {
                position: absolute;
                left: 50%;
                top: 50%;
                transform: translate(-50%, -50%);
                width: min(520px, calc(100vw - 32px));
                background: rgba(255, 255, 255, 0.96);
                border-radius: 18px;
                padding: 18px 18px 16px;
                box-shadow: 0 30px 80px rgba(0, 0, 0, 0.35);
                color: #111827;
            }

            [data-theme="dark"] .unlock-modal-card {
                background: rgba(17, 24, 39, 0.96);
                color: #f9fafb;
            }

            .unlock-modal-title {
                font-size: 18px;
                font-weight: 800;
                margin-bottom: 6px;
            }

            .unlock-modal-desc {
                margin: 0 0 14px;
                color: rgba(17, 24, 39, 0.75);
                font-size: 14px;
                line-height: 1.5;
            }

            [data-theme="dark"] .unlock-modal-desc {
                color: rgba(249, 250, 251, 0.7);
            }

        .unlock-modal-actions {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 10px;
        }

        .unlock-modal-actions .btn {
            width: 100%;
            justify-content: center;
        }

        .unlock-modal-actions .btn-primary {
            grid-column: 1 / -1;
        }

        .unlock-modal-actions .btn-ghost {
            background: rgba(15, 23, 42, 0.08);
            color: #111827;
        }

        [data-theme="dark"] .unlock-modal-actions .btn-ghost {
            background: rgba(255, 255, 255, 0.08);
            color: #f9fafb;
        }

            /* 加载状态 */
            .skeleton {
                background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
                background-size: 200% 100%;
            animation: skeleton-loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes skeleton-loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* 响应式 */
        @media (max-width: 768px) {
            .course-title {
                font-size: 28px;
            }

            .course-stats {
                gap: 16px;
            }

            .course-card-body {
                padding: 20px;
            }

            .course-price {
                font-size: 28px;
            }
        }

        /* App-shell polish overrides */
        .course-page {
            background:
                radial-gradient(1200px 600px at 15% 10%, rgba(99,102,241,0.22), transparent 60%),
                radial-gradient(900px 520px at 85% 70%, rgba(168,85,247,0.18), transparent 62%),
                linear-gradient(160deg, #0b1020 0%, #14162a 55%, #0b0b12 100%);
        }
        .purchase-section {
            border-radius: var(--radius);
            border: 1px solid var(--stroke);
            background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.03));
            box-shadow: var(--shadow-sm);
        }
        .purchase-section .enroll-btn.primary {
            background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(168,85,247,0.85));
            box-shadow: 0 18px 40px rgba(99,102,241,0.35);
        }
        .purchase-section .enroll-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 24px 50px rgba(99,102,241,0.45);
        }
        .course-right-panel .chapter-item,
        .chapter-item {
            border-radius: 14px;
            border: 1px solid var(--stroke);
            background: rgba(255,255,255,0.03);
        }
        .course-right-panel .chapter-item:hover,
        .chapter-item:hover {
            border-color: rgba(99,102,241,0.45);
            box-shadow: 0 16px 36px rgba(0,0,0,0.25);
        }
        .course-right-panel .chapter-item .chapter-info h3,
        .chapter-item .chapter-info h3 {
            font-weight: 700;
        }
    </style>
</head>
<body>
    <nav class="nav">
        <div class="nav-inner">
            <a href="/" class="nav-logo">AI 信息未来</a>
            <div class="nav-menu">
                <a href="courses.html" class="nav-link">课程</a>
                <a href="dashboard.html" class="nav-link">学习中心</a>
                <a href="my-courses.html" class="nav-link">我的课程</a>
                <a href="profile.html" class="nav-link">个人中心</a>
            </div>
            <div class="nav-actions">
                <div id="authArea"></div>
                <button class="theme-toggle" id="themeToggle" aria-label="切换主题">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path class="sun-icon" d="M10 2.5a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0v-1.5A.75.75 0 0110 2.5zM10 15a5 5 0 100-10 5 5 0 000 10zm6.5-5a.75.75 0 01.75.75v.5a.75.75 0 01-1.5 0v-.5a.75.75 0 01.75-.75z"/>
                        <path class="moon-icon" d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z" style="display: none;"/>
                    </svg>
                </button>
                
                    
                        <a href="#" class="dropdown-item" onclick="logout(); return false;">退出登录</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 全新单屏布局 -->
    <section class="course-page">
        <div class="course-page-container">
            <!-- 左侧：课程信息 + 购买 -->
            <div class="course-left-panel">
                <div class="course-breadcrumb">
                    <a href="courses.html">课程</a>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                    <span id="categoryName">分类</span>
                </div>

                <div class="course-badges" id="courseBadges"></div>
                <h1 class="course-title" id="courseTitle">加载中...</h1>
                <p class="course-subtitle" id="courseDesc">课程简介加载中...</p>

                <div class="course-meta-row">
                    <div class="meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
                        <span><strong id="enrollCount">0</strong> 学员</span>
                    </div>
                    <div class="meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                        <span><strong id="lessonCount">0</strong> 节课</span>
                    </div>
                    <div class="meta-item">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        <span><strong id="rating">5.0</strong> 评分</span>
                    </div>
                </div>

                <!-- 购买区域 -->
                <div class="purchase-section">
                    <div class="price-row">
                        <span class="course-price" id="coursePrice">加载中</span>
                        <span class="original-price" id="originalPrice" style="display: none;"></span>
                        <span class="discount-badge" id="discountBadge" style="display: none;">限时优惠</span>
                    </div>

                    <div id="progressSection" class="progress-section" style="display: none;">
                        <div class="progress-label">
                            <span>学习进度</span>
                            <span id="progressPercent">0%</span>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                        </div>
                    </div>

                    <button class="enroll-btn primary" id="enrollBtn" onclick="handleEnroll()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                            <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                        </svg>
                        立即报名
                    </button>

                    <div class="feature-tags">
                        <span class="feature-tag">永久有效</span>
                        <span class="feature-tag">高清内容</span>
                        <span class="feature-tag">课后答疑</span>
                        <span class="feature-tag">结业证书</span>
                    </div>
                </div>

                <!-- 讲师信息 -->
                <div class="instructor-mini">
                    <div class="instructor-avatar" id="instructorAvatar">A</div>
                    <div class="instructor-info">
                        <div class="instructor-name" id="instructorName">讲师</div>
                        <div class="instructor-title" id="instructorTitle">资深讲师</div>
                    </div>
                </div>
            </div>

            <!-- 右侧：课程大纲 -->
            <div class="course-right-panel">
                <div class="outline-header">
                    <h2 class="outline-title">课程大纲</h2>
                    <span class="outline-meta" id="outlineMeta">共 0 节</span>
                </div>
                <div class="chapter-list-container" id="chapterList">
                    <div class="skeleton" style="height: 80px; margin-bottom: 12px;"></div>
                    <div class="skeleton" style="height: 80px; margin-bottom: 12px;"></div>
                    <div class="skeleton" style="height: 80px;"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- 推荐课程区域 -->
    <section class="recommended-section">
        <div class="recommended-container">
            <div class="recommended-header">
                <h2 class="recommended-title">推荐课程</h2>
                <a href="courses.html" class="view-all-link">
                    查看全部
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </a>
            </div>
            <div class="recommended-grid" id="recommendedGrid">
                <!-- 骨架屏 -->
                <div class="recommend-card skeleton-card">
                    <div class="recommend-card-cover" style="background: rgba(255,255,255,0.1);"></div>
                    <div class="recommend-card-body">
                        <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                        <div class="skeleton" style="height: 14px; width: 60%;"></div>
                    </div>
                </div>
                <div class="recommend-card skeleton-card">
                    <div class="recommend-card-cover" style="background: rgba(255,255,255,0.1);"></div>
                    <div class="recommend-card-body">
                        <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                        <div class="skeleton" style="height: 14px; width: 60%;"></div>
                    </div>
                </div>
                <div class="recommend-card skeleton-card">
                    <div class="recommend-card-cover" style="background: rgba(255,255,255,0.1);"></div>
                    <div class="recommend-card-body">
                        <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                        <div class="skeleton" style="height: 14px; width: 60%;"></div>
                    </div>
                </div>
                <div class="recommend-card skeleton-card">
                    <div class="recommend-card-cover" style="background: rgba(255,255,255,0.1);"></div>
                    <div class="recommend-card-body">
                        <div class="skeleton" style="height: 20px; margin-bottom: 8px;"></div>
                        <div class="skeleton" style="height: 14px; width: 60%;"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 隐藏的元素用于兼容性 -->
    <div style="display:none;">
        <span id="ratingBig">5.0</span>
    </div>

    <!-- 原有Hero区域（隐藏，保留兼容性） -->
    <section class="course-hero" style="display:none;">
        <div class="course-hero-container">
            <div class="course-hero-grid">
                <div class="course-info">
                    <div class="course-breadcrumb">
                        <a href="courses.html">课程</a>
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                        <span>分类</span>
                    </div>
                    <div class="course-badges"></div>
                    <h1 class="course-title">加载中...</h1>
                    <p class="course-subtitle">课程简介加载中...</p>

                    <div class="course-stats">
                        <div class="course-stat">
                            <div class="course-stat-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/></svg>
                            </div>
                            <div>
                                <div class="course-stat-value">0</div>
                                <div class="course-stat-label">学习人数</div>
                            </div>
                        </div>
                        <div class="course-stat">
                            <div class="course-stat-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/></svg>
                            </div>
                            <div>
                                <div class="course-stat-value" id="lessonCount">0</div>
                                <div class="course-stat-label">课时数量</div>
                            </div>
                        </div>
                        <div class="course-stat">
                            <div class="course-stat-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            </div>
                            <div>
                                <div class="course-stat-value" id="rating">5.0</div>
                                <div class="course-stat-label">课程评分</div>
                            </div>
                        </div>
                    </div>

                    <div class="instructor-card" id="instructorCard">
                        <div class="instructor-avatar" id="instructorAvatar">讲</div>
                        <div class="instructor-info">
                            <div class="instructor-name" id="instructorName">课程讲师</div>
                            <div class="instructor-title" id="instructorTitle">高级AI工程师</div>
                        </div>
                        <div class="instructor-badge">认证讲师</div>
                    </div>
                </div>

                <div class="course-sidebar">
                    <div class="course-card">
                        <div class="course-preview" id="coursePreview" onclick="playPreview()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width:64px;height:64px;color:rgba(255,255,255,0.8);">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            <div class="course-preview-overlay">
                                <div class="play-btn">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="course-card-body">
                            <!-- 学习进度（已报名显示） -->
                            <div class="progress-section" id="progressSection" style="display: none;">
                                <div class="progress-header">
                                    <span class="progress-title">学习进度</span>
                                    <span class="progress-percent" id="progressPercent">0%</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                </div>
                            </div>

                            <div class="price-section">
                                <span class="course-price" id="coursePrice">加载中</span>
                                <span class="original-price" id="originalPrice" style="display: none;"></span>
                                <span class="discount-badge" id="discountBadge" style="display: none;"></span>
                            </div>
                            <p class="price-note">报名后永久有效</p>

                            <button class="enroll-btn primary" id="enrollBtn" onclick="handleEnroll()">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                                    <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                                </svg>
                                立即报名
                            </button>

                            <button class="share-btn" onclick="shareCourse()">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="18" cy="5" r="3"/>
                                    <circle cx="6" cy="12" r="3"/>
                                    <circle cx="18" cy="19" r="3"/>
                                    <line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/>
                                    <line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/>
                                </svg>
                                分享课程
                            </button>

                            <div class="course-features">
                                <div class="course-feature">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    <span>永久有效，随时学习</span>
                                </div>
                                <div class="course-feature">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    <span>高清内容，流畅体验</span>
                                </div>
                                <div class="course-feature">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    <span>课后答疑，专属社群</span>
                                </div>
                                <div class="course-feature">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                    <span>学完颁发结业证书</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 标签导航 -->
    <div class="tabs-container">
        <div class="course-main">
            <div class="tabs">
                <button class="tab-btn active" data-tab="outline">课程大纲</button>
                <button class="tab-btn" data-tab="reviews">学员评价</button>
                <button class="tab-btn" data-tab="qa">课程问答</button>
                <button class="tab-btn" data-tab="notes">学习笔记</button>
            </div>
        </div>
    </div>

    <!-- 内容区域 -->
    <div class="course-main">
        <!-- 课程大纲 -->
        <div class="tab-panel active" id="outline">
            <div class="outline-header">
                <h2 class="outline-title">课程大纲</h2>
                <span class="outline-meta" id="outlineMeta">共 0 章 0 节</span>
            </div>
            <div class="chapter-list" id="chapterList">
                <div class="skeleton" style="height: 100px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="height: 100px; margin-bottom: 16px;"></div>
                <div class="skeleton" style="height: 100px;"></div>
            </div>
        </div>

        <!-- 学员评价 -->
        <div class="tab-panel" id="reviews">
            <div class="reviews-header">
                <div class="reviews-summary">
                    <div class="rating-big">
                        <div class="rating-value" id="ratingBig">5.0</div>
                        <div class="rating-stars">
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>
                        </div>
                        <div class="rating-count" id="reviewCount">0 条评价</div>
                    </div>
                    <div class="rating-bars" id="ratingBars">
                        <!-- 动态生成 -->
                    </div>
                </div>
            </div>
            <div class="review-list" id="reviewList">
                <div class="skeleton" style="height: 150px; margin-bottom: 24px;"></div>
                <div class="skeleton" style="height: 150px;"></div>
            </div>
        </div>

        <!-- 课程问答 -->
        <div class="tab-panel" id="qa">
            <div class="qa-header">
                <h2 class="outline-title">课程问答</h2>
                <button class="ask-btn" onclick="askQuestion()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <path d="M12 8v8M8 12h8"/>
                    </svg>
                    提问
                </button>
            </div>
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <circle cx="12" cy="12" r="10"/>
                    <path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3M12 17h.01"/>
                </svg>
                <h3>暂无问答</h3>
                <p>有问题？点击上方按钮提问</p>
            </div>
        </div>

        <!-- 学习笔记 -->
        <div class="tab-panel" id="notes">
            <div class="empty-state">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                    <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                </svg>
                <h3>暂无笔记</h3>
                <p>学习过程中记录的笔记会显示在这里</p>
            </div>
        </div>
    </div>

    <!-- 相关课程 -->
    <section class="related-section">
        <h2 class="related-title">相关推荐</h2>
        <div class="related-grid" id="relatedCourses">
            <div class="skeleton" style="height: 280px;"></div>
            <div class="skeleton" style="height: 280px;"></div>
            <div class="skeleton" style="height: 280px;"></div>
        </div>
    </section>

        <footer class="footer">
            <div class="container">
                <div class="footer-content">
                    <p class="footer-text">2024 AI 信息未来. 保留所有权利.</p>
                    <div class="footer-links">
                        <a href="#" class="footer-link">关于我们</a>
                        <a href="#" class="footer-link">隐私政策</a>
                        <a href="#" class="footer-link">使用条款</a>
                    </div>
                </div>
            </div>
        </footer>

        <!-- 解锁提示弹窗 -->
    <div class="unlock-modal" id="unlockModal" aria-hidden="true">
            <div class="unlock-modal-backdrop" onclick="hideUnlockModal()"></div>
            <div class="unlock-modal-card" role="dialog" aria-modal="true" aria-labelledby="unlockModalTitle">
                <div class="unlock-modal-title" id="unlockModalTitle">解锁完整课程</div>
                <p class="unlock-modal-desc">该内容需要购买课程或开通 VIP 才能继续学习。</p>
                <div class="unlock-modal-actions">
                    <button class="btn btn-ghost" onclick="syncUnlockAccess()">重新同步</button>
                    <button class="btn btn-ghost" onclick="goToOrders()">查看订单</button>
                    <button class="btn btn-secondary" onclick="goToVipSubscribe()">开通 VIP</button>
                    <button class="btn btn-secondary" onclick="hideUnlockModal()">稍后再说</button>
                    <button class="btn btn-primary" onclick="goToCoursePayment()">购买本课程</button>
                </div>
            </div>
        </div>
    
        <script>
            const API_BASE = localStorage.getItem('API_BASE') || '/api';
            const TEMPLATE_API_BASE = localStorage.getItem('TEMPLATE_API_BASE') || '/api/course-templates';
        let currentCourse = null;
        let isEnrolled = false;
        let userProgress = 0;
        let enrollmentProgressDetails = null;
        let chapterProgressById = new Map(); // chapterId -> LearningProgress
        let loadedFlatChapters = [];
        let isTemplateCourse = false;
        let templateCourseId = null;

        document.addEventListener('DOMContentLoaded', () => {
            initTheme();
            
            // 检测是模板课程、课程产品还是普通课程
            const params = new URLSearchParams(window.location.search);
            // 模板课程：兼容老参数 templateId，也支持更直观的 templateCourseId
            templateCourseId = params.get('templateCourseId') || params.get('templateId');
            const productId = params.get('productId');
            const courseId = params.get('id');

            if (templateCourseId) {
                isTemplateCourse = true;
                loadTemplateCourse(templateCourseId);
            } else if (productId) {
                isTemplateCourse = true;
                loadCourseProduct(productId);
            } else if (courseId) {
                loadCourse();
            } else {
                showToast('课程ID无效');
            }

            // 加载推荐课程
            loadRecommendedCourses();

            setupTabs();
            setupEventListeners();
        });

        // ==================== 主题切换 ====================
        function initTheme() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeIcon();
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
            updateThemeIcon();
        }

        function updateThemeIcon() {
            const theme = document.documentElement.getAttribute('data-theme');
            const sunIcon = document.querySelector('.sun-icon');
            const moonIcon = document.querySelector('.moon-icon');
            if (theme === 'dark') {
                sunIcon.style.display = 'inline';
                moonIcon.style.display = 'none';
            } else {
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'inline';
            }
        }

        function setupEventListeners() {
            document.getElementById('themeToggle').addEventListener('click', toggleTheme);
        }

        // ==================== 加载课程 ====================
            async function loadCourse() {
                const courseId = new URLSearchParams(window.location.search).get('id');
                if (!courseId) {
                    showToast('课程ID无效');
                    return;
                }

                try {
                    const token = (window.AppShell && window.AppShell.getToken ? window.AppShell.getToken() : (localStorage.getItem('token') || sessionStorage.getItem('token')) );
                    const headers = token ? { 'Authorization': `Bearer ${token}` } : {};
                    const res = await fetch(`${API_BASE}/courses/${courseId}`, { headers });
                    const data = await res.json();
                    if (data.code === 200 && data.data) {
                        // API 返回结构: {course: {...}, chapters: [...], access: {...}, stats: {...}}
                        const responseData = data.data;
                        currentCourse = responseData.course || responseData;

                    renderCourse(currentCourse);

                    // 如果 API 已返回章节数据，直接使用
                    if (responseData.chapters && responseData.chapters.length > 0) {
                        renderChapters(responseData.chapters);
                    } else {
                        loadChapters(courseId);
                    }

                    // 如果 API 已返回访问权限信息
                    if (responseData.access) {
                        isEnrolled = responseData.access.hasAccess || responseData.access.fullAccess;
                        if (isEnrolled) {
                            await checkEnrollment(courseId);
                            syncCourseAccess(courseId);
                        }
                        updateEnrollButton();
                    } else {
                        checkEnrollment(courseId);
                    }

                    loadReviews(courseId);
                    loadRelatedCourses(currentCourse.categoryId);
                } else {
                    showToast(data.message || '加载课程失败');
                }
            } catch (e) {
                console.error('加载课程失败:', e);
                showToast('网络错误');
            }
        }

        function renderCourse(course) {
            document.title = `${course.title} - AI 信息未来`;
            document.getElementById('courseTitle').textContent = course.title;
            document.getElementById('courseDesc').textContent = course.description || '暂无简介';
            document.getElementById('enrollCount').textContent = course.enrollmentCount || 0;
            document.getElementById('lessonCount').textContent = course.lessonCount || 0;
            document.getElementById('rating').textContent = (course.rating || 5.0).toFixed(1);
            document.getElementById('ratingBig').textContent = (course.rating || 5.0).toFixed(1);

            // 分类
            if (course.category) {
                document.getElementById('categoryName').textContent = course.category.name || course.category;
            }

            // 徽章
            const badgesHtml = [];
            if (course.category) {
                badgesHtml.push(`<span class="course-badge category">${course.category.name || course.category}</span>`);
            }
            if (course.difficulty) {
                badgesHtml.push(`<span class="course-badge difficulty">${course.difficulty}</span>`);
            }
            if (course.isNew) {
                badgesHtml.push(`<span class="course-badge new">新课</span>`);
            }
            if (course.isHot) {
                badgesHtml.push(`<span class="course-badge hot">热门</span>`);
            }
            document.getElementById('courseBadges').innerHTML = badgesHtml.join('');

            // 价格
            const priceEl = document.getElementById('coursePrice');
            if (course.isFree) {
                priceEl.textContent = '免费';
                priceEl.classList.add('free');
            } else {
                priceEl.textContent = isEnrolled ? '已订阅' : `¥${course.price}`;
                if (!isEnrolled && course.originalPrice && course.originalPrice > course.price) {
                    document.getElementById('originalPrice').textContent = `¥${course.originalPrice}`;
                    document.getElementById('originalPrice').style.display = 'inline';
                    const discount = Math.round((1 - course.price / course.originalPrice) * 100);
                    document.getElementById('discountBadge').textContent = `-${discount}%`;
                    document.getElementById('discountBadge').style.display = 'inline';
                }
            }

            // 封面
            if (course.coverImage) {
                document.getElementById('coursePreview').innerHTML = `
                    <img src="${course.coverImage}" alt="${course.title}">
                    <div class="course-preview-overlay">
                        <div class="play-btn">
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        </div>
                    </div>
                `;
            }

            // 讲师
            if (course.instructor) {
                document.getElementById('instructorName').textContent = course.instructor.name || '课程讲师';
                document.getElementById('instructorTitle').textContent = course.instructor.title || '高级讲师';
                const initial = (course.instructor.name || '讲').charAt(0);
                document.getElementById('instructorAvatar').textContent = initial;
            }
        }

        // ==================== 加载模板课程 ====================
        async function loadTemplateCourse(courseId) {
            try {
                const res = await fetch(`${TEMPLATE_API_BASE}/courses/by-course-id/${courseId}`);
                const data = await res.json();

                // 支持 code=0 或 code=200 表示成功
                if ((data.code === 0 || data.code === 200) && data.data) {
                    const course = data.data;
                    currentCourse = course;

                    // 渲染课程基本信息
                    await renderTemplateCourseInfo(course);

                    // 解析并渲染章节（从JSON内容中提取）
                    renderTemplateChapters(course);

                    // 模板课程默认免费，设置已报名状态
                    isEnrolled = true;
                    updateTemplateCourseUI();

                } else {
                    showToast(data.message || '加载课程失败');
                }
            } catch (e) {
                console.error('加载模板课程失败:', e);
                showToast('网络错误');
            }
        }

        async function renderTemplateCourseInfo(course) {
            document.title = `${course.title} - AI 信息未来`;
            document.getElementById('courseTitle').textContent = course.title;
            document.getElementById('courseDesc').textContent = course.description || '探索AI前沿技术的深度解析课程';

            // 设置统计信息
            const content = typeof course.contentJson === 'string' ? JSON.parse(course.contentJson) : course.contentJson;
            const pageCount = content?.pages?.length || 0;
            document.getElementById('enrollCount').textContent = '1.2k+';
            document.getElementById('lessonCount').textContent = pageCount;
            document.getElementById('rating').textContent = '5.0';
            document.getElementById('ratingBig').textContent = '5.0';

            // 分类和难度
            document.getElementById('categoryName').textContent = course.category || 'AI技术';
            document.getElementById('courseBadges').innerHTML = `
                <span class="course-badge category">${course.category || 'AI技术'}</span>
                <span class="course-badge difficulty">${course.difficulty || '进阶'}</span>
                <span class="course-badge new">精品</span>
            `;

            // 价格 - 从模板清单读取（支持模板售卖/订阅）
            const priceEl = document.getElementById('coursePrice');
            priceEl.textContent = '免费';
            priceEl.classList.add('free');
            if (window.UnifiedCourseRenderer) {
                try {
                    window.UnifiedCourseRenderer.init({ templateBasePath: '' });
                    const tplId = course.templateId || course.theme || course.template_id;
                    if (tplId) {
                        const templateMeta = await window.UnifiedCourseRenderer.getTemplateById(tplId);
                        if (templateMeta) applyTemplatePricing(templateMeta);
                    }
                } catch (e) {
                    console.warn('applyTemplatePricing failed:', e);
                }
            }

            // 讲师信息
            document.getElementById('instructorName').textContent = course.author || 'AI教研团队';
            document.getElementById('instructorTitle').textContent = '资深AI技术专家';
            document.getElementById('instructorAvatar').textContent = (course.author || 'A').charAt(0);
        }

        function renderTemplateChapters(course) {
            const container = document.getElementById('chapterList');
            let content = course.contentJson;

            // 如果是字符串，解析为JSON
            if (typeof content === 'string') {
                try {
                    content = JSON.parse(content);
                } catch (e) {
                    console.error('解析课程内容失败:', e);
                    container.innerHTML = '<p style="color:var(--text-tertiary);text-align:center;">内容解析失败</p>';
                    return;
                }
            }

            // 支持两种结构: content.chapters[] 或 content.pages[]
            const chapters = content?.chapters || [];
            const directPages = content?.pages || [];

            // 如果有章节结构，按章节显示
            if (chapters.length > 0) {
                let totalPages = 0;
                chapters.forEach(c => totalPages += (c.pages?.length || 0));
                document.getElementById('outlineMeta').textContent = `共 ${chapters.length} 章 ${totalPages} 节`;

                container.innerHTML = chapters.map((chapter, chapterIdx) => {
                    const chapterTitle = chapter.title || `第 ${chapterIdx + 1} 章`;
                    const pages = chapter.pages || [];

                    return `
                    <div class="chapter-card" data-chapter="${chapterIdx}">
                        <div class="chapter-header" onclick="toggleChapter(this.parentElement)">
                            <div class="chapter-left">
                                <div class="chapter-number">${chapterIdx + 1}</div>
                                <div class="chapter-info">
                                    <h3>${chapterTitle}</h3>
                                    <p>${chapter.description || `本章共 ${pages.length} 节内容`}</p>
                                </div>
                            </div>
                            <div class="chapter-right">
                                <div class="chapter-meta">
                                    <div class="chapter-count">${pages.length} 节</div>
                                    <div class="chapter-duration">约${pages.length * 10}分钟</div>
                                </div>
                                <div class="chapter-toggle">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="lesson-list">
                            ${pages.map((page, pageIdx) => `
                                <div class="lesson-item" onclick="event.stopPropagation(); goToTemplateChapter('${templateCourseId}', ${chapterIdx}, ${pageIdx})">
                                    <div class="lesson-left">
                                        <div class="lesson-icon video">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                                            </svg>
                                        </div>
                                        <div>
                                            <div class="lesson-title">${page.title || `第 ${pageIdx + 1} 节`}</div>
                                            <div class="lesson-meta">约10分钟 · 免费</div>
                                        </div>
                                    </div>
                                    <div class="lesson-right">
                                        <span class="chapter-free-tag">免费</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `}).join('');

                // 默认展开第一章
                const firstChapter = container.querySelector('.chapter-card');
                if (firstChapter) firstChapter.classList.add('expanded');

            } else if (directPages.length > 0) {
                // 直接是页面列表的情况
                document.getElementById('outlineMeta').textContent = `共 ${directPages.length} 节内容`;

                container.innerHTML = directPages.map((page, idx) => {
                    const pageTitle = page.title || `第 ${idx + 1} 节`;
                    const pageDesc = getPageDescription(page);

                    return `
                    <div class="chapter-item accessible" onclick="goToTemplateChapter('${templateCourseId}', 0, ${idx})">
                        <div class="chapter-left">
                            <div class="chapter-number">${idx + 1}</div>
                            <div class="chapter-info">
                                <h3>${pageTitle}</h3>
                                <p>${pageDesc}</p>
                            </div>
                        </div>
                        <div class="chapter-right">
                            <span class="chapter-duration">约15分钟</span>
                            <span class="chapter-free-tag">免费</span>
                        </div>
                    </div>
                `}).join('');
            } else {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <h3>暂无章节</h3>
                        <p>课程内容正在准备中</p>
                    </div>
                `;
            }
        }

        // 从页面内容中提取描述
        function getPageDescription(page) {
            if (page.description) return page.description;

            // 尝试从页面元素中提取第一段文本
            const elements = page.elements || [];
            for (const el of elements) {
                if (el.type === 'text' && el.content) {
                    // 截取前50个字符作为描述
                    const text = el.content.replace(/<[^>]*>/g, '').trim();
                    if (text.length > 0) {
                        return text.length > 50 ? text.substring(0, 50) + '...' : text;
                    }
                }
            }
            return '点击查看详细内容';
        }

        // 跳转到模板课程的具体章节
        function goToTemplateChapter(courseId, chapterIdx, pageIdx) {
            // course-viewer.html 需要知道是哪个章节的哪个页面
            window.location.href = `course-viewer.html?id=${courseId}&chapter=${chapterIdx}&page=${pageIdx || 0}`;
        }

        function updateTemplateCourseUI() {
            const btn = document.getElementById('enrollBtn');
            btn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                开始学习
            `;
            btn.classList.remove('primary');
            btn.classList.add('enrolled');
            btn.onclick = () => goToTemplateChapter(templateCourseId, 0, 0);

            // 隐藏进度条（模板课程暂不追踪进度）
            document.getElementById('progressSection').style.display = 'none';

            // 隐藏相关课程（暂时）
            const relatedSection = document.querySelector('.related-section');
            if (relatedSection) relatedSection.style.display = 'none';
        }

        function applyTemplatePricing(templateMeta) {
            const priceEl = document.getElementById('coursePrice');
            const originalEl = document.getElementById('originalPrice');
            const discountEl = document.getElementById('discountBadge');
            const badges = document.getElementById('courseBadges');
            const price = Number(templateMeta.price || 0);
            const original = Number(templateMeta.originalPrice || 0);
            const isFree = templateMeta.isFree === true || price === 0;

            if (isFree) {
                priceEl.textContent = '免费';
                priceEl.classList.add('free');
                originalEl.style.display = 'none';
                discountEl.style.display = 'none';
            } else {
                priceEl.textContent = `¥${price}`;
                priceEl.classList.remove('free');
                if (original && original > price) {
                    originalEl.textContent = `¥${original}`;
                    originalEl.style.display = 'inline';
                    const discount = Math.round((1 - price / original) * 100);
                    discountEl.textContent = `-${discount}%`;
                    discountEl.style.display = 'inline';
                } else {
                    originalEl.style.display = 'none';
                    discountEl.style.display = 'none';
                }
            }

            if (templateMeta.vipOnly && badges) {
                badges.insertAdjacentHTML('beforeend', '<span class="course-badge hot">VIP专享</span>');
            }
        }

        // ==================== 加载课程产品 ====================
        let currentProductId = null;

        async function loadCourseProduct(productId) {
            currentProductId = productId;
            try {
                const res = await fetch(`${TEMPLATE_API_BASE}/products/by-product-id/${productId}/full`);
                const data = await res.json();

                if ((data.code === 0 || data.code === 200) && data.data) {
                    const { product, chapters } = data.data;
                    currentCourse = product;
                    currentProductId = product?.productId || product?.id || currentProductId;

                    // 渲染章节列表
                    const hasAccess = await checkProductAccess(product?.id);
                    renderProductInfo(product, hasAccess);
                    renderProductChapters(product, chapters, hasAccess);

                    syncProductAccess(product?.productId || product?.id);

                    // 更新报名按钮状态
                    updateProductUI(product, hasAccess);
                } else {
                    showToast(data.message || '加载课程失败');
                }
            } catch (e) {
                console.error('加载课程产品失败:', e);
                showToast('网络错误');
            }
        }

        function renderProductInfo(product, hasAccess = false) {
            document.title = `${product.title} - AI 信息未来`;
            document.getElementById('courseTitle').textContent = product.title;
            document.getElementById('courseDesc').textContent = product.description || product.subtitle || '精品AI课程';

            // 统计信息
            document.getElementById('enrollCount').textContent = product.enrollmentCount || 0;
            document.getElementById('lessonCount').textContent = product.chapterCount || 0;
            document.getElementById('rating').textContent = '5.0';
            document.getElementById('ratingBig').textContent = '5.0';

            // 分类
            document.getElementById('categoryName').textContent = 'AI技术';
            document.getElementById('courseBadges').innerHTML = `
                <span class="course-badge category">AI技术</span>
                <span class="course-badge difficulty">${product.difficulty || '入门'}</span>
                ${product.isFree ? '<span class="course-badge free">免费</span>' : '<span class="course-badge hot">精品</span>'}
            `;

            // 价格
            const priceEl = document.getElementById('coursePrice');
            if (product.isFree || product.price === 0) {
                priceEl.textContent = '免费';
                priceEl.classList.add('free');
            } else {
                priceEl.textContent = hasAccess ? '已订阅' : `¥${product.price}`;
                priceEl.classList.remove('free');
                if (product.originalPrice && product.originalPrice > product.price) {
                    document.getElementById('originalPrice').textContent = `¥${product.originalPrice}`;
                    document.getElementById('originalPrice').style.display = 'inline';
                    const discount = Math.round((1 - product.price / product.originalPrice) * 100);
                    document.getElementById('discountBadge').textContent = `-${discount}%`;
                    document.getElementById('discountBadge').style.display = 'inline';
                }
            }

            // 讲师信息
            document.getElementById('instructorName').textContent = 'AI教研团队';
            document.getElementById('instructorTitle').textContent = '资深AI技术专家';
            document.getElementById('instructorAvatar').textContent = 'A';
        }

        function renderProductChapters(product, chapters, hasAccess = false) {
            const container = document.getElementById('chapterList');
            document.getElementById('outlineMeta').textContent = `共 ${chapters.length} 章`;
            const canAccess = hasAccess || product.isFree || product.price === 0;

            if (!chapters.length) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                        <h3>暂无章节</h3>
                        <p>课程内容正在准备中</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = chapters.map((chapter, idx) => `
                <div class="chapter-item ${canAccess ? 'accessible' : 'locked'}" onclick="goToProductChapter('${chapter.chapterCourseId}', ${idx}, ${canAccess})">
                    <div class="chapter-left">
                        <div class="chapter-number">${idx + 1}</div>
                        <div class="chapter-info">
                            <h3>${chapter.chapterTitle || chapter.chapterOriginalTitle}</h3>
                            <p>点击开始学习</p>
                        </div>
                    </div>
                    <div class="chapter-right">
                        ${canAccess ? '<span class="chapter-free-tag">查看</span>' : '<span class="chapter-free-tag">需购买</span>'}
                    </div>
                </div>
            `).join('');
        }

        function goToProductChapter(chapterCourseId, chapterIdx, canAccess = false) {
            if (!canAccess) {
                showUnlockModal();
                return;
            }
            if (chapterCourseId) {
                window.location.href = `course-viewer.html?id=${chapterCourseId}&chapter=0&page=0`;
            } else {
                showToast('章节内容正在准备中');
            }
        }

        function updateProductUI(product, hasAccess = false) {
            const btn = document.getElementById('enrollBtn');
            const isFree = product.isFree || product.price === 0;

            if (isFree || hasAccess) {
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="5 3 19 12 5 21 5 3"/>
                    </svg>
                    ${hasAccess ? '继续学习' : '开始学习'}
                `;
                btn.classList.remove('primary');
                btn.classList.add('enrolled');
                btn.onclick = () => {
                    const firstChapter = document.querySelector('.chapter-item');
                    if (firstChapter) firstChapter.click();
                };
            } else {
                btn.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 14l9-5-9-5-9 5 9 5z"/>
                        <path d="M12 14l6.16-3.422a12.083 12.083 0 01.665 6.479A11.952 11.952 0 0012 20.055a11.952 11.952 0 00-6.824-2.998 12.078 12.078 0 01.665-6.479L12 14z"/>
                    </svg>
                    立即购买 ¥${product.price}
                `;
                btn.disabled = false;
                btn.style.opacity = '';
                btn.style.cursor = '';
                btn.onclick = () => goToCoursePayment();
            }
        }

        async function checkProductAccess(productId) {
            const token = (window.AppShell && window.AppShell.getToken
                ? window.AppShell.getToken()
                : (localStorage.getItem('token') || sessionStorage.getItem('token')));
            if (!token || !productId) return false;

            try {
                const res = await fetch(`${API_BASE}/subscriptions/access/course_product/${productId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                if (res.status === 401) {
                    if (window.AppShell && window.AppShell.showLoginBanner) {
                        window.AppShell.showLoginBanner();
                    }
                    return false;
                }
                const data = await res.json();
                return !!data?.data?.hasAccess;
            } catch (e) {
                return false;
            }
        }

        async function syncProductAccess(productId) {
            if (!productId || !window.AppShell || !window.AppShell.getToken) return;
            const token = window.AppShell.getToken();
            if (!token) return;
            const lastPaymentRaw = localStorage.getItem('lastPaymentSuccess');
            const lastPayment = lastPaymentRaw ? JSON.parse(lastPaymentRaw) : null;
            const orderNo = lastPayment?.orderNo || new URLSearchParams(window.location.search).get('orderNo');
            if (!orderNo) return;
            try {
                await fetch(`${API_BASE}/orders/sync/${encodeURIComponent(orderNo)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const hasAccess = await checkProductAccess(productId);
                if (hasAccess) {
                    renderProductChapters(currentCourse, Array.isArray(loadedFlatChapters) ? loadedFlatChapters : [], true);
                    updateProductUI(currentCourse, true);
                }
            } catch (e) {}
        }

        async function syncUnlockAccess() {
            if (!window.AppShell || !window.AppShell.getToken) {
                showToast('同步失败，请先登录');
                return;
            }
            const token = window.AppShell.getToken();
            if (!token) {
                window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.href)}`;
                return;
            }

            const lastPaymentRaw = localStorage.getItem('lastPaymentSuccess');
            try {
                const lastPayment = lastPaymentRaw ? JSON.parse(lastPaymentRaw) : null;
                const orderNo = lastPayment?.orderNo || new URLSearchParams(window.location.search).get('orderNo');
                if (!orderNo) {
                    showToast('订单号缺失，无法同步');
                    return;
                }
                const res = await fetch(`${API_BASE}/orders/sync/${encodeURIComponent(orderNo)}`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.code === 200) {
                    showToast('同步成功，正在刷新');
                    setTimeout(() => window.location.reload(), 800);
                } else {
                    showToast(data.message || '同步失败');
                }
            } catch (e) {
                showToast('同步失败，请稍后再试');
            }
        }

        // ==================== 加载推荐课程 ====================
        async function loadRecommendedCourses() {
            const grid = document.getElementById('recommendedGrid');

            try {
                // 同时加载普通课程和模板课程
                const [coursesRes, templateRes] = await Promise.all([
                    fetch(`${API_BASE}/courses?page=1&size=4`).catch(() => null),
                    fetch(`${TEMPLATE_API_BASE}/courses/by-status/published`).catch(() => null)
                ]);

                let courses = [];
                let templateCourses = [];

                // 解析普通课程
                if (coursesRes && coursesRes.ok) {
                    const data = await coursesRes.json();
                    if (data.code === 0 || data.code === 200) {
                        courses = (data.data?.list || data.data || []).slice(0, 4);
                    }
                }

                // 解析模板课程
                if (templateRes && templateRes.ok) {
                    const data = await templateRes.json();
                    if (data.code === 0 || data.code === 200) {
                        templateCourses = (data.data || []).slice(0, 4);
                    }
                }

                // 合并并随机排序，取4个
                const allCourses = [...courses.map(c => ({...c, isTemplate: false})),
                                   ...templateCourses.map(c => ({...c, isTemplate: true}))];

                // 排除当前课程
                const params = new URLSearchParams(window.location.search);
                const currentId = params.get('id');
                const currentTemplateId = params.get('templateId');

                const filtered = allCourses.filter(c => {
                    if (c.isTemplate) {
                        return c.courseId !== currentTemplateId;
                    } else {
                        return String(c.id) !== currentId;
                    }
                });

                // 随机打乱并取前4个
                const shuffled = filtered.sort(() => Math.random() - 0.5).slice(0, 4);

                if (shuffled.length === 0) {
                    grid.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; grid-column: 1/-1;">暂无推荐课程</p>';
                    return;
                }

                renderRecommendedCourses(shuffled);

            } catch (e) {
                console.error('加载推荐课程失败:', e);
                grid.innerHTML = '<p style="color: rgba(255,255,255,0.5); text-align: center; grid-column: 1/-1;">加载推荐课程失败</p>';
            }
        }

        function renderRecommendedCourses(courses) {
            const grid = document.getElementById('recommendedGrid');

            const gradients = [
                'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
                'linear-gradient(135deg, #ec4899 0%, #f43f5e 100%)',
                'linear-gradient(135deg, #14b8a6 0%, #10b981 100%)',
                'linear-gradient(135deg, #f59e0b 0%, #ef4444 100%)',
                'linear-gradient(135deg, #3b82f6 0%, #6366f1 100%)',
                'linear-gradient(135deg, #8b5cf6 0%, #d946ef 100%)'
            ];

            grid.innerHTML = courses.map((course, idx) => {
                const isTemplate = course.isTemplate;
                const title = course.title || '未命名课程';
                const category = course.category?.name || course.category || 'AI技术';
                const price = isTemplate ? 0 : (course.price || 0);
                const isFree = price === 0 || course.isFree;
                const enrollCount = course.enrollmentCount || course.studentCount || 0;
                const lessonCount = course.lessonCount || course.pageCount || 8;

                const href = isTemplate
                    ? `course-detail.html?templateId=${course.courseId}`
                    : `course-detail.html?id=${course.id}`;

                const gradient = gradients[idx % gradients.length];

                return `
                <a href="${href}" class="recommend-card">
                    <div class="recommend-card-cover" style="background: ${gradient};">
                        <span class="course-badge">${category}</span>
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                        </svg>
                    </div>
                    <div class="recommend-card-body">
                        <h3 class="recommend-card-title">${title}</h3>
                        <div class="recommend-card-meta">
                            <span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="8" r="4"/><path d="M4 20c0-4 4-6 8-6s8 2 8 6"/>
                                </svg>
                                ${enrollCount}人学习
                            </span>
                            <span>
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4M8 2v4M3 10h18"/>
                                </svg>
                                ${lessonCount}节
                            </span>
                        </div>
                    </div>
                    <div class="recommend-card-footer">
                        <span class="recommend-card-price ${isFree ? '' : 'paid'}">${isFree ? '免费' : '¥' + price}</span>
                        <span class="recommend-card-btn">查看详情</span>
                    </div>
                </a>
                `;
            }).join('');
        }

        // ==================== 加载章节 ====================
        async function loadChapters(courseId) {
            try {
                const res = await fetch(`${API_BASE}/content/courses/${courseId}/chapters`);
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    renderChapters(data.data);
                }
            } catch (e) {
                document.getElementById('chapterList').innerHTML = '<p style="color:var(--text-tertiary);text-align:center;">加载失败</p>';
            }
        }

            function renderChapters(chapters) {
                const container = document.getElementById('chapterList');

            // 支持两种数据格式：
            // 1. 扁平章节列表 (API直接返回) - 每个章节就是一节课
            // 2. 嵌套结构 (章节包含lessons)
            const isFlat = chapters.length > 0 && !chapters[0].lessons;

            if (isFlat) {
                loadedFlatChapters = Array.isArray(chapters) ? chapters : [];
                // 扁平结构：每个章节作为独立课时显示
                document.getElementById('outlineMeta').textContent = `共 ${chapters.length} 节内容`;

                if (!chapters.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            <h3>暂无章节</h3>
                            <p>课程内容正在准备中</p>
                        </div>
                    `;
                    return;
                }

                    container.innerHTML = chapters.map((chapter, idx) => {
                        const chapterIsFree = !!(chapter.is_free ?? chapter.isFree);
                        const canAccess = !!chapter.canAccess || chapterIsFree || isEnrolled;
                        const lp = chapterProgressById.get(String(chapter.id));
                        const lpStatus = (lp?.status || '').toLowerCase();
                        const lpPercent = Math.max(0, Math.min(100, Number(lp?.progressPercent ?? 0)));

                        let statusIcon = '';
                        if (!canAccess) {
                            statusIcon = '<svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>';
                        } else if (!isEnrolled && chapterIsFree) {
                            statusIcon = '<span class="chapter-free-tag">试看</span>';
                        } else if (isEnrolled && (lpStatus === 'completed' || lpPercent >= 100)) {
                            statusIcon = `<span class="chapter-status-tag completed">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                                已完成
                            </span>`;
                        } else if (isEnrolled && lpPercent > 0) {
                            statusIcon = `<span class="chapter-status-tag in-progress">
                                学习中 ${lpPercent}%
                            </span>`;
                        } else {
                            statusIcon = '';
                        }
                        const durationMinutes = chapter.duration_minutes ?? chapter.durationMinutes;

                        return `
                        <div class="chapter-item ${canAccess ? 'accessible' : 'locked'}" onclick="goToChapter(${chapter.id}, ${canAccess})">
                            <div class="chapter-left">
                                <div class="chapter-number">${idx + 1}</div>
                            <div class="chapter-info">
                                <h3>${chapter.title}</h3>
                                <p>${chapter.description || ''}</p>
                            </div>
                            </div>
                            <div class="chapter-right">
                                ${durationMinutes ? `<span class="chapter-duration">${durationMinutes}分钟</span>` : ''}
                                ${statusIcon}
                            </div>
                        </div>
                    `}).join('');
            } else {
                loadedFlatChapters = [];
                // 嵌套结构：章节包含lessons
                let totalLessons = 0;
                chapters.forEach(c => totalLessons += (c.lessons?.length || 0));

                document.getElementById('outlineMeta').textContent = `共 ${chapters.length} 章 ${totalLessons} 节`;

                if (!chapters.length) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            <h3>暂无章节</h3>
                            <p>课程内容正在准备中</p>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = chapters.map((chapter, idx) => `
                    <div class="chapter-card" onclick="toggleChapter(this)">
                        <div class="chapter-header">
                            <div class="chapter-left">
                                <div class="chapter-number">${idx + 1}</div>
                                <div class="chapter-info">
                                    <h3>${chapter.title}</h3>
                                    <p>${chapter.description || '本章内容概述'}</p>
                                </div>
                            </div>
                            <div class="chapter-right">
                                <div class="chapter-meta">
                                    <div class="chapter-count">${chapter.lessons?.length || 0} 节</div>
                                    <div class="chapter-duration">${chapter.duration || '约30分钟'}</div>
                                </div>
                                <div class="chapter-toggle">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                </div>
                            </div>
                        </div>
                        <div class="lesson-list">
                            ${(chapter.lessons || []).map(lesson => `
                                <div class="lesson-item" onclick="event.stopPropagation(); goToLesson('${lesson.id}')">
                                    <div class="lesson-left">
                                        <div class="lesson-icon ${lesson.type || 'video'}">
                                            ${getLessonIcon(lesson.type)}
                                        </div>
                                        <div>
                                            <div class="lesson-title">${lesson.title}</div>
                                            <div class="lesson-meta">${lesson.duration || '约10分钟'}</div>
                                        </div>
                                    </div>
                                    <div class="lesson-right">
                                        ${isEnrolled ?
                                            (lesson.completed ?
                                                '<div class="lesson-status completed"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg></div>' :
                                                '') :
                                            '<div class="lesson-status locked"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg></div>'
                                        }
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('');
            }
        }

            // 跳转到章节/课时学习页
            function goToChapter(chapterId, canAccess) {
                if (!canAccess) {
                    showUnlockModal();
                    return;
                }
                const courseId = new URLSearchParams(window.location.search).get('id');
                window.location.href = `study.html?courseId=${courseId}&chapterId=${chapterId}`;
            }

            function getContinueChapterId() {
                if (!Array.isArray(loadedFlatChapters) || !loadedFlatChapters.length) return null;

                const accessible = loadedFlatChapters.filter(ch => {
                    const chapterIsFree = !!(ch.is_free ?? ch.isFree);
                    return !!ch.canAccess || chapterIsFree || isEnrolled;
                });
                if (!accessible.length) return null;

                let best = null;
                accessible.forEach(ch => {
                    const lp = chapterProgressById.get(String(ch.id));
                    const lpStatus = (lp?.status || '').toLowerCase();
                    const lpPercent = Math.max(0, Math.min(100, Number(lp?.progressPercent ?? 0)));
                    if (lpStatus === 'completed' || lpPercent >= 100) return;

                    const ts = lp?.lastAccessedAt ? new Date(lp.lastAccessedAt).getTime() : 0;
                    if (!best || ts > best.ts) best = { id: ch.id, ts };
                });

                return best?.id ?? accessible[0]?.id ?? null;
            }

            let pendingUnlockCourseId = null;

            function showUnlockModal(courseId = null) {
                pendingUnlockCourseId = courseId || new URLSearchParams(window.location.search).get('id');
                const modal = document.getElementById('unlockModal');
                if (modal) modal.classList.add('show');
            }

            function hideUnlockModal() {
                const modal = document.getElementById('unlockModal');
                if (modal) modal.classList.remove('show');
                pendingUnlockCourseId = null;
            }

        function goToCoursePayment() {
            const params = new URLSearchParams(window.location.search);
            const courseId = pendingUnlockCourseId || params.get('id');
            const productId = currentProductId || params.get('productId');
            if (productId) {
                window.location.href = `payment.html?productId=${encodeURIComponent(productId)}`;
                return;
            }
            if (!courseId) return;
            window.location.href = `payment.html?courseId=${encodeURIComponent(courseId)}`;
        }

            function goToVipSubscribe() {
                window.location.href = 'vip.html';
            }

        function goToOrders() {
            window.location.href = 'orders.html';
        }


        // 更新报名按钮状态
        function updateEnrollButton() {
                        if (isEnrolled) {
                updateEnrolledUI();
            }
                        }

        function getLessonIcon(type) {
            switch(type) {
                case 'text':
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/></svg>';
                case 'quiz':
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 015.83 1c0 2-3 3-3 3M12 17h.01"/></svg>';
                default:
                    return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
            }
        }

        function toggleChapter(el) {
            el.classList.toggle('expanded');
        }

            function goToLesson(lessonId) {
                const courseId = new URLSearchParams(window.location.search).get('id');
                if (!isEnrolled && !currentCourse?.isFree) {
                    showUnlockModal(courseId);
                    return;
                }
                window.location.href = `study.html?courseId=${courseId}&chapterId=${lessonId}`;
            }

        // ==================== 加载评价 ====================
        async function loadReviews(courseId) {
            try {
                const res = await fetch(`${API_BASE}/reviews/course/${courseId}`);
                const data = await res.json();
                const container = document.getElementById('reviewList');

                if (data.code === 200 && data.data && data.data.length > 0) {
                    const reviews = data.data;
                    document.getElementById('reviewCount').textContent = `${reviews.length} 条评价`;

                    // 评分分布
                    const distribution = [0, 0, 0, 0, 0];
                    reviews.forEach(r => {
                        if (r.rating >= 1 && r.rating <= 5) {
                            distribution[r.rating - 1]++;
                        }
                    });
                    const total = reviews.length;
                    document.getElementById('ratingBars').innerHTML = [5, 4, 3, 2, 1].map(star => {
                        const count = distribution[star - 1];
                        const percent = total > 0 ? (count / total) * 100 : 0;
                        return `
                            <div class="rating-bar-item">
                                <span class="rating-bar-label">${star}</span>
                                <div class="rating-bar-track">
                                    <div class="rating-bar-fill" style="width: ${percent}%"></div>
                                </div>
                                <span class="rating-bar-count">${count}</span>
                            </div>
                        `;
                    }).join('');

                    container.innerHTML = reviews.map(review => `
                        <div class="review-card">
                            <div class="review-header">
                                <div class="review-avatar">${(review.username || 'U').charAt(0).toUpperCase()}</div>
                                <div class="review-user-info">
                                    <div class="review-username">${review.username || '匿名用户'}</div>
                                    <div class="review-date">${formatDate(review.createdAt)}</div>
                                </div>
                                <div class="review-rating">
                                    ${[1,2,3,4,5].map(i => `
                                        <svg class="${i <= review.rating ? 'filled' : 'empty'}" viewBox="0 0 24 24" fill="currentColor">
                                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                        </svg>
                                    `).join('')}
                                </div>
                            </div>
                            <p class="review-content">${review.content}</p>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                            </svg>
                            <h3>暂无评价</h3>
                            <p>学完课程后可以发表评价</p>
                        </div>
                    `;
                }
            } catch (e) {
                document.getElementById('reviewList').innerHTML = '<p style="color:var(--text-tertiary);text-align:center;">加载失败</p>';
            }
        }

        // ==================== 检查报名状态 ====================
        async function checkEnrollment(courseId) {
            const token = (window.AppShell && window.AppShell.getToken ? window.AppShell.getToken() : (localStorage.getItem('token') || sessionStorage.getItem('token')) );
            if (!token) return;

            try {
                const res = await fetch(`${API_BASE}/subscriptions/check/${courseId}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await res.json();
                if (data.code === 200 && data.data) {
                    isEnrolled = true;
                    userProgress = data.data.progress || 0;
                    enrollmentProgressDetails = data.data.progressDetails || null;

                    chapterProgressById = new Map();
                    const chapterProgress = enrollmentProgressDetails?.chapterProgress;
                    if (Array.isArray(chapterProgress)) {
                        chapterProgress.forEach(p => {
                            if (p?.chapterId != null) {
                                chapterProgressById.set(String(p.chapterId), p);
                            }
                        });
                    }
                    updateEnrolledUI();
                    if (loadedFlatChapters.length) {
                        renderChapters(loadedFlatChapters);
                    }
                }
            } catch (e) {}
        }

            function updateEnrolledUI() {
                const btn = document.getElementById('enrollBtn');
                btn.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="5 3 19 12 5 21 5 3"/>
                </svg>
                继续学习
            `;
            btn.classList.remove('primary');
            btn.classList.add('enrolled');

            // 显示进度
            document.getElementById('progressSection').style.display = 'block';
                document.getElementById('progressPercent').textContent = `${userProgress}%`;
                document.getElementById('progressFill').style.width = `${userProgress}%`;
            }

        // ==================== 报名处理 ====================
        async function handleEnroll() {
                        if (isEnrolled) {
                // 普通课程（扁平章节）优先继续上次学习/未完成章节
                if (!isTemplateCourse) {
                    const courseId = new URLSearchParams(window.location.search).get('id');
                    const nextChapterId = getContinueChapterId();
                    if (courseId && nextChapterId) {
                        window.location.href = `study.html?courseId=${courseId}&chapterId=${nextChapterId}`;
                        return;
                    }
                }

                const lessons = document.querySelectorAll('.lesson-item');
                if (lessons.length > 0) lessons[0].click();
                return;
            }

            const token = (window.AppShell && window.AppShell.getToken ? window.AppShell.getToken() : (localStorage.getItem('token') || sessionStorage.getItem('token')) );
            if (!token) {
                window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.href)}`;
                return;
            }

            const courseId = new URLSearchParams(window.location.search).get('id');

                if (currentCourse?.isFree) {
                    try {
                        const res = await fetch(`${API_BASE}/orders/subscribe/course/${courseId}`, {
                            method: 'POST',
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const data = await res.json();
                        if (data.code === 200) {
                            if (data?.data?.needPayment) {
                                window.location.href = `payment.html?courseId=${courseId}`;
                                return;
                            }
                            showToast('报名成功！开始学习吧');
                            isEnrolled = true;
                            await checkEnrollment(courseId);
                            updateEnrolledUI();
                        } else {
                            showToast(data.message || '报名失败');
                        }
                    } catch (e) {
                        showToast('网络错误');
                    }
            } else {
                window.location.href = `payment.html?courseId=${courseId}`;
            }
        }

        // ==================== 相关课程 ====================
        async function loadRelatedCourses(categoryId) {
            try {
                const res = await fetch(`${API_BASE}/courses?limit=3${categoryId ? `&categoryId=${categoryId}` : ''}`);
                const data = await res.json();
                const container = document.getElementById('relatedCourses');

                if (data.code === 200 && data.data && data.data.length > 0) {
                    const currentId = new URLSearchParams(window.location.search).get('id');
                    const courses = data.data.filter(c => c.id != currentId).slice(0, 3);

                    if (courses.length === 0) {
                        container.innerHTML = '<p style="text-align:center;color:var(--text-tertiary);grid-column:1/-1;">暂无相关课程</p>';
                        return;
                    }

                    container.innerHTML = courses.map(course => `
                        <div class="related-card" onclick="location.href='course-detail.html?id=${course.id}'">
                            <div class="related-cover">
                                ${course.coverImage ?
                                    `<img src="${course.coverImage}" alt="${course.title}">` :
                                    `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>`
                                }
                            </div>
                            <div class="related-body">
                                <h3 class="related-name">${course.title}</h3>
                                <div class="related-meta">
                                    <span class="related-price ${course.isFree ? 'free' : ''}">${course.isFree ? '免费' : '¥' + course.price}</span>
                                    <span class="related-students">${course.enrollmentCount || 0} 人学习</span>
                                </div>
                            </div>
                        </div>
                    `).join('');
                } else {
                    container.innerHTML = '<p style="text-align:center;color:var(--text-tertiary);grid-column:1/-1;">暂无相关课程</p>';
                }
            } catch (e) {
                document.getElementById('relatedCourses').innerHTML = '<p style="text-align:center;color:var(--text-tertiary);grid-column:1/-1;">加载失败</p>';
            }
        }

        // ==================== 标签切换 ====================
        function setupTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab).classList.add('active');
                });
            });
        }

        // ==================== 其他功能 ====================
        function playPreview() {
            showToast('预览功能即将上线');
        }

        function shareCourse() {
            if (navigator.share) {
                navigator.share({
                    title: currentCourse?.title || '精品课程',
                    text: currentCourse?.description || '来AI 信息未来学习这门精品课程',
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(window.location.href);
                showToast('链接已复制到剪贴板');
            }
        }

        function askQuestion() {
            const token = (window.AppShell && window.AppShell.getToken ? window.AppShell.getToken() : (localStorage.getItem('token') || sessionStorage.getItem('token')) );
            if (!token) {
                window.location.href = `login.html?returnUrl=${encodeURIComponent(window.location.href)}`;
                return;
            }
            showToast('问答功能即将上线');
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const date = new Date(dateStr);
            return date.toLocaleDateString('zh-CN');
        }

        function showToast(msg) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = msg;
            document.body.appendChild(toast);

            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // ==================== 页面初始化 ====================
        document.addEventListener('DOMContentLoaded', function() {
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            const productId = params.get('productId');
            const templateId = params.get('templateId');

            console.log('页面初始化，参数:', { id, productId, templateId });

            setupTabs();

            if (id) {
                loadCourse(id);
            } else if (productId) {
                loadCourseProduct(productId);
            } else if (templateId) {
                loadTemplateCourse(templateId);
            } else {
                console.error('缺少课程ID参数');
                showToast('页面参数错误');
            }
        });

        function logout() {
            if (confirm('确定要退出登录吗？')) {
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                window.location.href = 'login.html';
            }
        }
    </script>
    <script src="/js/app-shell.js"></script>
    
</body>
</html>
