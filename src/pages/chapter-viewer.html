<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>章节查看器</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0f0f1a;color:#fff;min-height:100vh}
    .loading-overlay{position:fixed;inset:0;background:#0f0f1a;display:flex;align-items:center;justify-content:center;flex-direction:column;z-index:9999;transition:opacity .3s}
    .loading-overlay.hidden{opacity:0;pointer-events:none}
    .loading-spinner{width:40px;height:40px;border:3px solid rgba(99,102,241,.2);border-top-color:#6366f1;border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .loading-text{margin-top:16px;color:#94a3b8;font-size:14px}
    .error-container{display:flex;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:40px}
    .error-icon{font-size:48px;margin-bottom:16px}
    .error-title{font-size:20px;font-weight:600;margin-bottom:8px}
    .error-message{color:#94a3b8;font-size:14px;max-width:520px;white-space:pre-wrap}
    .error-actions{margin-top:24px}
    .btn{display:inline-block;padding:10px 20px;background:#6366f1;color:#fff;text-decoration:none;border-radius:8px;font-size:14px;cursor:pointer;border:none;transition:background .2s}
    .btn:hover{background:#4f46e5}
    #htmlContainer{padding:24px;max-width:1200px;margin:0 auto}
    #chapterFrame{position:fixed;inset:0;width:100vw;height:100vh;border:none;display:none}
    #chapterFrame.active{display:block}
  </style>
  <link rel="stylesheet" href="/assets/skins/app-shell.css">
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">加载章节...</div>
  </div>
  <div id="errorContainer" style="display:none"></div>

  <div id="htmlContainer"></div>
  <iframe id="chapterFrame"></iframe>

  <script></script>
  <script src="/js/format-migrator.js"></script>
  <script src="/js/course-json-validator.js"></script>
  <script src="/js/unified-course-renderer.js"></script>

  <script>
    (function () {
      'use strict';

      const CONFIG = {
        apiBase: localStorage.getItem('CHAPTER_API_BASE') || '/api',
        defaultTemplate: 'chapter2',
      };

      const loadingOverlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      const htmlContainer = document.getElementById('htmlContainer');
      const chapterFrame = document.getElementById('chapterFrame');
      const errorContainer = document.getElementById('errorContainer');

      function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = String(text);
        return div.innerHTML;
      }

      function showError(title, message) {
        loadingOverlay.classList.add('hidden');
        htmlContainer.style.display = 'none';
        chapterFrame.classList.remove('active');
        errorContainer.style.display = 'block';
        errorContainer.innerHTML = `
          <div class="error-container">
            <div>
              <div class="error-icon">:(</div>
              <div class="error-title">${escapeHtml(title)}</div>
              <div class="error-message">${escapeHtml(message)}</div>
              <div class="error-actions">
                <button class="btn" onclick="location.reload()">重试</button>
                <a href="../../template-course-manage.html" class="btn" style="background:#475569;margin-left:8px;">返回管理</a>
              </div>
            </div>
          </div>`;
      }

      function getToken() {
        return localStorage.getItem('token') || sessionStorage.getItem('token');
      }

      function getUrlParams() {
        const params = new URLSearchParams(window.location.search);
        return {
          chapterId: params.get('chapterId') || params.get('id'),
          templateId: params.get('template') || params.get('templateId') || null,
        };
      }

      async function fetchChapterContent(chapterId) {
        const token = getToken();
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = `Bearer ${token}`;

        const res = await fetch(`${CONFIG.apiBase}/chapters/${encodeURIComponent(chapterId)}/content`, { headers });
        if (!res.ok) throw new Error(`API错误: ${res.status} ${res.statusText}`);
        const result = await res.json();
        if ((result.code === 200 || result.code === 0) && result.data) return result.data;
        return result;
      }

      function parseJsonFromBase64(jsonData) {
        try {
          const decoded = atob(jsonData);
          return JSON.parse(decoded);
        } catch (e) {
          throw new Error('JSON数据解析失败');
        }
      }

      async function renderChapter(payload, templateId) {
        const contentType = (payload.contentType || 'html').toLowerCase();
        const content = payload.content !== undefined ? payload.content : (contentType === 'json' ? payload.contentData : payload.contentHtml);

        if (contentType === 'json') {
          if (!window.UnifiedCourseRenderer) throw new Error('UnifiedCourseRenderer 未加载');
          window.UnifiedCourseRenderer.init({ templateBasePath: '..' });

          const rawConfig = typeof content === 'string' ? JSON.parse(content) : content;
          if (!rawConfig || typeof rawConfig !== 'object') throw new Error('章节 JSON 格式错误');
          let config = rawConfig;
          if (window.CourseJsonValidator && typeof window.CourseJsonValidator.validateCourseJson === 'function') {
            const check = window.CourseJsonValidator.validateCourseJson(rawConfig);
            if (!check.ok) {
              console.warn('Chapter schema validation failed:', check.errors);
              throw new Error('章节内容格式异常，请稍后再试。');
            }
            if (check.normalized) config = check.normalized;
          }
          const effectiveTemplateId = templateId || config.templateId || CONFIG.defaultTemplate;

          const html = await window.UnifiedCourseRenderer.renderCourse(config, null, { templateId: effectiveTemplateId });
          htmlContainer.style.display = 'none';
          chapterFrame.classList.add('active');
          chapterFrame.sandbox = 'allow-scripts allow-same-origin';
          chapterFrame.srcdoc = html;
          await new Promise((resolve) => (chapterFrame.onload = resolve));
          if (config.title) document.title = config.title;
          return;
        }

        // html 模式：后端直出 html 内容
        chapterFrame.classList.remove('active');
        htmlContainer.style.display = 'block';
        htmlContainer.innerHTML = (typeof content === 'string' ? content : '<p>暂无内容</p>');
        document.title = payload.title ? payload.title : '章节查看器';
      }

      async function main() {
        try {
          const params = getUrlParams();
          const urlParams = new URLSearchParams(window.location.search);
          const jsonBase64 = urlParams.get('json');
          if (!params.chapterId && !jsonBase64) throw new Error('请提供章节ID参数，例如: ?chapterId=123，或 ?json=<base64>');

          loadingText.textContent = '加载章节...';
          const payload = jsonBase64
            ? { contentType: 'json', content: parseJsonFromBase64(jsonBase64) }
            : await fetchChapterContent(params.chapterId);

          loadingText.textContent = '渲染中...';
          await renderChapter(payload, params.templateId);

          loadingOverlay.classList.add('hidden');
        } catch (e) {
          console.error(e);
          showError('章节加载失败', e && e.message ? e.message : String(e));
        }
      }

      if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', main);
      else main();
    })();
  </script>
    <script src="/js/app-shell.js"></script>
    
</body>
</html>
