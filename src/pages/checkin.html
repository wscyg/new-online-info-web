<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ¯æ—¥ç­¾åˆ° - AIå­¦ä¹ å¹³å°</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #ec4899;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #1e293b;
            --light: #f8fafc;
            --gray: #64748b;
            --white: #ffffff;
            --gold: #fbbf24;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(to bottom right, #0f172a, #1e293b);
            min-height: 100vh;
            color: var(--white);
            padding: 2rem;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 1.1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 3rem;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .stat-card .label {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .checkin-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
        }

        .checkin-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            padding: 1.25rem 3rem;
            border-radius: 3rem;
            font-size: 1.2rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.4);
            margin-top: 1rem;
        }

        .checkin-btn:hover:not(:disabled) {
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(99, 102, 241, 0.6);
        }

        .checkin-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .checkin-animation {
            display: none;
            font-size: 4rem;
            animation: bounce 0.6s ease;
        }

        @keyframes bounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .calendar-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .calendar-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.5rem;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .calendar-day.header {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.6);
        }

        .calendar-day.checked {
            background: linear-gradient(135deg, #10b981, #059669);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .calendar-day.today {
            border: 2px solid var(--gold);
        }

        .rewards-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .rewards-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .rewards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .reward-card {
            background: rgba(255, 255, 255, 0.05);
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.3s ease;
        }

        .reward-card.milestone {
            border-color: var(--gold);
            box-shadow: 0 0 20px rgba(251, 191, 36, 0.3);
        }

        .reward-card.achieved {
            opacity: 0.6;
            background: rgba(16, 185, 129, 0.1);
        }

        .reward-card .days {
            font-size: 2rem;
            font-weight: 700;
            color: var(--gold);
            margin-bottom: 0.5rem;
        }

        .reward-card .points {
            font-size: 1.2rem;
            color: var(--success);
            margin-bottom: 0.5rem;
        }

        .reward-card .description {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .leaderboard-section {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1.5rem;
            padding: 2rem;
        }

        .leaderboard-section h2 {
            margin-bottom: 1.5rem;
            font-size: 1.5rem;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .leaderboard-item {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .leaderboard-item .rank {
            font-size: 1.5rem;
            font-weight: 700;
            min-width: 3rem;
            text-align: center;
        }

        .leaderboard-item.rank-1 .rank {
            color: #fbbf24;
        }

        .leaderboard-item.rank-2 .rank {
            color: #9ca3af;
        }

        .leaderboard-item.rank-3 .rank {
            color: #d97706;
        }

        .leaderboard-item .user-info {
            flex: 1;
        }

        .leaderboard-item .username {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .leaderboard-item .days {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            border-radius: 0.5rem;
            padding: 1rem;
            color: var(--danger);
            margin-bottom: 1rem;
        }

        .success {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid var(--success);
            border-radius: 0.5rem;
            padding: 1rem;
            color: var(--success);
            margin-bottom: 1rem;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .rewards-grid {
                grid-template-columns: 1fr;
            }

            .calendar {
                gap: 0.25rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æ¯æ—¥ç­¾åˆ°</h1>
            <p>åšæŒç­¾åˆ°ï¼Œè§£é”æ›´å¤šå¥–åŠ±</p>
        </div>

        <div id="message-area"></div>

        <!-- ç»Ÿè®¡å¡ç‰‡ -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="label">è¿ç»­ç­¾åˆ°</div>
                <div class="value" id="consecutive-days">0</div>
            </div>
            <div class="stat-card">
                <div class="label">ç´¯è®¡ç­¾åˆ°</div>
                <div class="value" id="total-days">0</div>
            </div>
            <div class="stat-card">
                <div class="label">æœ€é•¿è¿ç»­</div>
                <div class="value" id="max-days">0</div>
            </div>
            <div class="stat-card">
                <div class="label">ç­¾åˆ°ç§¯åˆ†</div>
                <div class="value" id="total-points">0</div>
            </div>
        </div>

        <!-- ç­¾åˆ°åŒºåŸŸ -->
        <div class="checkin-section">
            <div class="checkin-animation" id="checkin-animation">ğŸ‰</div>
            <h2 id="checkin-title">ä»Šæ—¥ç­¾åˆ°</h2>
            <p id="checkin-message">ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å®Œæˆä»Šæ—¥ç­¾åˆ°</p>
            <button class="checkin-btn" id="checkin-btn" onclick="doCheckIn()">
                ç«‹å³ç­¾åˆ°
            </button>
        </div>

        <!-- ç­¾åˆ°æ—¥å† -->
        <div class="calendar-section">
            <h2>æœ¬æœˆç­¾åˆ°æ—¥å†</h2>
            <div class="calendar" id="calendar">
                <div class="calendar-day header">æ—¥</div>
                <div class="calendar-day header">ä¸€</div>
                <div class="calendar-day header">äºŒ</div>
                <div class="calendar-day header">ä¸‰</div>
                <div class="calendar-day header">å››</div>
                <div class="calendar-day header">äº”</div>
                <div class="calendar-day header">å…­</div>
            </div>
        </div>

        <!-- ç­¾åˆ°å¥–åŠ± -->
        <div class="rewards-section">
            <h2>ç­¾åˆ°å¥–åŠ±</h2>
            <div class="rewards-grid" id="rewards-grid">
                <!-- åŠ¨æ€åŠ è½½ -->
            </div>
        </div>

        <!-- æ’è¡Œæ¦œ -->
        <div class="leaderboard-section">
            <h2>ç­¾åˆ°æ’è¡Œæ¦œ</h2>
            <div class="leaderboard-list" id="leaderboard-list">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>
    </div>

    <script type="module" src="../utils/api.js"></script>
    <script type="module">
        import { checkinAPI } from '../utils/api.js';

        let currentStats = null;

        // åˆå§‹åŒ–é¡µé¢
        async function init() {
            await loadStats();
            await loadCalendar();
            await loadRewards();
            await loadLeaderboard();
        }

        // åŠ è½½ç»Ÿè®¡æ•°æ®
        async function loadStats() {
            try {
                const response = await checkinAPI.getStats();
                if (response.success) {
                    currentStats = response.data.stats;
                    updateStatsUI(currentStats);

                    // æ›´æ–°ç­¾åˆ°çŠ¶æ€
                    if (response.data.checkedInToday) {
                        document.getElementById('checkin-btn').disabled = true;
                        document.getElementById('checkin-btn').textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                        document.getElementById('checkin-message').textContent = 'æ˜å¤©å†æ¥å§ï¼';
                    }
                }
            } catch (error) {
                showMessage('åŠ è½½ç»Ÿè®¡å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°ç»Ÿè®¡UI
        function updateStatsUI(stats) {
            document.getElementById('consecutive-days').textContent = stats.currentConsecutiveDays || 0;
            document.getElementById('total-days').textContent = stats.totalCheckinDays || 0;
            document.getElementById('max-days').textContent = stats.maxConsecutiveDays || 0;
            document.getElementById('total-points').textContent = stats.totalPointsEarned || 0;
        }

        // æ‰§è¡Œç­¾åˆ°
        window.doCheckIn = async function() {
            const btn = document.getElementById('checkin-btn');
            const animation = document.getElementById('checkin-animation');

            btn.disabled = true;
            btn.textContent = 'ç­¾åˆ°ä¸­...';

            try {
                const response = await checkinAPI.dailyCheckIn();

                if (response.success) {
                    // æ˜¾ç¤ºåŠ¨ç”»
                    animation.style.display = 'block';
                    setTimeout(() => {
                        animation.style.display = 'none';
                    }, 1000);

                    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                    const msg = `ç­¾åˆ°æˆåŠŸï¼è¿ç»­${response.data.consecutiveDays}å¤©ï¼Œè·å¾—${response.data.pointsEarned}ç§¯åˆ†`;
                    showMessage(msg, 'success');

                    // æ›´æ–°UI
                    await loadStats();
                    await loadCalendar();

                    btn.textContent = 'ä»Šæ—¥å·²ç­¾åˆ°';
                    document.getElementById('checkin-message').textContent = 'æ˜å¤©å†æ¥å§ï¼';
                } else {
                    showMessage(response.message, 'error');
                    btn.disabled = false;
                    btn.textContent = 'ç«‹å³ç­¾åˆ°';
                }
            } catch (error) {
                showMessage('ç­¾åˆ°å¤±è´¥: ' + error.message, 'error');
                btn.disabled = false;
                btn.textContent = 'ç«‹å³ç­¾åˆ°';
            }
        };

        // åŠ è½½æ—¥å†
        async function loadCalendar() {
            try {
                const now = new Date();
                const response = await checkinAPI.getCalendar(now.getFullYear(), now.getMonth() + 1);

                if (response.success) {
                    renderCalendar(response.data);
                }
            } catch (error) {
                console.error('åŠ è½½æ—¥å†å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“æ—¥å†
        function renderCalendar(data) {
            const calendar = document.getElementById('calendar');
            const checkinDays = data.checkinDays || [];

            // è·å–æœ¬æœˆç¬¬ä¸€å¤©æ˜¯æ˜ŸæœŸå‡ 
            const firstDay = new Date(data.year, data.month - 1, 1).getDay();
            const daysInMonth = new Date(data.year, data.month, 0).getDate();
            const today = new Date().getDate();
            const currentMonth = new Date().getMonth() + 1;
            const currentYear = new Date().getFullYear();

            // æ¸…ç©ºæ—¥å†ï¼ˆä¿ç•™è¡¨å¤´ï¼‰
            while (calendar.children.length > 7) {
                calendar.removeChild(calendar.lastChild);
            }

            // å¡«å……ç©ºç™½å¤©
            for (let i = 0; i < firstDay; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.className = 'calendar-day';
                calendar.appendChild(emptyDay);
            }

            // å¡«å……æ—¥æœŸ
            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.className = 'calendar-day';
                dayElement.textContent = day;

                // æ ‡è®°å·²ç­¾åˆ°
                if (checkinDays.includes(day)) {
                    dayElement.classList.add('checked');
                }

                // æ ‡è®°ä»Šå¤©
                if (day === today && data.month === currentMonth && data.year === currentYear) {
                    dayElement.classList.add('today');
                }

                calendar.appendChild(dayElement);
            }
        }

        // åŠ è½½å¥–åŠ±é…ç½®
        async function loadRewards() {
            try {
                const response = await checkinAPI.getRewards();

                if (response.success) {
                    renderRewards(response.data);
                }
            } catch (error) {
                console.error('åŠ è½½å¥–åŠ±å¤±è´¥:', error);
            }
        }

        // æ¸²æŸ“å¥–åŠ±
        function renderRewards(rewards) {
            const grid = document.getElementById('rewards-grid');
            grid.innerHTML = '';

            const consecutiveDays = currentStats?.currentConsecutiveDays || 0;

            rewards.forEach(reward => {
                const card = document.createElement('div');
                card.className = 'reward-card';

                if (reward.milestoneDays === consecutiveDays) {
                    card.classList.add('milestone');
                } else if (reward.milestoneDays < consecutiveDays) {
                    card.classList.add('achieved');
                }

                let bonusText = '';
                if (reward.treasureBox) bonusText += reward.treasureBox + ' ';
                if (reward.badgeName) bonusText += reward.badgeName + ' ';
                if (reward.titleName) bonusText += reward.titleName;

                card.innerHTML = `
                    <div class="days">Day ${reward.milestoneDays}</div>
                    <div class="points">+${reward.points} ç§¯åˆ†</div>
                    <div class="description">${bonusText || reward.description}</div>
                `;

                grid.appendChild(card);
            });
        }

        // åŠ è½½æ’è¡Œæ¦œ
        async function loadLeaderboard() {
            try {
                const response = await checkinAPI.getLeaderboard(10);

                if (response.success) {
                    renderLeaderboard(response.data.leaderboard);
                }
            } catch (error) {
                console.error('åŠ è½½æ’è¡Œæ¦œå¤±è´¥:', error);
                document.getElementById('leaderboard-list').innerHTML =
                    '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // æ¸²æŸ“æ’è¡Œæ¦œ
        function renderLeaderboard(leaderboard) {
            const list = document.getElementById('leaderboard-list');
            list.innerHTML = '';

            if (!leaderboard || leaderboard.length === 0) {
                list.innerHTML = '<div class="loading">æš‚æ— æ•°æ®</div>';
                return;
            }

            leaderboard.forEach((item, index) => {
                const rank = index + 1;
                const element = document.createElement('div');
                element.className = `leaderboard-item rank-${rank}`;

                element.innerHTML = `
                    <div class="rank">#${rank}</div>
                    <div class="user-info">
                        <div class="username">${item.user?.nickname || item.user?.username || 'ç”¨æˆ·' + item.userId}</div>
                        <div class="days">è¿ç»­ç­¾åˆ° ${item.currentConsecutiveDays} å¤©</div>
                    </div>
                `;

                list.appendChild(element);
            });
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('message-area');
            const div = document.createElement('div');
            div.className = type;
            div.textContent = message;
            messageArea.appendChild(div);

            setTimeout(() => {
                div.remove();
            }, 3000);
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        init();
    </script>
</body>
</html>
