<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avatar 换装系统 - CodeArena</title>

    <!-- TailwindCSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: #e2e8f0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            min-height: 100vh;
        }

        .avatar-container {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }

        .skin-card {
            background: rgba(30, 41, 59, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .skin-card:hover {
            transform: translateY(-5px);
            border-color: rgba(79, 70, 229, 0.5);
            box-shadow: 0 10px 30px rgba(79, 70, 229, 0.3);
        }

        .skin-card.equipped {
            border-color: #4f46e5;
            background: rgba(79, 70, 229, 0.2);
        }

        .rarity-common { border-left: 4px solid #94a3b8; }
        .rarity-rare { border-left: 4px solid #3b82f6; }
        .rarity-epic { border-left: 4px solid #a855f7; }
        .rarity-legendary { border-left: 4px solid #f59e0b; }
        .rarity-mythic { border-left: 4px solid #ef4444; }

        #avatar-canvas {
            border: 2px solid rgba(79, 70, 229, 0.5);
            border-radius: 16px;
            background: rgba(15, 23, 42, 0.8);
        }

        .tab-button {
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .tab-button:hover {
            background: rgba(79, 70, 229, 0.2);
        }

        .tab-button.active {
            background: rgba(79, 70, 229, 0.3);
            border-color: #4f46e5;
        }
    </style>
</head>
<body>
    <div class="container mx-auto px-4 py-8">
        <!-- 页头 -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-4">
                <span style="background: linear-gradient(135deg, #00e5ff, #d946ef);
                             -webkit-background-clip: text;
                             -webkit-text-fill-color: transparent;">
                    Avatar 换装系统
                </span>
            </h1>
            <p class="text-gray-400">DNF风格纸娃娃系统 - 打造你的专属形象</p>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 左侧：Avatar预览 -->
            <div class="lg:col-span-1">
                <div class="avatar-container p-6">
                    <h2 class="text-xl font-bold mb-4 text-center">当前装扮</h2>

                    <!-- Canvas画布 -->
                    <div class="flex justify-center mb-4">
                        <canvas id="avatar-canvas" width="300" height="400"></canvas>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="flex gap-2 justify-center flex-wrap">
                        <button onclick="refreshAvatar()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                            <i class="fas fa-sync-alt mr-2"></i>刷新
                        </button>
                        <button onclick="downloadAvatar()" class="px-4 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg text-sm">
                            <i class="fas fa-download mr-2"></i>下载
                        </button>
                        <button onclick="toggleAnimation()" class="px-4 py-2 bg-green-600 hover:bg-green-700 rounded-lg text-sm">
                            <i class="fas fa-magic mr-2"></i>动画
                        </button>
                    </div>

                    <!-- 统计信息 -->
                    <div class="mt-6 pt-6 border-t border-gray-700">
                        <h3 class="font-semibold mb-3">穿戴统计</h3>
                        <div class="space-y-2 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-400">光环：</span>
                                <span id="stat-aura">未装备</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">素体：</span>
                                <span id="stat-body">未装备</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">武器：</span>
                                <span id="stat-weapon">未装备</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-400">发型：</span>
                                <span id="stat-hair">未装备</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧：衣柜和商城 -->
            <div class="lg:col-span-2">
                <div class="avatar-container p-6">
                    <!-- 标签页 -->
                    <div class="flex gap-2 mb-6 overflow-x-auto">
                        <button class="tab-button active" onclick="switchTab('inventory')">
                            <i class="fas fa-box mr-2"></i>我的衣柜
                        </button>
                        <button class="tab-button" onclick="switchTab('shop')">
                            <i class="fas fa-store mr-2"></i>皮肤商城
                        </button>
                    </div>

                    <!-- 部位筛选 -->
                    <div class="flex gap-2 mb-6 flex-wrap">
                        <button class="tab-button text-sm" onclick="filterByPart('ALL')">全部</button>
                        <button class="tab-button text-sm" onclick="filterByPart('AURA')">光环</button>
                        <button class="tab-button text-sm" onclick="filterByPart('BODY')">素体</button>
                        <button class="tab-button text-sm" onclick="filterByPart('WEAPON')">武器</button>
                        <button class="tab-button text-sm" onclick="filterByPart('HAIR')">发型</button>
                        <button class="tab-button text-sm" onclick="filterByPart('EFFECT')">特效</button>
                    </div>

                    <!-- 我的衣柜内容 -->
                    <div id="inventory-content">
                        <div id="inventory-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- 动态加载 -->
                        </div>
                    </div>

                    <!-- 商城内容 -->
                    <div id="shop-content" style="display: none;">
                        <div id="shop-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                            <!-- 动态加载 -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 引入Avatar渲染器 -->
    <script src="../components/AvatarRenderer.js"></script>

    <script>
        // 全局变量
        let avatarRenderer;
        let currentUserId = 1; // 示例用户ID（实际应从登录状态获取）
        let currentTab = 'inventory';
        let currentFilter = 'ALL';
        let animationEnabled = false;

        // API配置
        const apiBaseUrl = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:8070/api'
            : 'http://42.194.245.66:8070/api';

        // 初始化
        document.addEventListener('DOMContentLoaded', async () => {
            // 创建Avatar渲染器
            avatarRenderer = new AvatarRenderer('avatar-canvas', 300, 400);

            // 加载用户装备
            await refreshAvatar();

            // 加载衣柜
            await loadInventory();
        });

        // 刷新Avatar
        async function refreshAvatar() {
            await avatarRenderer.loadEquippedSkins(currentUserId);
            avatarRenderer.render();
            updateStats();
        }

        // 更新统计信息
        function updateStats() {
            const stats = {
                AURA: '未装备',
                BODY: '未装备',
                WEAPON: '未装备',
                HAIR: '未装备'
            };

            avatarRenderer.layers.forEach(layer => {
                if (stats[layer.partType] !== undefined) {
                    stats[layer.partType] = layer.name;
                }
            });

            document.getElementById('stat-aura').textContent = stats.AURA;
            document.getElementById('stat-body').textContent = stats.BODY;
            document.getElementById('stat-weapon').textContent = stats.WEAPON;
            document.getElementById('stat-hair').textContent = stats.HAIR;
        }

        // 下载Avatar
        function downloadAvatar() {
            avatarRenderer.downloadAsPNG(`avatar_${currentUserId}.png`);
        }

        // 切换动画
        function toggleAnimation() {
            animationEnabled = !animationEnabled;
            if (animationEnabled) {
                avatarRenderer.startAnimation();
            } else {
                avatarRenderer.stopAnimation();
                avatarRenderer.render();
            }
        }

        // 切换标签页
        function switchTab(tab) {
            currentTab = tab;

            // 更新按钮状态
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // 显示/隐藏内容
            if (tab === 'inventory') {
                document.getElementById('inventory-content').style.display = 'block';
                document.getElementById('shop-content').style.display = 'none';
                loadInventory();
            } else {
                document.getElementById('inventory-content').style.display = 'none';
                document.getElementById('shop-content').style.display = 'block';
                loadShop();
            }
        }

        // 加载衣柜
        async function loadInventory() {
            const grid = document.getElementById('inventory-grid');
            grid.innerHTML = '<p class="col-span-full text-center text-gray-400">加载中...</p>';

            try {
                // 这里需要添加token验证
                const response = await fetch(`${apiBaseUrl}/skins/inventory`, {
                    headers: {
                        'Authorization': 'Bearer YOUR_TOKEN_HERE'
                    }
                });

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.message);
                }

                renderInventory(result.data.inventory);

            } catch (error) {
                console.error('加载衣柜失败:', error);
                grid.innerHTML = '<p class="col-span-full text-center text-red-400">加载失败，请登录后重试</p>';
            }
        }

        // 渲染衣柜
        function renderInventory(inventory) {
            const grid = document.getElementById('inventory-grid');

            if (inventory.length === 0) {
                grid.innerHTML = '<p class="col-span-full text-center text-gray-400">衣柜空空如也，去商城看看吧！</p>';
                return;
            }

            grid.innerHTML = inventory.map(item => {
                const skin = item.skinItem;
                return `
                    <div class="skin-card ${item.isEquipped ? 'equipped' : ''} rarity-${skin.rarity.toLowerCase()} p-4"
                         onclick="equipSkin(${skin.id})">
                        <div class="aspect-square bg-gray-800 rounded-lg mb-3 flex items-center justify-center">
                            <img src="${skin.imageUrl}" alt="${skin.name}"
                                 class="max-w-full max-h-full object-contain"
                                 onerror="this.src='/assets/placeholder.png'">
                        </div>
                        <h4 class="font-semibold text-sm mb-1">${skin.name}</h4>
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>${translatePartType(skin.partType)}</span>
                            <span class="text-${getRarityColor(skin.rarity)}">${translateRarity(skin.rarity)}</span>
                        </div>
                        ${item.isEquipped ? '<div class="mt-2 text-xs text-green-400"><i class="fas fa-check mr-1"></i>已穿戴</div>' : ''}
                    </div>
                `;
            }).join('');
        }

        // 穿戴皮肤
        async function equipSkin(skinId) {
            try {
                const response = await fetch(`${apiBaseUrl}/skins/equip/${skinId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer YOUR_TOKEN_HERE'
                    }
                });

                const result = await response.json();
                if (result.success) {
                    await refreshAvatar();
                    await loadInventory();
                } else {
                    alert(result.message);
                }

            } catch (error) {
                console.error('穿戴失败:', error);
                alert('穿戴失败');
            }
        }

        // 翻译函数
        function translatePartType(type) {
            const map = { AURA: '光环', BODY: '素体', WEAPON: '武器', HAIR: '发型', EFFECT: '特效' };
            return map[type] || type;
        }

        function translateRarity(rarity) {
            const map = { COMMON: '普通', RARE: '稀有', EPIC: '史诗', LEGENDARY: '传说', MYTHIC: '神话' };
            return map[rarity] || rarity;
        }

        function getRarityColor(rarity) {
            const map = { COMMON: 'gray-400', RARE: 'blue-400', EPIC: 'purple-400', LEGENDARY: 'yellow-400', MYTHIC: 'red-400' };
            return map[rarity] || 'gray-400';
        }

        // 部位筛选
        function filterByPart(part) {
            currentFilter = part;
            // 重新加载当前标签页内容
            if (currentTab === 'inventory') {
                loadInventory();
            } else {
                loadShop();
            }
        }

        // 加载商城（占位）
        function loadShop() {
            const grid = document.getElementById('shop-grid');
            grid.innerHTML = '<p class="col-span-full text-center text-gray-400">商城功能开发中...</p>';
        }
    </script>
</body>
</html>
