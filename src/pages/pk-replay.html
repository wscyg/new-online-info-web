<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¹æˆ˜å›æ”¾ - æœªæ¥ä¿¡æ¯åœ¨çº¿æ•™è‚²</title>
    <link rel="stylesheet" href="../styles/main.css">
    <link rel="stylesheet" href="../styles/pk.css">
    <style>
        .replay-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .replay-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            padding: 24px;
            color: white;
            margin-bottom: 24px;
        }

        .replay-header h1 {
            margin: 0 0 12px 0;
            font-size: 28px;
        }

        .replay-info {
            display: flex;
            gap: 24px;
            font-size: 14px;
        }

        .replay-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .players-section {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 24px;
            margin-bottom: 24px;
            align-items: center;
        }

        .player-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .player-card.winner {
            border: 2px solid #ffd700;
            box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
        }

        .player-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .player-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
        }

        .player-name {
            font-size: 18px;
            font-weight: bold;
        }

        .player-rank {
            font-size: 14px;
            color: #666;
        }

        .player-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 12px;
            color: #999;
            margin-top: 4px;
        }

        .vs-badge {
            background: #667eea;
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 24px;
            font-weight: bold;
        }

        .questions-timeline {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timeline-header {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .question-item {
            display: grid;
            grid-template-columns: 60px 1fr 1fr;
            gap: 16px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .question-index {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: #f5f5f5;
            border-radius: 50%;
            font-weight: bold;
            font-size: 18px;
        }

        .question-content {
            flex: 1;
        }

        .question-title {
            font-weight: bold;
            margin-bottom: 12px;
        }

        .question-options {
            display: grid;
            gap: 8px;
        }

        .option {
            padding: 8px 12px;
            background: #f9f9f9;
            border-radius: 6px;
            font-size: 14px;
        }

        .option.correct {
            background: #d4edda;
            border: 1px solid #28a745;
        }

        .answer-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .player-answer {
            padding: 12px;
            border-radius: 8px;
            background: #f9f9f9;
        }

        .player-answer-header {
            font-weight: bold;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .player-answer.correct {
            background: #d4edda;
        }

        .player-answer.wrong {
            background: #f8d7da;
        }

        .answer-time {
            font-size: 12px;
            color: #666;
            margin-top: 4px;
        }

        .result-icon {
            width: 20px;
            height: 20px;
        }

        .explanation-section {
            margin-top: 12px;
            padding: 12px;
            background: #e7f3ff;
            border-radius: 6px;
            border-left: 4px solid #2196f3;
        }

        .explanation-title {
            font-weight: bold;
            margin-bottom: 8px;
            color: #2196f3;
        }

        .back-button {
            position: fixed;
            top: 20px;
            left: 20px;
            background: white;
            padding: 12px 24px;
            border-radius: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            z-index: 100;
        }

        .back-button:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transform: translateY(-2px);
        }

        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="back-button" onclick="goBack()">
        <span>â†</span>
        <span>è¿”å›</span>
    </div>

    <div id="loadingSpinner" class="loading-spinner">
        <div class="spinner"></div>
    </div>

    <div id="replayContent" class="replay-container" style="display: none;">
        <!-- å›æ”¾æ ‡é¢˜ -->
        <div class="replay-header">
            <h1>ğŸ“º å¯¹æˆ˜å›æ”¾</h1>
            <div class="replay-info">
                <div class="replay-info-item">
                    <span>ğŸ•</span>
                    <span id="battleTime"></span>
                </div>
                <div class="replay-info-item">
                    <span>ğŸ®</span>
                    <span id="battleMode"></span>
                </div>
                <div class="replay-info-item">
                    <span>â±ï¸</span>
                    <span id="battleDuration"></span>
                </div>
            </div>
        </div>

        <!-- ç©å®¶å¯¹æ¯” -->
        <div class="players-section">
            <div class="player-card" id="player1Card">
                <div class="player-header">
                    <img id="player1Avatar" class="player-avatar" src="" alt="Player 1">
                    <div>
                        <div class="player-name" id="player1Name"></div>
                        <div class="player-rank" id="player1Rank"></div>
                    </div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="player1Score"></div>
                        <div class="stat-label">å¾—åˆ†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="player1Correct"></div>
                        <div class="stat-label">æ­£ç¡®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="player1Time"></div>
                        <div class="stat-label">ç”¨æ—¶(ç§’)</div>
                    </div>
                </div>
            </div>

            <div class="vs-badge">VS</div>

            <div class="player-card" id="player2Card">
                <div class="player-header">
                    <img id="player2Avatar" class="player-avatar" src="" alt="Player 2">
                    <div>
                        <div class="player-name" id="player2Name"></div>
                        <div class="player-rank" id="player2Rank"></div>
                    </div>
                </div>
                <div class="player-stats">
                    <div class="stat-item">
                        <div class="stat-value" id="player2Score"></div>
                        <div class="stat-label">å¾—åˆ†</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="player2Correct"></div>
                        <div class="stat-label">æ­£ç¡®</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value" id="player2Time"></div>
                        <div class="stat-label">ç”¨æ—¶(ç§’)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- é¢˜ç›®æ—¶é—´è½´ -->
        <div class="questions-timeline">
            <div class="timeline-header">ğŸ“Š é¢˜ç›®è¯¦æƒ…</div>
            <div id="questionsContainer"></div>
        </div>
    </div>

    <script type="module">
        import { usePKStore } from '../store/pk-store.js';

        // è·å–battleId
        const urlParams = new URLSearchParams(window.location.search);
        const battleId = urlParams.get('battleId');

        if (!battleId) {
            alert('ç¼ºå°‘å¯¹æˆ˜ID');
            window.history.back();
        }

        // åŠ è½½å¯¹æˆ˜å›æ”¾æ•°æ®
        async function loadReplay() {
            try {
                const API_BASE = window.location.hostname === 'localhost'
                    ? 'http://localhost:8080/api'
                    : `${window.location.protocol}//${window.location.host}/api`;

                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/pk/battle/${battleId}/details`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load battle details');
                }

                const result = await response.json();
                if (result.success && result.data) {
                    renderReplay(result.data);
                } else {
                    throw new Error(result.message || 'åŠ è½½å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½å›æ”¾å¤±è´¥:', error);
                alert('åŠ è½½å¯¹æˆ˜å›æ”¾å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                window.history.back();
            }
        }

        // æ¸²æŸ“å›æ”¾
        function renderReplay(battleData) {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('replayContent').style.display = 'block';

            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('battleTime').textContent = new Date(battleData.startTime).toLocaleString();
            document.getElementById('battleMode').textContent = getModeText(battleData.mode);

            const duration = Math.floor((new Date(battleData.endTime) - new Date(battleData.startTime)) / 1000);
            document.getElementById('battleDuration').textContent = `${Math.floor(duration / 60)}åˆ†${duration % 60}ç§’`;

            // ç©å®¶1ä¿¡æ¯
            const player1 = battleData.player1;
            document.getElementById('player1Avatar').src = player1.avatar || '/images/default-avatar.png';
            document.getElementById('player1Name').textContent = player1.username;
            document.getElementById('player1Rank').textContent = getRankText(player1.rankTier);
            document.getElementById('player1Score').textContent = battleData.player1Score;
            document.getElementById('player1Correct').textContent = battleData.player1Correct;
            document.getElementById('player1Time').textContent = calculateTotalTime(battleData.player1Details);

            // ç©å®¶2ä¿¡æ¯
            const player2 = battleData.player2;
            document.getElementById('player2Avatar').src = player2.avatar || '/images/default-avatar.png';
            document.getElementById('player2Name').textContent = player2.username;
            document.getElementById('player2Rank').textContent = getRankText(player2.rankTier);
            document.getElementById('player2Score').textContent = battleData.player2Score;
            document.getElementById('player2Correct').textContent = battleData.player2Correct;
            document.getElementById('player2Time').textContent = calculateTotalTime(battleData.player2Details);

            // æ ‡è®°è·èƒœè€…
            if (battleData.winnerId) {
                const winnerCard = battleData.winnerId === player1.id ? 'player1Card' : 'player2Card';
                document.getElementById(winnerCard).classList.add('winner');
            }

            // æ¸²æŸ“é¢˜ç›®è¯¦æƒ…
            renderQuestions(battleData);
        }

        // æ¸²æŸ“é¢˜ç›®åˆ—è¡¨
        function renderQuestions(battleData) {
            const container = document.getElementById('questionsContainer');
            container.innerHTML = '';

            battleData.questions.forEach((question, index) => {
                const player1Answer = battleData.player1Details.find(d => d.questionIndex === index);
                const player2Answer = battleData.player2Details.find(d => d.questionIndex === index);

                const questionHTML = `
                    <div class="question-item">
                        <div class="question-index">Q${index + 1}</div>
                        <div class="question-content">
                            <div class="question-title">${question.questionHtml}</div>
                            <div class="question-options">
                                ${renderOptions(question, question.correctAnswer)}
                            </div>
                            ${question.explanationHtml ? `
                                <div class="explanation-section">
                                    <div class="explanation-title">ğŸ’¡ é¢˜ç›®è§£æ</div>
                                    <div>${question.explanationHtml}</div>
                                </div>
                            ` : ''}
                        </div>
                        <div class="answer-section">
                            <div class="player-answer ${player1Answer?.isCorrect ? 'correct' : 'wrong'}">
                                <div class="player-answer-header">
                                    <span>${player1Answer?.isCorrect ? 'âœ“' : 'âœ—'}</span>
                                    <span>${battleData.player1.username}</span>
                                </div>
                                <div>ç­”æ¡ˆ: ${player1Answer?.playerAnswer || 'æœªç­”'}</div>
                                <div class="answer-time">ç”¨æ—¶: ${player1Answer?.answerTime || 0}ç§’</div>
                            </div>
                            <div class="player-answer ${player2Answer?.isCorrect ? 'correct' : 'wrong'}">
                                <div class="player-answer-header">
                                    <span>${player2Answer?.isCorrect ? 'âœ“' : 'âœ—'}</span>
                                    <span>${battleData.player2.username}</span>
                                </div>
                                <div>ç­”æ¡ˆ: ${player2Answer?.playerAnswer || 'æœªç­”'}</div>
                                <div class="answer-time">ç”¨æ—¶: ${player2Answer?.answerTime || 0}ç§’</div>
                            </div>
                        </div>
                    </div>
                `;
                container.innerHTML += questionHTML;
            });
        }

        // æ¸²æŸ“é€‰é¡¹
        function renderOptions(question, correctAnswer) {
            if (!question.options || question.options.length === 0) {
                return '';
            }

            return question.options.map(opt => {
                const isCorrect = opt.optionKey === correctAnswer;
                return `<div class="option ${isCorrect ? 'correct' : ''}">${opt.optionKey}. ${opt.optionHtml}</div>`;
            }).join('');
        }

        // è®¡ç®—æ€»ç”¨æ—¶
        function calculateTotalTime(details) {
            return details.reduce((sum, d) => sum + (d.answerTime || 0), 0);
        }

        // æ¨¡å¼æ–‡æœ¬
        function getModeText(mode) {
            const modes = {
                'QUICK': 'å¿«é€Ÿæ¨¡å¼ (5é¢˜)',
                'STANDARD': 'æ ‡å‡†æ¨¡å¼ (10é¢˜)',
                'LONG': 'é•¿ç¯‡æ¨¡å¼ (20é¢˜)'
            };
            return modes[mode] || mode;
        }

        // æ®µä½æ–‡æœ¬
        function getRankText(tier) {
            const ranks = {
                'BRONZE': 'ğŸ¥‰ é’é“œ',
                'SILVER': 'ğŸ¥ˆ ç™½é“¶',
                'GOLD': 'ğŸ¥‡ é»„é‡‘',
                'PLATINUM': 'ğŸ’ é“‚é‡‘',
                'DIAMOND': 'ğŸ’  é’»çŸ³',
                'KING': 'ğŸ‘‘ ç‹è€…'
            };
            return ranks[tier] || tier;
        }

        // è¿”å›æŒ‰é’®
        window.goBack = function() {
            window.history.back();
        };

        // åˆå§‹åŒ–
        loadReplay();
    </script>
</body>
</html>
