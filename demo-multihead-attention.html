<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬4ç« ï¼šæ·±å…¥åˆ†æ - å¤šå¤´æ³¨æ„åŠ›çš„è¯ç”Ÿ | å®Œæ•´ä¼˜åŒ–ç‰ˆ</title>
    <meta name="description" content="ä»å•å¤´åˆ°å¤šå¤´æ³¨æ„åŠ›æœºåˆ¶çš„å®Œæ•´å­¦ä¹ ä¹‹æ—…ï¼ŒåŒ…å«è¯¦ç»†æ•°å­¦æ¨å¯¼ã€ä»£ç å®ç°å’Œäº¤äº’å¼å¯è§†åŒ–">
    <!-- ä½¿ç”¨æœ¬åœ°åº“ -->
    <link rel="stylesheet" href="/lib/highlightjs/github-dark.min.css">
    <link rel="stylesheet" href="/lib/katex/katex.min.css">
    <style>
        /* ===== CSSå˜é‡å®šä¹‰ ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-dark: #0f172a;
            --bg-section: #1e293b;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --accent-red: #ef4444;
            --accent-green: #22c55e;
            --accent-blue: #06b6d4;
            --accent-yellow: #fbbf24;
            --accent-purple: #8b5cf6;
            --accent-pink: #ec4899;
            --border-color: rgba(255, 255, 255, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.3);
            --animation-duration: 0.3s;
            --content-max-width: 1200px;
        }

        /* äº®è‰²ä¸»é¢˜ */
        [data-theme="light"] {
            --bg-dark: #ffffff;
            --bg-section: #f8fafc;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 40px rgba(0, 0, 0, 0.1);
        }

        /* ===== å…¨å±€æ ·å¼ ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            transition: background-color var(--animation-duration) ease;
        }

        /* ===== å¸ƒå±€ç»„ä»¶ ===== */
        .container {
            max-width: var(--content-max-width);
            margin: 0 auto;
            padding: 0 1rem;
        }

        /* ===== å¯¼èˆªæ  ===== */
        .nav-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(10px);
            z-index: 1000;
            border-bottom: 1px solid var(--border-color);
            transition: transform 0.3s ease;
        }

        .nav-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
        }

        .nav-title h1 {
            font-size: 1.25rem;
            font-weight: 600;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .btn-control {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-primary);
            padding: 0.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
        }

        .btn-control:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        .progress-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: var(--primary-gradient);
            width: 0%;
            transition: width 0.3s ease;
        }

        /* ===== ä¸»å†…å®¹åŒº ===== */
        main {
            margin-top: 80px;
            padding-bottom: 4rem;
        }

        /* ===== ç« èŠ‚å¡ç‰‡ ===== */
        .chapter-hero {
            background: var(--primary-gradient);
            padding: 4rem 0;
            margin-bottom: 3rem;
            position: relative;
            overflow: hidden;
        }

        .chapter-hero::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 10s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(180deg); }
        }

        .chapter-hero-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
        }

        .chapter-hero h1 {
            font-size: 3rem;
            margin-bottom: 1rem;
            animation: fadeInUp 0.8s ease;
        }

        .chapter-hero p {
            font-size: 1.25rem;
            opacity: 0.9;
            max-width: 600px;
            margin: 0 auto;
            animation: fadeInUp 0.8s ease 0.2s both;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== å†…å®¹åŒºå— ===== */
        .section-card {
            background: var(--bg-section);
            border-radius: 1rem;
            padding: 2.5rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-lg);
            transition: transform var(--animation-duration) ease;
        }

        .section-card:hover {
            transform: translateY(-2px);
        }

        /* ===== å¯è§†åŒ–å®¹å™¨ ===== */
        .visualization-container {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        .viz-controls {
            display: flex;
            gap: 2rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--animation-duration) ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        canvas {
            display: block;
            margin: 0 auto;
            border-radius: 0.5rem;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid var(--border-color);
        }

        /* ===== æ•°å­¦å…¬å¼å®¹å™¨ ===== */
        .math-container {
            background: rgba(79, 70, 229, 0.1);
            border: 1px solid rgba(79, 70, 229, 0.3);
            border-radius: 1rem;
            padding: 2rem;
            margin: 2rem 0;
            position: relative;
        }

        /* ===== ä»£ç å®¹å™¨ ===== */
        .code-container {
            margin: 2rem 0;
            border-radius: 0.75rem;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .code-content {
            background: #0d1117;
            overflow-x: auto;
        }

        .code-content pre {
            margin: 0;
            padding: 1.5rem;
        }

        .code-content code {
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        /* æç¤ºæ¡† */
        .tip {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 0.75rem;
            margin: 1.5rem 0;
        }

        .tip-icon {
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .tip-content {
            flex: 1;
        }

        .tip.info {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.3);
        }

        .tip.success {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .chapter-hero h1 {
                font-size: 2rem;
            }

            .section-card {
                padding: 1.5rem;
            }

            .viz-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }
    </style>
</head>
<body>
    <!-- å¯¼èˆªæ  -->
    <nav class="nav-header" role="navigation" aria-label="ä¸»å¯¼èˆª">
        <div class="container">
            <div class="nav-content">
                <div class="nav-title">
                    <h1>ç¬¬4ç« ï¼šå¤šå¤´æ³¨æ„åŠ›çš„è¯ç”Ÿ</h1>
                </div>
                <div class="nav-controls">
                    <button id="toggle-theme" class="btn-control" aria-label="åˆ‡æ¢ä¸»é¢˜">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="5"></circle>
                            <line x1="12" y1="1" x2="12" y2="3"></line>
                            <line x1="12" y1="21" x2="12" y2="23"></line>
                        </svg>
                    </button>
                </div>
                <div class="progress-bar" id="progress-bar"></div>
            </div>
        </div>
    </nav>

    <!-- ä¸»å†…å®¹ -->
    <main>
        <!-- ç« èŠ‚æ ‡é¢˜ -->
        <section class="chapter-hero">
            <div class="container">
                <div class="chapter-hero-content">
                    <h1>æ·±å…¥åˆ†æï¼šå¤šå¤´æ³¨æ„åŠ›çš„è¯ç”Ÿ</h1>
                    <p>ä»ç†æƒ³åˆ°ç°å®çš„è·ç¦» â€”â€” è®©æˆ‘ä»¬æ­£è§†é—®é¢˜ï¼Œå¯»æ‰¾çªç ´</p>
                </div>
            </div>
        </section>

        <div class="container">
            <!-- åŠ¨ç”»æµ‹è¯•åŒºåŸŸ -->
            <section class="section-card">
                <h2 style="color: var(--accent-purple); margin-bottom: 1.5rem;">ğŸ¨ åŠ¨ç”»æ•ˆæœæµ‹è¯•</h2>
                
                <div class="tip info">
                    <span class="tip-icon">ğŸ’¡</span>
                    <div class="tip-content">
                        <strong>æµ‹è¯•é¡¹ç›®ï¼š</strong><br>
                        1. èƒŒæ™¯è„‰å†²åŠ¨ç”»ï¼ˆç« èŠ‚æ ‡é¢˜åŒºåŸŸï¼‰<br>
                        2. æ–‡å­—æ·¡å…¥åŠ¨ç”»<br>
                        3. å¡ç‰‡æ‚¬åœæ•ˆæœ<br>
                        4. æŒ‰é’®äº¤äº’åŠ¨ç”»<br>
                        5. Canvaså¯è§†åŒ–åŠ¨ç”»
                    </div>
                </div>

                <!-- å¯è§†åŒ–æµ‹è¯• -->
                <div class="visualization-container">
                    <h3 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ¯ æ³¨æ„åŠ›æƒé‡å¯è§†åŒ–</h3>
                    
                    <div class="viz-controls">
                        <button class="btn btn-primary" onclick="drawAttentionVisualization()">
                            ç»˜åˆ¶æ³¨æ„åŠ›åˆ†å¸ƒ
                        </button>
                        <button class="btn btn-primary" onclick="animateAttention()">
                            æ’­æ”¾åŠ¨ç”»
                        </button>
                    </div>

                    <canvas id="attention-canvas" width="800" height="400"></canvas>
                    
                    <div id="animation-status" class="tip success" style="margin-top: 1rem; display: none;">
                        <span class="tip-icon">âœ…</span>
                        <div class="tip-content">
                            åŠ¨ç”»æ­£åœ¨æ’­æ”¾ï¼å¦‚æœä½ çœ‹åˆ°äº†æ¡å½¢å›¾çš„åŠ¨ç”»æ•ˆæœï¼Œè¯´æ˜JavaScriptå’ŒCanvasåŠ¨ç”»éƒ½å·¥ä½œæ­£å¸¸ã€‚
                        </div>
                    </div>
                </div>
            </section>

            <!-- æ•°å­¦å…¬å¼æµ‹è¯• -->
            <section class="section-card">
                <h2 style="color: var(--accent-green); margin-bottom: 1.5rem;">ğŸ“ æ•°å­¦å…¬å¼æ¸²æŸ“æµ‹è¯•</h2>
                
                <div class="math-container">
                    <h4 style="color: var(--accent-yellow); margin-bottom: 1rem;">å¤šå¤´æ³¨æ„åŠ›æ ¸å¿ƒå…¬å¼</h4>
                    
                    <div style="text-align: center; margin: 2rem 0;">
                        <div id="math-formula-1" style="font-size: 1.2rem; margin: 1rem 0;">
                            MultiHead(Q, K, V) = Concat(head_1, ..., head_h)W^O
                        </div>
                        <div id="math-formula-2" style="font-size: 1.1rem; margin: 1rem 0;">
                            head_i = Attention(QW_i^Q, KW_i^K, VW_i^V)
                        </div>
                        <div id="math-formula-3" style="font-size: 1.1rem; margin: 1rem 0;">
                            Attention(Q, K, V) = softmax(\frac{QK^T}{\sqrt{d_k}})V
                        </div>
                    </div>
                    
                    <div class="tip success" id="katex-status" style="display: none;">
                        <span class="tip-icon">âœ…</span>
                        <div class="tip-content">
                            KaTeX æ•°å­¦å…¬å¼æ¸²æŸ“æˆåŠŸï¼
                        </div>
                    </div>
                </div>
            </section>

            <!-- ä»£ç é«˜äº®æµ‹è¯• -->
            <section class="section-card">
                <h2 style="color: var(--accent-blue); margin-bottom: 1.5rem;">ğŸ’» ä»£ç é«˜äº®æµ‹è¯•</h2>
                
                <div class="code-container">
                    <div class="code-content">
                        <pre><code class="language-python">class MultiHeadAttention(nn.Module):
    def __init__(self, d_model, num_heads):
        super().__init__()
        assert d_model % num_heads == 0
        
        self.d_model = d_model
        self.num_heads = num_heads
        self.d_k = d_model // num_heads
        
        # QKVçº¿æ€§å˜æ¢
        self.W_q = nn.Linear(d_model, d_model)
        self.W_k = nn.Linear(d_model, d_model)
        self.W_v = nn.Linear(d_model, d_model)
        self.W_o = nn.Linear(d_model, d_model)
        
        self.scale = self.d_k ** -0.5

    def forward(self, x):
        batch_size, seq_len, _ = x.size()
        
        # çº¿æ€§å˜æ¢
        Q = self.W_q(x).view(batch_size, seq_len, self.num_heads, self.d_k)
        K = self.W_k(x).view(batch_size, seq_len, self.num_heads, self.d_k)
        V = self.W_v(x).view(batch_size, seq_len, self.num_heads, self.d_k)
        
        # è½¬ç½®ä»¥ä¾¿å¹¶è¡Œè®¡ç®—
        Q = Q.transpose(1, 2)  # [B, H, L, d_k]
        K = K.transpose(1, 2)
        V = V.transpose(1, 2)
        
        # è®¡ç®—æ³¨æ„åŠ›
        scores = torch.matmul(Q, K.transpose(-2, -1)) * self.scale
        attn_weights = F.softmax(scores, dim=-1)
        context = torch.matmul(attn_weights, V)
        
        # æ‹¼æ¥å¤šå¤´
        context = context.transpose(1, 2).contiguous()
        context = context.view(batch_size, seq_len, self.d_model)
        
        # è¾“å‡ºå˜æ¢
        output = self.W_o(context)
        return output</code></pre>
                    </div>
                </div>
                
                <div class="tip success" id="highlight-status" style="display: none;">
                    <span class="tip-icon">âœ…</span>
                    <div class="tip-content">
                        Highlight.js ä»£ç é«˜äº®æ¸²æŸ“æˆåŠŸï¼
                    </div>
                </div>
            </section>

            <!-- æµ‹è¯•æ€»ç»“ -->
            <section class="section-card">
                <h2 style="color: var(--accent-yellow); margin-bottom: 1.5rem;">ğŸ“Š åŠŸèƒ½æµ‹è¯•æ€»ç»“</h2>
                <div id="test-summary">
                    <p>é¡µé¢åŠ è½½ä¸­ï¼Œæ­£åœ¨æ£€æµ‹å„é¡¹åŠŸèƒ½...</p>
                </div>
            </section>
        </div>
    </main>

    <!-- åŠ è½½æœ¬åœ°JavaScriptåº“ -->
    <script src="/lib/highlightjs/highlight.min.js"></script>
    <script src="/lib/katex/katex.min.js"></script>
    <script src="/lib/katex/auto-render.min.js"></script>

    <script>
        // æµ‹è¯•çŠ¶æ€
        const testResults = {
            css: false,
            javascript: false,
            highlight: false,
            katex: false,
            animation: false
        };

        // ç­‰å¾…åº“åŠ è½½
        function waitForLibraries() {
            return new Promise((resolve) => {
                const checkLibraries = () => {
                    if (typeof hljs !== 'undefined' && 
                        typeof katex !== 'undefined') {
                        resolve();
                    } else {
                        setTimeout(checkLibraries, 100);
                    }
                };
                checkLibraries();
            });
        }

        // ç»˜åˆ¶æ³¨æ„åŠ›å¯è§†åŒ–
        function drawAttentionVisualization() {
            const canvas = document.getElementById('attention-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            canvas.width = 800;
            canvas.height = 400;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶èƒŒæ™¯
            ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // æ•°æ®
            const words = ['çº¢è‰²', 'è‹¹æœ', 'å¾ˆ', 'ç”œ'];
            const weights = [0.247, 0.251, 0.244, 0.258];
            
            // ç»˜åˆ¶å‚æ•°
            const barWidth = 120;
            const gap = 40;
            const startX = (canvas.width - (barWidth * 4 + gap * 3)) / 2;
            const maxHeight = 200;
            const baseY = 300;
            
            // ç»˜åˆ¶æŸ±çŠ¶å›¾
            words.forEach((word, i) => {
                const x = startX + i * (barWidth + gap);
                const height = weights[i] * maxHeight * 4;
                
                // æ¸å˜è‰²
                const gradient = ctx.createLinearGradient(x, baseY, x, baseY - height);
                gradient.addColorStop(0, 'rgba(102, 126, 234, 0.8)');
                gradient.addColorStop(1, 'rgba(118, 75, 162, 0.8)');
                
                // ç»˜åˆ¶æŸ±å­
                ctx.fillStyle = gradient;
                ctx.fillRect(x, baseY - height, barWidth, height);
                
                // ç»˜åˆ¶æ ‡ç­¾
                ctx.fillStyle = '#f1f5f9';
                ctx.font = '16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(word, x + barWidth / 2, baseY + 25);
                
                // ç»˜åˆ¶æ•°å€¼
                ctx.fillStyle = '#fbbf24';
                ctx.font = 'bold 14px sans-serif';
                ctx.fillText(weights[i].toFixed(3), x + barWidth / 2, baseY - height - 10);
            });
            
            // æ ‡é¢˜
            ctx.fillStyle = '#f1f5f9';
            ctx.font = 'bold 20px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('å•å¤´æ³¨æ„åŠ›æƒé‡åˆ†å¸ƒ', canvas.width / 2, 40);
            
            testResults.animation = true;
            updateTestSummary();
        }

        // åŠ¨ç”»æ•ˆæœ
        function animateAttention() {
            const canvas = document.getElementById('attention-canvas');
            if (!canvas) return;
            
            const ctx = canvas.getContext('2d');
            let frame = 0;
            const maxFrames = 60;
            
            function animate() {
                frame++;
                const progress = frame / maxFrames;
                
                // æ¸…ç©ºç”»å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = 'rgba(15, 23, 42, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // æ•°æ®
                const words = ['çº¢è‰²', 'è‹¹æœ', 'å¾ˆ', 'ç”œ'];
                const weights = [0.247, 0.251, 0.244, 0.258];
                
                // ç»˜åˆ¶å‚æ•°
                const barWidth = 120;
                const gap = 40;
                const startX = (canvas.width - (barWidth * 4 + gap * 3)) / 2;
                const maxHeight = 200;
                const baseY = 300;
                
                // åŠ¨ç”»è‰²å½©å˜åŒ–
                const hue = (frame * 3) % 360;
                
                words.forEach((word, i) => {
                    const x = startX + i * (barWidth + gap);
                    const animatedHeight = (weights[i] * maxHeight * 4) * progress;
                    
                    // åŠ¨æ€æ¸å˜è‰²
                    const gradient = ctx.createLinearGradient(x, baseY, x, baseY - animatedHeight);
                    gradient.addColorStop(0, `hsla(${hue + i * 30}, 70%, 60%, 0.8)`);
                    gradient.addColorStop(1, `hsla(${hue + i * 30}, 70%, 40%, 0.8)`);
                    
                    // ç»˜åˆ¶æŸ±å­
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, baseY - animatedHeight, barWidth, animatedHeight);
                    
                    // æ ‡ç­¾
                    ctx.fillStyle = '#f1f5f9';
                    ctx.font = '16px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(word, x + barWidth / 2, baseY + 25);
                    
                    // æ•°å€¼
                    if (progress > 0.8) {
                        ctx.fillStyle = '#fbbf24';
                        ctx.font = 'bold 14px sans-serif';
                        ctx.fillText(weights[i].toFixed(3), x + barWidth / 2, baseY - animatedHeight - 10);
                    }
                });
                
                // åŠ¨æ€æ ‡é¢˜
                ctx.fillStyle = '#f1f5f9';
                ctx.font = 'bold 20px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('å¤šå¤´æ³¨æ„åŠ›åŠ¨ç”»æ¼”ç¤º', canvas.width / 2, 40);
                
                if (frame < maxFrames) {
                    requestAnimationFrame(animate);
                } else {
                    // åŠ¨ç”»å®Œæˆ
                    document.getElementById('animation-status').style.display = 'flex';
                    testResults.animation = true;
                    updateTestSummary();
                }
            }
            
            animate();
        }

        // åˆå§‹åŒ–æµ‹è¯•
        async function initializeTests() {
            try {
                // ç­‰å¾…åº“åŠ è½½
                await waitForLibraries();
                
                // æµ‹è¯•CSS
                testResults.css = true;
                
                // æµ‹è¯•JavaScript
                testResults.javascript = true;
                
                // æµ‹è¯•ä»£ç é«˜äº®
                if (typeof hljs !== 'undefined') {
                    hljs.highlightAll();
                    document.getElementById('highlight-status').style.display = 'flex';
                    testResults.highlight = true;
                }
                
                // æµ‹è¯•KaTeX
                if (typeof katex !== 'undefined') {
                    katex.render('\\text{MultiHead}(Q, K, V) = \\text{Concat}(\\text{head}_1, \\ldots, \\text{head}_h)W^O', 
                                document.getElementById('math-formula-1'));
                    katex.render('\\text{head}_i = \\text{Attention}(QW_i^Q, KW_i^K, VW_i^V)', 
                                document.getElementById('math-formula-2'));
                    katex.render('\\text{Attention}(Q, K, V) = \\text{softmax}\\left(\\frac{QK^T}{\\sqrt{d_k}}\\right)V', 
                                document.getElementById('math-formula-3'));
                    
                    document.getElementById('katex-status').style.display = 'flex';
                    testResults.katex = true;
                }
                
                updateTestSummary();
                
                // è‡ªåŠ¨ç»˜åˆ¶ç¬¬ä¸€ä¸ªå¯è§†åŒ–
                setTimeout(() => {
                    drawAttentionVisualization();
                }, 1000);
                
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
            }
        }

        // æ›´æ–°æµ‹è¯•æ€»ç»“
        function updateTestSummary() {
            const summaryEl = document.getElementById('test-summary');
            const total = Object.keys(testResults).length;
            const passed = Object.values(testResults).filter(r => r).length;
            
            let html = `<h3>æµ‹è¯•ç»“æœï¼š${passed}/${total} é¡¹é€šè¿‡</h3><br>`;
            
            const testNames = {
                css: 'CSSæ ·å¼å’ŒåŠ¨ç”»',
                javascript: 'JavaScriptåŸºç¡€åŠŸèƒ½',
                highlight: 'Highlight.jsä»£ç é«˜äº®',
                katex: 'KaTeXæ•°å­¦å…¬å¼æ¸²æŸ“',
                animation: 'CanvasåŠ¨ç”»æ•ˆæœ'
            };
            
            for (const [test, result] of Object.entries(testResults)) {
                const status = result ? 'âœ…' : 'âŒ';
                const color = result ? 'var(--accent-green)' : 'var(--accent-red)';
                html += `<div style="color: ${color}; margin: 0.5rem 0;">${status} ${testNames[test]}</div>`;
            }
            
            if (passed === total) {
                html += '<br><div style="color: var(--accent-green); font-weight: bold; font-size: 1.2rem;">ğŸ‰ æ‰€æœ‰åŠŸèƒ½å®Œç¾è¿è¡Œï¼</div>';
            }
            
            summaryEl.innerHTML = html;
        }

        // ä¸»é¢˜åˆ‡æ¢
        document.getElementById('toggle-theme').addEventListener('click', () => {
            const currentTheme = document.documentElement.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
        });

        // æ»šåŠ¨è¿›åº¦æ¡
        window.addEventListener('scroll', () => {
            const scrolled = window.scrollY;
            const height = document.documentElement.scrollHeight - window.innerHeight;
            const progress = (scrolled / height) * 100;
            document.getElementById('progress-bar').style.width = progress + '%';
        });

        // å¯åŠ¨åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeTests);
        } else {
            initializeTests();
        }
    </script>
</body>
</html>