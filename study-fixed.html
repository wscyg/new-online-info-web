<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¦ä¹ ä¸­å¿ƒ - AIæœªæ¥å­¦é™¢</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: #f8fafc;
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .study-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0;
            max-width: 100%;
            margin: 0;
            padding: 0;
            height: 100vh;
        }

        .content-area {
            background: white;
            border-radius: 0;
            border: none;
            overflow: hidden;
            height: 100vh;
        }

        .content-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .error-state {
            text-align: center;
            padding: 60px 20px;
            font-family: sans-serif;
            background: white;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .error-content {
            max-width: 500px;
        }

        .error-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            color: #ef4444;
        }

        .error-title {
            color: #333;
            font-size: 1.2rem;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .error-message {
            color: #666;
            margin-bottom: 32px;
            line-height: 1.6;
        }

        .retry-btn {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .retry-btn:hover {
            background: #4338ca;
        }

        .loading-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: white;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-left-color: #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="study-container">
        <div class="content-area">
            <!-- åŠ è½½çŠ¶æ€ -->
            <div id="loadingState" class="loading-state">
                <div class="loading-spinner"></div>
            </div>
            
            <!-- é”™è¯¯çŠ¶æ€ -->
            <div id="errorState" class="error-state" style="display: none;">
                <div class="error-content">
                    <div class="error-icon">âŒ</div>
                    <div class="error-title" id="errorTitle">åŠ è½½å¤±è´¥</div>
                    <div class="error-message" id="errorMessage">æ— æ³•åŠ è½½ç« èŠ‚å†…å®¹</div>
                    <button class="retry-btn" onclick="location.reload()">é‡æ–°åŠ è½½</button>
                </div>
            </div>
            
            <!-- å†…å®¹iframe -->
            <iframe id="contentIframe" class="content-iframe" style="display: none;"></iframe>
        </div>
    </div>

    <script>
        const API_BASE = '/api';

        // è·å–URLå‚æ•°
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            return {
                courseId: urlParams.get('courseId') || '1',
                chapterId: urlParams.get('chapterId') || '100'
            };
        }

        // æ˜¾ç¤ºé”™è¯¯
        function showError(title, message) {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('contentIframe').style.display = 'none';
            document.getElementById('errorState').style.display = 'flex';
            document.getElementById('errorTitle').textContent = title;
            document.getElementById('errorMessage').textContent = message;
        }

        // æ˜¾ç¤ºå†…å®¹
        function showContent() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'none';
            document.getElementById('contentIframe').style.display = 'block';
        }

        // è·å–ç« èŠ‚HTMLå†…å®¹
        async function getChapterHTML(chapterId) {
            try {
                console.log('ğŸ“¥ å¼€å§‹è·å–ç« èŠ‚å†…å®¹ï¼ŒID:', chapterId);
                
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE}/content/chapters/${chapterId}`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('ğŸ“¦ APIå“åº”æ•°æ®:', data);
                
                if (data.code === 200 && data.success) {
                    // æ£€æŸ¥æ•°æ®ç»“æ„
                    if (data.data && data.data.content && data.data.content.contentHtml) {
                        console.log('âœ… æ‰¾åˆ°HTMLå†…å®¹ï¼Œé•¿åº¦:', data.data.content.contentHtml.length);
                        return data.data.content.contentHtml;
                    } else {
                        console.log('âš ï¸ æœªæ‰¾åˆ°contentHtmlï¼Œç”Ÿæˆé»˜è®¤å†…å®¹');
                        return generateDefaultHTML(data.data?.chapter || { title: 'ç« èŠ‚å†…å®¹' });
                    }
                } else if (data.code === 403) {
                    return generatePermissionDeniedHTML(chapterId, data.message);
                } else if (data.code === 401) {
                    return generateLoginRequiredHTML(chapterId);
                } else {
                    console.warn('âŒ APIè¿”å›é”™è¯¯:', data.message);
                    return generateErrorHTML(chapterId, data.message || 'è·å–å†…å®¹å¤±è´¥');
                }
            } catch (error) {
                console.error('âŒ è·å–ç« èŠ‚å†…å®¹å¤±è´¥:', error);
                return generateErrorHTML(chapterId, 'ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥');
            }
        }

        // ç”Ÿæˆé»˜è®¤HTML
        function generateDefaultHTML(chapter) {
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${chapter.title || 'ç« èŠ‚å†…å®¹'}</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem;
            background: white;
        }
        h1 { color: #4f46e5; margin-bottom: 2rem; }
        .coming-soon {
            text-align: center;
            padding: 3rem;
            background: #f8fafc;
            border-radius: 12px;
            margin: 2rem 0;
        }
        .icon { font-size: 4rem; margin-bottom: 1rem; }
    </style>
</head>
<body>
    <h1>${chapter.title || 'ç« èŠ‚å†…å®¹'}</h1>
    <div class="coming-soon">
        <div class="icon">ğŸ“š</div>
        <h2>å†…å®¹åˆ¶ä½œä¸­</h2>
        <p>è¯¥ç« èŠ‚çš„è¯¦ç»†å†…å®¹æ­£åœ¨åˆ¶ä½œä¸­ï¼Œæ•¬è¯·æœŸå¾…ï¼</p>
        <p>${chapter.description || 'æˆ‘ä»¬æ­£åœ¨ä¸ºæ‚¨å‡†å¤‡é«˜è´¨é‡çš„å­¦ä¹ å†…å®¹ã€‚'}</p>
    </div>
</body>
</html>`;
        }

        // ç”Ÿæˆæƒé™é”™è¯¯HTML
        function generatePermissionDeniedHTML(chapterId, message) {
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœ€è¦æƒé™</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            padding: 3rem;
            background: white;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { max-width: 500px; }
        .icon { font-size: 4rem; margin-bottom: 2rem; }
        h1 { color: #ef4444; margin-bottom: 1rem; }
        .btn {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ğŸ”’</div>
        <h1>éœ€è¦è´­ä¹°è¯¾ç¨‹</h1>
        <p>${message || 'è¯¥ç« èŠ‚éœ€è¦è´­ä¹°è¯¾ç¨‹åæ‰èƒ½è§‚çœ‹'}</p>
        <a href="/src/pages/course-detail.html?id=1" class="btn">è´­ä¹°è¯¾ç¨‹</a>
    </div>
</body>
</html>`;
        }

        // ç”Ÿæˆç™»å½•é”™è¯¯HTML
        function generateLoginRequiredHTML(chapterId) {
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éœ€è¦ç™»å½•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            padding: 3rem;
            background: white;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { max-width: 500px; }
        .icon { font-size: 4rem; margin-bottom: 2rem; }
        h1 { color: #f59e0b; margin-bottom: 1rem; }
        .btn {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">ğŸ‘¤</div>
        <h1>éœ€è¦ç™»å½•</h1>
        <p>éœ€è¦ç™»å½•åæ‰èƒ½è§‚çœ‹è¯¾ç¨‹å†…å®¹</p>
        <a href="/src/pages/login.html" class="btn">ç«‹å³ç™»å½•</a>
    </div>
</body>
</html>`;
        }

        // ç”Ÿæˆé€šç”¨é”™è¯¯HTML
        function generateErrorHTML(chapterId, message) {
            return `<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠ è½½é”™è¯¯</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            text-align: center;
            padding: 3rem;
            background: white;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .container { max-width: 500px; }
        .icon { font-size: 4rem; margin-bottom: 2rem; }
        h1 { color: #ef4444; margin-bottom: 1rem; }
        .btn {
            padding: 12px 24px;
            background: #4f46e5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="icon">âŒ</div>
        <h1>åŠ è½½å¤±è´¥</h1>
        <p>${message}</p>
        <p>ç« èŠ‚ID: ${chapterId}</p>
        <button class="btn" onclick="parent.location.reload()">é‡æ–°åŠ è½½</button>
    </div>
</body>
</html>`;
        }

        // åŠ è½½ç« èŠ‚å†…å®¹
        async function loadChapterContent() {
            const { courseId, chapterId } = getUrlParams();
            
            console.log('ğŸš€ å¼€å§‹åŠ è½½ç« èŠ‚å†…å®¹');
            console.log('ğŸ“‹ å‚æ•°:', { courseId, chapterId });
            
            try {
                // è·å–HTMLå†…å®¹
                const htmlContent = await getChapterHTML(chapterId);
                console.log('ğŸ“„ è·å–åˆ°HTMLå†…å®¹ï¼Œé•¿åº¦:', htmlContent.length);
                
                // è®¾ç½®iframeå†…å®¹
                const iframe = document.getElementById('contentIframe');
                iframe.onload = function() {
                    console.log('âœ… iframeåŠ è½½å®Œæˆ');
                    showContent();
                };
                
                // æ–¹æ³•1ï¼šä½¿ç”¨srcDoc (æ¨è)
                if ('srcDoc' in iframe) {
                    console.log('ğŸ“ ä½¿ç”¨srcDocè®¾ç½®å†…å®¹');
                    iframe.srcDoc = htmlContent;
                } else {
                    // æ–¹æ³•2ï¼šä½¿ç”¨data URL (å…¼å®¹æ€§)
                    console.log('ğŸ“ ä½¿ç”¨data URLè®¾ç½®å†…å®¹');
                    const dataUrl = 'data:text/html;charset=utf-8,' + encodeURIComponent(htmlContent);
                    iframe.src = dataUrl;
                }
                
            } catch (error) {
                console.error('âŒ åŠ è½½ç« èŠ‚å†…å®¹å¤±è´¥:', error);
                showError('åŠ è½½å¤±è´¥', error.message || 'æ— æ³•åŠ è½½ç« èŠ‚å†…å®¹');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–');
            loadChapterContent();
        });
    </script>
</body>
</html>