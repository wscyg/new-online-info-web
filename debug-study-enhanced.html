<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studyé¡µé¢è°ƒè¯•ç‰ˆæœ¬</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background-color: #0f172a;
            font-family: sans-serif;
        }
        #contentFrame {
            width: 100%;
            height: 100%;
            border: none;
            display: block;
        }
        .loading-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: white;
            font-size: 1.2rem;
            padding: 2rem;
        }
        .debug-info {
            background: rgba(30, 41, 59, 0.8);
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-width: 80%;
            max-height: 200px;
            overflow-y: auto;
            font-size: 0.9rem;
            border: 1px solid #475569;
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .info { color: #06b6d4; }
    </style>
    <script>
        // å¢å¼ºç‰ˆæœ¬çš„åº“æ›¿æ¢å‡½æ•°ï¼Œå¸¦è°ƒè¯•è¾“å‡º
        function replaceExternalLibs(htmlContent) {
            console.log('ğŸ” å¼€å§‹æ›¿æ¢å¤–éƒ¨åº“...');
            
            const replacements = {
                // Cloudflare CDN
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css': '/lib/highlightjs/github-dark.min.css',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css': '/lib/katex/katex.min.css',
                'https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js': '/lib/highlightjs/highlight.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.js': '/lib/katex/katex.min.js',
                'https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/contrib/auto-render.min.js': '/lib/katex/auto-render.min.js',
                // JSDelivr CDN
                'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css': '/lib/highlightjs/github-dark.min.css',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css': '/lib/katex/katex.min.css',
                'https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/lib/highlight.min.js': '/lib/highlightjs/highlight.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js': '/lib/katex/katex.min.js',
                'https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js': '/lib/katex/auto-render.min.js'
            };
            
            let modifiedHtml = htmlContent;
            let replacementCount = 0;
            
            for (const [cdnUrl, localUrl] of Object.entries(replacements)) {
                const originalLength = modifiedHtml.length;
                modifiedHtml = modifiedHtml.split(cdnUrl).join(localUrl);
                if (modifiedHtml.length !== originalLength) {
                    replacementCount++;
                    console.log(`âœ… æ›¿æ¢æˆåŠŸ: ${cdnUrl} â†’ ${localUrl}`);
                }
            }
            
            console.log(`ğŸ“Š æ€»å…±æ›¿æ¢äº† ${replacementCount} ä¸ªå¤–éƒ¨é“¾æ¥`);
            
            // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æœªå¤„ç†çš„CDNé“¾æ¥
            const remainingCDN = [];
            if (modifiedHtml.includes('cdnjs.cloudflare.com')) remainingCDN.push('Cloudflare CDN');
            if (modifiedHtml.includes('cdn.jsdelivr.net')) remainingCDN.push('JSDelivr CDN');
            if (modifiedHtml.includes('unpkg.com')) remainingCDN.push('unpkg CDN');
            
            if (remainingCDN.length > 0) {
                console.warn(`âš ï¸  ä»ç„¶å­˜åœ¨å¤–éƒ¨CDN: ${remainingCDN.join(', ')}`);
            }
            
            return modifiedHtml;
        }

        function updateDebugInfo(message, type = 'info') {
            const debugDiv = document.getElementById('debug-info');
            if (debugDiv) {
                const timestamp = new Date().toLocaleTimeString();
                debugDiv.innerHTML += `<div class="${type}">[${timestamp}] ${message}</div>`;
                debugDiv.scrollTop = debugDiv.scrollHeight;
            }
        }
    </script>
</head>
<body>
    <div id="loading" class="loading-container">
        <div>ğŸš€ æ­£åœ¨åŠ è½½ç« èŠ‚å†…å®¹...</div>
        <div class="debug-info" id="debug-info"></div>
    </div>
    <iframe id="contentFrame" style="display: none;"></iframe>
    
    <script>
        (async function () {
            const loadingIndicator = document.getElementById('loading');
            const contentFrame = document.getElementById('contentFrame');
            
            try {
                updateDebugInfo('å¼€å§‹è·å–ç« èŠ‚å‚æ•°...');
                
                const urlParams = new URLSearchParams(window.location.search);
                const chapterId = urlParams.get('chapterId');
                if (!chapterId) {
                    throw new Error('URLä¸­æœªæ‰¾åˆ°ç« èŠ‚ID (chapterId)');
                }
                
                updateDebugInfo(`ç« èŠ‚ID: ${chapterId}`, 'success');
                updateDebugInfo('å‘é€APIè¯·æ±‚...');
                
                const response = await fetch(`/api/content/chapters/${chapterId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    }
                });
                
                updateDebugInfo(`APIå“åº”çŠ¶æ€: ${response.status}`, response.ok ? 'success' : 'error');
                
                if (!response.ok) {
                    throw new Error(`æ— æ³•è·å–ç« èŠ‚å†…å®¹ï¼ŒæœåŠ¡å™¨çŠ¶æ€: ${response.status}`);
                }
                
                const data = await response.json();
                updateDebugInfo(`APIå“åº”ä»£ç : ${data.code}`, data.code === 200 ? 'success' : 'warning');
                
                let htmlText = '';
                if (data.code === 200 && data.data && data.data.content && data.data.content.contentHtml) {
                    const originalHtml = data.data.content.contentHtml;
                    updateDebugInfo(`åŸå§‹HTMLé•¿åº¦: ${originalHtml.length} å­—ç¬¦`);
                    
                    // æ£€æŸ¥åŸå§‹HTMLä¸­çš„CDNé“¾æ¥
                    const cdnCount = (originalHtml.match(/https:\/\/cdnjs\.cloudflare\.com/g) || []).length + 
                                   (originalHtml.match(/https:\/\/cdn\.jsdelivr\.net/g) || []).length;
                    updateDebugInfo(`æ£€æµ‹åˆ° ${cdnCount} ä¸ªCDNé“¾æ¥`, cdnCount > 0 ? 'warning' : 'success');
                    
                    // å…³é”®ï¼šåœ¨è¿™é‡Œæ›¿æ¢å¤–éƒ¨åº“ä¸ºæœ¬åœ°åº“
                    updateDebugInfo('å¼€å§‹æ›¿æ¢CDNé“¾æ¥ä¸ºæœ¬åœ°åº“...');
                    htmlText = replaceExternalLibs(originalHtml);
                    
                    updateDebugInfo(`å¤„ç†åHTMLé•¿åº¦: ${htmlText.length} å­—ç¬¦`);
                    
                    // éªŒè¯æ›¿æ¢ç»“æœ
                    const localLibCount = (htmlText.match(/\/lib\//g) || []).length;
                    updateDebugInfo(`æ£€æµ‹åˆ° ${localLibCount} ä¸ªæœ¬åœ°åº“å¼•ç”¨`, localLibCount > 0 ? 'success' : 'warning');
                    
                } else {
                    throw new Error(data.message || 'æœªæ‰¾åˆ°ç« èŠ‚å†…å®¹');
                }
                
                updateDebugInfo('åˆ›å»ºBlob URL...');
                const blob = new Blob([htmlText], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);
                
                updateDebugInfo('åŠ è½½å†…å®¹åˆ°iframe...');
                contentFrame.src = blobUrl;
                
                contentFrame.onload = () => {
                    updateDebugInfo('å†…å®¹åŠ è½½å®Œæˆï¼', 'success');
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                        contentFrame.style.display = 'block';
                    }, 2000); // å»¶è¿Ÿ2ç§’ä»¥ä¾¿æŸ¥çœ‹è°ƒè¯•ä¿¡æ¯
                    
                    // æ¸…ç†blob URLä»¥é‡Šæ”¾å†…å­˜
                    setTimeout(() => {
                        URL.revokeObjectURL(blobUrl);
                    }, 3000);
                };
                
                contentFrame.onerror = (error) => {
                    updateDebugInfo(`iframeåŠ è½½é”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                console.error('åŠ è½½ç« èŠ‚å¤±è´¥:', error);
                updateDebugInfo(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        })();
    </script>
</body>
</html>